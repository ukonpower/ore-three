window.ORE=function(t){var i={};function e(s){if(i[s])return i[s].exports;var o=i[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,e),o.l=!0,o.exports}return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var o in t)e.d(s,o,function(i){return t[i]}.bind(null,o));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=19)}([function(t,i){t.exports=window.THREE},function(t,i,e){var s;t.exports=function t(i,e,o){function n(a,h){if(!e[a]){if(!i[a]){if(!h&&"function"==typeof s&&s)return s(a,!0);if(r)return r(a,!0);throw new Error("Cannot find module '"+a+"'")}var l=e[a]={exports:{}};i[a][0].call(l.exports,(function(t){var e=i[a][1][t];return n(e||t)}),l,l.exports,t,i,e,o)}return e[a].exports}for(var r="function"==typeof s&&s,a=0;a<o.length;a++)n(o[a]);return n}({1:[function(t,i,e){i.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,i,e){i.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,i,e){var s=t("../math/Vec3");function o(t){t=t||{},this.lowerBound=new s,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new s,t.upperBound&&this.upperBound.copy(t.upperBound)}t("../utils/Utils"),i.exports=o;var n=new s;o.prototype.setFromPoints=function(t,i,e,s){var o=this.lowerBound,r=this.upperBound,a=e;o.copy(t[0]),a&&a.vmult(o,o),r.copy(o);for(var h=1;h<t.length;h++){var l=t[h];a&&(a.vmult(l,n),l=n),l.x>r.x&&(r.x=l.x),l.x<o.x&&(o.x=l.x),l.y>r.y&&(r.y=l.y),l.y<o.y&&(o.y=l.y),l.z>r.z&&(r.z=l.z),l.z<o.z&&(o.z=l.z)}return i&&(i.vadd(o,o),i.vadd(r,r)),s&&(o.x-=s,o.y-=s,o.z-=s,r.x+=s,r.y+=s,r.z+=s),this},o.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},o.prototype.clone=function(){return(new o).copy(this)},o.prototype.extend=function(t){var i=t.lowerBound.x;this.lowerBound.x>i&&(this.lowerBound.x=i);var e=t.upperBound.x;this.upperBound.x<e&&(this.upperBound.x=e),i=t.lowerBound.y,this.lowerBound.y>i&&(this.lowerBound.y=i),e=t.upperBound.y,this.upperBound.y<e&&(this.upperBound.y=e),i=t.lowerBound.z,this.lowerBound.z>i&&(this.lowerBound.z=i),e=t.upperBound.z,this.upperBound.z<e&&(this.upperBound.z=e)},o.prototype.overlaps=function(t){var i=this.lowerBound,e=this.upperBound,s=t.lowerBound,o=t.upperBound;return(s.x<=e.x&&e.x<=o.x||i.x<=o.x&&o.x<=e.x)&&(s.y<=e.y&&e.y<=o.y||i.y<=o.y&&o.y<=e.y)&&(s.z<=e.z&&e.z<=o.z||i.z<=o.z&&o.z<=e.z)},o.prototype.contains=function(t){var i=this.lowerBound,e=this.upperBound,s=t.lowerBound,o=t.upperBound;return i.x<=s.x&&e.x>=o.x&&i.y<=s.y&&e.y>=o.y&&i.z<=s.z&&e.z>=o.z},o.prototype.getCorners=function(t,i,e,s,o,n,r,a){var h=this.lowerBound,l=this.upperBound;t.copy(h),i.set(l.x,h.y,h.z),e.set(l.x,l.y,h.z),s.set(h.x,l.y,l.z),o.set(l.x,h.y,h.z),n.set(h.x,l.y,h.z),r.set(h.x,h.y,l.z),a.copy(l)};var r=[new s,new s,new s,new s,new s,new s,new s,new s];o.prototype.toLocalFrame=function(t,i){var e=r,s=e[0],o=e[1],n=e[2],a=e[3],h=e[4],l=e[5],c=e[6],u=e[7];this.getCorners(s,o,n,a,h,l,c,u);for(var p=0;8!==p;p++){var d=e[p];t.pointToLocal(d,d)}return i.setFromPoints(e)},o.prototype.toWorldFrame=function(t,i){var e=r,s=e[0],o=e[1],n=e[2],a=e[3],h=e[4],l=e[5],c=e[6],u=e[7];this.getCorners(s,o,n,a,h,l,c,u);for(var p=0;8!==p;p++){var d=e[p];t.pointToWorld(d,d)}return i.setFromPoints(e)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,i,e){function s(){this.matrix=[]}i.exports=s,s.prototype.get=function(t,i){if(t=t.index,(i=i.index)>t){var e=i;i=t,t=e}return this.matrix[(t*(t+1)>>1)+i-1]},s.prototype.set=function(t,i,e){if(t=t.index,(i=i.index)>t){var s=i;i=t,t=s}this.matrix[(t*(t+1)>>1)+i-1]=e?1:0},s.prototype.reset=function(){for(var t=0,i=this.matrix.length;t!==i;t++)this.matrix[t]=0},s.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,i,e){var s=t("../objects/Body"),o=t("../math/Vec3"),n=t("../math/Quaternion");function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}t("../shapes/Shape"),t("../shapes/Plane"),i.exports=r,r.prototype.collisionPairs=function(t,i,e){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var a=s.STATIC|s.KINEMATIC;r.prototype.needBroadphaseCollision=function(t,i){return 0!=(t.collisionFilterGroup&i.collisionFilterMask)&&0!=(i.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&a)&&t.sleepState!==s.SLEEPING||0==(i.type&a)&&i.sleepState!==s.SLEEPING)},r.prototype.intersectionTest=function(t,i,e,s){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,i,e,s):this.doBoundingSphereBroadphase(t,i,e,s)};var h=new o;new o,new n,new o,r.prototype.doBoundingSphereBroadphase=function(t,i,e,s){var o=h;i.position.vsub(t.position,o);var n=Math.pow(t.boundingRadius+i.boundingRadius,2);o.norm2()<n&&(e.push(t),s.push(i))},r.prototype.doBoundingBoxBroadphase=function(t,i,e,s){t.aabbNeedsUpdate&&t.computeAABB(),i.aabbNeedsUpdate&&i.computeAABB(),t.aabb.overlaps(i.aabb)&&(e.push(t),s.push(i))};var l={keys:[]},c=[],u=[];r.prototype.makePairsUnique=function(t,i){for(var e=l,s=c,o=u,n=t.length,r=0;r!==n;r++)s[r]=t[r],o[r]=i[r];for(t.length=0,i.length=0,r=0;r!==n;r++){var a=s[r].id,h=o[r].id;e[p=a<h?a+","+h:h+","+a]=r,e.keys.push(p)}for(r=0;r!==e.keys.length;r++){var p=e.keys.pop(),d=e[p];t.push(s[d]),i.push(o[d]),delete e[p]}},r.prototype.setWorld=function(t){};var p=new o;r.boundingSphereCheck=function(t,i){var e=p;return t.position.vsub(i.position,e),Math.pow(t.shape.boundingSphereRadius+i.shape.boundingSphereRadius,2)>e.norm2()},r.prototype.aabbQuery=function(t,i,e){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,i,e){i.exports=r;var s=t("./Broadphase"),o=t("../math/Vec3"),n=t("../shapes/Shape");function r(t,i,e,n,r){s.apply(this),this.nx=e||10,this.ny=n||10,this.nz=r||10,this.aabbMin=t||new o(100,100,100),this.aabbMax=i||new o(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var h=0;h<a;h++)this.bins[h]=[],this.binLengths[h]=0}r.prototype=new s,r.prototype.constructor=r;var a=new o;new o,r.prototype.collisionPairs=function(t,i,e){for(var s=t.numObjects(),o=t.bodies,r=this.aabbMax,h=this.aabbMin,l=this.nx,c=this.ny,u=this.nz,p=c*u,d=u,m=1,y=r.x,f=r.y,v=r.z,x=h.x,b=h.y,g=h.z,w=l/(y-x),z=c/(f-b),N=u/(v-g),S=(y-x)/l,M=(f-b)/c,P=(v-g)/u,k=.5*Math.sqrt(S*S+M*M+P*P),A=n.types,V=A.SPHERE,T=A.PLANE,I=(A.BOX,A.COMPOUND,A.CONVEXPOLYHEDRON,this.bins),L=this.binLengths,C=this.bins.length,B=0;B!==C;B++)L[B]=0;var E=Math.ceil;function R(t,i,e,s,o,n,r){var a=(t-x)*w|0,h=(i-b)*z|0,y=(e-g)*N|0,f=E((s-x)*w),v=E((o-b)*z),S=E((n-g)*N);a<0?a=0:a>=l&&(a=l-1),h<0?h=0:h>=c&&(h=c-1),y<0?y=0:y>=u&&(y=u-1),f<0?f=0:f>=l&&(f=l-1),v<0?v=0:v>=c&&(v=c-1),S<0?S=0:S>=u&&(S=u-1),h*=d,y*=m,f*=p,v*=d,S*=m;for(var M=a*=p;M<=f;M+=p)for(var P=h;P<=v;P+=d)for(var k=y;k<=S;k+=m){var A=M+P+k;I[A][L[A]++]=r}}for(h=Math.min,r=Math.max,B=0;B!==s;B++){var F=(et=o[B]).shape;switch(F.type){case V:var q=et.position.x,j=et.position.y,O=et.position.z,D=F.radius;R(q-D,j-D,O-D,q+D,j+D,O+D,et);break;case T:F.worldNormalNeedsUpdate&&F.computeWorldNormal(et.quaternion);var _=F.worldNormal,W=x+.5*S-et.position.x,U=b+.5*M-et.position.y,H=g+.5*P-et.position.z,G=a;G.set(W,U,H);for(var X=0,Y=0;X!==l;X++,Y+=p,G.y=U,G.x+=S)for(var Q=0,Z=0;Q!==c;Q++,Z+=d,G.z=H,G.y+=M)for(var K=0,J=0;K!==u;K++,J+=m,G.z+=P)if(G.dot(_)<k){var $=Y+Z+J;I[$][L[$]++]=et}break;default:et.aabbNeedsUpdate&&et.computeAABB(),R(et.aabb.lowerBound.x,et.aabb.lowerBound.y,et.aabb.lowerBound.z,et.aabb.upperBound.x,et.aabb.upperBound.y,et.aabb.upperBound.z,et)}}for(B=0;B!==C;B++){var tt=L[B];if(tt>1){var it=I[B];for(X=0;X!==tt;X++){var et=it[X];for(Q=0;Q!==X;Q++){var st=it[Q];this.needBroadphaseCollision(et,st)&&this.intersectionTest(et,st,i,e)}}}}this.makePairsUnique(i,e)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,i,e){i.exports=n;var s=t("./Broadphase"),o=t("./AABB");function n(){s.apply(this)}n.prototype=new s,n.prototype.constructor=n,n.prototype.collisionPairs=function(t,i,e){var s,o,n,r,a=t.bodies,h=a.length;for(s=0;s!==h;s++)for(o=0;o!==s;o++)n=a[s],r=a[o],this.needBroadphaseCollision(n,r)&&this.intersectionTest(n,r,i,e)},new o,n.prototype.aabbQuery=function(t,i,e){e=e||[];for(var s=0;s<t.bodies.length;s++){var o=t.bodies[s];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(i)&&e.push(o)}return e}},{"./AABB":3,"./Broadphase":5}],8:[function(t,i,e){function s(){this.matrix={}}i.exports=s,s.prototype.get=function(t,i){if(t=t.id,(i=i.id)>t){var e=i;i=t,t=e}return t+"-"+i in this.matrix},s.prototype.set=function(t,i,e){if(t=t.id,(i=i.id)>t){var s=i;i=t,t=s}e?this.matrix[t+"-"+i]=!0:delete this.matrix[t+"-"+i]},s.prototype.reset=function(){this.matrix={}},s.prototype.setNumObjects=function(t){}},{}],9:[function(t,i,e){i.exports=l;var s=t("../math/Vec3"),o=t("../math/Quaternion"),n=t("../math/Transform"),r=(t("../shapes/ConvexPolyhedron"),t("../shapes/Box"),t("../collision/RaycastResult")),a=t("../shapes/Shape"),h=t("../collision/AABB");function l(t,i){this.from=t?t.clone():new s,this.to=i?i.clone():new s,this._direction=new s,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=l.ANY,this.result=new r,this.hasHit=!1,this.callback=function(t){}}l.prototype.constructor=l,l.CLOSEST=1,l.ANY=2,l.ALL=4;var c=new h,u=[];l.prototype.intersectWorld=function(t,i){return this.mode=i.mode||l.ANY,this.result=i.result||new r,this.skipBackfaces=!!i.skipBackfaces,this.collisionFilterMask=void 0!==i.collisionFilterMask?i.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==i.collisionFilterGroup?i.collisionFilterGroup:-1,i.from&&this.from.copy(i.from),i.to&&this.to.copy(i.to),this.callback=i.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(c),u.length=0,t.broadphase.aabbQuery(t,c,u),this.intersectBodies(u),this.hasHit};var p=new s,d=new s;function m(t,i,e,s){s.vsub(i,B),e.vsub(i,p),t.vsub(i,d);var o,n,r=B.dot(B),a=B.dot(p),h=B.dot(d),l=p.dot(p),c=p.dot(d);return(o=l*h-a*c)>=0&&(n=r*c-a*h)>=0&&o+n<r*l-a*a}l.pointInTriangle=m;var y=new s,f=new o;l.prototype.intersectBody=function(t,i){i&&(this.result=i,this._updateDirection());var e=this.checkCollisionResponse;if((!e||t.collisionResponse)&&0!=(this.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&this.collisionFilterMask))for(var s=y,o=f,n=0,r=t.shapes.length;n<r;n++){var a=t.shapes[n];if((!e||a.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[n],o),t.quaternion.vmult(t.shapeOffsets[n],s),s.vadd(t.position,s),this.intersectShape(a,o,s,t),this.result._shouldStop))break}},l.prototype.intersectBodies=function(t,i){i&&(this.result=i,this._updateDirection());for(var e=0,s=t.length;!this.result._shouldStop&&e<s;e++)this.intersectBody(t[e])},l.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},l.prototype.intersectShape=function(t,i,e,s){if(!(function(t,i,e){e.vsub(t,B);var s=B.dot(i);return i.mult(s,E),E.vadd(t,E),e.distanceTo(E)}(this.from,this._direction,e)>t.boundingSphereRadius)){var o=this[t.type];o&&o.call(this,t,i,e,s)}},new s,new s;var v=new s,x=new s,b=new s,g=new s;new s,new r,l.prototype.intersectBox=function(t,i,e,s){return this.intersectConvex(t.convexPolyhedronRepresentation,i,e,s)},l.prototype[a.types.BOX]=l.prototype.intersectBox,l.prototype.intersectPlane=function(t,i,e,o){var n=this.from,r=this.to,a=this._direction,h=new s(0,0,1);i.vmult(h,h);var l=new s;n.vsub(e,l);var c=l.dot(h);if(r.vsub(e,l),!(c*l.dot(h)>0||n.distanceTo(r)<c)){var u=h.dot(a);if(!(Math.abs(u)<this.precision)){var p=new s,d=new s,m=new s;n.vsub(e,p);var y=-h.dot(p)/u;a.scale(y,d),n.vadd(d,m),this.reportIntersection(h,m,t,o,-1)}}},l.prototype[a.types.PLANE]=l.prototype.intersectPlane,l.prototype.getAABB=function(t){var i=this.to,e=this.from;t.lowerBound.x=Math.min(i.x,e.x),t.lowerBound.y=Math.min(i.y,e.y),t.lowerBound.z=Math.min(i.z,e.z),t.upperBound.x=Math.max(i.x,e.x),t.upperBound.y=Math.max(i.y,e.y),t.upperBound.z=Math.max(i.z,e.z)};var w={faceList:[0]};l.prototype.intersectHeightfield=function(t,i,e,o){t.data,t.elementSize;var r=new s,a=new l(this.from,this.to);n.pointToLocalFrame(e,i,a.from,a.from),n.pointToLocalFrame(e,i,a.to,a.to);var h=[],c=null,u=null,p=null,d=null,m=t.getIndexOfPosition(a.from.x,a.from.y,h,!1);if(m&&(c=h[0],u=h[1],p=h[0],d=h[1]),(m=t.getIndexOfPosition(a.to.x,a.to.y,h,!1))&&((null===c||h[0]<c)&&(c=h[0]),(null===p||h[0]>p)&&(p=h[0]),(null===u||h[1]<u)&&(u=h[1]),(null===d||h[1]>d)&&(d=h[1])),null!==c){var y=[];t.getRectMinMax(c,u,p,d,y);for(var f=c;f<=p;f++)for(var v=u;v<=d;v++){if(this.result._shouldStop)return;if(t.getConvexTrianglePillar(f,v,!1),n.pointToWorldFrame(e,i,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,i,r,o,w),this.result._shouldStop)return;t.getConvexTrianglePillar(f,v,!0),n.pointToWorldFrame(e,i,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,i,r,o,w)}}},l.prototype[a.types.HEIGHTFIELD]=l.prototype.intersectHeightfield;var z=new s,N=new s;l.prototype.intersectSphere=function(t,i,e,s){var o=this.from,n=this.to,r=t.radius,a=Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2)+Math.pow(n.z-o.z,2),h=2*((n.x-o.x)*(o.x-e.x)+(n.y-o.y)*(o.y-e.y)+(n.z-o.z)*(o.z-e.z)),l=Math.pow(o.x-e.x,2)+Math.pow(o.y-e.y,2)+Math.pow(o.z-e.z,2)-Math.pow(r,2),c=Math.pow(h,2)-4*a*l,u=z,p=N;if(!(c<0))if(0===c)o.lerp(n,c,u),u.vsub(e,p),p.normalize(),this.reportIntersection(p,u,t,s,-1);else{var d=(-h-Math.sqrt(c))/(2*a),m=(-h+Math.sqrt(c))/(2*a);if(d>=0&&d<=1&&(o.lerp(n,d,u),u.vsub(e,p),p.normalize(),this.reportIntersection(p,u,t,s,-1)),this.result._shouldStop)return;m>=0&&m<=1&&(o.lerp(n,m,u),u.vsub(e,p),p.normalize(),this.reportIntersection(p,u,t,s,-1))}},l.prototype[a.types.SPHERE]=l.prototype.intersectSphere;var S=new s,M=(new s,new s,new s);l.prototype.intersectConvex=function(t,i,e,s,o){for(var n=S,r=M,a=o&&o.faceList||null,h=t.faces,l=t.vertices,c=t.faceNormals,u=this._direction,p=this.from,d=this.to,y=p.distanceTo(d),f=a?a.length:h.length,w=this.result,z=0;!w._shouldStop&&z<f;z++){var N=a?a[z]:z,P=h[N],k=c[N],A=i,V=e;r.copy(l[P[0]]),A.vmult(r,r),r.vadd(V,r),r.vsub(p,r),A.vmult(k,n);var T=u.dot(n);if(!(Math.abs(T)<this.precision)){var I=n.dot(r)/T;if(!(I<0)){u.mult(I,v),v.vadd(p,v),x.copy(l[P[0]]),A.vmult(x,x),V.vadd(x,x);for(var L=1;!w._shouldStop&&L<P.length-1;L++){b.copy(l[P[L]]),g.copy(l[P[L+1]]),A.vmult(b,b),A.vmult(g,g),V.vadd(b,b),V.vadd(g,g);var C=v.distanceTo(p);!m(v,x,b,g)&&!m(v,b,x,g)||C>y||this.reportIntersection(n,v,t,s,N)}}}}},l.prototype[a.types.CONVEXPOLYHEDRON]=l.prototype.intersectConvex;var P=new s,k=new s,A=new s,V=new s,T=new s,I=new s,L=(new h,[]),C=new n;l.prototype.intersectTrimesh=function(t,i,e,s,o){var r=P,a=L,h=C,l=M,c=k,u=A,p=V,d=I,y=T,f=(o&&o.faceList,t.indices),w=(t.vertices,t.faceNormals,this.from),z=this.to,N=this._direction;h.position.copy(e),h.quaternion.copy(i),n.vectorToLocalFrame(e,i,N,c),n.pointToLocalFrame(e,i,w,u),n.pointToLocalFrame(e,i,z,p);var S=u.distanceSquared(p);t.tree.rayQuery(this,h,a);for(var B=0,E=a.length;!this.result._shouldStop&&B!==E;B++){var R=a[B];t.getNormal(R,r),t.getVertex(f[3*R],x),x.vsub(u,l);var F=c.dot(r),q=r.dot(l)/F;if(!(q<0)){c.scale(q,v),v.vadd(u,v),t.getVertex(f[3*R+1],b),t.getVertex(f[3*R+2],g);var j=v.distanceSquared(u);!m(v,b,x,g)&&!m(v,x,b,g)||j>S||(n.vectorToWorldFrame(i,r,y),n.pointToWorldFrame(e,i,v,d),this.reportIntersection(y,d,t,s,R))}}a.length=0},l.prototype[a.types.TRIMESH]=l.prototype.intersectTrimesh,l.prototype.reportIntersection=function(t,i,e,s,o){var n=this.from,r=this.to,a=n.distanceTo(i),h=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(h.hitFaceIndex=void 0!==o?o:-1,this.mode){case l.ALL:this.hasHit=!0,h.set(n,r,t,i,e,s,a),h.hasHit=!0,this.callback(h);break;case l.CLOSEST:(a<h.distance||!h.hasHit)&&(this.hasHit=!0,h.hasHit=!0,h.set(n,r,t,i,e,s,a));break;case l.ANY:this.hasHit=!0,h.hasHit=!0,h.set(n,r,t,i,e,s,a),h._shouldStop=!0}};var B=new s,E=new s},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,i,e){var s=t("../math/Vec3");function o(){this.rayFromWorld=new s,this.rayToWorld=new s,this.hitNormalWorld=new s,this.hitPointWorld=new s,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}i.exports=o,o.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},o.prototype.abort=function(){this._shouldStop=!0},o.prototype.set=function(t,i,e,s,o,n,r){this.rayFromWorld.copy(t),this.rayToWorld.copy(i),this.hitNormalWorld.copy(e),this.hitPointWorld.copy(s),this.shape=o,this.body=n,this.distance=r}},{"../math/Vec3":30}],11:[function(t,i,e){t("../shapes/Shape");var s=t("../collision/Broadphase");function o(t){s.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(t){i.push(t.body)},this._removeBodyHandler=function(t){var e=i.indexOf(t.body);-1!==e&&i.splice(e,1)},t&&this.setWorld(t)}i.exports=o,o.prototype=new s,o.prototype.setWorld=function(t){this.axisList.length=0;for(var i=0;i<t.bodies.length;i++)this.axisList.push(t.bodies[i]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},o.insertionSortX=function(t){for(var i=1,e=t.length;i<e;i++){for(var s=t[i],o=i-1;o>=0&&!(t[o].aabb.lowerBound.x<=s.aabb.lowerBound.x);o--)t[o+1]=t[o];t[o+1]=s}return t},o.insertionSortY=function(t){for(var i=1,e=t.length;i<e;i++){for(var s=t[i],o=i-1;o>=0&&!(t[o].aabb.lowerBound.y<=s.aabb.lowerBound.y);o--)t[o+1]=t[o];t[o+1]=s}return t},o.insertionSortZ=function(t){for(var i=1,e=t.length;i<e;i++){for(var s=t[i],o=i-1;o>=0&&!(t[o].aabb.lowerBound.z<=s.aabb.lowerBound.z);o--)t[o+1]=t[o];t[o+1]=s}return t},o.prototype.collisionPairs=function(t,i,e){var s,n,r=this.axisList,a=r.length,h=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),s=0;s!==a;s++){var l=r[s];for(n=s+1;n<a;n++){var c=r[n];if(this.needBroadphaseCollision(l,c)){if(!o.checkBounds(l,c,h))break;this.intersectionTest(l,c,i,e)}}}},o.prototype.sortList=function(){for(var t=this.axisList,i=this.axisIndex,e=t.length,s=0;s!==e;s++){var n=t[s];n.aabbNeedsUpdate&&n.computeAABB()}0===i?o.insertionSortX(t):1===i?o.insertionSortY(t):2===i&&o.insertionSortZ(t)},o.checkBounds=function(t,i,e){var s,o;0===e?(s=t.position.x,o=i.position.x):1===e?(s=t.position.y,o=i.position.y):2===e&&(s=t.position.z,o=i.position.z);var n=t.boundingRadius,r=i.boundingRadius;return o-r<s+n},o.prototype.autoDetectAxis=function(){for(var t=0,i=0,e=0,s=0,o=0,n=0,r=this.axisList,a=r.length,h=1/a,l=0;l!==a;l++){var c=r[l],u=c.position.x;t+=u,i+=u*u;var p=c.position.y;e+=p,s+=p*p;var d=c.position.z;o+=d,n+=d*d}var m=i-t*t*h,y=s-e*e*h,f=n-o*o*h;this.axisIndex=m>y?m>f?0:2:y>f?1:2},o.prototype.aabbQuery=function(t,i,e){e=e||[],this.dirty&&(this.sortList(),this.dirty=!1);var s=this.axisIndex,o="x";1===s&&(o="y"),2===s&&(o="z");for(var n=this.axisList,r=(i.lowerBound[o],i.upperBound[o],0);r<n.length;r++){var a=n[r];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(i)&&e.push(a)}return e}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,i,e){i.exports=a,t("./Constraint");var s=t("./PointToPointConstraint"),o=t("../equations/ConeEquation"),n=t("../equations/RotationalEquation"),r=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,i,e){var a=void 0!==(e=e||{}).maxForce?e.maxForce:1e6,h=e.pivotA?e.pivotA.clone():new r,l=e.pivotB?e.pivotB.clone():new r;this.axisA=e.axisA?e.axisA.clone():new r,this.axisB=e.axisB?e.axisB.clone():new r,s.call(this,t,h,i,l,a),this.collideConnected=!!e.collideConnected,this.angle=void 0!==e.angle?e.angle:0;var c=this.coneEquation=new o(t,i,e),u=this.twistEquation=new n(t,i,e);this.twistAngle=void 0!==e.twistAngle?e.twistAngle:0,c.maxForce=0,c.minForce=-a,u.maxForce=0,u.minForce=-a,this.equations.push(c,u)}a.prototype=new s,a.constructor=a,new r,new r,a.prototype.update=function(){var t=this.bodyA,i=this.bodyB,e=this.coneEquation,o=this.twistEquation;s.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,e.axisA),i.vectorToWorldFrame(this.axisB,e.axisB),this.axisA.tangents(o.axisA,o.axisA),t.vectorToWorldFrame(o.axisA,o.axisA),this.axisB.tangents(o.axisB,o.axisB),i.vectorToWorldFrame(o.axisB,o.axisB),e.angle=this.angle,o.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,i,e){i.exports=o;var s=t("../utils/Utils");function o(t,i,e){e=s.defaults(e,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=i,this.id=o.idCounter++,this.collideConnected=e.collideConnected,e.wakeUpBodies&&(t&&t.wakeUp(),i&&i.wakeUp())}o.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},o.prototype.enable=function(){for(var t=this.equations,i=0;i<t.length;i++)t[i].enabled=!0},o.prototype.disable=function(){for(var t=this.equations,i=0;i<t.length;i++)t[i].enabled=!1},o.idCounter=0},{"../utils/Utils":53}],14:[function(t,i,e){i.exports=n;var s=t("./Constraint"),o=t("../equations/ContactEquation");function n(t,i,e,n){s.call(this,t,i),void 0===e&&(e=t.position.distanceTo(i.position)),void 0===n&&(n=1e6),this.distance=e;var r=this.distanceEquation=new o(t,i);this.equations.push(r),r.minForce=-n,r.maxForce=n}n.prototype=new s,n.prototype.update=function(){var t=this.bodyA,i=this.bodyB,e=this.distanceEquation,s=.5*this.distance,o=e.ni;i.position.vsub(t.position,o),o.normalize(),o.mult(s,e.ri),o.mult(-s,e.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,i,e){i.exports=a,t("./Constraint");var s=t("./PointToPointConstraint"),o=t("../equations/RotationalEquation"),n=t("../equations/RotationalMotorEquation"),r=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,i,e){var a=void 0!==(e=e||{}).maxForce?e.maxForce:1e6,h=e.pivotA?e.pivotA.clone():new r,l=e.pivotB?e.pivotB.clone():new r;s.call(this,t,h,i,l,a),(this.axisA=e.axisA?e.axisA.clone():new r(1,0,0)).normalize(),(this.axisB=e.axisB?e.axisB.clone():new r(1,0,0)).normalize();var c=this.rotationalEquation1=new o(t,i,e),u=this.rotationalEquation2=new o(t,i,e),p=this.motorEquation=new n(t,i,a);p.enabled=!1,this.equations.push(c,u,p)}a.prototype=new s,a.constructor=a,a.prototype.enableMotor=function(){this.motorEquation.enabled=!0},a.prototype.disableMotor=function(){this.motorEquation.enabled=!1},a.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},a.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var h=new r,l=new r;a.prototype.update=function(){var t=this.bodyA,i=this.bodyB,e=this.motorEquation,o=this.rotationalEquation1,n=this.rotationalEquation2,r=h,a=l,c=this.axisA,u=this.axisB;s.prototype.update.call(this),t.quaternion.vmult(c,r),i.quaternion.vmult(u,a),r.tangents(o.axisA,n.axisA),o.axisB.copy(a),n.axisB.copy(a),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,e.axisA),i.quaternion.vmult(this.axisB,e.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,i,e){i.exports=r,t("./Constraint");var s=t("./PointToPointConstraint"),o=t("../equations/RotationalEquation"),n=(t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation"),t("../math/Vec3"));function r(t,i,e){var r=void 0!==(e=e||{}).maxForce?e.maxForce:1e6,a=new n,h=new n,l=new n;t.position.vadd(i.position,l),l.scale(.5,l),i.pointToLocalFrame(l,h),t.pointToLocalFrame(l,a),s.call(this,t,a,i,h,r);var c=this.rotationalEquation1=new o(t,i,e),u=this.rotationalEquation2=new o(t,i,e),p=this.rotationalEquation3=new o(t,i,e);this.equations.push(c,u,p)}r.prototype=new s,r.constructor=r,new n,new n,r.prototype.update=function(){var t=this.bodyA,i=this.bodyB,e=(this.motorEquation,this.rotationalEquation1),o=this.rotationalEquation2,r=this.rotationalEquation3;s.prototype.update.call(this),t.vectorToWorldFrame(n.UNIT_X,e.axisA),i.vectorToWorldFrame(n.UNIT_Y,e.axisB),t.vectorToWorldFrame(n.UNIT_Y,o.axisA),i.vectorToWorldFrame(n.UNIT_Z,o.axisB),t.vectorToWorldFrame(n.UNIT_Z,r.axisA),i.vectorToWorldFrame(n.UNIT_X,r.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,i,e){i.exports=r;var s=t("./Constraint"),o=t("../equations/ContactEquation"),n=t("../math/Vec3");function r(t,i,e,r,a){s.call(this,t,e),a=void 0!==a?a:1e6,this.pivotA=i?i.clone():new n,this.pivotB=r?r.clone():new n;var h=this.equationX=new o(t,e),l=this.equationY=new o(t,e),c=this.equationZ=new o(t,e);this.equations.push(h,l,c),h.minForce=l.minForce=c.minForce=-a,h.maxForce=l.maxForce=c.maxForce=a,h.ni.set(1,0,0),l.ni.set(0,1,0),c.ni.set(0,0,1)}r.prototype=new s,r.prototype.update=function(){var t=this.bodyA,i=this.bodyB,e=this.equationX,s=this.equationY,o=this.equationZ;t.quaternion.vmult(this.pivotA,e.ri),i.quaternion.vmult(this.pivotB,e.rj),s.ri.copy(e.ri),s.rj.copy(e.rj),o.ri.copy(e.ri),o.rj.copy(e.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,i,e){i.exports=n;var s=t("../math/Vec3"),o=(t("../math/Mat3"),t("./Equation"));function n(t,i,e){var n=void 0!==(e=e||{}).maxForce?e.maxForce:1e6;o.call(this,t,i,-n,n),this.axisA=e.axisA?e.axisA.clone():new s(1,0,0),this.axisB=e.axisB?e.axisB.clone():new s(0,1,0),this.angle=void 0!==e.angle?e.angle:0}n.prototype=new o,n.prototype.constructor=n;var r=new s,a=new s;n.prototype.computeB=function(t){var i=this.a,e=this.b,s=this.axisA,o=this.axisB,n=r,h=a,l=this.jacobianElementA,c=this.jacobianElementB;return s.cross(o,n),o.cross(s,h),l.rotational.copy(h),c.rotational.copy(n),-(Math.cos(this.angle)-s.dot(o))*i-this.computeGW()*e-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,i,e){i.exports=n;var s=t("./Equation"),o=t("../math/Vec3");function n(t,i,e){e=void 0!==e?e:1e6,s.call(this,t,i,0,e),this.restitution=0,this.ri=new o,this.rj=new o,this.ni=new o}t("../math/Mat3"),n.prototype=new s,n.prototype.constructor=n;var r=new o,a=new o,h=new o;n.prototype.computeB=function(t){var i=this.a,e=this.b,s=this.bi,o=this.bj,n=this.ri,l=this.rj,c=r,u=a,p=s.velocity,d=s.angularVelocity,m=(s.force,s.torque,o.velocity),y=o.angularVelocity,f=(o.force,o.torque,h),v=this.jacobianElementA,x=this.jacobianElementB,b=this.ni;n.cross(b,c),l.cross(b,u),b.negate(v.spatial),c.negate(v.rotational),x.spatial.copy(b),x.rotational.copy(u),f.copy(o.position),f.vadd(l,f),f.vsub(s.position,f),f.vsub(n,f);var g=b.dot(f),w=this.restitution+1;return-g*i-(w*m.dot(b)-w*p.dot(b)+y.dot(u)-d.dot(c))*e-t*this.computeGiMf()};var l=new o,c=new o,u=new o,p=new o,d=new o;n.prototype.getImpactVelocityAlongNormal=function(){var t=l,i=c,e=u,s=p,o=d;return this.bi.position.vadd(this.ri,e),this.bj.position.vadd(this.rj,s),this.bi.getVelocityAtWorldPoint(e,t),this.bj.getVelocityAtWorldPoint(s,i),t.vsub(i,o),this.ni.dot(o)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,i,e){i.exports=n;var s=t("../math/JacobianElement"),o=t("../math/Vec3");function n(t,i,e,o){this.id=n.id++,this.minForce=void 0===e?-1e6:e,this.maxForce=void 0===o?1e6:o,this.bi=t,this.bj=i,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new s,this.jacobianElementB=new s,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}n.prototype.constructor=n,n.id=0,n.prototype.setSpookParams=function(t,i,e){var s=i,o=t,n=e;this.a=4/(n*(1+4*s)),this.b=4*s/(1+4*s),this.eps=4/(n*n*o*(1+4*s))},n.prototype.computeB=function(t,i,e){var s=this.computeGW();return-this.computeGq()*t-s*i-this.computeGiMf()*e},n.prototype.computeGq=function(){var t=this.jacobianElementA,i=this.jacobianElementB,e=this.bi,s=this.bj,o=e.position,n=s.position;return t.spatial.dot(o)+i.spatial.dot(n)};var r=new o;n.prototype.computeGW=function(){var t=this.jacobianElementA,i=this.jacobianElementB,e=this.bi,s=this.bj,o=e.velocity,n=s.velocity,a=e.angularVelocity||r,h=s.angularVelocity||r;return t.multiplyVectors(o,a)+i.multiplyVectors(n,h)},n.prototype.computeGWlambda=function(){var t=this.jacobianElementA,i=this.jacobianElementB,e=this.bi,s=this.bj,o=e.vlambda,n=s.vlambda,a=e.wlambda||r,h=s.wlambda||r;return t.multiplyVectors(o,a)+i.multiplyVectors(n,h)};var a=new o,h=new o,l=new o,c=new o;n.prototype.computeGiMf=function(){var t=this.jacobianElementA,i=this.jacobianElementB,e=this.bi,s=this.bj,o=e.force,n=e.torque,r=s.force,u=s.torque,p=e.invMassSolve,d=s.invMassSolve;return e.invInertiaWorldSolve?e.invInertiaWorldSolve.vmult(n,l):l.set(0,0,0),s.invInertiaWorldSolve?s.invInertiaWorldSolve.vmult(u,c):c.set(0,0,0),o.mult(p,a),r.mult(d,h),t.multiplyVectors(a,l)+i.multiplyVectors(h,c)};var u=new o;n.prototype.computeGiMGt=function(){var t=this.jacobianElementA,i=this.jacobianElementB,e=this.bi,s=this.bj,o=e.invMassSolve,n=s.invMassSolve,r=e.invInertiaWorldSolve,a=s.invInertiaWorldSolve,h=o+n;return r&&(r.vmult(t.rotational,u),h+=u.dot(t.rotational)),a&&(a.vmult(i.rotational,u),h+=u.dot(i.rotational)),h};var p=new o;new o,new o,new o,new o,new o,n.prototype.addToWlambda=function(t){var i=this.jacobianElementA,e=this.jacobianElementB,s=this.bi,o=this.bj,n=p;i.spatial.mult(s.invMassSolve*t,n),s.vlambda.vadd(n,s.vlambda),e.spatial.mult(o.invMassSolve*t,n),o.vlambda.vadd(n,o.vlambda),s.invInertiaWorldSolve&&(s.invInertiaWorldSolve.vmult(i.rotational,n),n.mult(t,n),s.wlambda.vadd(n,s.wlambda)),o.invInertiaWorldSolve&&(o.invInertiaWorldSolve.vmult(e.rotational,n),n.mult(t,n),o.wlambda.vadd(n,o.wlambda))},n.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,i,e){i.exports=n;var s=t("./Equation"),o=t("../math/Vec3");function n(t,i,e){s.call(this,t,i,-e,e),this.ri=new o,this.rj=new o,this.t=new o}t("../math/Mat3"),n.prototype=new s,n.prototype.constructor=n;var r=new o,a=new o;n.prototype.computeB=function(t){this.a;var i=this.b,e=(this.bi,this.bj,this.ri),s=this.rj,o=r,n=a,h=this.t;e.cross(h,o),s.cross(h,n);var l=this.jacobianElementA,c=this.jacobianElementB;return h.negate(l.spatial),o.negate(l.rotational),c.spatial.copy(h),c.rotational.copy(n),-this.computeGW()*i-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,i,e){i.exports=n;var s=t("../math/Vec3"),o=(t("../math/Mat3"),t("./Equation"));function n(t,i,e){var n=void 0!==(e=e||{}).maxForce?e.maxForce:1e6;o.call(this,t,i,-n,n),this.axisA=e.axisA?e.axisA.clone():new s(1,0,0),this.axisB=e.axisB?e.axisB.clone():new s(0,1,0),this.maxAngle=Math.PI/2}n.prototype=new o,n.prototype.constructor=n;var r=new s,a=new s;n.prototype.computeB=function(t){var i=this.a,e=this.b,s=this.axisA,o=this.axisB,n=r,h=a,l=this.jacobianElementA,c=this.jacobianElementB;return s.cross(o,n),o.cross(s,h),l.rotational.copy(h),c.rotational.copy(n),-(Math.cos(this.maxAngle)-s.dot(o))*i-this.computeGW()*e-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,i,e){i.exports=n;var s=t("../math/Vec3"),o=(t("../math/Mat3"),t("./Equation"));function n(t,i,e){e=void 0!==e?e:1e6,o.call(this,t,i,-e,e),this.axisA=new s,this.axisB=new s,this.targetVelocity=0}n.prototype=new o,n.prototype.constructor=n,n.prototype.computeB=function(t){this.a;var i=this.b,e=(this.bi,this.bj,this.axisA),s=this.axisB,o=this.jacobianElementA,n=this.jacobianElementB;return o.rotational.copy(e),s.negate(n.rotational),-(this.computeGW()-this.targetVelocity)*i-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,i,e){var s=t("../utils/Utils");function o(t,i,e){e=s.defaults(e,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=o.idCounter++,this.materials=[t,i],this.friction=e.friction,this.restitution=e.restitution,this.contactEquationStiffness=e.contactEquationStiffness,this.contactEquationRelaxation=e.contactEquationRelaxation,this.frictionEquationStiffness=e.frictionEquationStiffness,this.frictionEquationRelaxation=e.frictionEquationRelaxation}i.exports=o,o.idCounter=0},{"../utils/Utils":53}],25:[function(t,i,e){function s(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=s.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}i.exports=s,s.idCounter=0},{}],26:[function(t,i,e){i.exports=o;var s=t("./Vec3");function o(){this.spatial=new s,this.rotational=new s}o.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},o.prototype.multiplyVectors=function(t,i){return t.dot(this.spatial)+i.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,i,e){i.exports=o;var s=t("./Vec3");function o(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}o.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},o.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},o.prototype.setTrace=function(t){var i=this.elements;i[0]=t.x,i[4]=t.y,i[8]=t.z},o.prototype.getTrace=function(t){t=t||new s;var i=this.elements;t.x=i[0],t.y=i[4],t.z=i[8]},o.prototype.vmult=function(t,i){i=i||new s;var e=this.elements,o=t.x,n=t.y,r=t.z;return i.x=e[0]*o+e[1]*n+e[2]*r,i.y=e[3]*o+e[4]*n+e[5]*r,i.z=e[6]*o+e[7]*n+e[8]*r,i},o.prototype.smult=function(t){for(var i=0;i<this.elements.length;i++)this.elements[i]*=t},o.prototype.mmult=function(t,i){for(var e=i||new o,s=0;s<3;s++)for(var n=0;n<3;n++){for(var r=0,a=0;a<3;a++)r+=t.elements[s+3*a]*this.elements[a+3*n];e.elements[s+3*n]=r}return e},o.prototype.scale=function(t,i){i=i||new o;for(var e=this.elements,s=i.elements,n=0;3!==n;n++)s[3*n+0]=t.x*e[3*n+0],s[3*n+1]=t.y*e[3*n+1],s[3*n+2]=t.z*e[3*n+2];return i},o.prototype.solve=function(t,i){i=i||new s;for(var e,o=[],n=0;n<12;n++)o.push(0);for(n=0;n<3;n++)for(e=0;e<3;e++)o[n+4*e]=this.elements[n+3*e];o[3]=t.x,o[7]=t.y,o[11]=t.z;var r,a,h=3,l=h;do{if(0===o[(n=l-h)+4*n])for(e=n+1;e<l;e++)if(0!==o[n+4*e]){r=4;do{o[(a=4-r)+4*n]+=o[a+4*e]}while(--r);break}if(0!==o[n+4*n])for(e=n+1;e<l;e++){var c=o[n+4*e]/o[n+4*n];r=4;do{o[(a=4-r)+4*e]=a<=n?0:o[a+4*e]-o[a+4*n]*c}while(--r)}}while(--h);if(i.z=o[11]/o[10],i.y=(o[7]-o[6]*i.z)/o[5],i.x=(o[3]-o[2]*i.z-o[1]*i.y)/o[0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||i.x===1/0||i.y===1/0||i.z===1/0)throw"Could not solve equation! Got x=["+i.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return i},o.prototype.e=function(t,i,e){if(void 0===e)return this.elements[i+3*t];this.elements[i+3*t]=e},o.prototype.copy=function(t){for(var i=0;i<t.elements.length;i++)this.elements[i]=t.elements[i];return this},o.prototype.toString=function(){for(var t="",i=0;i<9;i++)t+=this.elements[i]+",";return t},o.prototype.reverse=function(t){t=t||new o;for(var i,e=[],s=0;s<18;s++)e.push(0);for(s=0;s<3;s++)for(i=0;i<3;i++)e[s+6*i]=this.elements[s+3*i];e[3]=1,e[9]=0,e[15]=0,e[4]=0,e[10]=1,e[16]=0,e[5]=0,e[11]=0,e[17]=1;var n,r,a=3,h=a;do{if(0===e[(s=h-a)+6*s])for(i=s+1;i<h;i++)if(0!==e[s+6*i]){n=6;do{e[(r=6-n)+6*s]+=e[r+6*i]}while(--n);break}if(0!==e[s+6*s])for(i=s+1;i<h;i++){var l=e[s+6*i]/e[s+6*s];n=6;do{e[(r=6-n)+6*i]=r<=s?0:e[r+6*i]-e[r+6*s]*l}while(--n)}}while(--a);s=2;do{i=s-1;do{l=e[s+6*i]/e[s+6*s],n=6;do{e[(r=6-n)+6*i]=e[r+6*i]-e[r+6*s]*l}while(--n)}while(i--)}while(--s);s=2;do{l=1/e[s+6*s],n=6;do{e[(r=6-n)+6*s]=e[r+6*s]*l}while(--n)}while(s--);s=2;do{i=2;do{if(r=e[3+i+6*s],isNaN(r)||r===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(s,i,r)}while(i--)}while(s--);return t},o.prototype.setRotationFromQuaternion=function(t){var i=t.x,e=t.y,s=t.z,o=t.w,n=i+i,r=e+e,a=s+s,h=i*n,l=i*r,c=i*a,u=e*r,p=e*a,d=s*a,m=o*n,y=o*r,f=o*a,v=this.elements;return v[0]=1-(u+d),v[1]=l-f,v[2]=c+y,v[3]=l+f,v[4]=1-(h+d),v[5]=p-m,v[6]=c-y,v[7]=p+m,v[8]=1-(h+u),this},o.prototype.transpose=function(t){for(var i=(t=t||new o).elements,e=this.elements,s=0;3!==s;s++)for(var n=0;3!==n;n++)i[3*s+n]=e[3*n+s];return t}},{"./Vec3":30}],28:[function(t,i,e){i.exports=o;var s=t("./Vec3");function o(t,i,e,s){this.x=void 0!==t?t:0,this.y=void 0!==i?i:0,this.z=void 0!==e?e:0,this.w=void 0!==s?s:1}o.prototype.set=function(t,i,e,s){this.x=t,this.y=i,this.z=e,this.w=s},o.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},o.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},o.prototype.setFromAxisAngle=function(t,i){var e=Math.sin(.5*i);this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=Math.cos(.5*i)},o.prototype.toAxisAngle=function(t){t=t||new s,this.normalize();var i=2*Math.acos(this.w),e=Math.sqrt(1-this.w*this.w);return e<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/e,t.y=this.y/e,t.z=this.z/e),[t,i]};var n=new s,r=new s;o.prototype.setFromVectors=function(t,i){if(t.isAntiparallelTo(i)){var e=n,s=r;t.tangents(e,s),this.setFromAxisAngle(e,Math.PI)}else{var o=t.cross(i);this.x=o.x,this.y=o.y,this.z=o.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(i.norm(),2))+t.dot(i),this.normalize()}};var a=new s,h=new s,l=new s;o.prototype.mult=function(t,i){i=i||new o;var e=this.w,s=a,n=h,r=l;return s.set(this.x,this.y,this.z),n.set(t.x,t.y,t.z),i.w=e*t.w-s.dot(n),s.cross(n,r),i.x=e*n.x+t.w*s.x+r.x,i.y=e*n.y+t.w*s.y+r.y,i.z=e*n.z+t.w*s.z+r.z,i},o.prototype.inverse=function(t){var i=this.x,e=this.y,s=this.z,n=this.w;t=t||new o,this.conjugate(t);var r=1/(i*i+e*e+s*s+n*n);return t.x*=r,t.y*=r,t.z*=r,t.w*=r,t},o.prototype.conjugate=function(t){return(t=t||new o).x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},o.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},o.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},o.prototype.vmult=function(t,i){i=i||new s;var e=t.x,o=t.y,n=t.z,r=this.x,a=this.y,h=this.z,l=this.w,c=l*e+a*n-h*o,u=l*o+h*e-r*n,p=l*n+r*o-a*e,d=-r*e-a*o-h*n;return i.x=c*l+d*-r+u*-h-p*-a,i.y=u*l+d*-a+p*-r-c*-h,i.z=p*l+d*-h+c*-a-u*-r,i},o.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},o.prototype.toEuler=function(t,i){var e,s,o;i=i||"YZX";var n=this.x,r=this.y,a=this.z,h=this.w;switch(i){case"YZX":var l=n*r+a*h;if(l>.499&&(e=2*Math.atan2(n,h),s=Math.PI/2,o=0),l<-.499&&(e=-2*Math.atan2(n,h),s=-Math.PI/2,o=0),isNaN(e)){var c=n*n,u=r*r,p=a*a;e=Math.atan2(2*r*h-2*n*a,1-2*u-2*p),s=Math.asin(2*l),o=Math.atan2(2*n*h-2*r*a,1-2*c-2*p)}break;default:throw new Error("Euler order "+i+" not supported yet.")}t.y=e,t.z=s,t.x=o},o.prototype.setFromEuler=function(t,i,e,s){s=s||"XYZ";var o=Math.cos(t/2),n=Math.cos(i/2),r=Math.cos(e/2),a=Math.sin(t/2),h=Math.sin(i/2),l=Math.sin(e/2);return"XYZ"===s?(this.x=a*n*r+o*h*l,this.y=o*h*r-a*n*l,this.z=o*n*l+a*h*r,this.w=o*n*r-a*h*l):"YXZ"===s?(this.x=a*n*r+o*h*l,this.y=o*h*r-a*n*l,this.z=o*n*l-a*h*r,this.w=o*n*r+a*h*l):"ZXY"===s?(this.x=a*n*r-o*h*l,this.y=o*h*r+a*n*l,this.z=o*n*l+a*h*r,this.w=o*n*r-a*h*l):"ZYX"===s?(this.x=a*n*r-o*h*l,this.y=o*h*r+a*n*l,this.z=o*n*l-a*h*r,this.w=o*n*r+a*h*l):"YZX"===s?(this.x=a*n*r+o*h*l,this.y=o*h*r+a*n*l,this.z=o*n*l-a*h*r,this.w=o*n*r-a*h*l):"XZY"===s&&(this.x=a*n*r-o*h*l,this.y=o*h*r-a*n*l,this.z=o*n*l+a*h*r,this.w=o*n*r+a*h*l),this},o.prototype.clone=function(){return new o(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,i,e){var s=t("./Vec3"),o=t("./Quaternion");function n(t){t=t||{},this.position=new s,t.position&&this.position.copy(t.position),this.quaternion=new o,t.quaternion&&this.quaternion.copy(t.quaternion)}i.exports=n;var r=new o;n.pointToLocalFrame=function(t,i,e,o){return o=o||new s,e.vsub(t,o),i.conjugate(r),r.vmult(o,o),o},n.prototype.pointToLocal=function(t,i){return n.pointToLocalFrame(this.position,this.quaternion,t,i)},n.pointToWorldFrame=function(t,i,e,o){return o=o||new s,i.vmult(e,o),o.vadd(t,o),o},n.prototype.pointToWorld=function(t,i){return n.pointToWorldFrame(this.position,this.quaternion,t,i)},n.prototype.vectorToWorldFrame=function(t,i){return i=i||new s,this.quaternion.vmult(t,i),i},n.vectorToWorldFrame=function(t,i,e){return t.vmult(i,e),e},n.vectorToLocalFrame=function(t,i,e,o){return o=o||new s,i.w*=-1,i.vmult(e,o),i.w*=-1,o}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,i,e){i.exports=o;var s=t("./Mat3");function o(t,i,e){this.x=t||0,this.y=i||0,this.z=e||0}o.ZERO=new o(0,0,0),o.UNIT_X=new o(1,0,0),o.UNIT_Y=new o(0,1,0),o.UNIT_Z=new o(0,0,1),o.prototype.cross=function(t,i){var e=t.x,s=t.y,n=t.z,r=this.x,a=this.y,h=this.z;return(i=i||new o).x=a*n-h*s,i.y=h*e-r*n,i.z=r*s-a*e,i},o.prototype.set=function(t,i,e){return this.x=t,this.y=i,this.z=e,this},o.prototype.setZero=function(){this.x=this.y=this.z=0},o.prototype.vadd=function(t,i){if(!i)return new o(this.x+t.x,this.y+t.y,this.z+t.z);i.x=t.x+this.x,i.y=t.y+this.y,i.z=t.z+this.z},o.prototype.vsub=function(t,i){if(!i)return new o(this.x-t.x,this.y-t.y,this.z-t.z);i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z},o.prototype.crossmat=function(){return new s([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},o.prototype.normalize=function(){var t=this.x,i=this.y,e=this.z,s=Math.sqrt(t*t+i*i+e*e);if(s>0){var o=1/s;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return s},o.prototype.unit=function(t){t=t||new o;var i=this.x,e=this.y,s=this.z,n=Math.sqrt(i*i+e*e+s*s);return n>0?(n=1/n,t.x=i*n,t.y=e*n,t.z=s*n):(t.x=1,t.y=0,t.z=0),t},o.prototype.norm=function(){var t=this.x,i=this.y,e=this.z;return Math.sqrt(t*t+i*i+e*e)},o.prototype.length=o.prototype.norm,o.prototype.norm2=function(){return this.dot(this)},o.prototype.lengthSquared=o.prototype.norm2,o.prototype.distanceTo=function(t){var i=this.x,e=this.y,s=this.z,o=t.x,n=t.y,r=t.z;return Math.sqrt((o-i)*(o-i)+(n-e)*(n-e)+(r-s)*(r-s))},o.prototype.distanceSquared=function(t){var i=this.x,e=this.y,s=this.z,o=t.x,n=t.y,r=t.z;return(o-i)*(o-i)+(n-e)*(n-e)+(r-s)*(r-s)},o.prototype.mult=function(t,i){i=i||new o;var e=this.x,s=this.y,n=this.z;return i.x=t*e,i.y=t*s,i.z=t*n,i},o.prototype.scale=o.prototype.mult,o.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},o.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},o.prototype.negate=function(t){return(t=t||new o).x=-this.x,t.y=-this.y,t.z=-this.z,t};var n=new o,r=new o;o.prototype.tangents=function(t,i){var e=this.norm();if(e>0){var s=n,o=1/e;s.set(this.x*o,this.y*o,this.z*o);var a=r;Math.abs(s.x)<.9?(a.set(1,0,0),s.cross(a,t)):(a.set(0,1,0),s.cross(a,t)),s.cross(t,i)}else t.set(1,0,0),i.set(0,1,0)},o.prototype.toString=function(){return this.x+","+this.y+","+this.z},o.prototype.toArray=function(){return[this.x,this.y,this.z]},o.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},o.prototype.lerp=function(t,i,e){var s=this.x,o=this.y,n=this.z;e.x=s+(t.x-s)*i,e.y=o+(t.y-o)*i,e.z=n+(t.z-n)*i},o.prototype.almostEquals=function(t,i){return void 0===i&&(i=1e-6),!(Math.abs(this.x-t.x)>i||Math.abs(this.y-t.y)>i||Math.abs(this.z-t.z)>i)},o.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)};var a=new o;o.prototype.isAntiparallelTo=function(t,i){return this.negate(a),a.almostEquals(t,i)},o.prototype.clone=function(){return new o(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,i,e){i.exports=l;var s=t("../utils/EventTarget"),o=(t("../shapes/Shape"),t("../math/Vec3")),n=t("../math/Mat3"),r=t("../math/Quaternion"),a=(t("../material/Material"),t("../collision/AABB")),h=t("../shapes/Box");function l(t){t=t||{},s.apply(this),this.id=l.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new o,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:1,this.collisionResponse=!0,this.position=new o,t.position&&this.position.copy(t.position),this.previousPosition=new o,this.initPosition=new o,this.velocity=new o,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new o,this.force=new o;var i="number"==typeof t.mass?t.mass:0;this.mass=i,this.invMass=i>0?1/i:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=i<=0?l.STATIC:l.DYNAMIC,typeof t.type==typeof l.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new o,this.quaternion=new r,t.quaternion&&this.quaternion.copy(t.quaternion),this.initQuaternion=new r,this.angularVelocity=new o,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new o,this.interpolatedPosition=new o,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new o,this.invInertia=new o,this.invInertiaWorld=new n,this.invMassSolve=0,this.invInertiaSolve=new o,this.invInertiaWorldSolve=new n,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.aabb=new a,this.aabbNeedsUpdate=!0,this.wlambda=new o,t.shape&&this.addShape(t.shape),this.updateMassProperties()}l.prototype=new s,l.prototype.constructor=l,l.DYNAMIC=1,l.STATIC=2,l.KINEMATIC=4,l.AWAKE=0,l.SLEEPY=1,l.SLEEPING=2,l.idCounter=0,l.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,t===l.SLEEPING&&this.dispatchEvent({type:"wakeup"})},l.prototype.sleep=function(){this.sleepState=l.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},l.sleepyEvent={type:"sleepy"},l.sleepEvent={type:"sleep"},l.prototype.sleepTick=function(t){if(this.allowSleep){var i=this.sleepState,e=this.velocity.norm2()+this.angularVelocity.norm2(),s=Math.pow(this.sleepSpeedLimit,2);i===l.AWAKE&&e<s?(this.sleepState=l.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(l.sleepyEvent)):i===l.SLEEPY&&e>s?this.wakeUp():i===l.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(l.sleepEvent))}},l.prototype.updateSolveMassProperties=function(){this.sleepState===l.SLEEPING||this.type===l.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},l.prototype.pointToLocalFrame=function(t,i){return i=i||new o,t.vsub(this.position,i),this.quaternion.conjugate().vmult(i,i),i},l.prototype.vectorToLocalFrame=function(t,i){return i=i||new o,this.quaternion.conjugate().vmult(t,i),i},l.prototype.pointToWorldFrame=function(t,i){return i=i||new o,this.quaternion.vmult(t,i),i.vadd(this.position,i),i},l.prototype.vectorToWorldFrame=function(t,i){return i=i||new o,this.quaternion.vmult(t,i),i};var c=new o,u=new r;l.prototype.addShape=function(t,i,e){var s=new o,n=new r;return i&&s.copy(i),e&&n.copy(e),this.shapes.push(t),this.shapeOffsets.push(s),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},l.prototype.updateBoundingRadius=function(){for(var t=this.shapes,i=this.shapeOffsets,e=t.length,s=0,o=0;o!==e;o++){var n=t[o];n.updateBoundingSphereRadius();var r=i[o].norm(),a=n.boundingSphereRadius;r+a>s&&(s=r+a)}this.boundingRadius=s};var p=new a;l.prototype.computeAABB=function(){for(var t=this.shapes,i=this.shapeOffsets,e=this.shapeOrientations,s=t.length,o=c,n=u,r=this.quaternion,a=this.aabb,h=p,l=0;l!==s;l++){var d=t[l];e[l].mult(r,n),n.vmult(i[l],o),o.vadd(this.position,o),d.calculateWorldAABB(o,n,h.lowerBound,h.upperBound),0===l?a.copy(h):a.extend(h)}this.aabbNeedsUpdate=!1};var d=new n,m=new n;new n,l.prototype.updateInertiaWorld=function(t){var i=this.invInertia;if(i.x!==i.y||i.y!==i.z||t){var e=d,s=m;e.setRotationFromQuaternion(this.quaternion),e.transpose(s),e.scale(i,e),e.mmult(s,this.invInertiaWorld)}};var y=new o,f=new o;l.prototype.applyForce=function(t,i){if(this.type===l.DYNAMIC){var e=y;i.vsub(this.position,e);var s=f;e.cross(t,s),this.force.vadd(t,this.force),this.torque.vadd(s,this.torque)}};var v=new o,x=new o;l.prototype.applyLocalForce=function(t,i){if(this.type===l.DYNAMIC){var e=v,s=x;this.vectorToWorldFrame(t,e),this.pointToWorldFrame(i,s),this.applyForce(e,s)}};var b=new o,g=new o,w=new o;l.prototype.applyImpulse=function(t,i){if(this.type===l.DYNAMIC){var e=b;i.vsub(this.position,e);var s=g;s.copy(t),s.mult(this.invMass,s),this.velocity.vadd(s,this.velocity);var o=w;e.cross(t,o),this.invInertiaWorld.vmult(o,o),this.angularVelocity.vadd(o,this.angularVelocity)}};var z=new o,N=new o;l.prototype.applyLocalImpulse=function(t,i){if(this.type===l.DYNAMIC){var e=z,s=N;this.vectorToWorldFrame(t,e),this.pointToWorldFrame(i,s),this.applyImpulse(e,s)}};var S=new o;l.prototype.updateMassProperties=function(){var t=S;this.invMass=this.mass>0?1/this.mass:0;var i=this.inertia,e=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),h.calculateInertia(t,this.mass,i),this.invInertia.set(i.x>0&&!e?1/i.x:0,i.y>0&&!e?1/i.y:0,i.z>0&&!e?1/i.z:0),this.updateInertiaWorld(!0)},l.prototype.getVelocityAtWorldPoint=function(t,i){var e=new o;return t.vsub(this.position,e),this.angularVelocity.cross(e,i),this.velocity.vadd(i,i),i}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,i,e){t("./Body");var s=t("../math/Vec3"),o=t("../math/Quaternion"),n=(t("../collision/RaycastResult"),t("../collision/Ray")),r=t("../objects/WheelInfo");function a(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2}i.exports=a,new s,new s,new s;var h=new s,l=new s,c=new s;new n,a.prototype.addWheel=function(t){var i=new r(t=t||{}),e=this.wheelInfos.length;return this.wheelInfos.push(i),e},a.prototype.setSteeringValue=function(t,i){this.wheelInfos[i].steering=t},new s,a.prototype.applyEngineForce=function(t,i){this.wheelInfos[i].engineForce=t},a.prototype.setBrake=function(t,i){this.wheelInfos[i].brake=t},a.prototype.addToWorld=function(t){this.constraints,t.add(this.chassisBody);var i=this;this.preStepCallback=function(){i.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},a.prototype.getVehicleAxisWorld=function(t,i){i.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(i,i)},a.prototype.updateVehicle=function(t){for(var i=this.wheelInfos,e=i.length,o=this.chassisBody,n=0;n<e;n++)this.updateWheelTransform(n);this.currentVehicleSpeedKmHour=3.6*o.velocity.norm();var r=new s;for(this.getVehicleAxisWorld(this.indexForwardAxis,r),r.dot(o.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),n=0;n<e;n++)this.castRay(i[n]);this.updateSuspension(t);var a=new s,h=new s;for(n=0;n<e;n++){var l=(d=i[n]).suspensionForce;l>d.maxSuspensionForce&&(l=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(l*t,a),d.raycastResult.hitPointWorld.vsub(o.position,h),o.applyImpulse(a,d.raycastResult.hitPointWorld)}this.updateFriction(t);var c=new s,u=new s,p=new s;for(n=0;n<e;n++){var d=i[n];o.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,p);var m=1;switch(this.indexUpAxis){case 1:m=-1}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var y=u.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(y,c),u.vsub(c,u);var f=u.dot(p);d.deltaRotation=m*f*t/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(d.engineForce>0?1:-1)*d.customSlidingRotationalSpeed*t),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},a.prototype.updateSuspension=function(t){for(var i=this.chassisBody.mass,e=this.wheelInfos,s=e.length,o=0;o<s;o++){var n=e[o];if(n.isInContact){var r,a=n.suspensionRestLength-n.suspensionLength;r=n.suspensionStiffness*a*n.clippedInvContactDotSuspension;var h=n.suspensionRelativeVelocity;r-=(h<0?n.dampingCompression:n.dampingRelaxation)*h,n.suspensionForce=r*i,n.suspensionForce<0&&(n.suspensionForce=0)}else n.suspensionForce=0}},a.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new s,p=new s;a.prototype.castRay=function(t){var i=u,e=p;this.updateWheelTransformWorld(t);var o=this.chassisBody,n=-1,r=t.suspensionRestLength+t.radius;t.directionWorld.scale(r,i);var a=t.chassisConnectionPointWorld;a.vadd(i,e);var h=t.raycastResult;h.reset();var l=o.collisionResponse;o.collisionResponse=!1,this.world.rayTest(a,e,h),o.collisionResponse=l;var c=h.body;if(t.raycastResult.groundObject=0,c){n=h.distance,t.raycastResult.hitNormalWorld=h.hitNormalWorld,t.isInContact=!0;var d=h.distance;t.suspensionLength=d-t.radius;var m=t.suspensionRestLength-t.maxSuspensionTravel,y=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<m&&(t.suspensionLength=m),t.suspensionLength>y&&(t.suspensionLength=y,t.raycastResult.reset());var f=t.raycastResult.hitNormalWorld.dot(t.directionWorld),v=new s;o.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,v);var x=t.raycastResult.hitNormalWorld.dot(v);if(f>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var b=-1/f;t.suspensionRelativeVelocity=x*b,t.clippedInvContactDotSuspension=b}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return n},a.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var i=this.chassisBody;i.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),i.vectorToWorldFrame(t.directionLocal,t.directionWorld),i.vectorToWorldFrame(t.axleLocal,t.axleWorld)},a.prototype.updateWheelTransform=function(t){var i=h,e=l,s=c,n=this.wheelInfos[t];this.updateWheelTransformWorld(n),n.directionLocal.scale(-1,i),e.copy(n.axleLocal),i.cross(e,s),s.normalize(),e.normalize();var r=n.steering,a=new o;a.setFromAxisAngle(i,r);var u=new o;u.setFromAxisAngle(e,n.rotation);var p=n.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,p),p.mult(u,p),p.normalize();var d=n.worldTransform.position;d.copy(n.directionWorld),d.scale(n.suspensionLength,d),d.vadd(n.chassisConnectionPointWorld,d)};var d=[new s(1,0,0),new s(0,1,0),new s(0,0,1)];a.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var m=new s,y=[],f=[];a.prototype.updateFriction=function(t){for(var i=m,e=this.wheelInfos,o=e.length,n=this.chassisBody,r=f,a=y,h=0;h<o;h++)p=(P=e[h]).raycastResult.body,P.sideImpulse=0,P.forwardImpulse=0,r[h]||(r[h]=new s),a[h]||(a[h]=new s);for(h=0;h<o;h++)if(p=(P=e[h]).raycastResult.body){var l=a[h];this.getWheelTransformWorld(h).vectorToWorldFrame(d[this.indexRightAxis],l);var c=P.raycastResult.hitNormalWorld,u=l.dot(c);c.scale(u,i),l.vsub(i,l),l.normalize(),c.cross(l,r[h]),r[h].normalize(),P.sideImpulse=V(n,P.raycastResult.hitPointWorld,p,P.raycastResult.hitPointWorld,l),P.sideImpulse*=1}for(this.sliding=!1,h=0;h<o;h++){var p=(P=e[h]).raycastResult.body,v=0;if(P.slipInfo=1,p){var x=P.brake?P.brake:0;v=g(n,p,P.raycastResult.hitPointWorld,r[h],x);var b=x/(v+=P.engineForce*t);P.slipInfo*=b}if(P.forwardImpulse=0,P.skidInfo=1,p){P.skidInfo=1;var w=P.suspensionForce*t*P.frictionSlip,z=w*w;P.forwardImpulse=v;var N=.5*P.forwardImpulse,S=1*P.sideImpulse,M=N*N+S*S;P.sliding=!1,M>z&&(this.sliding=!0,P.sliding=!0,b=w/Math.sqrt(M),P.skidInfo*=b)}}if(this.sliding)for(h=0;h<o;h++)0!==(P=e[h]).sideImpulse&&P.skidInfo<1&&(P.forwardImpulse*=P.skidInfo,P.sideImpulse*=P.skidInfo);for(h=0;h<o;h++){var P=e[h],k=new s;if(k.copy(P.raycastResult.hitPointWorld),0!==P.forwardImpulse){var A=new s;r[h].scale(P.forwardImpulse,A),n.applyImpulse(A,k)}if(0!==P.sideImpulse){p=P.raycastResult.body;var T=new s;T.copy(P.raycastResult.hitPointWorld);var I=new s;a[h].scale(P.sideImpulse,I),n.pointToLocalFrame(k,k),k["xyz"[this.indexUpAxis]]*=P.rollInfluence,n.pointToWorldFrame(k,k),n.applyImpulse(I,k),I.scale(-1,I),p.applyImpulse(I,T)}}};var v=new s,x=new s,b=new s;function g(t,i,e,s,o){var n=0,r=e,a=v,h=x,l=b;return t.getVelocityAtWorldPoint(r,a),i.getVelocityAtWorldPoint(r,h),a.vsub(h,l),o<(n=-s.dot(l)*(1/(M(t,e,s)+M(i,e,s))))&&(n=o),n<-o&&(n=-o),n}var w=new s,z=new s,N=new s,S=new s;function M(t,i,e){var s=w,o=z,n=N,r=S;return i.vsub(t.position,s),s.cross(e,o),t.invInertiaWorld.vmult(o,r),r.cross(s,n),t.invMass+e.dot(n)}var P=new s,k=new s,A=new s;function V(t,i,e,s,o,n){if(o.norm2()>1.1)return 0;var r=P,a=k,h=A;return t.getVelocityAtWorldPoint(i,r),e.getVelocityAtWorldPoint(s,a),r.vsub(a,h),-.2*o.dot(h)*(1/(t.invMass+e.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,i,e){var s=t("./Body"),o=t("../shapes/Sphere"),n=t("../shapes/Box"),r=t("../math/Vec3"),a=t("../constraints/HingeConstraint");function h(t){if(this.wheelBodies=[],this.coordinateSystem=void 0===t.coordinateSystem?new r(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var i=new n(new r(5,2,.5));this.chassisBody=new s(1,i)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}i.exports=h,h.prototype.addWheel=function(t){var i=(t=t||{}).body;i||(i=new s(1,new o(1.2))),this.wheelBodies.push(i),this.wheelForces.push(0),new r;var e=void 0!==t.position?t.position.clone():new r,n=new r;this.chassisBody.pointToWorldFrame(e,n),i.position.set(n.x,n.y,n.z);var h=void 0!==t.axis?t.axis.clone():new r(0,1,0);this.wheelAxes.push(h);var l=new a(this.chassisBody,i,{pivotA:e,axisA:h,pivotB:r.ZERO,axisB:h,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},h.prototype.setSteeringValue=function(t,i){var e=this.wheelAxes[i],s=Math.cos(t),o=Math.sin(t),n=e.x,r=e.y;this.constraints[i].axisA.set(s*n-o*r,o*n+s*r,0)},h.prototype.setMotorSpeed=function(t,i){var e=this.constraints[i];e.enableMotor(),e.motorTargetVelocity=t},h.prototype.disableMotor=function(t){this.constraints[t].disableMotor()};var l=new r;h.prototype.setWheelForce=function(t,i){this.wheelForces[i]=t},h.prototype.applyWheelForce=function(t,i){var e=this.wheelAxes[i],s=this.wheelBodies[i],o=s.torque;e.scale(t,l),s.vectorToWorldFrame(l,l),o.vadd(l,o)},h.prototype.addToWorld=function(t){for(var i=this.constraints,e=this.wheelBodies.concat([this.chassisBody]),s=0;s<e.length;s++)t.add(e[s]);for(s=0;s<i.length;s++)t.addConstraint(i[s]);t.addEventListener("preStep",this._update.bind(this))},h.prototype._update=function(){for(var t=this.wheelForces,i=0;i<t.length;i++)this.applyWheelForce(t[i],i)},h.prototype.removeFromWorld=function(t){for(var i=this.constraints,e=this.wheelBodies.concat([this.chassisBody]),s=0;s<e.length;s++)t.remove(e[s]);for(s=0;s<i.length;s++)t.removeConstraint(i[s])};var c=new r;h.prototype.getWheelSpeed=function(t){var i=this.wheelAxes[t],e=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(i,c),e.dot(c)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,i,e){i.exports=o,t("../shapes/Shape");var s=t("../math/Vec3");function o(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),o.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},o.prototype.remove=function(t){var i=this.particles.indexOf(t);-1!==i&&(this.particles.splice(i,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var n=new s;o.prototype.getNeighbors=function(t,i){for(var e=this.particles.length,s=t.id,o=this.smoothingRadius*this.smoothingRadius,r=n,a=0;a!==e;a++){var h=this.particles[a];h.position.vsub(t.position,r),s!==h.id&&r.norm2()<o&&i.push(h)}};var r=new s,a=new s,h=new s,l=new s,c=new s,u=new s;o.prototype.update=function(){for(var t=this.particles.length,i=r,e=this.speedOfSound,s=this.eps,o=0;o!==t;o++){var n=this.particles[o];(S=this.neighbors[o]).length=0,this.getNeighbors(n,S),S.push(this.particles[o]);for(var p=S.length,d=0,m=0;m!==p;m++){n.position.vsub(S[m].position,i);var y=i.norm(),f=this.w(y);d+=S[m].mass*f}this.densities[o]=d,this.pressures[o]=e*e*(this.densities[o]-this.density)}var v=a,x=h,b=l,g=c,w=u;for(o=0;o!==t;o++){var z,N,S,M=this.particles[o];for(v.set(0,0,0),x.set(0,0,0),p=(S=this.neighbors[o]).length,m=0;m!==p;m++){var P=S[m];M.position.vsub(P.position,g);var k=g.norm();z=-P.mass*(this.pressures[o]/(this.densities[o]*this.densities[o]+s)+this.pressures[m]/(this.densities[m]*this.densities[m]+s)),this.gradw(g,b),b.mult(z,b),v.vadd(b,v),P.velocity.vsub(M.velocity,w),w.mult(1/(1e-4+this.densities[o]*this.densities[m])*this.viscosity*P.mass,w),N=this.nablaw(k),w.mult(N,w),x.vadd(w,x)}x.mult(M.mass,x),v.mult(M.mass,v),M.force.vadd(x,M.force),M.force.vadd(v,M.force)}},o.prototype.w=function(t){var i=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(i,9))*Math.pow(i*i-t*t,3)},o.prototype.gradw=function(t,i){var e=t.norm(),s=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(s,9))*Math.pow(s*s-e*e,2),i)},o.prototype.nablaw=function(t){var i=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(i,9))*(i*i-t*t)*(7*t*t-3*i*i)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,i,e){var s=t("../math/Vec3");function o(t,i,e){e=e||{},this.restLength="number"==typeof e.restLength?e.restLength:1,this.stiffness=e.stiffness||100,this.damping=e.damping||1,this.bodyA=t,this.bodyB=i,this.localAnchorA=new s,this.localAnchorB=new s,e.localAnchorA&&this.localAnchorA.copy(e.localAnchorA),e.localAnchorB&&this.localAnchorB.copy(e.localAnchorB),e.worldAnchorA&&this.setWorldAnchorA(e.worldAnchorA),e.worldAnchorB&&this.setWorldAnchorB(e.worldAnchorB)}i.exports=o,o.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},o.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},o.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},o.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var n=new s,r=new s,a=new s,h=new s,l=new s,c=new s,u=new s,p=new s,d=new s,m=new s,y=new s;o.prototype.applyForce=function(){var t=this.stiffness,i=this.damping,e=this.restLength,s=this.bodyA,o=this.bodyB,f=n,v=r,x=a,b=h,g=y,w=l,z=c,N=u,S=p,M=d,P=m;this.getWorldAnchorA(w),this.getWorldAnchorB(z),w.vsub(s.position,N),z.vsub(o.position,S),z.vsub(w,f);var k=f.norm();v.copy(f),v.normalize(),o.velocity.vsub(s.velocity,x),o.angularVelocity.cross(S,g),x.vadd(g,x),s.angularVelocity.cross(N,g),x.vsub(g,x),v.mult(-t*(k-e)-i*x.dot(v),b),s.force.vsub(b,s.force),o.force.vadd(b,o.force),N.cross(b,M),S.cross(b,P),s.torque.vsub(M,s.torque),o.torque.vadd(P,o.torque)}},{"../math/Vec3":30}],36:[function(t,i,e){var s=t("../math/Vec3"),o=t("../math/Transform"),n=t("../collision/RaycastResult"),r=t("../utils/Utils");function a(t){t=r.defaults(t,{chassisConnectionPointLocal:new s,chassisConnectionPointWorld:new s,directionLocal:new s,directionWorld:new s,axleLocal:new s,axleWorld:new s,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new n,this.worldTransform=new o,this.isInContact=!1}i.exports=a;var h=new s,l=new s;h=new s,a.prototype.updateWheel=function(t){var i=this.raycastResult;if(this.isInContact){var e=i.hitNormalWorld.dot(i.directionWorld);i.hitPointWorld.vsub(t.position,l),t.getVelocityAtWorldPoint(l,h);var s=i.hitNormalWorld.dot(h);if(e>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var o=-1/e;this.suspensionRelativeVelocity=s*o,this.clippedInvContactDotSuspension=o}}else i.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,i.directionWorld.scale(-1,i.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,i,e){i.exports=r;var s=t("./Shape"),o=t("../math/Vec3"),n=t("./ConvexPolyhedron");function r(t){s.call(this),this.type=s.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new s,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,e=this.halfExtents.z,s=o,r=[new s(-t,-i,-e),new s(t,-i,-e),new s(t,i,-e),new s(-t,i,-e),new s(-t,-i,e),new s(t,-i,e),new s(t,i,e),new s(-t,i,e)],a=(new s(0,0,1),new s(0,1,0),new s(1,0,0),new n(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));this.convexPolyhedronRepresentation=a,a.material=this.material},r.prototype.calculateLocalInertia=function(t,i){return i=i||new o,r.calculateInertia(this.halfExtents,t,i),i},r.calculateInertia=function(t,i,e){var s=t;e.x=1/12*i*(2*s.y*2*s.y+2*s.z*2*s.z),e.y=1/12*i*(2*s.x*2*s.x+2*s.z*2*s.z),e.z=1/12*i*(2*s.y*2*s.y+2*s.x*2*s.x)},r.prototype.getSideNormals=function(t,i){var e=t,s=this.halfExtents;if(e[0].set(s.x,0,0),e[1].set(0,s.y,0),e[2].set(0,0,s.z),e[3].set(-s.x,0,0),e[4].set(0,-s.y,0),e[5].set(0,0,-s.z),void 0!==i)for(var o=0;o!==e.length;o++)i.vmult(e[o],e[o]);return e},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new o;new o,r.prototype.forEachWorldCorner=function(t,i,e){for(var s=this.halfExtents,o=[[s.x,s.y,s.z],[-s.x,s.y,s.z],[-s.x,-s.y,s.z],[-s.x,-s.y,-s.z],[s.x,-s.y,-s.z],[s.x,s.y,-s.z],[-s.x,s.y,-s.z],[s.x,-s.y,s.z]],n=0;n<o.length;n++)a.set(o[n][0],o[n][1],o[n][2]),i.vmult(a,a),t.vadd(a,a),e(a.x,a.y,a.z)};var h=[new o,new o,new o,new o,new o,new o,new o,new o];r.prototype.calculateWorldAABB=function(t,i,e,s){var o=this.halfExtents;h[0].set(o.x,o.y,o.z),h[1].set(-o.x,o.y,o.z),h[2].set(-o.x,-o.y,o.z),h[3].set(-o.x,-o.y,-o.z),h[4].set(o.x,-o.y,-o.z),h[5].set(o.x,o.y,-o.z),h[6].set(-o.x,o.y,-o.z),h[7].set(o.x,-o.y,o.z);var n=h[0];i.vmult(n,n),t.vadd(n,n),s.copy(n),e.copy(n);for(var r=1;r<8;r++){n=h[r],i.vmult(n,n),t.vadd(n,n);var a=n.x,l=n.y,c=n.z;a>s.x&&(s.x=a),l>s.y&&(s.y=l),c>s.z&&(s.z=c),a<e.x&&(e.x=a),l<e.y&&(e.y=l),c<e.z&&(e.z=c)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,i,e){i.exports=r;var s=t("./Shape"),o=t("../math/Vec3"),n=(t("../math/Quaternion"),t("../math/Transform"));function r(t,i,e){s.call(this),this.type=s.types.CONVEXPOLYHEDRON,this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=e?e.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new s,r.prototype.constructor=r;var a=new o;r.prototype.computeEdges=function(){var t=this.faces,i=this.vertices,e=(i.length,this.uniqueEdges);e.length=0;for(var s=a,o=0;o!==t.length;o++)for(var n=t[o],r=n.length,h=0;h!==r;h++){var l=(h+1)%r;i[n[h]].vsub(i[n[l]],s),s.normalize();for(var c=!1,u=0;u!==e.length;u++)if(e[u].almostEquals(s)||e[u].almostEquals(s)){c=!0;break}c||e.push(s.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var i=0;i<this.faces[t].length;i++)if(!this.vertices[this.faces[t][i]])throw new Error("Vertex "+this.faces[t][i]+" not found!");var e=this.faceNormals[t]||new o;this.getFaceNormal(t,e),e.negate(e),this.faceNormals[t]=e;var s=this.vertices[this.faces[t][0]];if(e.dot(s)<0)for(console.error(".faceNormals["+t+"] = Vec3("+e.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),i=0;i<this.faces[t].length;i++)console.warn(".vertices["+this.faces[t][i]+"] = Vec3("+this.vertices[this.faces[t][i]].toString()+")")}};var h=new o,l=new o;r.computeNormal=function(t,i,e,s){i.vsub(t,l),e.vsub(i,h),h.cross(l,s),s.isZero()||s.normalize()},r.prototype.getFaceNormal=function(t,i){var e=this.faces[t],s=this.vertices[e[0]],o=this.vertices[e[1]],n=this.vertices[e[2]];return r.computeNormal(s,o,n,i)};var c=new o;r.prototype.clipAgainstHull=function(t,i,e,s,n,r,a,h,l){for(var u=c,p=-1,d=-Number.MAX_VALUE,m=0;m<e.faces.length;m++){u.copy(e.faceNormals[m]),n.vmult(u,u);var y=u.dot(r);y>d&&(d=y,p=m)}for(var f=[],v=e.faces[p],x=v.length,b=0;b<x;b++){var g=e.vertices[v[b]],w=new o;w.copy(g),n.vmult(w,w),s.vadd(w,w),f.push(w)}p>=0&&this.clipFaceAgainstHull(r,t,i,f,a,h,l)};var u=new o,p=new o,d=new o,m=new o,y=new o,f=new o;r.prototype.findSeparatingAxis=function(t,i,e,s,o,n,r,a){var h=u,l=p,c=d,v=m,x=y,b=f,g=Number.MAX_VALUE;if(this.uniqueAxes)for(z=0;z!==this.uniqueAxes.length;z++){if(e.vmult(this.uniqueAxes[z],h),!1===(M=this.testSepAxis(h,t,i,e,s,o)))return!1;M<g&&(g=M,n.copy(h))}else for(var w=r?r.length:this.faces.length,z=0;z<w;z++){var N=r?r[z]:z;if(h.copy(this.faceNormals[N]),e.vmult(h,h),!1===(M=this.testSepAxis(h,t,i,e,s,o)))return!1;M<g&&(g=M,n.copy(h))}if(t.uniqueAxes)for(z=0;z!==t.uniqueAxes.length;z++){if(o.vmult(t.uniqueAxes[z],l),!1===(M=this.testSepAxis(l,t,i,e,s,o)))return!1;M<g&&(g=M,n.copy(l))}else for(var S=a?a.length:t.faces.length,z=0;z<S;z++){var M;if(N=a?a[z]:z,l.copy(t.faceNormals[N]),o.vmult(l,l),!1===(M=this.testSepAxis(l,t,i,e,s,o)))return!1;M<g&&(g=M,n.copy(l))}for(var P=0;P!==this.uniqueEdges.length;P++){e.vmult(this.uniqueEdges[P],v);for(var k=0;k!==t.uniqueEdges.length;k++)if(o.vmult(t.uniqueEdges[k],x),v.cross(x,b),!b.almostZero()){b.normalize();var A=this.testSepAxis(b,t,i,e,s,o);if(!1===A)return!1;A<g&&(g=A,n.copy(b))}}return s.vsub(i,c),c.dot(n)>0&&n.negate(n),!0};var v=[],x=[];r.prototype.testSepAxis=function(t,i,e,s,o,n){r.project(this,t,e,s,v),r.project(i,t,o,n,x);var a=v[0],h=v[1],l=x[0],c=x[1];if(a<c||l<h)return!1;var u=a-c,p=l-h;return u<p?u:p};var b=new o,g=new o;r.prototype.calculateLocalInertia=function(t,i){this.computeLocalAABB(b,g);var e=g.x-b.x,s=g.y-b.y,o=g.z-b.z;i.x=1/12*t*(2*s*2*s+2*o*2*o),i.y=1/12*t*(2*e*2*e+2*o*2*o),i.z=1/12*t*(2*s*2*s+2*e*2*e)},r.prototype.getPlaneConstantOfFace=function(t){var i=this.faces[t],e=this.faceNormals[t],s=this.vertices[i[0]];return-e.dot(s)};var w=new o,z=new o,N=new o,S=new o,M=new o,P=new o,k=new o,A=new o;r.prototype.clipFaceAgainstHull=function(t,i,e,s,o,n,r){for(var a=w,h=z,l=N,c=S,u=M,p=P,d=k,m=A,y=s,f=[],v=-1,x=Number.MAX_VALUE,b=0;b<this.faces.length;b++){a.copy(this.faceNormals[b]),e.vmult(a,a);var g=a.dot(t);g<x&&(x=g,v=b)}if(!(v<0)){var V=this.faces[v];V.connectedFaces=[];for(var T=0;T<this.faces.length;T++)for(var I=0;I<this.faces[T].length;I++)-1!==V.indexOf(this.faces[T][I])&&T!==v&&-1===V.connectedFaces.indexOf(T)&&V.connectedFaces.push(T);y.length;for(var L=V.length,C=0;C<L;C++){var B=this.vertices[V[C]],E=this.vertices[V[(C+1)%L]];B.vsub(E,h),l.copy(h),e.vmult(l,l),i.vadd(l,l),c.copy(this.faceNormals[v]),e.vmult(c,c),i.vadd(c,c),l.cross(c,u),u.negate(u),p.copy(B),e.vmult(p,p),i.vadd(p,p),p.dot(u);var R=V.connectedFaces[C];d.copy(this.faceNormals[R]);var F=this.getPlaneConstantOfFace(R);m.copy(d),e.vmult(m,m);var q=F-m.dot(i);for(this.clipFaceAgainstPlane(y,f,m,q);y.length;)y.shift();for(;f.length;)y.push(f.shift())}for(d.copy(this.faceNormals[v]),F=this.getPlaneConstantOfFace(v),m.copy(d),e.vmult(m,m),q=F-m.dot(i),T=0;T<y.length;T++){var j=m.dot(y[T])+q;if(j<=o&&(console.log("clamped: depth="+j+" to minDist="+o),j=o),j<=n){var O=y[T];if(j<=0){var D={point:O,normal:m,depth:j};r.push(D)}}}}},r.prototype.clipFaceAgainstPlane=function(t,i,e,s){var n,r,a=t.length;if(a<2)return i;var h=t[t.length-1],l=t[0];n=e.dot(h)+s;for(var c=0;c<a;c++){if(l=t[c],r=e.dot(l)+s,n<0)if(r<0)(u=new o).copy(l),i.push(u);else{var u=new o;h.lerp(l,n/(n-r),u),i.push(u)}else r<0&&(u=new o,h.lerp(l,n/(n-r),u),i.push(u),i.push(l));h=l,n=r}return i},r.prototype.computeWorldVertices=function(t,i){for(var e=this.vertices.length;this.worldVertices.length<e;)this.worldVertices.push(new o);for(var s=this.vertices,n=this.worldVertices,r=0;r!==e;r++)i.vmult(s[r],n[r]),t.vadd(n[r],n[r]);this.worldVerticesNeedsUpdate=!1},new o,r.prototype.computeLocalAABB=function(t,i){var e=this.vertices.length,s=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var o=0;o<e;o++){var n=s[o];n.x<t.x?t.x=n.x:n.x>i.x&&(i.x=n.x),n.y<t.y?t.y=n.y:n.y>i.y&&(i.y=n.y),n.z<t.z?t.z=n.z:n.z>i.z&&(i.z=n.z)}},r.prototype.computeWorldFaceNormals=function(t){for(var i=this.faceNormals.length;this.worldFaceNormals.length<i;)this.worldFaceNormals.push(new o);for(var e=this.faceNormals,s=this.worldFaceNormals,n=0;n!==i;n++)t.vmult(e[n],s[n]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var t=0,i=this.vertices,e=0,s=i.length;e!==s;e++){var o=i[e].norm2();o>t&&(t=o)}this.boundingSphereRadius=Math.sqrt(t)};var V=new o;r.prototype.calculateWorldAABB=function(t,i,e,s){for(var o,n,r,a,h,l,c=this.vertices.length,u=this.vertices,p=0;p<c;p++){V.copy(u[p]),i.vmult(V,V),t.vadd(V,V);var d=V;d.x<o||void 0===o?o=d.x:(d.x>a||void 0===a)&&(a=d.x),d.y<n||void 0===n?n=d.y:(d.y>h||void 0===h)&&(h=d.y),d.z<r||void 0===r?r=d.z:(d.z>l||void 0===l)&&(l=d.z)}e.set(o,n,r),s.set(a,h,l)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(t){t=t||new o;for(var i=this.vertices.length,e=this.vertices,s=0;s<i;s++)t.vadd(e[s],t);return t.mult(1/i,t),t},r.prototype.transformAllPoints=function(t,i){var e=this.vertices.length,s=this.vertices;if(i){for(var o=0;o<e;o++){var n=s[o];i.vmult(n,n)}for(o=0;o<this.faceNormals.length;o++)n=this.faceNormals[o],i.vmult(n,n)}if(t)for(o=0;o<e;o++)(n=s[o]).vadd(t,n)};var T=new o,I=new o,L=new o;r.prototype.pointIsInside=function(t){var i=this.vertices.length,e=this.vertices,s=this.faces,o=this.faceNormals,n=this.faces.length,r=T;this.getAveragePointLocal(r);for(var a=0;a<n;a++){this.faces[a].length,i=o[a];var h=e[s[a][0]],l=I;t.vsub(h,l);var c=i.dot(l),u=L;r.vsub(h,u);var p=i.dot(u);if(c<0&&p>0||c>0&&p<0)return!1}return-1},new o;var C=new o,B=new o;r.project=function(t,i,e,s,o){var r=t.vertices.length,a=C,h=0,l=0,c=B,u=t.vertices;c.setZero(),n.vectorToLocalFrame(e,s,i,a),n.pointToLocalFrame(e,s,c,c);var p=c.dot(a);l=h=u[0].dot(a);for(var d=1;d<r;d++){var m=u[d].dot(a);m>h&&(h=m),m<l&&(l=m)}if((l-=p)>(h-=p)){var y=l;l=h,h=y}o[0]=h,o[1]=l}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,i,e){i.exports=r;var s=t("./Shape"),o=t("../math/Vec3"),n=(t("../math/Quaternion"),t("./ConvexPolyhedron"));function r(t,i,e,r){var a=r,h=[],l=[],c=[],u=[],p=[],d=Math.cos,m=Math.sin;h.push(new o(i*d(0),i*m(0),.5*-e)),u.push(0),h.push(new o(t*d(0),t*m(0),.5*e)),p.push(1);for(var y=0;y<a;y++){var f=2*Math.PI/a*(y+1),v=2*Math.PI/a*(y+.5);y<a-1?(h.push(new o(i*d(f),i*m(f),.5*-e)),u.push(2*y+2),h.push(new o(t*d(f),t*m(f),.5*e)),p.push(2*y+3),c.push([2*y+2,2*y+3,2*y+1,2*y])):c.push([0,1,2*y+1,2*y]),(a%2==1||y<a/2)&&l.push(new o(d(v),m(v),0))}c.push(p),l.push(new o(0,0,1));var x=[];for(y=0;y<u.length;y++)x.push(u[u.length-y-1]);c.push(x),this.type=s.types.CONVEXPOLYHEDRON,n.call(this,h,c,l)}r.prototype=new n},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,i,e){var s=t("./Shape"),o=t("./ConvexPolyhedron"),n=t("../math/Vec3"),r=t("../utils/Utils");function a(t,i){i=r.defaults(i,{maxValue:null,minValue:null,elementSize:1}),this.data=t,this.maxValue=i.maxValue,this.minValue=i.minValue,this.elementSize=i.elementSize,null===i.minValue&&this.updateMinValue(),null===i.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,s.call(this),this.pillarConvex=new o,this.pillarOffset=new n,this.type=s.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}i.exports=a,a.prototype=new s,a.prototype.update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var t=this.data,i=t[0][0],e=0;e!==t.length;e++)for(var s=0;s!==t[e].length;s++){var o=t[e][s];o<i&&(i=o)}this.minValue=i},a.prototype.updateMaxValue=function(){for(var t=this.data,i=t[0][0],e=0;e!==t.length;e++)for(var s=0;s!==t[e].length;s++){var o=t[e][s];o>i&&(i=o)}this.maxValue=i},a.prototype.setHeightValueAtIndex=function(t,i,e){this.data[t][i]=e,this.clearCachedConvexTrianglePillar(t,i,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,i,!0),this.clearCachedConvexTrianglePillar(t-1,i,!1)),i>0&&(this.clearCachedConvexTrianglePillar(t,i-1,!0),this.clearCachedConvexTrianglePillar(t,i-1,!1)),i>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,i-1,!0)},a.prototype.getRectMinMax=function(t,i,e,s,o){o=o||[];for(var n=this.data,r=this.minValue,a=t;a<=e;a++)for(var h=i;h<=s;h++){var l=n[a][h];l>r&&(r=l)}o[0]=this.minValue,o[1]=r},a.prototype.getIndexOfPosition=function(t,i,e,s){var o=this.elementSize,n=this.data,r=Math.floor(t/o),a=Math.floor(i/o);return e[0]=r,e[1]=a,s&&(r<0&&(r=0),a<0&&(a=0),r>=n.length-1&&(r=n.length-1),a>=n[0].length-1&&(a=n[0].length-1)),!(r<0||a<0||r>=n.length-1||a>=n[0].length-1)},a.prototype.getHeightAt=function(t,i,e){var s=[];this.getIndexOfPosition(t,i,s,e);var o=[];return this.getRectMinMax(s[0],s[1]+1,s[0],s[1]+1,o),(o[0]+o[1])/2},a.prototype.getCacheConvexTrianglePillarKey=function(t,i,e){return t+"_"+i+"_"+(e?1:0)},a.prototype.getCachedConvexTrianglePillar=function(t,i,e){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,i,e)]},a.prototype.setCachedConvexTrianglePillar=function(t,i,e,s,o){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,i,e)]={convex:s,offset:o}},a.prototype.clearCachedConvexTrianglePillar=function(t,i,e){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,i,e)]},a.prototype.getConvexTrianglePillar=function(t,i,e){var s=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(t,i,e))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);s=new o,r=new n,this.pillarConvex=s,this.pillarOffset=r}var a=this.data,h=this.elementSize,l=s.faces;s.vertices.length=6;for(var c=0;c<6;c++)s.vertices[c]||(s.vertices[c]=new n);for(l.length=5,c=0;c<5;c++)l[c]||(l[c]=[]);var u=s.vertices,p=(Math.min(a[t][i],a[t+1][i],a[t][i+1],a[t+1][i+1])-this.minValue)/2+this.minValue;e?(r.set((t+.75)*h,(i+.75)*h,p),u[0].set(.25*h,.25*h,a[t+1][i+1]-p),u[1].set(-.75*h,.25*h,a[t][i+1]-p),u[2].set(.25*h,-.75*h,a[t+1][i]-p),u[3].set(.25*h,.25*h,-p-1),u[4].set(-.75*h,.25*h,-p-1),u[5].set(.25*h,-.75*h,-p-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(r.set((t+.25)*h,(i+.25)*h,p),u[0].set(-.25*h,-.25*h,a[t][i]-p),u[1].set(.75*h,-.25*h,a[t+1][i]-p),u[2].set(-.25*h,.75*h,a[t][i+1]-p),u[3].set(-.25*h,-.25*h,-p-1),u[4].set(.75*h,-.25*h,-p-1),u[5].set(-.25*h,.75*h,-p-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),s.computeNormals(),s.computeEdges(),s.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,i,e,s,r)},a.prototype.calculateLocalInertia=function(t,i){return(i=i||new n).set(0,0,0),i},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(t,i,e,s){e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var t=this.data,i=this.elementSize;this.boundingSphereRadius=new n(t.length*i,t[0].length*i,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,i,e){i.exports=n;var s=t("./Shape"),o=t("../math/Vec3");function n(){s.call(this),this.type=s.types.PARTICLE}n.prototype=new s,n.prototype.constructor=n,n.prototype.calculateLocalInertia=function(t,i){return(i=i||new o).set(0,0,0),i},n.prototype.volume=function(){return 0},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},n.prototype.calculateWorldAABB=function(t,i,e,s){e.copy(t),s.copy(t)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,i,e){i.exports=n;var s=t("./Shape"),o=t("../math/Vec3");function n(){s.call(this),this.type=s.types.PLANE,this.worldNormal=new o,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}n.prototype=new s,n.prototype.constructor=n,n.prototype.computeWorldNormal=function(t){var i=this.worldNormal;i.set(0,0,1),t.vmult(i,i),this.worldNormalNeedsUpdate=!1},n.prototype.calculateLocalInertia=function(t,i){return i=i||new o},n.prototype.volume=function(){return Number.MAX_VALUE};var r=new o;n.prototype.calculateWorldAABB=function(t,i,e,s){r.set(0,0,1),i.vmult(r,r);var o=Number.MAX_VALUE;e.set(-o,-o,-o),s.set(o,o,o),1===r.x&&(s.x=t.x),1===r.y&&(s.y=t.y),1===r.z&&(s.z=t.z),-1===r.x&&(e.x=t.x),-1===r.y&&(e.y=t.y),-1===r.z&&(e.z=t.z)},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,i,e){i.exports=s;var s=t("./Shape");function s(){this.id=s.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),s.prototype.constructor=s,s.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},s.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},s.prototype.calculateLocalInertia=function(t,i){throw"calculateLocalInertia() not implemented for shape type "+this.type},s.idCounter=0,s.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,i,e){i.exports=n;var s=t("./Shape"),o=t("../math/Vec3");function n(t){if(s.call(this),this.radius=void 0!==t?Number(t):1,this.type=s.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}n.prototype=new s,n.prototype.constructor=n,n.prototype.calculateLocalInertia=function(t,i){i=i||new o;var e=2*t*this.radius*this.radius/5;return i.x=e,i.y=e,i.z=e,i},n.prototype.volume=function(){return 4*Math.PI*this.radius/3},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},n.prototype.calculateWorldAABB=function(t,i,e,s){for(var o=this.radius,n=["x","y","z"],r=0;r<n.length;r++){var a=n[r];e[a]=t[a]-o,s[a]=t[a]+o}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,i,e){i.exports=h;var s=t("./Shape"),o=t("../math/Vec3"),n=(t("../math/Quaternion"),t("../math/Transform")),r=t("../collision/AABB"),a=t("../utils/Octree");function h(t,i){s.call(this),this.type=s.types.TRIMESH,this.vertices=new Float32Array(t),this.indices=new Int16Array(i),this.normals=new Float32Array(i.length),this.aabb=new r,this.edges=null,this.scale=new o(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}h.prototype=new s,h.prototype.constructor=h;var l=new o;h.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var i=this.scale;t.aabb.lowerBound.x*=1/i.x,t.aabb.lowerBound.y*=1/i.y,t.aabb.lowerBound.z*=1/i.z,t.aabb.upperBound.x*=1/i.x,t.aabb.upperBound.y*=1/i.y,t.aabb.upperBound.z*=1/i.z;for(var e=new r,s=new o,n=new o,a=new o,h=[s,n,a],l=0;l<this.indices.length/3;l++){var c=3*l;this._getUnscaledVertex(this.indices[c],s),this._getUnscaledVertex(this.indices[c+1],n),this._getUnscaledVertex(this.indices[c+2],a),e.setFromPoints(h),t.insert(e,l)}t.removeEmptyNodes()};var c=new r;h.prototype.getTrianglesInAABB=function(t,i){c.copy(t);var e=this.scale,s=e.x,o=e.y,n=e.z,r=c.lowerBound,a=c.upperBound;return r.x/=s,r.y/=o,r.z/=n,a.x/=s,a.y/=o,a.z/=n,this.tree.aabbQuery(c,i)},h.prototype.setScale=function(t){var i=this.scale.x===this.scale.y===this.scale.z,e=t.x===t.y===t.z;i&&e||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},h.prototype.updateNormals=function(){for(var t=l,i=this.normals,e=0;e<this.indices.length/3;e++){var s=3*e,o=this.indices[s],n=this.indices[s+1],r=this.indices[s+2];this.getVertex(o,y),this.getVertex(n,f),this.getVertex(r,v),h.computeNormal(f,y,v,t),i[s]=t.x,i[s+1]=t.y,i[s+2]=t.z}},h.prototype.updateEdges=function(){for(var t={},i=function(i,e){t[o<n?o+"_"+n:n+"_"+o]=!0},e=0;e<this.indices.length/3;e++){var s=3*e,o=this.indices[s],n=this.indices[s+1];this.indices[s+2],i(),i(),i()}var r=Object.keys(t);for(this.edges=new Int16Array(2*r.length),e=0;e<r.length;e++){var a=r[e].split("_");this.edges[2*e]=parseInt(a[0],10),this.edges[2*e+1]=parseInt(a[1],10)}},h.prototype.getEdgeVertex=function(t,i,e){var s=this.edges[2*t+(i?1:0)];this.getVertex(s,e)};var u=new o,p=new o;h.prototype.getEdgeVector=function(t,i){var e=u,s=p;this.getEdgeVertex(t,0,e),this.getEdgeVertex(t,1,s),s.vsub(e,i)};var d=new o,m=new o;h.computeNormal=function(t,i,e,s){i.vsub(t,m),e.vsub(i,d),d.cross(m,s),s.isZero()||s.normalize()};var y=new o,f=new o,v=new o;h.prototype.getVertex=function(t,i){var e=this.scale;return this._getUnscaledVertex(t,i),i.x*=e.x,i.y*=e.y,i.z*=e.z,i},h.prototype._getUnscaledVertex=function(t,i){var e=3*t,s=this.vertices;return i.set(s[e],s[e+1],s[e+2])},h.prototype.getWorldVertex=function(t,i,e,s){return this.getVertex(t,s),n.pointToWorldFrame(i,e,s,s),s},h.prototype.getTriangleVertices=function(t,i,e,s){var o=3*t;this.getVertex(this.indices[o],i),this.getVertex(this.indices[o+1],e),this.getVertex(this.indices[o+2],s)},h.prototype.getNormal=function(t,i){var e=3*t;return i.set(this.normals[e],this.normals[e+1],this.normals[e+2])};var x=new r;h.prototype.calculateLocalInertia=function(t,i){this.computeLocalAABB(x);var e=x.upperBound.x-x.lowerBound.x,s=x.upperBound.y-x.lowerBound.y,o=x.upperBound.z-x.lowerBound.z;return i.set(1/12*t*(2*s*2*s+2*o*2*o),1/12*t*(2*e*2*e+2*o*2*o),1/12*t*(2*s*2*s+2*e*2*e))};var b=new o;h.prototype.computeLocalAABB=function(t){var i=t.lowerBound,e=t.upperBound,s=this.vertices.length,o=(this.vertices,b);this.getVertex(0,o),i.copy(o),e.copy(o);for(var n=0;n!==s;n++)this.getVertex(n,o),o.x<i.x?i.x=o.x:o.x>e.x&&(e.x=o.x),o.y<i.y?i.y=o.y:o.y>e.y&&(e.y=o.y),o.z<i.z?i.z=o.z:o.z>e.z&&(e.z=o.z)},h.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},h.prototype.updateBoundingSphereRadius=function(){for(var t=0,i=this.vertices,e=new o,s=0,n=i.length/3;s!==n;s++){this.getVertex(s,e);var r=e.norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)},new o;var g=new n,w=new r;h.prototype.calculateWorldAABB=function(t,i,e,s){var o=g,n=w;o.position=t,o.quaternion=i,this.aabb.toWorldFrame(o,n),e.copy(n.lowerBound),s.copy(n.upperBound)},h.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},h.createTorus=function(t,i,e,s,o){t=t||1,i=i||.5,e=e||8,s=s||6,o=o||2*Math.PI;for(var n=[],r=[],a=0;a<=e;a++)for(var l=0;l<=s;l++){var c=l/s*o,u=a/e*Math.PI*2,p=(t+i*Math.cos(u))*Math.cos(c),d=(t+i*Math.cos(u))*Math.sin(c),m=i*Math.sin(u);n.push(p,d,m)}for(a=1;a<=e;a++)for(l=1;l<=s;l++){var y=(s+1)*a+l-1,f=(s+1)*(a-1)+l-1,v=(s+1)*(a-1)+l,x=(s+1)*a+l;r.push(y,f,x),r.push(f,v,x)}return new h(n,r)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,i,e){i.exports=o,t("../math/Vec3"),t("../math/Quaternion");var s=t("./Solver");function o(){s.call(this),this.iterations=10,this.tolerance=1e-7}o.prototype=new s;var n=[],r=[],a=[];o.prototype.solve=function(t,i){var e,s,o,h,l,c=0,u=this.iterations,p=this.tolerance*this.tolerance,d=this.equations,m=d.length,y=i.bodies,f=y.length,v=t;if(0!==m)for(var x=0;x!==f;x++)y[x].updateSolveMassProperties();var b=r,g=a,w=n;for(b.length=m,g.length=m,w.length=m,x=0;x!==m;x++){var z=d[x];w[x]=0,g[x]=z.computeB(v),b[x]=1/z.computeC()}if(0!==m){for(x=0;x!==f;x++){var N=(P=y[x]).vlambda,S=P.wlambda;N.set(0,0,0),S&&S.set(0,0,0)}for(c=0;c!==u;c++){h=0;for(var M=0;M!==m;M++)z=d[M],e=g[M],s=b[M],(l=w[M])+(o=s*(e-z.computeGWlambda()-z.eps*l))<z.minForce?o=z.minForce-l:l+o>z.maxForce&&(o=z.maxForce-l),w[M]+=o,h+=o>0?o:-o,z.addToWlambda(o);if(h*h<p)break}for(x=0;x!==f;x++){var P,k=(P=y[x]).velocity,A=P.angularVelocity;k.vadd(P.vlambda,k),A&&A.vadd(P.wlambda,A)}}return c}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,i,e){function s(){this.equations=[]}i.exports=s,s.prototype.solve=function(t,i){return 0},s.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},s.prototype.removeEquation=function(t){var i=this.equations,e=i.indexOf(t);-1!==e&&i.splice(e,1)},s.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,i,e){i.exports=n,t("../math/Vec3"),t("../math/Quaternion");var s=t("./Solver"),o=t("../objects/Body");function n(t){for(s.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}n.prototype=new s;var r=[],a=[],h={bodies:[]},l=o.STATIC;function c(t){for(var i=t.length,e=0;e!==i;e++){var s=t[e];if(!(s.visited||s.body.type&l))return s}return!1}var u=[];function p(t,i,e,s){for(u.push(t),t.visited=!0,i(t,e,s);u.length;)for(var o,n=u.pop();o=c(n.children);)o.visited=!0,i(o,e,s),u.push(o)}function d(t,i,e){i.push(t.body);for(var s=t.eqs.length,o=0;o!==s;o++){var n=t.eqs[o];-1===e.indexOf(n)&&e.push(n)}}function m(t,i){return i.id-t.id}n.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},n.prototype.solve=function(t,i){for(var e=r,s=this.nodePool,o=i.bodies,n=this.equations,l=n.length,u=o.length,y=this.subsolver;s.length<u;)s.push(this.createNode());e.length=u;for(var f=0;f<u;f++)e[f]=s[f];for(f=0;f!==u;f++){var v=e[f];v.body=o[f],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var x=0;x!==l;x++){var b=n[x],g=(f=o.indexOf(b.bi),o.indexOf(b.bj)),w=e[f],z=e[g];w.children.push(z),w.eqs.push(b),z.children.push(w),z.eqs.push(b)}var N,S=0,M=a;y.tolerance=this.tolerance,y.iterations=this.iterations;for(var P=h;N=c(e);){M.length=0,P.bodies.length=0,p(N,d,P.bodies,M);var k=M.length;for(M=M.sort(m),f=0;f!==k;f++)y.addEquation(M[f]);y.solve(t,P),y.removeAllEquations(),S++}return S}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,i,e){var s=function(){};i.exports=s,s.prototype={constructor:s,addEventListener:function(t,i){void 0===this._listeners&&(this._listeners={});var e=this._listeners;return void 0===e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i),this},hasEventListener:function(t,i){if(void 0===this._listeners)return!1;var e=this._listeners;return void 0!==e[t]&&-1!==e[t].indexOf(i)},removeEventListener:function(t,i){if(void 0===this._listeners)return this;var e=this._listeners;if(void 0===e[t])return this;var s=e[t].indexOf(i);return-1!==s&&e[t].splice(s,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var i=this._listeners[t.type];if(void 0!==i){t.target=this;for(var e=0,s=i.length;e<s;e++)i[e].call(this,t)}return this}}},{}],50:[function(t,i,e){var s=t("../collision/AABB"),o=t("../math/Vec3");function n(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new s,this.data=[],this.children=[]}function r(t,i){(i=i||{}).root=null,i.aabb=t,n.call(this,i),this.maxDepth=void 0!==i.maxDepth?i.maxDepth:8}i.exports=r,r.prototype=new n,n.prototype.reset=function(t,i){this.children.length=this.data.length=0},n.prototype.insert=function(t,i,e){var s=this.data;if(e=e||0,!this.aabb.contains(t))return!1;var o=this.children;if(e<(this.maxDepth||this.root.maxDepth)){var n=!1;o.length||(this.subdivide(),n=!0);for(var r=0;8!==r;r++)if(o[r].insert(t,i,e+1))return!0;n&&(o.length=0)}return s.push(i),!0};var a=new o;n.prototype.subdivide=function(){var t=this.aabb,i=t.lowerBound,e=t.upperBound,r=this.children;r.push(new n({aabb:new s({lowerBound:new o(0,0,0)})}),new n({aabb:new s({lowerBound:new o(1,0,0)})}),new n({aabb:new s({lowerBound:new o(1,1,0)})}),new n({aabb:new s({lowerBound:new o(1,1,1)})}),new n({aabb:new s({lowerBound:new o(0,1,1)})}),new n({aabb:new s({lowerBound:new o(0,0,1)})}),new n({aabb:new s({lowerBound:new o(1,0,1)})}),new n({aabb:new s({lowerBound:new o(0,1,0)})})),e.vsub(i,a),a.scale(.5,a);for(var h=this.root||this,l=0;8!==l;l++){var c=r[l];c.root=h;var u=c.aabb.lowerBound;u.x*=a.x,u.y*=a.y,u.z*=a.z,u.vadd(i,u),u.vadd(a,c.aabb.upperBound)}},n.prototype.aabbQuery=function(t,i){this.data,this.children;for(var e=[this];e.length;){var s=e.pop();s.aabb.overlaps(t)&&Array.prototype.push.apply(i,s.data),Array.prototype.push.apply(e,s.children)}return i};var h=new s;n.prototype.rayQuery=function(t,i,e){return t.getAABB(h),h.toLocalFrame(i,h),this.aabbQuery(h,e),e},n.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var i=t.pop(),e=i.children.length-1;e>=0;e--)i.children[e].data.length||i.children.splice(e,1);Array.prototype.push.apply(t,i.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,i,e){function s(){this.objects=[],this.type=Object}i.exports=s,s.prototype.release=function(){for(var t=arguments.length,i=0;i!==t;i++)this.objects.push(arguments[i])},s.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},s.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,i,e){function s(){this.data={keys:[]}}i.exports=s,s.prototype.get=function(t,i){if(t>i){var e=i;i=t,t=e}return this.data[t+"-"+i]},s.prototype.set=function(t,i,e){if(t>i){var s=i;i=t,t=s}var o=t+"-"+i;this.get(t,i)||this.data.keys.push(o),this.data[o]=e},s.prototype.reset=function(){for(var t=this.data,i=t.keys;i.length>0;)delete t[i.pop()]}},{}],53:[function(t,i,e){function s(){}i.exports=s,s.defaults=function(t,i){for(var e in t=t||{},i)e in t||(t[e]=i[e]);return t}},{}],54:[function(t,i,e){i.exports=n;var s=t("../math/Vec3"),o=t("./Pool");function n(){o.call(this),this.type=s}n.prototype=new o,n.prototype.constructObject=function(){return new s}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,i,e){i.exports=p;var s=t("../collision/AABB"),o=t("../shapes/Shape"),n=t("../collision/Ray"),r=t("../math/Vec3"),a=t("../math/Transform"),h=(t("../shapes/ConvexPolyhedron"),t("../math/Quaternion")),l=(t("../solver/Solver"),t("../utils/Vec3Pool")),c=t("../equations/ContactEquation"),u=t("../equations/FrictionEquation");function p(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new l,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}p.prototype.createContactEquation=function(t,i,e,s,o,n){var r;this.contactPointPool.length?((r=this.contactPointPool.pop()).bi=t,r.bj=i):r=new c(t,i),r.enabled=t.collisionResponse&&i.collisionResponse&&e.collisionResponse&&s.collisionResponse;var a=this.currentContactMaterial;r.restitution=a.restitution,r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var h=e.material||t.material,l=s.material||i.material;return h&&l&&h.restitution>=0&&l.restitution>=0&&(r.restitution=h.restitution*l.restitution),r.si=o||e,r.sj=n||s,r},p.prototype.createFrictionEquationsFromContact=function(t,i){var e=t.bi,s=t.bj,o=t.si,n=t.sj,r=this.world,a=this.currentContactMaterial,h=a.friction,l=o.material||e.material,c=n.material||s.material;if(l&&c&&l.friction>=0&&c.friction>=0&&(h=l.friction*c.friction),h>0){var p=h*r.gravity.length(),d=e.invMass+s.invMass;d>0&&(d=1/d);var m=this.frictionEquationPool,y=m.length?m.pop():new u(e,s,p*d),f=m.length?m.pop():new u(e,s,p*d);return y.bi=f.bi=e,y.bj=f.bj=s,y.minForce=f.minForce=-p*d,y.maxForce=f.maxForce=p*d,y.ri.copy(t.ri),y.rj.copy(t.rj),f.ri.copy(t.ri),f.rj.copy(t.rj),t.ni.tangents(y.t,f.t),y.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),f.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),y.enabled=f.enabled=t.enabled,i.push(y,f),!0}return!1};var d=new r,m=new r,y=new r;p.prototype.createFrictionFromAverage=function(t){var i=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(i,this.frictionResult)&&1!==t){var e=this.frictionResult[this.frictionResult.length-2],s=this.frictionResult[this.frictionResult.length-1];d.setZero(),m.setZero(),y.setZero();for(var o=i.bi,n=(i.bj,0);n!==t;n++)(i=this.result[this.result.length-1-n]).bodyA!==o?(d.vadd(i.ni,d),m.vadd(i.ri,m),y.vadd(i.rj,y)):(d.vsub(i.ni,d),m.vadd(i.rj,m),y.vadd(i.ri,y));var r=1/t;m.scale(r,e.ri),y.scale(r,e.rj),s.ri.copy(e.ri),s.rj.copy(e.rj),d.normalize(),d.tangents(e.t,s.t)}};var f=new r,v=new r,x=new h,b=new h;p.prototype.getContacts=function(t,i,e,s,o,n,r){this.contactPointPool=o,this.frictionEquationPool=r,this.result=s,this.frictionResult=n;for(var a=x,h=b,l=f,c=v,u=0,p=t.length;u!==p;u++){var d=t[u],m=i[u],y=null;d.material&&m.material&&(y=e.getContactMaterial(d.material,m.material)||null);for(var g=0;g<d.shapes.length;g++){d.quaternion.mult(d.shapeOrientations[g],a),d.quaternion.vmult(d.shapeOffsets[g],l),l.vadd(d.position,l);for(var w=d.shapes[g],z=0;z<m.shapes.length;z++){m.quaternion.mult(m.shapeOrientations[z],h),m.quaternion.vmult(m.shapeOffsets[z],c),c.vadd(m.position,c);var N=m.shapes[z];if(!(l.distanceTo(c)>w.boundingSphereRadius+N.boundingSphereRadius)){var S=null;w.material&&N.material&&(S=e.getContactMaterial(w.material,N.material)||null),this.currentContactMaterial=S||y||e.defaultContactMaterial;var M=this[w.type|N.type];M&&(w.type<N.type?M.call(this,w,N,l,c,a,h,d,m,w,N):M.call(this,N,w,c,l,h,a,m,d,w,N))}}}}},p.prototype[o.types.BOX|o.types.BOX]=p.prototype.boxBox=function(t,i,e,s,o,n,r,a){t.convexPolyhedronRepresentation.material=t.material,i.convexPolyhedronRepresentation.material=i.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,i.convexPolyhedronRepresentation.collisionResponse=i.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,i.convexPolyhedronRepresentation,e,s,o,n,r,a,t,i)},p.prototype[o.types.BOX|o.types.CONVEXPOLYHEDRON]=p.prototype.boxConvex=function(t,i,e,s,o,n,r,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,i,e,s,o,n,r,a,t,i)},p.prototype[o.types.BOX|o.types.PARTICLE]=p.prototype.boxParticle=function(t,i,e,s,o,n,r,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,i,e,s,o,n,r,a,t,i)},p.prototype[o.types.SPHERE]=p.prototype.sphereSphere=function(t,i,e,s,o,n,r,a){var h=this.createContactEquation(r,a,t,i);s.vsub(e,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(t.radius,h.ri),h.rj.mult(-i.radius,h.rj),h.ri.vadd(e,h.ri),h.ri.vsub(r.position,h.ri),h.rj.vadd(s,h.rj),h.rj.vsub(a.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var g=new r,w=new r,z=new r;p.prototype[o.types.PLANE|o.types.TRIMESH]=p.prototype.planeTrimesh=function(t,i,e,s,o,n,h,l){var c=new r,u=g;u.set(0,0,1),o.vmult(u,u);for(var p=0;p<i.vertices.length/3;p++){i.getVertex(p,c);var d=new r;d.copy(c),a.pointToWorldFrame(s,n,d,c);var m=w;if(c.vsub(e,m),u.dot(m)<=0){var y=this.createContactEquation(h,l,t,i);y.ni.copy(u);var f=z;u.scale(m.dot(u),f),c.vsub(f,f),y.ri.copy(f),y.ri.vsub(h.position,y.ri),y.rj.copy(c),y.rj.vsub(l.position,y.rj),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult)}}};var N=new r,S=new r,M=(new r,new r),P=new r,k=new r,A=new r,V=new r,T=new r,I=new r,L=new r,C=new r,B=new r,E=new r,R=new s,F=[];p.prototype[o.types.SPHERE|o.types.TRIMESH]=p.prototype.sphereTrimesh=function(t,i,e,s,o,r,h,l){var c=k,u=A,p=V,d=T,m=I,y=L,f=R,v=P,x=S,b=F;a.pointToLocalFrame(s,r,e,m);var g=t.radius;f.lowerBound.set(m.x-g,m.y-g,m.z-g),f.upperBound.set(m.x+g,m.y+g,m.z+g),i.getTrianglesInAABB(f,b);for(var w=M,z=t.radius*t.radius,q=0;q<b.length;q++)for(var j=0;j<3;j++)i.getVertex(i.indices[3*b[q]+j],w),w.vsub(m,x),x.norm2()<=z&&(v.copy(w),a.pointToWorldFrame(s,r,v,w),w.vsub(e,x),(_=this.createContactEquation(h,l,t,i)).ni.copy(x),_.ni.normalize(),_.ri.copy(_.ni),_.ri.scale(t.radius,_.ri),_.ri.vadd(e,_.ri),_.ri.vsub(h.position,_.ri),_.rj.copy(w),_.rj.vsub(l.position,_.rj),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult));for(q=0;q<b.length;q++)for(j=0;j<3;j++){i.getVertex(i.indices[3*b[q]+j],c),i.getVertex(i.indices[3*b[q]+(j+1)%3],u),u.vsub(c,p),m.vsub(u,y);var O=y.dot(p);m.vsub(c,y);var D=y.dot(p);if(D>0&&O<0&&(m.vsub(c,y),d.copy(p),d.normalize(),D=y.dot(d),d.scale(D,y),y.vadd(c,y),(Y=y.distanceTo(m))<t.radius)){var _=this.createContactEquation(h,l,t,i);y.vsub(m,_.ni),_.ni.normalize(),_.ni.scale(t.radius,_.ri),a.pointToWorldFrame(s,r,y,y),y.vsub(l.position,_.rj),a.vectorToWorldFrame(r,_.ni,_.ni),a.vectorToWorldFrame(r,_.ri,_.ri),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}}for(var W=C,U=B,H=E,G=N,X=(q=0,b.length);q!==X;q++){i.getTriangleVertices(b[q],W,U,H),i.getNormal(b[q],G),m.vsub(W,y);var Y=y.dot(G);G.scale(Y,y),m.vsub(y,y),Y=y.distanceTo(m),n.pointInTriangle(y,W,U,H)&&Y<t.radius&&(_=this.createContactEquation(h,l,t,i),y.vsub(m,_.ni),_.ni.normalize(),_.ni.scale(t.radius,_.ri),a.pointToWorldFrame(s,r,y,y),y.vsub(l.position,_.rj),a.vectorToWorldFrame(r,_.ni,_.ni),a.vectorToWorldFrame(r,_.ri,_.ri),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult))}b.length=0};var q=new r,j=new r;p.prototype[o.types.SPHERE|o.types.PLANE]=p.prototype.spherePlane=function(t,i,e,s,o,n,r,a){var h=this.createContactEquation(r,a,t,i);if(h.ni.set(0,0,1),n.vmult(h.ni,h.ni),h.ni.negate(h.ni),h.ni.normalize(),h.ni.mult(t.radius,h.ri),e.vsub(s,q),h.ni.mult(h.ni.dot(q),j),q.vsub(j,h.rj),-q.dot(h.ni)<=t.radius){var l=h.ri,c=h.rj;l.vadd(e,l),l.vsub(r.position,l),c.vadd(s,c),c.vsub(a.position,c),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var O=new r,D=new r,_=new r;function W(t,i,e){for(var s=null,o=t.length,n=0;n!==o;n++){var r=t[n],a=O;t[(n+1)%o].vsub(r,a);var h=D;a.cross(i,h);var l=_;e.vsub(r,l);var c=h.dot(l);if(!(null===s||c>0&&!0===s||c<=0&&!1===s))return!1;null===s&&(s=c>0)}return!0}var U=new r,H=new r,G=new r,X=new r,Y=[new r,new r,new r,new r,new r,new r],Q=new r,Z=new r,K=new r,J=new r;p.prototype[o.types.SPHERE|o.types.BOX]=p.prototype.sphereBox=function(t,i,e,s,o,n,r,a){var h=this.v3pool,l=Y;e.vsub(s,U),i.getSideNormals(l,n);for(var c=t.radius,u=!1,p=Z,d=K,m=J,y=null,f=0,v=0,x=0,b=null,g=0,w=l.length;g!==w&&!1===u;g++){var z=H;z.copy(l[g]);var N=z.norm();z.normalize();var S=U.dot(z);if(S<N+c&&S>0){var M=G,P=X;M.copy(l[(g+1)%3]),P.copy(l[(g+2)%3]);var k=M.norm(),A=P.norm();M.normalize(),P.normalize();var V=U.dot(M),T=U.dot(P);if(V<k&&V>-k&&T<A&&T>-A){var I=Math.abs(S-N-c);(null===b||I<b)&&(b=I,v=V,x=T,y=N,p.copy(z),d.copy(M),m.copy(P),f++)}}}if(f){u=!0;var L=this.createContactEquation(r,a,t,i);p.mult(-c,L.ri),L.ni.copy(p),L.ni.negate(L.ni),p.mult(y,p),d.mult(v,d),p.vadd(d,p),m.mult(x,m),p.vadd(m,L.rj),L.ri.vadd(e,L.ri),L.ri.vsub(r.position,L.ri),L.rj.vadd(s,L.rj),L.rj.vsub(a.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var C=h.get(),B=Q,E=0;2!==E&&!u;E++)for(var R=0;2!==R&&!u;R++)for(var F=0;2!==F&&!u;F++)C.set(0,0,0),E?C.vadd(l[0],C):C.vsub(l[0],C),R?C.vadd(l[1],C):C.vsub(l[1],C),F?C.vadd(l[2],C):C.vsub(l[2],C),s.vadd(C,B),B.vsub(e,B),B.norm2()<c*c&&(u=!0,(L=this.createContactEquation(r,a,t,i)).ri.copy(B),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(c,L.ri),L.rj.copy(C),L.ri.vadd(e,L.ri),L.ri.vsub(r.position,L.ri),L.rj.vadd(s,L.rj),L.rj.vsub(a.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult));h.release(C),C=null;var q=h.get(),j=h.get(),O=(L=h.get(),h.get()),D=(I=h.get(),l.length);for(E=0;E!==D&&!u;E++)for(R=0;R!==D&&!u;R++)if(E%3!=R%3){l[R].cross(l[E],q),q.normalize(),l[E].vadd(l[R],j),L.copy(e),L.vsub(j,L),L.vsub(s,L);var _=L.dot(q);for(q.mult(_,O),F=0;F===E%3||F===R%3;)F++;I.copy(e),I.vsub(O,I),I.vsub(j,I),I.vsub(s,I);var W=Math.abs(_),$=I.norm();if(W<l[F].norm()&&$<c){u=!0;var tt=this.createContactEquation(r,a,t,i);j.vadd(O,tt.rj),tt.rj.copy(tt.rj),I.negate(tt.ni),tt.ni.normalize(),tt.ri.copy(tt.rj),tt.ri.vadd(s,tt.ri),tt.ri.vsub(e,tt.ri),tt.ri.normalize(),tt.ri.mult(c,tt.ri),tt.ri.vadd(e,tt.ri),tt.ri.vsub(r.position,tt.ri),tt.rj.vadd(s,tt.rj),tt.rj.vsub(a.position,tt.rj),this.result.push(tt),this.createFrictionEquationsFromContact(tt,this.frictionResult)}}h.release(q,j,L,O,I)};var $=new r,tt=new r,it=new r,et=new r,st=new r,ot=new r,nt=new r,rt=new r,at=new r,ht=new r;p.prototype[o.types.SPHERE|o.types.CONVEXPOLYHEDRON]=p.prototype.sphereConvex=function(t,i,e,s,o,n,r,a){var h=this.v3pool;e.vsub(s,$);for(var l=i.faceNormals,c=i.faces,u=i.vertices,p=t.radius,d=0;d!==u.length;d++){var m=u[d],y=st;n.vmult(m,y),s.vadd(y,y);var f=et;if(y.vsub(e,f),f.norm2()<p*p)return v=!0,(I=this.createContactEquation(r,a,t,i)).ri.copy(f),I.ri.normalize(),I.ni.copy(I.ri),I.ri.mult(p,I.ri),y.vsub(s,I.rj),I.ri.vadd(e,I.ri),I.ri.vsub(r.position,I.ri),I.rj.vadd(s,I.rj),I.rj.vsub(a.position,I.rj),this.result.push(I),void this.createFrictionEquationsFromContact(I,this.frictionResult)}for(var v=!1,x=(d=0,c.length);d!==x&&!1===v;d++){var b=l[d],g=c[d],w=ot;n.vmult(b,w);var z=nt;n.vmult(u[g[0]],z),z.vadd(s,z);var N=rt;w.mult(-p,N),e.vadd(N,N);var S=at;N.vsub(z,S);var M=S.dot(w),P=ht;if(e.vsub(z,P),M<0&&P.dot(w)>0){for(var k=[],A=0,V=g.length;A!==V;A++){var T=h.get();n.vmult(u[g[A]],T),s.vadd(T,T),k.push(T)}if(W(k,w,e)){v=!0;var I=this.createContactEquation(r,a,t,i);w.mult(-p,I.ri),w.negate(I.ni);var L=h.get();w.mult(-M,L);var C=h.get();w.mult(-p,C),e.vsub(s,I.rj),I.rj.vadd(C,I.rj),I.rj.vadd(L,I.rj),I.rj.vadd(s,I.rj),I.rj.vsub(a.position,I.rj),I.ri.vadd(e,I.ri),I.ri.vsub(r.position,I.ri),h.release(L),h.release(C),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult),A=0;for(var B=k.length;A!==B;A++)h.release(k[A]);return}for(A=0;A!==g.length;A++){var E=h.get(),R=h.get();n.vmult(u[g[(A+1)%g.length]],E),n.vmult(u[g[(A+2)%g.length]],R),s.vadd(E,E),s.vadd(R,R);var F=tt;R.vsub(E,F);var q=it;F.unit(q);var j=h.get(),O=h.get();e.vsub(E,O);var D=O.dot(q);q.mult(D,j),j.vadd(E,j);var _=h.get();if(j.vsub(e,_),D>0&&D*D<F.norm2()&&_.norm2()<p*p){for(I=this.createContactEquation(r,a,t,i),j.vsub(s,I.rj),j.vsub(e,I.ni),I.ni.normalize(),I.ni.mult(p,I.ri),I.rj.vadd(s,I.rj),I.rj.vsub(a.position,I.rj),I.ri.vadd(e,I.ri),I.ri.vsub(r.position,I.ri),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult),A=0,B=k.length;A!==B;A++)h.release(k[A]);return h.release(E),h.release(R),h.release(j),h.release(_),void h.release(O)}h.release(E),h.release(R),h.release(j),h.release(_),h.release(O)}for(A=0,B=k.length;A!==B;A++)h.release(k[A])}}},new r,new r,p.prototype[o.types.PLANE|o.types.BOX]=p.prototype.planeBox=function(t,i,e,s,o,n,r,a){i.convexPolyhedronRepresentation.material=i.material,i.convexPolyhedronRepresentation.collisionResponse=i.collisionResponse,this.planeConvex(t,i.convexPolyhedronRepresentation,e,s,o,n,r,a)};var lt=new r,ct=new r,ut=new r,pt=new r;p.prototype[o.types.PLANE|o.types.CONVEXPOLYHEDRON]=p.prototype.planeConvex=function(t,i,e,s,o,n,r,a){var h=lt,l=ct;l.set(0,0,1),o.vmult(l,l);for(var c=0,u=ut,p=0;p!==i.vertices.length;p++)if(h.copy(i.vertices[p]),n.vmult(h,h),s.vadd(h,h),h.vsub(e,u),l.dot(u)<=0){var d=this.createContactEquation(r,a,t,i),m=pt;l.mult(l.dot(u),m),h.vsub(m,m),m.vsub(e,d.ri),d.ni.copy(l),h.vsub(s,d.rj),d.ri.vadd(e,d.ri),d.ri.vsub(r.position,d.ri),d.rj.vadd(s,d.rj),d.rj.vsub(a.position,d.rj),this.result.push(d),c++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(d,this.frictionResult)}this.enableFrictionReduction&&c&&this.createFrictionFromAverage(c)};var dt=new r,mt=new r;p.prototype[o.types.CONVEXPOLYHEDRON]=p.prototype.convexConvex=function(t,i,e,s,o,n,r,a,h,l,c,u){var p=dt;if(!(e.distanceTo(s)>t.boundingSphereRadius+i.boundingSphereRadius)&&t.findSeparatingAxis(i,e,o,s,n,p,c,u)){var d=[],m=mt;t.clipAgainstHull(e,o,i,s,n,p,-100,100,d);for(var y=0,f=0;f!==d.length;f++){var v=this.createContactEquation(r,a,t,i,h,l),x=v.ri,b=v.rj;p.negate(v.ni),d[f].normal.negate(m),m.mult(d[f].depth,m),d[f].point.vadd(m,x),b.copy(d[f].point),x.vsub(e,x),b.vsub(s,b),x.vadd(e,x),x.vsub(r.position,x),b.vadd(s,b),b.vsub(a.position,b),this.result.push(v),y++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&y&&this.createFrictionFromAverage(y)}};var yt=new r,ft=new r,vt=new r;p.prototype[o.types.PLANE|o.types.PARTICLE]=p.prototype.planeParticle=function(t,i,e,s,o,n,r,a){var h=yt;h.set(0,0,1),r.quaternion.vmult(h,h);var l=ft;if(s.vsub(r.position,l),h.dot(l)<=0){var c=this.createContactEquation(a,r,i,t);c.ni.copy(h),c.ni.negate(c.ni),c.ri.set(0,0,0);var u=vt;h.mult(h.dot(s),u),s.vsub(u,u),c.rj.copy(u),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var xt=new r;p.prototype[o.types.PARTICLE|o.types.SPHERE]=p.prototype.sphereParticle=function(t,i,e,s,o,n,r,a){var h=xt;if(h.set(0,0,1),s.vsub(e,h),h.norm2()<=t.radius*t.radius){var l=this.createContactEquation(a,r,i,t);h.normalize(),l.rj.copy(h),l.rj.mult(t.radius,l.rj),l.ni.copy(h),l.ni.negate(l.ni),l.ri.set(0,0,0),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var bt=new h,gt=new r,wt=(new r,new r),zt=new r,Nt=new r;p.prototype[o.types.PARTICLE|o.types.CONVEXPOLYHEDRON]=p.prototype.convexParticle=function(t,i,e,s,o,n,r,a){var h=-1,l=wt,c=Nt,u=null,p=gt;if(p.copy(s),p.vsub(e,p),o.conjugate(bt),bt.vmult(p,p),t.pointIsInside(p)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(e,o),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(o);for(var d=0,m=t.faces.length;d!==m;d++){var y=[t.worldVertices[t.faces[d][0]]],f=t.worldFaceNormals[d];s.vsub(y[0],zt);var v=-f.dot(zt);(null===u||Math.abs(v)<Math.abs(u))&&(u=v,h=d,l.copy(f))}if(-1!==h){var x=this.createContactEquation(a,r,i,t);l.mult(u,c),c.vadd(s,c),c.vsub(e,c),x.rj.copy(c),l.negate(x.ni),x.ri.set(0,0,0);var b=x.ri,g=x.rj;b.vadd(s,b),b.vsub(a.position,b),g.vadd(e,g),g.vsub(r.position,g),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},p.prototype[o.types.BOX|o.types.HEIGHTFIELD]=p.prototype.boxHeightfield=function(t,i,e,s,o,n,r,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,i,e,s,o,n,r,a)};var St=new r,Mt=new r,Pt=[0];p.prototype[o.types.CONVEXPOLYHEDRON|o.types.HEIGHTFIELD]=p.prototype.convexHeightfield=function(t,i,e,s,o,n,r,h){var l=i.data,c=i.elementSize,u=t.boundingSphereRadius,p=Mt,d=Pt,m=St;a.pointToLocalFrame(s,n,e,m);var y=Math.floor((m.x-u)/c)-1,f=Math.ceil((m.x+u)/c)+1,v=Math.floor((m.y-u)/c)-1,x=Math.ceil((m.y+u)/c)+1;if(!(f<0||x<0||y>l.length||v>l[0].length)){y<0&&(y=0),f<0&&(f=0),v<0&&(v=0),x<0&&(x=0),y>=l.length&&(y=l.length-1),f>=l.length&&(f=l.length-1),x>=l[0].length&&(x=l[0].length-1),v>=l[0].length&&(v=l[0].length-1);var b=[];i.getRectMinMax(y,v,f,x,b);var g=b[0],w=b[1];if(!(m.z-u>w||m.z+u<g))for(var z=y;z<f;z++)for(var N=v;N<x;N++)i.getConvexTrianglePillar(z,N,!1),a.pointToWorldFrame(s,n,i.pillarOffset,p),e.distanceTo(p)<i.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,i.pillarConvex,e,p,o,n,r,h,null,null,d,null),i.getConvexTrianglePillar(z,N,!0),a.pointToWorldFrame(s,n,i.pillarOffset,p),e.distanceTo(p)<i.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,i.pillarConvex,e,p,o,n,r,h,null,null,d,null)}};var kt=new r,At=new r;p.prototype[o.types.SPHERE|o.types.HEIGHTFIELD]=p.prototype.sphereHeightfield=function(t,i,e,s,o,n,r,h){var l=i.data,c=t.radius,u=i.elementSize,p=At,d=kt;a.pointToLocalFrame(s,n,e,d);var m=Math.floor((d.x-c)/u)-1,y=Math.ceil((d.x+c)/u)+1,f=Math.floor((d.y-c)/u)-1,v=Math.ceil((d.y+c)/u)+1;if(!(y<0||v<0||m>l.length||v>l[0].length)){m<0&&(m=0),y<0&&(y=0),f<0&&(f=0),v<0&&(v=0),m>=l.length&&(m=l.length-1),y>=l.length&&(y=l.length-1),v>=l[0].length&&(v=l[0].length-1),f>=l[0].length&&(f=l[0].length-1);var x=[];i.getRectMinMax(m,f,y,v,x);var b=x[0],g=x[1];if(!(d.z-c>g||d.z+c<b))for(var w=this.result,z=m;z<y;z++)for(var N=f;N<v;N++){var S=w.length;if(i.getConvexTrianglePillar(z,N,!1),a.pointToWorldFrame(s,n,i.pillarOffset,p),e.distanceTo(p)<i.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,i.pillarConvex,e,p,o,n,r,h),i.getConvexTrianglePillar(z,N,!0),a.pointToWorldFrame(s,n,i.pillarOffset,p),e.distanceTo(p)<i.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,i.pillarConvex,e,p,o,n,r,h),w.length-S>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,i,e){i.exports=x;var s=t("../shapes/Shape"),o=t("../math/Vec3"),n=t("../math/Quaternion"),r=t("../solver/GSSolver"),a=(t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation"),t("./Narrowphase")),h=t("../utils/EventTarget"),l=t("../collision/ArrayCollisionMatrix"),c=t("../material/Material"),u=t("../material/ContactMaterial"),p=t("../objects/Body"),d=t("../utils/TupleDictionary"),m=t("../collision/RaycastResult"),y=t("../collision/AABB"),f=t("../collision/Ray"),v=t("../collision/NaiveBroadphase");function x(){h.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new o,this.broadphase=new v,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new a(this),this.collisionMatrix=new l,this.collisionMatrixPrevious=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new d,this.defaultMaterial=new c("default"),this.defaultContactMaterial=new u(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}x.prototype=new h,new y;var b=new f;if(x.prototype.getContactMaterial=function(t,i){return this.contactMaterialTable.get(t.id,i.id)},x.prototype.numObjects=function(){return this.bodies.length},x.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset()},x.prototype.add=x.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof p&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.dispatchEvent(this.addBodyEvent))},x.prototype.addConstraint=function(t){this.constraints.push(t)},x.prototype.removeConstraint=function(t){var i=this.constraints.indexOf(t);-1!==i&&this.constraints.splice(i,1)},x.prototype.rayTest=function(t,i,e){e instanceof m?this.raycastClosest(t,i,{skipBackfaces:!0},e):this.raycastAll(t,i,{skipBackfaces:!0},e)},x.prototype.raycastAll=function(t,i,e,s){return e.mode=f.ALL,e.from=t,e.to=i,e.callback=s,b.intersectWorld(this,e)},x.prototype.raycastAny=function(t,i,e,s){return e.mode=f.ANY,e.from=t,e.to=i,e.result=s,b.intersectWorld(this,e)},x.prototype.raycastClosest=function(t,i,e,s){return e.mode=f.CLOSEST,e.from=t,e.to=i,e.result=s,b.intersectWorld(this,e)},x.prototype.remove=function(t){t.world=null;var i=this.bodies.length-1,e=this.bodies,s=e.indexOf(t);if(-1!==s){e.splice(s,1);for(var o=0;o!==e.length;o++)e[o].index=o;this.collisionMatrix.setNumObjects(i),this.removeBodyEvent.body=t,this.dispatchEvent(this.removeBodyEvent)}},x.prototype.removeBody=x.prototype.remove,x.prototype.addMaterial=function(t){this.materials.push(t)},x.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var g=Date.now();performance.timing&&performance.timing.navigationStart&&(g=performance.timing.navigationStart),performance.now=function(){return Date.now()-g}}var w=new o;x.prototype.step=function(t,i,e){if(e=e||10,0===(i=i||0))this.internalStep(t),this.time+=t;else{var s=Math.floor((this.time+i)/t)-Math.floor(this.time/t);s=Math.min(s,e);for(var o=performance.now(),n=0;n!==s&&(this.internalStep(t),!(performance.now()-o>1e3*t));n++);this.time+=i;for(var r=this.time%t/t,a=w,h=this.bodies,l=0;l!==h.length;l++){var c=h[l];c.type!==p.STATIC&&c.sleepState!==p.SLEEPING?(c.position.vsub(c.previousPosition,a),a.scale(r,a),c.position.vadd(a,c.interpolatedPosition)):(c.interpolatedPosition.copy(c.position),c.interpolatedQuaternion.copy(c.quaternion))}}};var z={type:"postStep"},N={type:"preStep"},S={type:"collide",body:null,contact:null},M=[],P=[],k=[],A=[],V=(new o,new o,new o,new o,new o,new o,new o,new o,new o,new n,new n),T=new n,I=new o;x.prototype.internalStep=function(t){this.dt=t;var i,e=this.contacts,o=k,n=A,r=this.numObjects(),a=this.bodies,h=this.solver,l=this.gravity,c=this.doProfiling,u=this.profile,d=p.DYNAMIC,m=this.constraints,y=P,f=(l.norm(),l.x),v=l.y,x=l.z,b=0;for(c&&(i=performance.now()),b=0;b!==r;b++)if((O=a[b]).type&d){var g=O.force,w=O.mass;g.x+=w*f,g.y+=w*v,g.z+=w*x}b=0;for(var L=this.subsystems.length;b!==L;b++)this.subsystems[b].update();c&&(i=performance.now()),o.length=0,n.length=0,this.broadphase.collisionPairs(this,o,n),c&&(u.broadphase=performance.now()-i);var C=m.length;for(b=0;b!==C;b++)if(!(_=m[b]).collideConnected)for(var B=o.length-1;B>=0;B-=1)(_.bodyA===o[B]&&_.bodyB===n[B]||_.bodyB===o[B]&&_.bodyA===n[B])&&(o.splice(B,1),n.splice(B,1));this.collisionMatrixTick(),c&&(i=performance.now());var E=M,R=e.length;for(b=0;b!==R;b++)E.push(e[b]);e.length=0;var F=this.frictionEquations.length;for(b=0;b!==F;b++)y.push(this.frictionEquations[b]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(o,n,this,e,E,this.frictionEquations,y),c&&(u.narrowphase=performance.now()-i),c&&(i=performance.now()),b=0;b<this.frictionEquations.length;b++)h.addEquation(this.frictionEquations[b]);for(var q=e.length,j=0;j!==q;j++){var O=(_=e[j]).bi,D=_.bj;_.si,_.sj,(O.material&&D.material&&this.getContactMaterial(O.material,D.material)||this.defaultContactMaterial).friction,O.material&&D.material&&(O.material.friction>=0&&D.material.friction>=0&&(O.material.friction,D.material.friction),O.material.restitution>=0&&D.material.restitution>=0&&(_.restitution=O.material.restitution*D.material.restitution)),h.addEquation(_),O.allowSleep&&O.type===p.DYNAMIC&&O.sleepState===p.SLEEPING&&D.sleepState===p.AWAKE&&D.type!==p.STATIC&&D.velocity.norm2()+D.angularVelocity.norm2()>=2*Math.pow(D.sleepSpeedLimit,2)&&(O._wakeUpAfterNarrowphase=!0),D.allowSleep&&D.type===p.DYNAMIC&&D.sleepState===p.SLEEPING&&O.sleepState===p.AWAKE&&O.type!==p.STATIC&&O.velocity.norm2()+O.angularVelocity.norm2()>=2*Math.pow(O.sleepSpeedLimit,2)&&(D._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(O,D,!0),this.collisionMatrixPrevious.get(O,D)||(S.body=D,S.contact=_,O.dispatchEvent(S),S.body=O,D.dispatchEvent(S))}for(c&&(u.makeContactConstraints=performance.now()-i,i=performance.now()),b=0;b!==r;b++)(O=a[b])._wakeUpAfterNarrowphase&&(O.wakeUp(),O._wakeUpAfterNarrowphase=!1);for(C=m.length,b=0;b!==C;b++){var _;(_=m[b]).update(),B=0;for(var W=_.equations.length;B!==W;B++){var U=_.equations[B];h.addEquation(U)}}h.solve(t,this),c&&(u.solve=performance.now()-i),h.removeAllEquations();var H=Math.pow;for(b=0;b!==r;b++)if((O=a[b]).type&d){var G=H(1-O.linearDamping,t),X=O.velocity;X.mult(G,X);var Y=O.angularVelocity;if(Y){var Q=H(1-O.angularDamping,t);Y.mult(Q,Y)}}for(this.dispatchEvent(N),b=0;b!==r;b++)(O=a[b]).preStep&&O.preStep.call(O);c&&(i=performance.now());var Z=V,K=T,J=this.stepnumber,$=p.DYNAMIC|p.KINEMATIC,tt=J%(this.quatNormalizeSkip+1)==0,it=this.quatNormalizeFast,et=.5*t;for(s.types.PLANE,s.types.CONVEXPOLYHEDRON,b=0;b!==r;b++){var st=a[b],ot=st.force,nt=st.torque;if(st.type&$&&st.sleepState!==p.SLEEPING){var rt=st.velocity,at=st.angularVelocity,ht=st.position,lt=st.quaternion,ct=st.invMass,ut=st.invInertiaWorld;rt.x+=ot.x*ct*t,rt.y+=ot.y*ct*t,rt.z+=ot.z*ct*t,st.angularVelocity&&(ut.vmult(nt,I),I.mult(t,I),I.vadd(at,at)),ht.x+=rt.x*t,ht.y+=rt.y*t,ht.z+=rt.z*t,st.angularVelocity&&(Z.set(at.x,at.y,at.z,0),Z.mult(lt,K),lt.x+=et*K.x,lt.y+=et*K.y,lt.z+=et*K.z,lt.w+=et*K.w,tt&&(it?lt.normalizeFast():lt.normalize())),st.aabb&&(st.aabbNeedsUpdate=!0),st.updateInertiaWorld&&st.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,c&&(u.integrate=performance.now()-i),this.time+=t,this.stepnumber+=1,this.dispatchEvent(z),b=0;b!==r;b++){var pt=(O=a[b]).postStep;pt&&pt.call(O)}if(this.allowSleep)for(b=0;b!==r;b++)a[b].sleepTick(this.time)},x.prototype.clearForces=function(){for(var t=this.bodies,i=t.length,e=0;e!==i;e++){var s=t[e];s.force,s.torque,s.force.set(0,0,0),s.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)},function(t,i){t.exports='varying vec2 vUv;\nuniform sampler2D backbuffer;\nuniform vec2 resolution;\n\nuniform bool direction;\nuniform float gaussVar;\n\n/*\nhttps://github.com/Jam3/glsl-fast-gaussian-blur/blob/master/\n\nThe MIT License (MIT) Copyright (c) 2015 Jam3\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n*/\n\nvec4 blur9(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n\tvec4 color = vec4(0.0);\n\tvec2 off1 = vec2(1.3846153846) * direction;\n\tvec2 off2 = vec2(3.2307692308) * direction;\n\tcolor += texture2D(image, uv) * 0.2270270270;\n\tcolor += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n\tcolor += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n\tcolor += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n\tcolor += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n\treturn color;\n}\n\nvoid main(){\n\n\tvec4 c = blur9(backbuffer,vUv,resolution,direction ? vec2(1.0,0.0) : vec2(0.0, 1.0));\n\n\tgl_FragColor = c;\n}'},function(t,i){t.exports="uniform sampler2D texturePosition;\nuniform sampler2D textureVelocity;\nuniform vec2 resolution;\nuniform float time;\nuniform float seed;\n\n//\n// Description : Array and textureless GLSL 2D/3D/4D simplex \n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n// \n\nvec4 mod289(vec4 x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0; }\n\nfloat mod289(float x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0; }\n\nvec4 permute(vec4 x) {\n     return mod289(((x*34.0)+1.0)*x);\n}\n\nfloat permute(float x) {\n     return mod289(((x*34.0)+1.0)*x);\n}\n\nvec4 taylorInvSqrt(vec4 r)\n{\n  return 1.79284291400159 - 0.85373472095314 * r;\n}\n\nfloat taylorInvSqrt(float r)\n{\n  return 1.79284291400159 - 0.85373472095314 * r;\n}\n\nvec4 grad4(float j, vec4 ip)\n  {\n  const vec4 ones = vec4(1.0, 1.0, 1.0, -1.0);\n  vec4 p,s;\n\n  p.xyz = floor( fract (vec3(j) * ip.xyz) * 7.0) * ip.z - 1.0;\n  p.w = 1.5 - dot(abs(p.xyz), ones.xyz);\n  s = vec4(lessThan(p, vec4(0.0)));\n  p.xyz = p.xyz + (s.xyz*2.0 - 1.0) * s.www; \n\n  return p;\n  }\n\t\t\t\t\t\t\n// (sqrt(5) - 1)/4 = F4, used once below\n#define F4 0.309016994374947451\n\nfloat snoise(vec4 v)\n  {\n  const vec4  C = vec4( 0.138196601125011,  // (5 - sqrt(5))/20  G4\n                        0.276393202250021,  // 2 * G4\n                        0.414589803375032,  // 3 * G4\n                       -0.447213595499958); // -1 + 4 * G4\n\n// First corner\n  vec4 i  = floor(v + dot(v, vec4(F4)) );\n  vec4 x0 = v -   i + dot(i, C.xxxx);\n\n// Other corners\n\n// Rank sorting originally contributed by Bill Licea-Kane, AMD (formerly ATI)\n  vec4 i0;\n  vec3 isX = step( x0.yzw, x0.xxx );\n  vec3 isYZ = step( x0.zww, x0.yyz );\n//  i0.x = dot( isX, vec3( 1.0 ) );\n  i0.x = isX.x + isX.y + isX.z;\n  i0.yzw = 1.0 - isX;\n//  i0.y += dot( isYZ.xy, vec2( 1.0 ) );\n  i0.y += isYZ.x + isYZ.y;\n  i0.zw += 1.0 - isYZ.xy;\n  i0.z += isYZ.z;\n  i0.w += 1.0 - isYZ.z;\n\n  // i0 now contains the unique values 0,1,2,3 in each channel\n  vec4 i3 = clamp( i0, 0.0, 1.0 );\n  vec4 i2 = clamp( i0-1.0, 0.0, 1.0 );\n  vec4 i1 = clamp( i0-2.0, 0.0, 1.0 );\n\n  //  x0 = x0 - 0.0 + 0.0 * C.xxxx\n  //  x1 = x0 - i1  + 1.0 * C.xxxx\n  //  x2 = x0 - i2  + 2.0 * C.xxxx\n  //  x3 = x0 - i3  + 3.0 * C.xxxx\n  //  x4 = x0 - 1.0 + 4.0 * C.xxxx\n  vec4 x1 = x0 - i1 + C.xxxx;\n  vec4 x2 = x0 - i2 + C.yyyy;\n  vec4 x3 = x0 - i3 + C.zzzz;\n  vec4 x4 = x0 + C.wwww;\n\n// Permutations\n  i = mod289(i); \n  float j0 = permute( permute( permute( permute(i.w) + i.z) + i.y) + i.x);\n  vec4 j1 = permute( permute( permute( permute (\n             i.w + vec4(i1.w, i2.w, i3.w, 1.0 ))\n           + i.z + vec4(i1.z, i2.z, i3.z, 1.0 ))\n           + i.y + vec4(i1.y, i2.y, i3.y, 1.0 ))\n           + i.x + vec4(i1.x, i2.x, i3.x, 1.0 ));\n\n// Gradients: 7x7x6 points over a cube, mapped onto a 4-cross polytope\n// 7*7*6 = 294, which is close to the ring size 17*17 = 289.\n  vec4 ip = vec4(1.0/294.0, 1.0/49.0, 1.0/7.0, 0.0) ;\n\n  vec4 p0 = grad4(j0,   ip);\n  vec4 p1 = grad4(j1.x, ip);\n  vec4 p2 = grad4(j1.y, ip);\n  vec4 p3 = grad4(j1.z, ip);\n  vec4 p4 = grad4(j1.w, ip);\n\n// Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n  p4 *= taylorInvSqrt(dot(p4,p4));\n\n// Mix contributions from the five corners\n  vec3 m0 = max(0.6 - vec3(dot(x0,x0), dot(x1,x1), dot(x2,x2)), 0.0);\n  vec2 m1 = max(0.6 - vec2(dot(x3,x3), dot(x4,x4)            ), 0.0);\n  m0 = m0 * m0;\n  m1 = m1 * m1;\n  return 49.0 * ( dot(m0*m0, vec3( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 )))\n               + dot(m1*m1, vec2( dot( p3, x3 ), dot( p4, x4 ) ) ) ) ;\n\n  }\n\nvoid main() {\n    if(gl_FragCoord.x >= 1.0) return;    \n    \n    vec2 uv = gl_FragCoord.xy / resolution.xy;\n    vec3 pos = texture2D( texturePosition, uv ).xyz;\n    vec3 vel = texture2D( textureVelocity, uv ).xyz;\n    float idParticle = uv.y * resolution.x + uv.x;\n    float scale = 0.08;\n    \n    vel.xyz += 40.0 * vec3(\n      snoise( vec4( scale * pos.xyz, 7.225 * seed * 200.0 + 0.4 * time ) ),\n      snoise( vec4( scale * pos.xyz, 3.553 * seed + 0.4 * time ) ),\n      snoise( vec4( scale * pos.xyz, 1.259 * seed * 10.0 + 0.4 * time ) )\n    ) * 0.05;\n\n    vec3 gpos = pos - vec3(0.0,0.0,0.0);\n    vel += -(gpos)* length(gpos) * 0.005;\n\n    vel.xyz *= 0.9 + abs(sin(uv.y * 9.0)) * 0.05;\n\n    gl_FragColor = vec4( vel.xyz, 1.0 );\n}"},function(t,i){t.exports="varying vec2 vUv;\n\nvoid main() {\n    vec3 pos = position;\n    pos.z = 1.0;\n    gl_Position = vec4(pos,1.0);\n    vUv = uv;\n}\n\n\n"},function(t,i){t.exports="uniform sampler2D backbuffer;\nuniform vec2 resolution;\nvarying vec2 vUv;\n\nuniform float threshold;\n\nvoid main(){\n\tvec3 c = texture2D(backbuffer,vUv).xyz;\n\tfloat f = max(0.0,length(c) * 1.2 - length(vec3(threshold)));\n\tgl_FragColor = vec4(vec3(c) * f,1.0);\n}"},function(t,i){t.exports="varying vec2 vUv;\nuniform sampler2D backbuffer;\nuniform vec2 resolution;\n\nuniform sampler2D sceneTex;\nuniform float brightness;\n\nvoid main(){\n\tgl_FragColor = texture2D(sceneTex, vUv) * 1.0 + texture2D(backbuffer, vUv) * brightness;\n}"},function(t,i){t.exports="varying vec2 vUv;\nuniform vec2 domPos;\nuniform vec2 domSize;\nuniform vec2 windowSize;\nuniform float time;\n\nvoid main()\n{\n  float aspect = windowSize.x / windowSize.y;\n  float width = domSize.x / windowSize.x;\n\n  //(0,0)\n  vec3 pos = position + vec3(1.0,-1.0,0.0);\n\n  //size\n  pos.x *= width;\n  pos.y *= (width * aspect) * (domSize.y / domSize.x);\n\n  //left top\n  pos += vec3(-1.0,1.0,0.0);\n\n  //dom position (window(-1.0,-1.0)-(1.0,1.0) *2 )\n  pos += vec3(domPos.x / windowSize.x * 2.0,-domPos.y / windowSize.y * 2.0,0.0);\n\n  gl_Position = vec4(pos, 1.0);\n  vUv = uv;\n}\n"},function(t,i){t.exports="uniform sampler2D texturePosition;\nuniform sampler2D textureVelocity;\nuniform vec2 resolution;\n\nvoid main() {\n    if(gl_FragCoord.x <= 1.0){\n        vec2 uv = gl_FragCoord.xy / resolution.xy;\n        vec3 pos = texture2D( texturePosition, uv ).xyz;\n        vec3 vel = texture2D( textureVelocity, uv ).xyz;\n\n        pos += vel * 0.01;\n        gl_FragColor = vec4(pos,1.0);\n        \n    }else{\n        vec2 uv = gl_FragCoord.xy / resolution.xy;\n        vec2 bUV = (gl_FragCoord.xy - vec2(1.0,0.0)) / resolution.xy;\n        vec3 bPos = texture2D( texturePosition, bUV ).xyz;;\n        gl_FragColor = vec4(bPos,1.0);\n    }\n}"},function(t,i){t.exports="varying vec3 vViewPosition;\nattribute float uvx;\nattribute float uvy;\nuniform sampler2D texturePosition;\nuniform float camY;\n\nfloat PI = 3.14159265;\n\nfloat atan2(float y, float x)\n{\n    return x == 0.0 ? sign(y) * PI / 2.0 : atan(y, x);\n}\n\nmat2 rotate(float rad){\n    return mat2(cos(rad),sin(rad),-sin(rad),cos(rad));\n}\n\nvoid main() {\n    vec2 nUV = vec2(uvx,uvy) + vec2(1.0,0.0);\n    \n    if(nUV.x >= 1.0){\n        nUV = vec2(uvx,uvy) - vec2(1.0,0.0);\n    }\n\n    vec3 p = position * 0.3;\n    vec3 pos = texture2D( texturePosition, vec2(uvx,uvy)).xyz;\n    vec3 nPos = texture2D( texturePosition, nUV).xyz;\n\n    vec3 vec = normalize(nPos - pos);\n    float rotX = atan2(vec.y,vec.z);\n\n    p.xy *= sin(uvx * PI) * (sin(uvy * PI) * 1.0 + 0.1);\n    p.yz *= rotate(rotX);\n\n    vec4 mvPosition = modelViewMatrix * vec4(p + pos, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n\n    vViewPosition = -mvPosition.xyz;\n}\n\n\n"},function(t,i){t.exports="varying vec2 vUv;\n\nvoid main() {\n    gl_Position = vec4( position, 1.0 );\n    vUv = uv;\n}"},function(t,i){t.exports="uniform sampler2D texture;\nvarying vec2 vUv;\n\nvoid main() {\n    gl_FragColor = texture2D(texture,vUv);\n}"},function(t,i){t.exports="uniform float alpha;\nuniform float beta;\nuniform vec2 resolution;\nuniform sampler2D dataTex;\n\nfloat sampleData( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\n\t}\n\n\treturn texture2D( tex, uv + offset / resolution ).z;\n\n}\n\nvoid main(){\n  vec4 data = texture2D(dataTex, gl_FragCoord.xy / resolution);\n\n  float l = sampleData(dataTex, (gl_FragCoord.xy - vec2(1.0, 0.0)) / resolution, resolution);\n  float r = sampleData(dataTex, (gl_FragCoord.xy + vec2(1.0, 0.0)) / resolution, resolution);\n  float t = sampleData(dataTex, (gl_FragCoord.xy - vec2(0.0, 1.0)) / resolution, resolution);\n  float b = sampleData(dataTex, (gl_FragCoord.xy + vec2(0.0, 1.0)) / resolution, resolution);\n\n  float divergence = data.w;\n  float pressure = ((l + r + t + b) - divergence) * 0.25;\n\n  gl_FragColor = vec4(data.xy, pressure, divergence);\n}"},function(t,i){t.exports="precision mediump float;\nprecision mediump sampler2D;\n\nuniform vec2 resolution;\nuniform sampler2D dataTex;\n\n\t\nfloat sampleData( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\n\t}\n\n\treturn texture2D( tex, uv + offset / resolution ).z;\n\n}\n\n    void main () {\n\n\t\tvec2 uv = gl_FragCoord.xy / resolution;\n\n\t\tfloat l = sampleData(dataTex, (gl_FragCoord.xy - vec2(1.0, 0.0)) / resolution, resolution);\n\t\tfloat r = sampleData(dataTex, (gl_FragCoord.xy + vec2(1.0, 0.0)) / resolution, resolution);\n\t\tfloat t = sampleData(dataTex, (gl_FragCoord.xy - vec2(0.0, 1.0)) / resolution, resolution);\n\t\tfloat b = sampleData(dataTex, (gl_FragCoord.xy + vec2(0.0, 1.0)) / resolution, resolution);\n\n        vec4 data = texture2D(dataTex, uv);\n\n        data.xy -= vec2(r - l, b - t);\n        gl_FragColor = data;\n    }"},function(t,i){t.exports="\nuniform float time;\nuniform vec2 resolution;\n\nuniform sampler2D dataTex;\nuniform sampler2D curlTex;\n\nuniform vec2 pointerPos;\nuniform vec2 pointerVec;\nuniform float pointerSize;\n\nuniform float screenAspect;\n\nvec2 smapleVelocity( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\tfloat w = 1.0;\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\t\tw = -1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\tw = -1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\t\tw = -1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\tw = -1.0;\n\t\n\t}\n\n\treturn w * texture2D( tex, uv + offset / resolution ).xy;\n\n}\n\nfloat samplePressure( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n  \tfloat w = 1.0;\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n    w = - 1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n    w = - 1.0;\n    \n\t} \n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n    w = - 1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n    w = - 1.0;\n\t\n\t}\n\n\treturn w * texture2D( tex, uv + offset / resolution ).z;\n\n}\n\nvoid main(){\n\tvec2 uv = gl_FragCoord.xy / resolution;\n\n\tvec2 offsetX = vec2(1.0, 0.0);\n\tvec2 offsetY = vec2(0.0, 1.0);\n\n\tfloat l = smapleVelocity(curlTex, (gl_FragCoord.xy - offsetX) / resolution, resolution).x;\n\tfloat r = smapleVelocity(curlTex, (gl_FragCoord.xy + offsetX) / resolution, resolution).x;\n\tfloat t = smapleVelocity(curlTex, (gl_FragCoord.xy - offsetY) / resolution, resolution).x;\n\tfloat b = smapleVelocity(curlTex, (gl_FragCoord.xy + offsetY) / resolution, resolution).x;\n\tfloat c = texture2D(curlTex, uv).x;\n\t\n\tvec2 force = 0.5 * vec2(abs(b) - abs(t), abs(r) - abs(l));\n\tforce /= length(force) + 0.0001;\n\tforce *= 1.0 * c;\n\tforce.y *= -1.0;\n\n\tvec4 data = texture2D( dataTex, uv);\n\n\tfloat pointerW = 1.0 - smoothstep( 0.0, pointerSize * 0.15, length(uv * vec2( screenAspect, 1.0 ) - pointerPos * vec2( screenAspect, 1.0 ) ) );\n\tvec2 mouse = vec2( 0.0, 0.0 );\n\tmouse += pointerW * pointerVec * 0.1;\n\t// data.xy = mix( data.xy, pointerVec * 0.3, pointerW);\n\n\tgl_FragColor = vec4(data.xy + mouse + force * 0.5, data.zw);\n}"},function(t,i){t.exports="uniform vec2 resolution;\nuniform sampler2D dataTex;\n\nvec2 sampleData( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\tfloat w = 1.0;\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\t\tw = -1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\tw = -1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\t\tw = -1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\tw = -1.0;\n\t\n\t}\n\n\treturn w * texture2D( tex, uv + offset / resolution ).xy;\n\n}\n\nvoid main(){\n\n  vec4 data = texture2D(dataTex, gl_FragCoord.xy / resolution);\n\n  vec2 offsetX = vec2(1.0, 0.0);\n  vec2 offsetY = vec2(0.0, 1.0);\n\n  vec2 l = sampleData(dataTex, (gl_FragCoord.xy - offsetX) / resolution, resolution);\n  vec2 r = sampleData(dataTex, (gl_FragCoord.xy + offsetX) / resolution, resolution);\n  vec2 t = sampleData(dataTex, (gl_FragCoord.xy - offsetY) / resolution, resolution);\n  vec2 b = sampleData(dataTex, (gl_FragCoord.xy + offsetY) / resolution, resolution);\n\n  float divergence = ((r.x - l.x) + (b.y - t.y)) * 0.5;\n\n  gl_FragColor = vec4(data.xyz, divergence);\n}"},function(t,i){t.exports="uniform vec2 resolution;\nuniform sampler2D dataTex;\n\nuniform float velocityAttenuation;\nuniform float pressureAttenuation;\n\nvec2 sampleVelocity( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\tfloat w = 1.0;\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\t\tw = - 1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\tw = - 1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\t\tw = - 1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\tw = - 1.0;\n\t\n\t}\n\n\treturn w * texture2D( tex, uv + offset / resolution ).xy;\n\n}\n\nfloat samplePressure( sampler2D tex, vec2 uv, vec2 resolution ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\n\t}\n\n\treturn texture2D( tex, uv + offset / resolution ).z;\n\n}\n\nvoid main(){\n\tvec2 uv =  gl_FragCoord.xy / resolution;\n\tvec2 p = gl_FragCoord.xy - sampleVelocity(dataTex, uv, resolution);\n\tgl_FragColor = vec4(sampleVelocity(dataTex, p / resolution,resolution) * velocityAttenuation, samplePressure(dataTex, uv, resolution) * pressureAttenuation, 0.0);\n}"},function(t,i){t.exports="uniform sampler2D dataTex;\nuniform vec2 resolution;\nuniform float curl;\n\nvec2 sampleData( sampler2D tex, vec2 uv, vec2 res ){\n\n\tvec2 offset = vec2( 0.0, 0.0 );\n\tfloat w = 1.0;\n\t\n\tif( uv.x < 0.0 ){\n\n\t\toffset.x = 1.0;\n\t\tw = -1.0;\n\n\t}else if( uv.x > 1.0 ){\n\n\t\toffset.x = -1.0;\n\t\tw = -1.0;\n\t\n\t}\n\n\tif( uv.y < 0.0 ){\n\n\t\toffset.y = 1.0;\n\t\tw = -1.0;\n\n\t}else if( uv.y > 1.0 ){\n\t\t\n\t\toffset.y = -1.0;\n\t\tw = -1.0;\n\t\n\t}\n\n\treturn w * texture2D( tex, uv + offset / res ).xy;\n\n}\n\nvoid main () {\n\tvec2 uv = gl_FragCoord.xy / resolution;\n\n\tvec2 offsetX = vec2(1.0, 0.0);\n\tvec2 offsetY = vec2(0.0, 1.0);\n\n\tfloat l = sampleData(dataTex, (gl_FragCoord.xy - offsetX) / resolution, resolution).y;\n\tfloat r = sampleData(dataTex, (gl_FragCoord.xy + offsetX) / resolution, resolution).y;\n\tfloat t = sampleData(dataTex, (gl_FragCoord.xy - offsetY) / resolution, resolution).x;\n\tfloat b = sampleData(dataTex, (gl_FragCoord.xy + offsetY) / resolution, resolution).x;\n\n\tfloat c = (r - l - b + t);\n\tgl_FragColor = vec4(curl * c, 0.0, 0.0, 1.0);\n}"},function(t){t.exports=JSON.parse('{"name":"ore-three-ts","version":"0.3.10","description":"Three.js utils.","main":"build/ore-three.js","scripts":{"dev":"webpack-dev-server --watch-content-base --config ./webpack/dev.config.js","build":"npm run build:module && npm run build:min && npm run build:types && npm run build:typedoc && npm run build:examples","build:module":"webpack --config ./webpack/build-module.config.js","build:min":"webpack --config ./webpack/build-min.config.js","build:types":"tsc --emitDeclarationOnly","build:typedoc":"typedoc --out ./docs/documentation/ ./src/ --mode file --name ore-three","build:examples":"webpack --config ./webpack/build-examples.config.js"},"repository":{"type":"git","url":"git@github.com:ukonpower/ore-three-ts.git"},"keywords":["threejs","webgl"],"types":"types/index.d.ts","files":["build","src","types"],"author":"ukonpower","bugs":{"url":"https://github.com/ukonpower/ore-three-ts/issues"},"license":"MIT","devDependencies":{"@types/cannon":"^0.1.4","cannon":"^0.6.2","copy-webpack-plugin":"^5.0.4","oimo":"^1.0.9","shader-loader":"^1.3.1","three":"^0.112.0","ts-loader":"^6.0.0","typedoc":"^0.16.4","typescript":"^3.7.4","webpack":"^4.30.0","webpack-cli":"^3.3.2","webpack-dev-server":"^3.3.1","webpack-merge":"^4.2.1"},"dependencies":{}}')},function(t,e,s){"use strict";s.r(e);var o,n=s(0),r=function(){function t(){this.attenuation=.9,this._position=new n.Vector2(0,0),this._delta=new n.Vector2(0,0),this._hoverPosition=new n.Vector2(0,0),this._hoverDelta=new n.Vector2(0,0);var t=navigator.userAgent;t.indexOf("iPhone")>=0||t.indexOf("iPad")>=0||t.indexOf("Android")>=0?(window.addEventListener("touchstart",this._MouseEvent.bind(this,"start")),window.addEventListener("touchmove",this._MouseEvent.bind(this,"move"),{passive:!1}),window.addEventListener("touchend",this._MouseEvent.bind(this,"end"))):(window.addEventListener("mousedown",this._MouseEvent.bind(this,"start")),window.addEventListener("mousemove",this._MouseEvent.bind(this,"move")),window.addEventListener("mouseup",this._MouseEvent.bind(this,"end")),window.addEventListener("dragend",this._MouseEvent.bind(this,"end")),window.addEventListener("wheel",this.wheel.bind(this),{passive:!1})),this._position.set(NaN,NaN),this._hoverPosition.set(NaN,NaN),this._touchDown=!1}return Object.defineProperty(t.prototype,"position",{get:function(){return this._position},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"delta",{get:function(){return this._delta},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hoverPosition",{get:function(){return this._hoverPosition},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hoverDelta",{get:function(){return this._hoverDelta},enumerable:!0,configurable:!0}),t.prototype.getRelativePosition=function(t,i){var e,s=t.getClientRects()[0],o=(e=this._hoverPosition).x-s.left,r=e.y-s.top;return i&&(o/=s.width,r/=s.height),new n.Vector2(o,r)},t.prototype.setPos=function(t,i){this._touchDown?(this._position.x!=this._position.x||this._position.y!=this._position.y?this._delta.set(0,0):this._delta.set(t-this._position.x,i-this._position.y),this._position.set(t,i)):(this._position.set(NaN,NaN),this._delta.set(0,0)),this._hoverPosition.x!=this._hoverPosition.x||this._hoverPosition.y!=this._hoverPosition.y?this._hoverDelta.set(0,0):this._hoverDelta.set(t-this._hoverPosition.x,i-this._hoverPosition.y),this._hoverPosition.set(t,i)},t.prototype._MouseEvent=function(t,i){var e,s;"touches"in i?i.touches.length>0&&(e=i.touches[0].clientX,s=i.touches[0].clientY):0==i.button&&(e=i.pageX-window.pageXOffset,s=i.pageY-window.pageYOffset),"start"==t?(this._touchDown=!0,this.setPos(e,s),this.onTouchStart&&this.onTouchStart(i)):"move"==t?(this.setPos(e,s),this._touchDown&&this.onTouchMove&&this.onTouchMove(i)):"end"==t&&(this._touchDown=!1,this.setPos(e,s),this.onTouchEnd&&this.onTouchEnd(i))},t.prototype.wheel=function(t){this.onWheel&&this.onWheel(t)},t.prototype.update=function(){this._delta.multiplyScalar(this.attenuation),this._hoverDelta.multiplyScalar(this.attenuation),this.onHover&&this.onHover()},t}(),a=s(18).version,h=function(){function t(t){t.silent||console.log("%c- ore-three "+a+" -","padding: 5px 10px ;background-color: black; color: white;font-size:11px"),this.renderer=new n.WebGLRenderer(t),this.renderer.debug.checkShaderErrors=!0,this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(t.retina?window.devicePixelRatio:1),this.cursor=new r,this.cursor.onTouchStart=this.onTouchStart.bind(this),this.cursor.onTouchMove=this.onTouchMove.bind(this),this.cursor.onTouchEnd=this.onTouchEnd.bind(this),this.cursor.onHover=this.onHover.bind(this),this.cursor.onWheel=this.onWheel.bind(this),this.clock=new n.Clock,this.gProps={renderer:this.renderer,cursor:this.cursor},window.addEventListener("orientationchange",this.onOrientationDevice.bind(this)),window.addEventListener("resize",this.onWindowResize.bind(this)),this.onWindowResize(),this.tick()}return t.prototype.tick=function(){var t=this.clock.getDelta();this.cursor.update(),this.currentScene&&this.currentScene.tick(t),requestAnimationFrame(this.tick.bind(this))},t.prototype.bindScene=function(t){this.currentScene=t,this.currentScene.onBind(this.gProps),this.onWindowResize()},t.prototype.unbindScene=function(){this.currentScene&&(this.currentScene.onUnbind(),this.currentScene=null,this.renderer.renderLists.dispose())},t.prototype.onWindowResize=function(){var t=new n.Vector2(window.innerWidth,window.innerHeight);this.renderer.setSize(t.x,t.y),this.currentScene&&this.currentScene.onResize({aspectRatio:t.x/t.y,pixelRatio:this.renderer.getPixelRatio(),windowSize:t,windowPixelSize:t.clone().multiplyScalar(this.renderer.getPixelRatio())})},t.prototype.onOrientationDevice=function(){this.onWindowResize()},t.prototype.onTouchStart=function(t){this.currentScene&&this.currentScene.onTouchStart(this.cursor,t)},t.prototype.onTouchMove=function(t){this.currentScene&&this.currentScene.onTouchMove(this.cursor,t)},t.prototype.onTouchEnd=function(t){this.currentScene&&this.currentScene.onTouchEnd(this.cursor,t)},t.prototype.onHover=function(){this.currentScene&&this.currentScene.onHover(this.cursor)},t.prototype.onWheel=function(t){this.currentScene&&this.currentScene.onWheel(t)},t}();!function(t){t.sigmoid=function(t,i){var e=6;i[0]&&(e=i[0]);var s=Math.exp(-e*(2*t-1)),o=Math.exp(-e);return(1+(1-s)/(1+s)*(1+o)/(1-o))/2},t.smoothstep=function(t,i,e){var s=Math.max(0,Math.min(1,e-t/(i-t)));return s*s*(3-2*s)},t.linear=function(t){return t},t.easeInQuad=function(t){return t*t},t.easeOutQuad=function(t){return t*(2-t)},t.easeInOutQuad=function(t){return t<.5?2*t*t:(4-2*t)*t-1},t.easeInCubic=function(t){return t*t*t},t.easeOutCubic=function(t){return--t*t*t+1},t.easeInOutCubic=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},t.easeInQuart=function(t){return t*t*t*t},t.easeOutQuart=function(t){return 1- --t*t*t*t},t.easeInOutQuart=function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},t.easeInQuint=function(t){return t*t*t*t*t},t.easeOutQuint=function(t){return 1+--t*t*t*t*t},t.easeInOutQuint=function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}}(o||(o={}));var l=function(){function t(t){this.enabled=!0,this._velocity=0,this._pageOffset=0,this._pageOffsetMem=0,this.velocityAttenuation=.95,this.x=1,this.isAutoMoving=!1,this.autoMovingLock=!1,this.forceAutoMove=!1,this.sections=[],this.sectionScrollPercentages={},this.threePosition=new n.Vector3(0,0,0),this.threeRotation=new n.Quaternion(0,0,0),this.isStop=!1,this.stopSection=null,this.element=t,this.rect=this.element.getBoundingClientRect(),this.initEasings()}return Object.defineProperty(t.prototype,"pageOffset",{get:function(){return this._pageOffset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scrollVel",{get:function(){return this._velocity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scrollPercentage",{get:function(){for(var t=0,i=1;i<this.sections.length;i++)t+=this.sectionScrollPercentages[this.sections[i].name];return t/(this.sections.length-1)},enumerable:!0,configurable:!0}),t.prototype.getScrollPercentage=function(t){var i=0;t||(t=[this.sections[0].name,this.sections[this.sections.length-1].name]);for(var e=0;e<t.length-1;e++){for(var s=this.getSection(t[e]),o=this.getSection(t[e+1]),n=0,r=o.num-s.num,a=s.num+1;a<=o.num;a++)n+=this.sectionScrollPercentages[this.sections[a].name];i+=n/r}return i/(t.length-1)},t.prototype.initEasings=function(){this.easingPos={func:o.linear,variables:null},this.easingRot={func:o.linear,variables:null},this.easingAutoMove={func:o.sigmoid,variables:[6]}},t.prototype.addVelocity=function(t){this.enabled&&(this.autoMovingLock||this.isStop&&!this.checkUnlockStopScroll(t,"add")||(this._velocity+=t))},t.prototype.setVelocity=function(t){this.enabled&&(this.autoMovingLock||this.isStop&&!this.checkUnlockStopScroll(t,"set")||(this._velocity=t))},t.prototype.checkUnlockStopScroll=function(t,i){var e,s=this.sections[this.stopSection];return(e=!s.events.onStartScroll||s.events.onStartScroll({scroller:this,section:s,scrollVelocity:t,scrollMode:i}))&&(this.isStop=!1,this.stopSection=null),e},t.prototype.setEasingPos=function(t){for(var i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];this.easingPos.func=t,this.easingPos.variables=i},t.prototype.setEasingRot=function(t){for(var i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];this.easingRot.func=t,this.easingRot.variables=i},t.prototype.setEasingAutoMove=function(t){for(var i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];this.easingAutoMove.func=t,this.easingAutoMove.variables=i},t.prototype.moveto=function(t){if(this.enabled||t.force){var i;if("string"==typeof t.target){var e=this.getSection(t.target);if(!e)return void console.log(t.target+"is not exist.");i=t.bottom?e.rect.bottom-window.innerHeight:e.rect.top}else{i=t.target.getBoundingClientRect().top}this.baseOffset=this.pageOffset,this.x=0,this._velocity=0,this.isAutoMoving=!0,this.duration=t.duration||1,this.autoMovingLock=t.lock||!1,this.scrollDistance=i-this.baseOffset,this.onAutoMoveFinished=t.callback,this.forceAutoMove=t.force||!1,!this.isStop||this.checkUnlockStopScroll(this.scrollDistance,"auto")}},t.prototype.update=function(t){this.isStop||(this.updateScroll(t),this.checkThrowSection()),this.calcScrollPercentage(),this.currentSectionNum=this.getCurrentSection(),this.calcThreePosition(),this.calcThreeRotation(),this.applyPageOffset(this.pageOffset)},t.prototype.updateScroll=function(t){if(this._pageOffsetMem=this.pageOffset,this.isAutoMoving){if(!this.enabled&&!this.forceAutoMove)return;this.autoScroll(t)}else{if(!this.enabled)return;this.manualScroll(t)}},t.prototype.manualScroll=function(t){this._pageOffset+=this._velocity,this._pageOffset=Math.min(Math.max(0,this.pageOffset),this.rect.height-window.innerHeight),this._velocity*=this.velocityAttenuation},t.prototype.autoScroll=function(t){this.x+=(t||.016)/this.duration;var i=!1;this.x>=1&&(i=!0,this.x=1);var e=this.easingAutoMove.func(this.x,this.easingAutoMove.variables),s=this.baseOffset+this.scrollDistance*e;this._velocity=s-this._pageOffset,this._pageOffset=s,i&&(this.onAutoMoveFinished&&this.onAutoMoveFinished(),this.isAutoMoving=!1,this.onAutoMoveFinished=null,this._velocity=0,this.autoMovingLock=!1)},t.prototype.applyPageOffset=function(t){this.element.style.transform="translate3d( 0,"+-t+"px,0 )"},t.prototype.checkThrowSection=function(){var t;for(t=0;t<this.sections.length;t++){var i=this.sections[t],e=void 0,s=this._pageOffset,o=this._pageOffsetMem;i.bottom?(e=i.rect.bottom,s+=window.innerHeight,o+=window.innerHeight):e=i.rect.top;for(var n=0;n<i.events.onArrivals.length;n++){var r=0;if(s>=(r=i.bottom?i.rect.bottom+i.rect.height*i.events.onArrivals[n].percentage:i.rect.top+i.rect.height*i.events.onArrivals[n].percentage)&&r>o||s<=r&&r<o){i.events.onArrivals[n].event({scroller:this,section:i,scrollVelocity:this._velocity,scrollMode:this.isAutoMoving?"auto":"manual"});break}}(s>=e&&e>o||s<=e&&e<o||s==o&&s==e)&&this.onThrowSection(t)}},t.prototype.onThrowSection=function(t){if(this.stopSection!=t){var i=this.sections[t];i.stop&&(this.isAutoMoving?i.events.onStartScroll&&i.events.onStartScroll({scroller:this,section:i,scrollVelocity:this._velocity,scrollMode:"auto"}):(this.isStop=!0,this.stopSection=t,this._velocity=0,this.setPageOffsetToSection(t)))}},t.prototype.setPageOffsetToSection=function(t){this.sections[t].bottom?this._pageOffset=this.sections[t].rect.bottom-window.innerHeight:this._pageOffset=this.sections[t].rect.top},t.prototype.getSection=function(t){for(var i=0;i<this.sections.length;i++)if(this.sections[i].name==t)return this.sections[i];return null},t.prototype.getCurrentSection=function(){for(var t=0;t<this.sections.length;t++){var i=this.sections[t],e=this.sectionScrollPercentages[i.name],s=this.sections[t+1];if(null==s){if(e>0)return t;break}var o=this.sectionScrollPercentages[s.name];if(e>0&&0==o)return t}},t.prototype.calcScrollPercentage=function(){for(var t=1;t<this.sections.length;t++){var i=this.sections[t-1],e=this.sections[t],s=i.bottom?i.rect.bottom:i.rect.top,o=e.bottom?e.rect.bottom:e.rect.top,n=void 0,r=void 0;e.bottom?i.bottom?(n=this._pageOffset+window.innerHeight-s,r=o-s):(n=this._pageOffset-s,r=o-s-window.innerHeight):i.bottom?(n=this._pageOffset-s+window.innerHeight,r=o-s+window.innerHeight):(n=this._pageOffset-s,r=o-s);var a=n/r,h=Math.min(1,Math.max(0,a));this.sectionScrollPercentages[e.name]=h}},t.prototype.calcThreePosition=function(){for(var t,i,e,s,o=this.currentSectionNum-1;o>=0&&(t=o,null==(e=this.sections[t].threePosition));o--);for(o=this.currentSectionNum;o<this.sections.length&&(i=o,null==(s=this.sections[i].threePosition));o++);var r=0,a=0;if(e&&s){for(o=t+1;o<=i;o++)r+=this.sectionScrollPercentages[this.sections[o].name],a++;var h=this.sections[this.currentSectionNum],l=this.calcThreeEasings(r/a,h,"pos");this.threePosition.copy(e.clone().add((new n.Vector3).subVectors(s,e).multiplyScalar(l)))}else e?this.threePosition.copy(e):s&&this.threePosition.copy(s)},t.prototype.calcThreeRotation=function(){for(var t,i,e,s,o=this.currentSectionNum-1;o>=0&&(t=o,null==(e=this.sections[t].threeRotation));o--);for(o=this.currentSectionNum;o<this.sections.length&&(i=o,null==(s=this.sections[i].threeRotation));o++);var n=0,r=0;if(e&&s){for(o=t+1;o<=i;o++)n+=this.sectionScrollPercentages[this.sections[o].name],r++;var a=this.sections[this.currentSectionNum],h=this.calcThreeEasings(n/r,a,"rot");this.threeRotation.copy(e.clone().slerp(s,h))}else e?this.threeRotation.copy(e):s&&this.threeRotation.copy(s)},t.prototype.calcThreeEasings=function(t,i,e){return"pos"==e?i.sectionEasings&&i.sectionEasings.position?i.sectionEasings.position.func(t,i.sectionEasings.position.variables):this.easingPos.func(t,this.easingPos.variables):"rot"==e?i.sectionEasings&&i.sectionEasings.rotation?i.sectionEasings.rotation.func(t,i.sectionEasings.rotation.variables):this.easingRot.func(t,this.easingRot.variables):void 0},t.prototype.registerSection=function(t){this.sections.push(t),this.sectionScrollPercentages[t.name]=0,this._pageOffset=0,this.currentSectionNum=0,this.resize(),this.sortSections(),this.calcScrollPercentage()},t.prototype.sortSections=function(){this.sections.sort((function(t,i){return(t.bottom?t.rect.bottom:t.rect.top)>(i.bottom?i.rect.bottom:i.rect.top)?1:-1}));for(var t=!1,i=0;i<this.sections.length;i++)this.sections[i].num=i,!t&&this.sections[i].threePosition&&(this.threePosition.copy(this.sections[i].threePosition),t=!0);this.sectionScrollPercentages[this.sections[0].name]=1},t.prototype.resize=function(){this.rect=this.element.getBoundingClientRect();for(var t=0;t<this.sections.length;t++)this.sections[t].resize(this._pageOffset)},t}(),c=function(){function t(t){var i=t.element.getBoundingClientRect(),e={top:i.top,bottom:i.bottom,width:i.width,height:i.height};this._name=t.name,this._element=t.element,this._rect=e,this.bottom=t.bottom||!1,this.stop=t.stop||!1,this.threePosition=t.threePosition||null,this.threeRotation=t.threeRotation||null,this._events={onStartScroll:null,onArrivals:[]},t.events&&(this._events.onArrivals=t.events.onArrivals||[],this._events.onStartScroll=t.events.onStartScroll||null),this.sectionEasings={position:null,rotation:null},t.sectionEasings&&t.sectionEasings.position&&(this.sectionEasings.position={func:t.sectionEasings.position.func||null,variables:t.sectionEasings.position.variables||[]}),t.sectionEasings&&t.sectionEasings.rotation&&(this.sectionEasings.rotation={func:t.sectionEasings.rotation.func||null,variables:t.sectionEasings.rotation.variables||[]})}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"element",{get:function(){return this._element},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"events",{get:function(){return this._events},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rect",{get:function(){return this._rect},enumerable:!0,configurable:!0}),t.prototype.resize=function(t){var i=this._element.getBoundingClientRect();this.rect.bottom=i.bottom+t,this.rect.top=i.top+t,this.rect.width=i.width,this.rect.height=i.height},t.prototype.addArrivalEvent=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];Array.prototype.push.apply(this._events.onArrivals,t)},t}(),u=function(){function t(){this.time=0,this.name="",this.scene=new n.Scene,this.camera=new n.PerspectiveCamera(50,innerWidth/innerHeight,.1,1e3)}return t.prototype.tick=function(t){this.time+=t,this.animate(t)},t.prototype.animate=function(t){},t.prototype.onBind=function(t){this.gProps=t},t.prototype.onUnbind=function(){this.removeChildrens(this.scene)},t.prototype.removeChildrens=function(t){for(var i=t.children.length-1;i>=0;i--){this.removeChildrens(t.children[i]);var e=void 0,s=void 0;t.children[i].isMesh&&(e=t.children[i].geometry,s=t.children[i].material),t.remove(t.children[i]),e&&e.dispose(),s&&s.dispose()}},t.prototype.onResize=function(t){this.camera.aspect=t.aspectRatio,this.camera.updateProjectionMatrix()},t.prototype.onTouchStart=function(t,i){},t.prototype.onTouchMove=function(t,i){},t.prototype.onTouchEnd=function(t,i){},t.prototype.onHover=function(t){},t.prototype.onWheel=function(t){},t}(),p=function(){function t(t){this.target=t,this.scrollVel=new n.Vector2}return t.prototype.update=function(){this.scrollVel.multiplyScalar(.96);var t=new n.Vector3(this.scrollVel.y,this.scrollVel.x,0).normalize(),i=(new n.Quaternion).setFromAxisAngle(t,this.scrollVel.length());i.multiply(this.target.quaternion),this.target.quaternion.copy(i)},t.prototype.addVelocity=function(t){this.scrollVel.addVectors(this.scrollVel,t.multiplyScalar(.001))},t}(),d=function(){function t(t,i){this.target=t,this.rotate=new n.Quaternion,this.rotMat=new n.Matrix4,this.scrollVel=new n.Vector2(0,0),this.uniform=i,this.uniform.rotVec={value:this.scrollVel},this.uniform.rotation={value:null}}return t.prototype.update=function(){this.scrollVel.multiplyScalar(.96);var t=new n.Vector3(this.scrollVel.y,this.scrollVel.x,0).normalize(),i=(new n.Quaternion).setFromAxisAngle(t,this.scrollVel.length());i.multiply(this.rotate),this.rotate.copy(i),this.uniform.rotation.value=this.rotMat.compose(new n.Vector3,this.rotate,this.target.scale)},t.prototype.addVelocity=function(t){this.scrollVel.addVectors(this.scrollVel,t.multiplyScalar(.001))},t}(),m=function(){function t(t){this.x=0,this.duration=1,this.isMoving=!1,this.force=!1,this.objPos=t.position,this.objRot=t.rotation,this.setBaseTransform()}return t.prototype.setBaseTransform=function(){this.basePos=this.objPos.clone(),this.baseRot=this.objRot.toVector3()},t.prototype.move=function(t,i,e,s){return void 0===t&&(t=null),void 0===i&&(i=null),void 0===e&&(e=1),!(this.isMoving&&!this.force)&&(t||(t=this.objPos.clone()),i||(i=this.objRot.clone()),s&&(this.onFinish=s),this.duration=e,this.setBaseTransform(),this.goalPos=t.clone(),this.goalRot=i.toVector3(),this.distancePos=(new n.Vector3).subVectors(this.goalPos,this.basePos),this.distanceRot=(new n.Vector3).subVectors(this.goalRot,this.baseRot),this.x=0,this.isMoving=!0,!0)},t.prototype.update=function(t){var i=!1;if(this.isMoving){this.x+=(t||.016)/this.duration,this.x>1&&(this.x=1,i=!0);var e=this.sigmoid(6,this.x);this.objPos.set(this.basePos.x+this.distancePos.x*e,this.basePos.y+this.distancePos.y*e,this.basePos.z+this.distancePos.z*e),this.objRot.set(this.baseRot.x+this.distanceRot.x*e,this.baseRot.y+this.distanceRot.y*e,this.baseRot.z+this.distanceRot.z*e),i&&(this.x=0,this.isMoving=!1,this.onFinish&&(this.onFinish(),this.onFinish=null))}},t.prototype.sigmoid=function(t,i){var e=Math.exp(-t*(2*i-1)),s=Math.exp(-t);return(1+(1-e)/(1+e)*(1+s)/(1-s))/2},t}(),y=function(){function t(t,i){this.isLoaded=!1,this.loadingManager=i,this.listener=t.listener?t.listener:new n.AudioListener,this.audio=new n.Audio(this.listener),this.bufferSize=t.bufferSize?t.bufferSize:128,t.src&&this.load(t.src)}return Object.defineProperty(t.prototype,"isPlaying",{get:function(){return!!this.audio&&this.audio.isPlaying},enumerable:!0,configurable:!0}),t.prototype.load=function(t){var i=this;this.audio.buffer&&this.audio.stop();var e=new n.AudioLoader(this.loadingManager);this.isLoaded=!1,e.load(t,(function(t){i.audio.setBuffer(t),i.audio.setLoop(!0),i.audio.setVolume(.5),i.analyser=new n.AudioAnalyser(i.audio,i.bufferSize),i.spectrumData=new n.DataTexture(i.analyser.data,i.bufferSize/2,1,n.LuminanceFormat),i.spectrumData.needsUpdate=!0,i.isLoaded=!0,i.onLoad&&(i.onLoad(),i.onLoad=null)}),(function(t){console.log(t.loaded/t.total*100+"% loaded")}),(function(t){console.log("An error happened: "+t)}))},t.prototype.play=function(){var t=this;this.isLoaded?this.audio.play():this.onLoad=function(){t.audio.play()}},t.prototype.pause=function(){this.audio.isPlaying&&this.audio.pause()},t.prototype.stop=function(){this.audio.stop()},t.prototype.update=function(){this.analyser&&(this.analyser.getFrequencyData(),this.volume=this.analyser.getAverageFrequency(),this.spectrumData&&(this.spectrumData.needsUpdate=!0))},t}(),f=function(){function t(t,i){this.volume=0,this.navigator=t,this.bufferSize=i,this.navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.onGetUserMedia.bind(this))}return t.prototype.onGetUserMedia=function(t){this.context=new(window.AudioContext||window.webkitAudioContext),this.analyzer=this.context.createAnalyser(),this.analyzer.fftSize=this.bufferSize,this.analyzer.smoothingTimeConstant=.8,this.bufferArray=new Uint8Array(this.analyzer.frequencyBinCount),this.spectrumData=new n.DataTexture(this.bufferArray,this.bufferSize/2,1,n.LuminanceFormat);var i=this.context.createMediaStreamSource(t);this.processor=this.context.createScriptProcessor(this.bufferSize,1,1),i.connect(this.analyzer),this.analyzer.connect(this.processor),this.processor.connect(this.context.destination),this.processor.addEventListener("audioprocess",this.onProcess.bind(this))},t.prototype.onProcess=function(t){this.analyzer.getByteFrequencyData(this.bufferArray),this.spectrumData.needsUpdate=!0,this.calcVolume()},t.prototype.calcVolume=function(){for(var t=0,i=0;i<this.bufferArray.length;i++)t+=this.bufferArray[i];this.volume=t/this.bufferArray.length},t}(),v=s(1),x=function(){function t(t,i){this.objs=[],this.scene=t,this.cannonGroup=new n.Group,this.cannonGroup.name="cannon",this.scene.add(this.cannonGroup),i=i||{},this.world=new v.World,this.world.gravity.copy(i.gravity||new v.Vec3(0,-9.82,0)),this.world.broadphase=new v.NaiveBroadphase,this.world.iterations=null!=i.iterations?i.iterations:10}return t.prototype.add=function(t,i){if(i=i||{},this.cannonGroup.add(t),!i.shape){var e=this.createShape(t);i.shape=e}var s=new v.Body(i);return s.position.copy(t.position),s.quaternion.copy(t.quaternion),this.world.addBody(s),this.objs.push({threeObj:t,body:s}),s},t.prototype.createShape=function(t){var i,e=t.scale,s=t.geometry;if(s){var o=s.type;if(-1!==o.indexOf("Box"))(n=s.parameters).width=void 0===n.width?1:n.width,n.height=void 0===n.height?1:n.height,n.depth=void 0===n.depth?1:n.depth,i=new v.Box(new v.Vec3(n.width/2*e.x,n.height/2*e.y,n.depth/2*e.z));else if(-1!==o.indexOf("Sphere")){(n=s.parameters).radius=void 0===n.radius?1:n.radius,i=new v.Sphere(n.radius*Math.max(e.x,Math.max(e.y,e.z)))}else if(-1!==o.indexOf("Plane"))i=new v.Plane;else if(-1!==o.indexOf("Cylinder")){var n;(n=s.parameters).radiusTop=void 0===n.radiusTop?1:n.radiusTop,n.radiusBottom=void 0===n.radiusBottom?1:n.radiusBottom,n.height=void 0===n.height?1:n.height;var r=Math.max(e.x,e.z);i=new v.Cylinder(n.radiusTop*r,n.radiusBottom*r,n.height*e.y,n.radialSegments)}else i=new v.Sphere(1)}return i},t.prototype.update=function(t){this.world.step(t);for(var i=0;i<this.objs.length;i++){var e=this.objs[i];e.threeObj.position.copy(e.body.position),e.threeObj.quaternion.copy(e.body.quaternion)}},t}();void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),e=1;e<arguments.length;e++){var s=arguments[e];if(null!=s)for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(i[o]=s[o])}return i});var b,g,w,z,N="1.0.9",S=0,M=1,P=2,k=3,A=0,V=0,T=1,I=2,L=3,C=4,B=5,E=0,R=1,F=2,q=3,j=4,O=5,D=6,_={sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,INF:1/0,EPZ:1e-5,EPZ2:1e-6,lerp:function(t,i,e){return(1-e)*t+e*i},randInt:function(t,i){return t+_.floor(_.random()*(i-t+1))},rand:function(t,i){return t+_.random()*(i-t)},generateUUID:(g="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),w=new Array(36),z=0,function(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?w[t]="-":14===t?w[t]="4":(z<=2&&(z=33554432+16777216*Math.random()|0),b=15&z,z>>=4,w[t]=g[19===t?3&b|8:b]);return w.join("")}),int:function(t){return _.floor(t)},fix:function(t,i){return t.toFixed(i||3,10)},clamp:function(t,i,e){return _.max(i,_.min(e,t))},distance:function(t,i){var e=i[0]-t[0],s=i[1]-t[1],o=i[2]-t[2];return _.sqrt(e*e+s*s+o*o)},acosClamp:function(t){return t>1?0:t<-1?_.PI:_.acos(t)},distanceVector:function(t,i){var e=t.x-i.x,s=t.y-i.y,o=t.z-i.z;return e*e+s*s+o*o},dotVectors:function(t,i){return t.x*i.x+t.y*i.y+t.z*i.z}};function W(t,i){console.error("[OIMO] "+t+": "+i)}function U(t){this.parent=t,this.infos=new Float32Array(13),this.f=[0,0,0],this.times=[0,0,0,0],this.broadPhase=this.parent.broadPhaseType,this.version=N,this.fps=0,this.tt=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0,this.updateTime=0,this.MaxBroadPhaseTime=0,this.MaxNarrowPhaseTime=0,this.MaxSolvingTime=0,this.MaxTotalTime=0,this.MaxUpdateTime=0}function H(t,i,e){this.x=t||0,this.y=i||0,this.z=e||0}function G(t,i,e,s){this.x=t||0,this.y=i||0,this.z=e||0,this.w=void 0!==s?s:1}function X(t,i,e,s,o,n,r,a,h){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("OIMO.Mat33: the constructor no longer reads arguments. use .set() instead.")}function Y(t,i,e,s,o,n){this.elements=new Float32Array(6);var r=this.elements;r[0]=t||0,r[1]=e||0,r[2]=o||0,r[3]=i||0,r[4]=s||0,r[5]=n||0}Object.assign(U.prototype,{setTime:function(t){this.times[t||0]=performance.now()},resetMax:function(){this.MaxBroadPhaseTime=0,this.MaxNarrowPhaseTime=0,this.MaxSolvingTime=0,this.MaxTotalTime=0,this.MaxUpdateTime=0},calcBroadPhase:function(){this.setTime(2),this.broadPhaseTime=this.times[2]-this.times[1]},calcNarrowPhase:function(){this.setTime(3),this.narrowPhaseTime=this.times[3]-this.times[2]},calcEnd:function(){this.setTime(2),this.solvingTime=this.times[2]-this.times[1],this.totalTime=this.times[2]-this.times[0],this.updateTime=this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime),100===this.tt&&this.resetMax(),this.tt>100&&(this.broadPhaseTime>this.MaxBroadPhaseTime&&(this.MaxBroadPhaseTime=this.broadPhaseTime),this.narrowPhaseTime>this.MaxNarrowPhaseTime&&(this.MaxNarrowPhaseTime=this.narrowPhaseTime),this.solvingTime>this.MaxSolvingTime&&(this.MaxSolvingTime=this.solvingTime),this.totalTime>this.MaxTotalTime&&(this.MaxTotalTime=this.totalTime),this.updateTime>this.MaxUpdateTime&&(this.MaxUpdateTime=this.updateTime)),this.upfps(),this.tt++,this.tt>500&&(this.tt=0)},upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},show:function(){return["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconds<br><br>","broadphase &nbsp;"+_.fix(this.broadPhaseTime)+" | "+_.fix(this.MaxBroadPhaseTime)+"<br>","narrowphase "+_.fix(this.narrowPhaseTime)+" | "+_.fix(this.MaxNarrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;"+_.fix(this.solvingTime)+" | "+_.fix(this.MaxSolvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+_.fix(this.totalTime)+" | "+_.fix(this.MaxTotalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;"+_.fix(this.updateTime)+" | "+_.fix(this.MaxUpdateTime)+"<br>"].join("\n")},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updateTime,this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}}),Object.assign(H.prototype,{Vec3:!0,set:function(t,i,e){return this.x=t,this.y=i,this.z=e,this},add:function(t,i){return void 0!==i?this.addVectors(t,i):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addVectors:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},sub:function(t,i){return void 0!==i?this.subVectors(t,i):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subVectors:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},scale:function(t,i){return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiply:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},addScaledVector:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},subScaledVector:function(t,i){return this.x-=t.x*i,this.y-=t.y*i,this.z-=t.z*i,this},cross:function(t,i){if(void 0!==i)return this.crossVectors(t,i);var e=this.x,s=this.y,o=this.z;return this.x=s*t.z-o*t.y,this.y=o*t.x-e*t.z,this.z=e*t.y-s*t.x,this},crossVectors:function(t,i){var e=t.x,s=t.y,o=t.z,n=i.x,r=i.y,a=i.z;return this.x=s*a-o*r,this.y=o*n-e*a,this.z=e*r-s*n,this},tangent:function(t){var i=t.x,e=t.y,s=t.z;return this.x=e*i-s*s,this.y=-s*e-i*i,this.z=i*s+e*e,this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},addition:function(){return this.x+this.y+this.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return _.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyMatrix3:function(t,i){var e=this.x,s=this.y,o=this.z,n=t.elements;return i?(this.x=n[0]*e+n[1]*s+n[2]*o,this.y=n[3]*e+n[4]*s+n[5]*o,this.z=n[6]*e+n[7]*s+n[8]*o):(this.x=n[0]*e+n[3]*s+n[6]*o,this.y=n[1]*e+n[4]*s+n[7]*o,this.z=n[2]*e+n[5]*s+n[8]*o),this},applyQuaternion:function(t){var i=this.x,e=this.y,s=this.z,o=t.x,n=t.y,r=t.z,a=t.w,h=a*i+n*s-r*e,l=a*e+r*i-o*s,c=a*s+o*e-n*i,u=-o*i-n*e-r*s;return this.x=h*a+u*-o+l*-r-c*-n,this.y=l*a+u*-n+c*-o-h*-r,this.z=c*a+u*-r+h*-n-l*-o,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return!this.equals(t)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},normalize:function(){return this.divideScalar(this.length())},toArray:function(t,i){void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z},fromArray:function(t,i){return void 0===i&&(i=0),this.x=t[i],this.y=t[i+1],this.z=t[i+2],this}}),Object.assign(G.prototype,{Quat:!0,set:function(t,i,e,s){return this.x=t,this.y=i,this.z=e,this.w=s,this},addTime:function(t,i){var e=t.x,s=t.y,o=t.z,n=this.w,r=this.x,a=this.y,h=this.z;return i*=.5,this.x+=i*(e*n+s*h-o*a),this.y+=i*(s*n+o*r-e*h),this.z+=i*(o*n+e*a-s*r),this.w+=i*(-e*r-s*a-o*h),this.normalize(),this},multiply:function(t,i){return void 0!==i?this.multiplyQuaternions(t,i):this.multiplyQuaternions(this,t)},multiplyQuaternions:function(t,i){var e=t.x,s=t.y,o=t.z,n=t.w,r=i.x,a=i.y,h=i.z,l=i.w;return this.x=e*l+n*r+s*h-o*a,this.y=s*l+n*a+o*r-e*h,this.z=o*l+n*h+e*a-s*r,this.w=n*l-e*r-s*a-o*h,this},setFromUnitVectors:function(t,i){var e=new H,s=t.dot(i)+1;return s<_.EPS2?(s=0,_.abs(t.x)>_.abs(t.z)?e.set(-t.y,t.x,0):e.set(0,-t.z,t.y)):e.crossVectors(t,i),this._x=e.x,this._y=e.y,this._z=e.z,this._w=s,this.normalize()},arc:function(t,i){var e=t.x,s=t.y,o=t.z,n=i.x,r=i.y,a=i.z,h=e*n+s*r+o*a;if(-1==h)return n=s*e-o*o,r=-o*s-e*e,a=e*o+s*s,h=1/_.sqrt(n*n+r*r+a*a),this.w=0,this.x=n*h,this.y=r*h,this.z=a*h,this;var l=s*a-o*r,c=o*n-e*a,u=e*r-s*n;return this.w=_.sqrt(.5*(1+h)),h=.5/this.w,this.x=l*h,this.y=c*h,this.z=u*h,this},normalize:function(){var t=this.length();return 0===t?this.set(0,0,0,1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},inverse:function(){return this.conjugate().normalize()},invert:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this.conjugate().normalize(),this},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},length:function(){return _.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},clone:function(t){return new G(this.x,this.y,this.z,this.w)},testDiff:function(t){return!this.equals(t)},equals:function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},toString:function(){return"Quat["+this.x.toFixed(4)+", ("+this.y.toFixed(4)+", "+this.z.toFixed(4)+", "+this.w.toFixed(4)+")]"},setFromEuler:function(t,i,e){var s=Math.cos(.5*t),o=Math.cos(.5*i),n=Math.cos(.5*e),r=Math.sin(.5*t),a=Math.sin(.5*i),h=Math.sin(.5*e);return this.x=r*o*n+s*a*h,this.y=s*a*n-r*o*h,this.z=s*o*h+r*a*n,this.w=s*o*n-r*a*h,this},setFromAxis:function(t,i){t.normalize(),i*=.5;var e=_.sin(i);return this.x=e*t.x,this.y=e*t.y,this.z=e*t.z,this.w=_.cos(i),this},setFromMat33:function(t){var i,e=t[0]+t[4]+t[8];if(e>0)i=_.sqrt(e+1),this.w=.5/i,i=.5/i,this.x=(t[5]-t[7])*i,this.y=(t[6]-t[2])*i,this.z=(t[1]-t[3])*i;else{var s=[],o=0;t[4]>t[0]&&(o=1),t[8]>t[3*o+o]&&(o=2);var n=(o+1)%3,r=(o+2)%3;i=_.sqrt(t[3*o+o]-t[3*n+n]-t[3*r+r]+1),s[o]=.5*fRoot,i=.5/fRoot,this.w=(t[3*n+r]-t[3*r+n])*i,s[n]=(t[3*n+o]+t[3*o+n])*i,s[r]=(t[3*r+o]+t[3*o+r])*i,this.x=s[1],this.y=s[2],this.z=s[3]}return this},toArray:function(t,i){t[i=i||0]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w},fromArray:function(t,i){return i=i||0,this.set(t[i],t[i+1],t[i+2],t[i+3]),this}}),Object.assign(X.prototype,{Mat33:!0,set:function(t,i,e,s,o,n,r,a,h){var l=this.elements;return l[0]=t,l[1]=i,l[2]=e,l[3]=s,l[4]=o,l[5]=n,l[6]=r,l[7]=a,l[8]=h,this},add:function(t,i){if(void 0!==i)return this.addMatrixs(t,i);var e=this.elements,s=t.elements;return e[0]+=s[0],e[1]+=s[1],e[2]+=s[2],e[3]+=s[3],e[4]+=s[4],e[5]+=s[5],e[6]+=s[6],e[7]+=s[7],e[8]+=s[8],this},addMatrixs:function(t,i){var e=this.elements,s=t.elements,o=i.elements;return e[0]=s[0]+o[0],e[1]=s[1]+o[1],e[2]=s[2]+o[2],e[3]=s[3]+o[3],e[4]=s[4]+o[4],e[5]=s[5]+o[5],e[6]=s[6]+o[6],e[7]=s[7]+o[7],e[8]=s[8]+o[8],this},addEqual:function(t){var i=this.elements,e=t.elements;return i[0]+=e[0],i[1]+=e[1],i[2]+=e[2],i[3]+=e[3],i[4]+=e[4],i[5]+=e[5],i[6]+=e[6],i[7]+=e[7],i[8]+=e[8],this},sub:function(t,i){if(void 0!==i)return this.subMatrixs(t,i);var e=this.elements,s=t.elements;return e[0]-=s[0],e[1]-=s[1],e[2]-=s[2],e[3]-=s[3],e[4]-=s[4],e[5]-=s[5],e[6]-=s[6],e[7]-=s[7],e[8]-=s[8],this},subMatrixs:function(t,i){var e=this.elements,s=t.elements,o=i.elements;return e[0]=s[0]-o[0],e[1]=s[1]-o[1],e[2]=s[2]-o[2],e[3]=s[3]-o[3],e[4]=s[4]-o[4],e[5]=s[5]-o[5],e[6]=s[6]-o[6],e[7]=s[7]-o[7],e[8]=s[8]-o[8],this},subEqual:function(t){var i=this.elements,e=t.elements;return i[0]-=e[0],i[1]-=e[1],i[2]-=e[2],i[3]-=e[3],i[4]-=e[4],i[5]-=e[5],i[6]-=e[6],i[7]-=e[7],i[8]-=e[8],this},scale:function(t,i){var e=this.elements,s=t.elements;return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=s[3]*i,e[4]=s[4]*i,e[5]=s[5]*i,e[6]=s[6]*i,e[7]=s[7]*i,e[8]=s[8]*i,this},scaleEqual:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},multiplyMatrices:function(t,i,e){e&&(i=i.clone().transpose());var s=this.elements,o=t.elements,n=i.elements,r=o[0],a=o[3],h=o[6],l=o[1],c=o[4],u=o[7],p=o[2],d=o[5],m=o[8],y=n[0],f=n[3],v=n[6],x=n[1],b=n[4],g=n[7],w=n[2],z=n[5],N=n[8];return s[0]=r*y+l*f+p*v,s[1]=r*x+l*b+p*g,s[2]=r*w+l*z+p*N,s[3]=a*y+c*f+d*v,s[4]=a*x+c*b+d*g,s[5]=a*w+c*z+d*N,s[6]=h*y+u*f+m*v,s[7]=h*x+u*b+m*g,s[8]=h*w+u*z+m*N,this},transpose:function(t){if(void 0!==t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]),this}var e=this.elements,s=e[1],o=e[2],n=e[5];return e[1]=e[3],e[2]=e[6],e[3]=s,e[5]=e[7],e[6]=o,e[7]=n,this},setQuat:function(t){var i=this.elements,e=t.x,s=t.y,o=t.z,n=t.w,r=e+e,a=s+s,h=o+o,l=e*r,c=e*a,u=e*h,p=s*a,d=s*h,m=o*h,y=n*r,f=n*a,v=n*h;return i[0]=1-(p+m),i[1]=c-v,i[2]=u+f,i[3]=c+v,i[4]=1-(l+m),i[5]=d-y,i[6]=u-f,i[7]=d+y,i[8]=1-(l+p),this},invert:function(t){var i=this.elements,e=t.elements,s=e[0],o=e[3],n=e[6],r=e[1],a=e[4],h=e[7],l=e[2],c=e[5],u=e[8],p=u*a-c*h,d=-u*o+c*n,m=h*o-a*n,y=s*p+r*d+l*m;return 0===y?(console.log("can't invert matrix, determinant is 0"),this.identity()):(y=1/y,i[0]=p*y,i[1]=(-u*r+l*h)*y,i[2]=(c*r-l*a)*y,i[3]=d*y,i[4]=(u*s-l*n)*y,i[5]=(-c*s+l*o)*y,i[6]=m*y,i[7]=(-h*s+r*n)*y,i[8]=(a*s-r*o)*y,this)},addOffset:function(t,i){var e=i.x,s=i.y,o=i.z,n=this.elements;n[0]+=t*(s*s+o*o),n[4]+=t*(e*e+o*o),n[8]+=t*(e*e+s*s);var r=t*e*s,a=t*s*o,h=t*o*e;return n[1]-=r,n[3]-=r,n[2]-=a,n[6]-=a,n[5]-=h,n[7]-=h,this},subOffset:function(t,i){var e=i.x,s=i.y,o=i.z,n=this.elements;n[0]-=t*(s*s+o*o),n[4]-=t*(e*e+o*o),n[8]-=t*(e*e+s*s);var r=t*e*s,a=t*s*o,h=t*o*e;return n[1]+=r,n[3]+=r,n[2]+=a,n[6]+=a,n[5]+=h,n[7]+=h,this},multiplyScalar:function(t){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=t,i[4]*=t,i[7]*=t,i[2]*=t,i[5]*=t,i[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new X).fromArray(this.elements)},copy:function(t){for(var i=0;i<9;i++)this.elements[i]=t.elements[i];return this},determinant:function(){var t=this.elements,i=t[0],e=t[1],s=t[2],o=t[3],n=t[4],r=t[5],a=t[6],h=t[7],l=t[8];return i*n*l-i*r*h-e*o*l+e*r*a+s*o*h-s*n*a},fromArray:function(t,i){void 0===i&&(i=0);for(var e=0;e<9;e++)this.elements[e]=t[e+i];return this},toArray:function(t,i){void 0===t&&(t=[]),void 0===i&&(i=0);var e=this.elements;return t[i]=e[0],t[i+1]=e[1],t[i+2]=e[2],t[i+3]=e[3],t[i+4]=e[4],t[i+5]=e[5],t[i+6]=e[6],t[i+7]=e[7],t[i+8]=e[8],t}}),Object.assign(Y.prototype,{AABB:!0,set:function(t,i,e,s,o,n){var r=this.elements;return r[0]=t,r[3]=i,r[1]=e,r[4]=s,r[2]=o,r[5]=n,this},intersectTest:function(t){var i=this.elements,e=t.elements;return i[0]>e[3]||i[1]>e[4]||i[2]>e[5]||i[3]<e[0]||i[4]<e[1]||i[5]<e[2]},intersectTestTwo:function(t){var i=this.elements,e=t.elements;return i[0]<e[0]||i[1]<e[1]||i[2]<e[2]||i[3]>e[3]||i[4]>e[4]||i[5]>e[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,i){var e=i||0,s=t.elements;return this.set(s[0]-e,s[3]+e,s[1]-e,s[4]+e,s[2]-e,s[5]+e),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,i){var e=t.elements,s=i.elements,o=this.elements;return o[0]=e[0]<s[0]?e[0]:s[0],o[1]=e[1]<s[1]?e[1]:s[1],o[2]=e[2]<s[2]?e[2]:s[2],o[3]=e[3]>s[3]?e[3]:s[3],o[4]=e[4]>s[4]?e[4]:s[4],o[5]=e[5]>s[5]?e[5]:s[5],this},surfaceArea:function(){var t=this.elements,i=t[3]-t[0],e=t[4]-t[1],s=t[5]-t[2];return 2*(i*(e+s)+e*s)},intersectsWithPoint:function(t,i,e){var s=this.elements;return t>=s[0]&&t<=s[3]&&i>=s[1]&&i<=s[4]&&e>=s[2]&&e<=s[5]},setFromPoints:function(t){this.makeEmpty();for(var i=0;i<t.length;i++)this.expandByPoint(t[i])},makeEmpty:function(){this.set(-1/0,-1/0,-1/0,1/0,1/0,1/0)},expandByPoint:function(t){var i=this.elements;this.set(_.min(i[0],t.x),_.min(i[1],t.y),_.min(i[2],t.z),_.max(i[3],t.x),_.max(i[4],t.y),_.max(i[5],t.z))},expandByScalar:function(t){var i=this.elements;i[0]+=-t,i[1]+=-t,i[2]+=-t,i[3]+=t,i[4]+=t,i[5]+=t}});var Q=0;function Z(t){this.type=V,this.id=Q++,this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new H,this.rotation=new X,this.relativePosition=(new H).copy(t.relativePosition),this.relativeRotation=(new X).copy(t.relativeRotation),this.aabb=new Y,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith}function K(t,i,e,s){Z.call(this,t),this.type=I,this.width=i,this.height=e,this.depth=s,this.halfWidth=.5*i,this.halfHeight=.5*e,this.halfDepth=.5*s,this.dimentions=new Float32Array(18),this.elements=new Float32Array(24)}function J(t,i){Z.call(this,t),this.type=T,this.radius=i}function $(t,i,e){Z.call(this,t),this.type=L,this.radius=i,this.height=e,this.halfHeight=.5*e,this.normalDirection=new H,this.halfDirection=new H}function tt(t,i){Z.call(this,t),this.type=C,this.normal=new H(0,1,0)}function it(t,i){Z.call(this,t),this.type=B}function et(){this.relativePosition=new H,this.relativeRotation=new X,this.friction=.2,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295}function st(t,i){i=i||!1,this.axis=t,this.angle=0,this.lowerLimit=i?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0}function ot(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1}function nt(t){this.prev=null,this.next=null,this.body=null,this.joint=t}function rt(t){ot.call(this),this.scale=1,this.invScale=1,this.name="",this.id=NaN,this.type=E,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new H).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new H).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new H,this.relativeAnchorPoint2=new H,this.anchorPoint1=new H,this.anchorPoint2=new H,this.allowCollision=t.allowCollision,this.b1Link=new nt(this),this.b2Link=new nt(this)}function at(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0}function ht(t,i,e,s){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=e,this.limitMotor3=s,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0}function lt(t,i,e){rt.call(this,t),this.type=q,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize();var s=(new X).setQuat((new G).setFromUnitVectors(this.localAxis1,this.localAxis2));this.localAngle1=(new H).tangent(this.localAxis1).normalize(),this.localAngle2=this.localAngle1.clone().applyMatrix3(s,!0),this.ax1=new H,this.ax2=new H,this.an1=new H,this.an2=new H,this.tmp=new H,this.nor=new H,this.tan=new H,this.bin=new H,this.limitMotor=new st(this.nor,!1),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=e,this.lc=new at(this),this.r3=new ht(this,this.limitMotor,new st(this.tan,!0),new st(this.bin,!0))}function ct(t){rt.call(this,t),this.type=F,this.lc=new at(this)}function ut(t,i){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0}function pt(t,i,e){rt.call(this,t),this.type=R,this.nor=new H,this.limitMotor=new st(this.nor,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=e,this.t=new ut(this,this.limitMotor)}function dt(t,i){this.joint=t,this.targetOrientation=(new G).invert(i),this.relativeOrientation=new G,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new H,this.imp=new H,this.rn0=new H,this.rn1=new H,this.rn2=new H,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia}function mt(t,i,e,s){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=e,this.limitMotor3=s,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1}function yt(t,i,e){rt.call(this,t),this.type=D,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize(),this.ax1=new H,this.ax2=new H,this.nor=new H,this.tan=new H,this.bin=new H,this.ac=new dt(this,(new G).setFromUnitVectors(this.localAxis1,this.localAxis2)),this.limitMotor=new st(this.nor,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=e,this.t3=new mt(this,this.limitMotor,new st(this.tan,!0),new st(this.bin,!0))}function ft(t,i,e){rt.call(this,t),this.type=O,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize();var s=(new X).setQuat((new G).setFromUnitVectors(this.localAxis1,this.localAxis2));this.localAngle1=(new H).tangent(this.localAxis1).normalize(),this.localAngle2=this.localAngle1.clone().applyMatrix3(s,!0),this.ax1=new H,this.ax2=new H,this.an1=new H,this.an2=new H,this.tmp=new H,this.nor=new H,this.tan=new H,this.bin=new H,this.rotationalLimitMotor=new st(this.nor,!1),this.r3=new ht(this,this.rotationalLimitMotor,new st(this.tan,!0),new st(this.bin,!0)),this.translationalLimitMotor=new st(this.nor,!0),this.translationalLimitMotor.lowerLimit=i,this.translationalLimitMotor.upperLimit=e,this.t3=new mt(this,this.translationalLimitMotor,new st(this.tan,!0),new st(this.bin,!0))}function vt(t){rt.call(this,t),this.type=j,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize(),this.localAngle1=new H,this.localAngle2=new H;var i=_.dotVectors(this.localAxis1,this.localAxis2);if(i>-1&&i<1)this.localAngle1.set(this.localAxis2.x-i*this.localAxis1.x,this.localAxis2.y-i*this.localAxis1.y,this.localAxis2.z-i*this.localAxis1.z).normalize(),this.localAngle2.set(this.localAxis1.x-i*this.localAxis2.x,this.localAxis1.y-i*this.localAxis2.y,this.localAxis1.z-i*this.localAxis2.z).normalize();else{var e=(new X).setQuat((new G).setFromUnitVectors(this.localAxis1,this.localAxis2));this.localAngle1.tangent(this.localAxis1).normalize(),this.localAngle2=this.localAngle1.clone().applyMatrix3(e,!0)}this.ax1=new H,this.ax2=new H,this.an1=new H,this.an2=new H,this.tmp=new H,this.nor=new H,this.tan=new H,this.bin=new H,this.translationalLimitMotor=new st(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new st(this.tan,!1),this.rotationalLimitMotor2=new st(this.bin,!1),this.t3=new mt(this,new st(this.nor,!0),this.translationalLimitMotor,new st(this.bin,!0)),this.t3.weight=1,this.r3=new ht(this,new st(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)}function xt(){this.scale=1,this.invScale=1,this.body1=null,this.body2=null,this.localAnchorPoint1=new H,this.localAnchorPoint2=new H,this.localAxis1=new H,this.localAxis2=new H,this.allowCollision=!1}function bt(){this.mass=0,this.inertia=new X}function gt(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t}function wt(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN}function zt(){this.warmStarted=!1,this.position=new H,this.localPoint1=new H,this.localPoint2=new H,this.normal=new H,this.tangent=new H,this.binormal=new H,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0}function Nt(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[new zt,new zt,new zt,new zt]}function St(){this.nor=new H,this.tan=new H,this.bin=new H,this.norU1=new H,this.tanU1=new H,this.binU1=new H,this.norU2=new H,this.tanU2=new H,this.binU2=new H,this.norT1=new H,this.tanT1=new H,this.binT1=new H,this.norT2=new H,this.tanT2=new H,this.binT2=new H,this.norTU1=new H,this.tanTU1=new H,this.binTU1=new H,this.norTU2=new H,this.tanTU2=new H,this.binTU2=new H,this.norImp=0,this.tanImp=0,this.binImp=0,this.norDen=0,this.tanDen=0,this.binDen=0,this.norTar=0,this.next=null,this.last=!1}function Mt(t){ot.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.tmp=new H,this.tmpC1=new H,this.tmpC2=new H,this.tmpP1=new H,this.tmpP2=new H,this.tmplv1=new H,this.tmplv2=new H,this.tmpav1=new H,this.tmpav2=new H,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new St,this.cs.next=new St,this.cs.next.next=new St,this.cs.next.next.next=new St}function Pt(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.close=!1,this.dist=_.INF,this.b1Link=new gt(this),this.b2Link=new gt(this),this.s1Link=new gt(this),this.s2Link=new gt(this),this.manifold=new Nt,this.buffer=[new wt,new wt,new wt,new wt],this.points=this.manifold.points,this.constraint=new Mt(this.manifold)}function kt(t,i){this.position=t||new H,this.orientation=i||new G,this.scale=1,this.invScale=1,this.mesh=null,this.id=NaN,this.name="",this.prev=null,this.next=null,this.type=A,this.massInfo=new bt,this.newPosition=new H,this.controlPos=!1,this.newOrientation=new G,this.newRotation=new H,this.currentRotation=new H,this.controlRot=!1,this.controlRotInTime=!1,this.quaternion=new G,this.pos=new H,this.linearVelocity=new H,this.angularVelocity=new H,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new H,this.sleepOrientation=new G,this.isStatic=!1,this.isDynamic=!1,this.isKinematic=!1,this.rotation=new X,this.mass=0,this.inverseMass=0,this.inverseInertia=new X,this.localInertia=new X,this.inverseLocalInertia=new X,this.tmpInertia=new X,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1}function At(t,i){this.shape1=t||null,this.shape2=i||null}function Vt(){this.types=S,this.numPairChecks=0,this.numPairs=0,this.pairs=[]}Object.assign(Z.prototype,{Shape:!0,calculateMassInfo:function(t){W("Shape","Inheritance error.")},updateProxy:function(){W("Shape","Inheritance error.")}}),K.prototype=Object.assign(Object.create(Z.prototype),{constructor:K,calculateMassInfo:function(t){var i=this.width*this.height*this.depth*this.density;t.mass=i,t.inertia.set(i*(this.height*this.height+this.depth*this.depth)*(1/12),0,0,0,i*(this.width*this.width+this.depth*this.depth)*(1/12),0,0,0,i*(this.width*this.width+this.height*this.height)*(1/12))},updateProxy:function(){var t=this.rotation.elements,i=this.dimentions;i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8],i[9]=t[0]*this.halfWidth,i[10]=t[3]*this.halfWidth,i[11]=t[6]*this.halfWidth,i[12]=t[1]*this.halfHeight,i[13]=t[4]*this.halfHeight,i[14]=t[7]*this.halfHeight,i[15]=t[2]*this.halfDepth,i[16]=t[5]*this.halfDepth,i[17]=t[8]*this.halfDepth;var e=i[9],s=i[10],o=i[11],n=i[12],r=i[13],a=i[14],h=i[15],l=i[16],c=i[17],u=this.position.x,p=this.position.y,d=this.position.z,m=this.elements;m[0]=u+e+n+h,m[1]=p+s+r+l,m[2]=d+o+a+c,m[3]=u+e+n-h,m[4]=p+s+r-l,m[5]=d+o+a-c,m[6]=u+e-n+h,m[7]=p+s-r+l,m[8]=d+o-a+c,m[9]=u+e-n-h,m[10]=p+s-r-l,m[11]=d+o-a-c,m[12]=u-e+n+h,m[13]=p-s+r+l,m[14]=d-o+a+c,m[15]=u-e+n-h,m[16]=p-s+r-l,m[17]=d-o+a-c,m[18]=u-e-n+h,m[19]=p-s-r+l,m[20]=d-o-a+c,m[21]=u-e-n-h,m[22]=p-s-r-l,m[23]=d-o-a-c;var y=i[9]<0?-i[9]:i[9],f=i[10]<0?-i[10]:i[10],v=i[11]<0?-i[11]:i[11];y=i[12]<0?y-i[12]:y+i[12],f=i[13]<0?f-i[13]:f+i[13],v=i[14]<0?v-i[14]:v+i[14],y=i[15]<0?y-i[15]:y+i[15],f=i[16]<0?f-i[16]:f+i[16],v=i[17]<0?v-i[17]:v+i[17];var x=.005;this.aabb.set(this.position.x-y-x,this.position.x+y+x,this.position.y-f-x,this.position.y+f+x,this.position.z-v-x,this.position.z+v+x),null!=this.proxy&&this.proxy.update()}}),J.prototype=Object.assign(Object.create(Z.prototype),{constructor:J,volume:function(){return _.PI*this.radius*1.333333},calculateMassInfo:function(t){var i=this.volume()*this.radius*this.radius*this.density;t.mass=i;var e=i*this.radius*this.radius*.4;t.inertia.set(e,0,0,0,e,0,0,0,e)},updateProxy:function(){var t=.005;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()}}),$.prototype=Object.assign(Object.create(Z.prototype),{constructor:$,calculateMassInfo:function(t){var i=this.radius*this.radius,e=_.PI*i*this.height*this.density,s=(.25*i+.0833*this.height*this.height)*e,o=.5*i;t.mass=e,t.inertia.set(s,0,0,0,o,0,0,0,s)},updateProxy:function(){var t,i,e,s,o,n,r,a,h,l,c,u=this.rotation.elements;o=u[1]*u[1],n=u[4]*u[4],r=u[7]*u[7],this.normalDirection.set(u[1],u[4],u[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),i=1-o,(t=_.sqrt(i*i+o*n+o*r))>0&&(t=this.radius/t),i*=t,e=1-n,(t=_.sqrt(n*o+e*e+n*r))>0&&(t=this.radius/t),e*=t,s=1-r,(t=_.sqrt(r*o+r*n+s*s))>0&&(t=this.radius/t),s*=t,a=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,h=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,l=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,a=i<0?a-i:a+i,h=e<0?h-e:h+e,l=s<0?l-s:l+s,c=.005,this.aabb.set(this.position.x-a-c,this.position.x+a+c,this.position.y-h-c,this.position.y+h+c,this.position.z-l-c,this.position.z+l+c),null!=this.proxy&&this.proxy.update()}}),tt.prototype=Object.assign(Object.create(Z.prototype),{constructor:tt,volume:function(){return Number.MAX_VALUE},calculateMassInfo:function(t){t.mass=this.density;t.inertia.set(1,0,0,0,1,0,0,0,1)},updateProxy:function(){var t=.005,i=-_.INF,e=_.INF,s=this.normal;this.aabb.set(-1===s.x?this.position.x-t:i,1===s.x?this.position.x+t:e,-1===s.y?this.position.y-t:i,1===s.y?this.position.y+t:e,-1===s.z?this.position.z-t:i,1===s.z?this.position.z+t:e),null!=this.proxy&&this.proxy.update()}}),it.prototype=Object.assign(Object.create(Z.prototype),{constructor:it,volume:function(){return Number.MAX_VALUE},calculateMassInfo:function(t){t.inertia.set(0,0,0,0,0,0,0,0,0)},updateProxy:function(){this.aabb.set(this.position.x-0,this.position.x+0,this.position.y-0,this.position.y+0,this.position.z-0,this.position.z+0),null!=this.proxy&&this.proxy.update()}}),Object.assign(st.prototype,{LimitMotor:!0,setLimit:function(t,i){this.lowerLimit=t,this.upperLimit=i},setMotor:function(t,i){this.motorSpeed=t,this.maxMotorForce=i},setSpring:function(t,i){this.frequency=t,this.dampingRatio=i}}),Object.assign(ot.prototype,{Constraint:!0,preSolve:function(t,i){W("Constraint","Inheritance error.")},solve:function(){W("Constraint","Inheritance error.")},postSolve:function(){W("Constraint","Inheritance error.")}}),rt.prototype=Object.assign(Object.create(ot.prototype),{constructor:rt,setId:function(t){this.id=i},setParent:function(t){this.parent=t,this.scale=this.parent.scale,this.invScale=this.parent.invScale,this.id=this.parent.numJoints,this.name||(this.name="J"+this.id)},updateAnchorPoints:function(){this.relativeAnchorPoint1.copy(this.localAnchorPoint1).applyMatrix3(this.body1.rotation,!0),this.relativeAnchorPoint2.copy(this.localAnchorPoint2).applyMatrix3(this.body2.rotation,!0),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},attach:function(t){this.b1Link.body=this.body2,this.b2Link.body=this.body1,t?(this.body1.jointLink.push(this.b1Link),this.body2.jointLink.push(this.b2Link)):(null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++)},detach:function(t){if(t)this.body1.jointLink.splice(this.body1.jointLink.indexOf(this.b1Link),1),this.body2.jointLink.splice(this.body2.jointLink.indexOf(this.b2Link),1);else{var i=this.b1Link.prev,e=this.b1Link.next;null!=i&&(i.next=e),null!=e&&(e.prev=i),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=e),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,i=this.b2Link.prev,e=this.b2Link.next,null!=i&&(i.next=e),null!=e&&(e.prev=i),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=e),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--}this.b1Link.body=null,this.b2Link.body=null},awake:function(){this.body1.awake(),this.body2.awake()},preSolve:function(t,i){},solve:function(){},postSolve:function(){},remove:function(){this.dispose()},dispose:function(){this.parent.removeJoint(this)},getPosition:function(){return[(new H).scale(this.anchorPoint1,this.scale),(new H).scale(this.anchorPoint2,this.scale)]}}),Object.assign(at.prototype,{LinearConstraint:!0,preSolve:function(t,i){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var e=this.ii1.elements,s=this.ii2.elements;this.ax1x=this.r1z*e[1]+-this.r1y*e[2],this.ax1y=this.r1z*e[4]+-this.r1y*e[5],this.ax1z=this.r1z*e[7]+-this.r1y*e[8],this.ay1x=-this.r1z*e[0]+this.r1x*e[2],this.ay1y=-this.r1z*e[3]+this.r1x*e[5],this.ay1z=-this.r1z*e[6]+this.r1x*e[8],this.az1x=this.r1y*e[0]+-this.r1x*e[1],this.az1y=this.r1y*e[3]+-this.r1x*e[4],this.az1z=this.r1y*e[6]+-this.r1x*e[7],this.ax2x=this.r2z*s[1]+-this.r2y*s[2],this.ax2y=this.r2z*s[4]+-this.r2y*s[5],this.ax2z=this.r2z*s[7]+-this.r2y*s[8],this.ay2x=-this.r2z*s[0]+this.r2x*s[2],this.ay2y=-this.r2z*s[3]+this.r2x*s[5],this.ay2z=-this.r2z*s[6]+this.r2x*s[8],this.az2x=this.r2y*s[0]+-this.r2x*s[1],this.az2y=this.r2y*s[3]+-this.r2x*s[4],this.az2z=this.r2y*s[6]+-this.r2x*s[7];var o=this.m1+this.m2,n=(new X).set(o,0,0,0,o,0,0,0,o).elements;n[0]+=e[4]*this.r1z*this.r1z-(e[7]+e[5])*this.r1y*this.r1z+e[8]*this.r1y*this.r1y,n[1]+=(e[6]*this.r1y+e[5]*this.r1x)*this.r1z-e[3]*this.r1z*this.r1z-e[8]*this.r1x*this.r1y,n[2]+=(e[3]*this.r1y-e[4]*this.r1x)*this.r1z-e[6]*this.r1y*this.r1y+e[7]*this.r1x*this.r1y,n[3]+=(e[2]*this.r1y+e[7]*this.r1x)*this.r1z-e[1]*this.r1z*this.r1z-e[8]*this.r1x*this.r1y,n[4]+=e[0]*this.r1z*this.r1z-(e[6]+e[2])*this.r1x*this.r1z+e[8]*this.r1x*this.r1x,n[5]+=(e[1]*this.r1x-e[0]*this.r1y)*this.r1z-e[7]*this.r1x*this.r1x+e[6]*this.r1x*this.r1y,n[6]+=(e[1]*this.r1y-e[4]*this.r1x)*this.r1z-e[2]*this.r1y*this.r1y+e[5]*this.r1x*this.r1y,n[7]+=(e[3]*this.r1x-e[0]*this.r1y)*this.r1z-e[5]*this.r1x*this.r1x+e[2]*this.r1x*this.r1y,n[8]+=e[0]*this.r1y*this.r1y-(e[3]+e[1])*this.r1x*this.r1y+e[4]*this.r1x*this.r1x,n[0]+=s[4]*this.r2z*this.r2z-(s[7]+s[5])*this.r2y*this.r2z+s[8]*this.r2y*this.r2y,n[1]+=(s[6]*this.r2y+s[5]*this.r2x)*this.r2z-s[3]*this.r2z*this.r2z-s[8]*this.r2x*this.r2y,n[2]+=(s[3]*this.r2y-s[4]*this.r2x)*this.r2z-s[6]*this.r2y*this.r2y+s[7]*this.r2x*this.r2y,n[3]+=(s[2]*this.r2y+s[7]*this.r2x)*this.r2z-s[1]*this.r2z*this.r2z-s[8]*this.r2x*this.r2y,n[4]+=s[0]*this.r2z*this.r2z-(s[6]+s[2])*this.r2x*this.r2z+s[8]*this.r2x*this.r2x,n[5]+=(s[1]*this.r2x-s[0]*this.r2y)*this.r2z-s[7]*this.r2x*this.r2x+s[6]*this.r2x*this.r2y,n[6]+=(s[1]*this.r2y-s[4]*this.r2x)*this.r2z-s[2]*this.r2y*this.r2y+s[5]*this.r2x*this.r2y,n[7]+=(s[3]*this.r2x-s[0]*this.r2y)*this.r2z-s[5]*this.r2x*this.r2x+s[2]*this.r2x*this.r2y,n[8]+=s[0]*this.r2y*this.r2y-(s[3]+s[1])*this.r2x*this.r2y+s[4]*this.r2x*this.r2x;var r=1/(n[0]*(n[4]*n[8]-n[7]*n[5])+n[3]*(n[7]*n[2]-n[1]*n[8])+n[6]*(n[1]*n[5]-n[4]*n[2]));this.dd=(new X).set(n[4]*n[8]-n[5]*n[7],n[2]*n[7]-n[1]*n[8],n[1]*n[5]-n[2]*n[4],n[5]*n[6]-n[3]*n[8],n[0]*n[8]-n[2]*n[6],n[2]*n[3]-n[0]*n[5],n[3]*n[7]-n[4]*n[6],n[1]*n[6]-n[0]*n[7],n[0]*n[4]-n[1]*n[3]).scaleEqual(r),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var a=_.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);a>.005?(a=(.005-a)/a*i*.05,this.velx*=a,this.vely*=a,this.velz*=a):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,e=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,o=i*t[0]+e*t[1]+s*t[2],n=i*t[3]+e*t[4]+s*t[5],r=i*t[6]+e*t[7]+s*t[8];this.impx+=o,this.impy+=n,this.impz+=r,this.l1.x+=o*this.m1,this.l1.y+=n*this.m1,this.l1.z+=r*this.m1,this.a1.x+=o*this.ax1x+n*this.ay1x+r*this.az1x,this.a1.y+=o*this.ax1y+n*this.ay1y+r*this.az1y,this.a1.z+=o*this.ax1z+n*this.ay1z+r*this.az1z,this.l2.x-=o*this.m2,this.l2.y-=n*this.m2,this.l2.z-=r*this.m2,this.a2.x-=o*this.ax2x+n*this.ay2x+r*this.az2x,this.a2.y-=o*this.ax2y+n*this.ay2y+r*this.az2y,this.a2.z-=o*this.ax2z+n*this.ay2z+r*this.az2z}}),Object.assign(ht.prototype,{Rotational3Constraint:!0,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var e=this.i1.elements,s=this.i2.elements;this.i1e00=e[0],this.i1e01=e[1],this.i1e02=e[2],this.i1e10=e[3],this.i1e11=e[4],this.i1e12=e[5],this.i1e20=e[6],this.i1e21=e[7],this.i1e22=e[8],this.i2e00=s[0],this.i2e01=s[1],this.i2e02=s[2],this.i2e10=s[3],this.i2e11=s[4],this.i2e12=s[5],this.i2e20=s[6],this.i2e21=s[7],this.i2e22=s[8];var o=this.limitMotor1.frequency,n=this.limitMotor2.frequency,r=this.limitMotor3.frequency,a=o>0,h=n>0,l=r>0,c=this.lowerLimit1<=this.upperLimit1,u=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,d=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-d):d<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-d):d>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-d):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),a||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var m=this.limitMotor2.angle;u?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-m):m<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-m):m>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-m):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),h||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var y=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-y):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||a)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||h)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,a&&2!=this.limitState1){var f=6.2831853*o,v=f*f*t,x=i/(v+2*this.limitMotor1.dampingRatio*f);this.cfm1=this.kv00*x,this.limitVelocity1*=v*x}else this.cfm1=0,this.limitVelocity1*=.05*i;h&&2!=this.limitState2?(x=i/((v=(f=6.2831853*n)*f*t)+2*this.limitMotor2.dampingRatio*f),this.cfm2=this.kv11*x,this.limitVelocity2*=v*x):(this.cfm2=0,this.limitVelocity2*=.05*i),l&&2!=this.limitState3?(x=i/((v=(f=6.2831853*r)*f*t)+2*this.limitMotor3.dampingRatio*f),this.cfm3=this.kv22*x,this.limitVelocity3*=v*x):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*b,this.d01=(this.k02*this.k21-this.k01*this.k22)*b,this.d02=(this.k01*this.k12-this.k02*this.k11)*b,this.d10=(this.k12*this.k20-this.k10*this.k22)*b,this.d11=(this.k00*this.k22-this.k02*this.k20)*b,this.d12=(this.k02*this.k10-this.k00*this.k12)*b,this.d20=(this.k10*this.k21-this.k11*this.k20)*b,this.d21=(this.k01*this.k20-this.k00*this.k21)*b,this.d22=(this.k00*this.k11-this.k01*this.k10)*b,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var g=this.limitImpulse1+this.motorImpulse1,w=this.limitImpulse2+this.motorImpulse2,z=this.limitImpulse3+this.motorImpulse3;this.a1.x+=g*this.a1x1+w*this.a1x2+z*this.a1x3,this.a1.y+=g*this.a1y1+w*this.a1y2+z*this.a1y3,this.a1.z+=g*this.a1z1+w*this.a1z2+z*this.a1z3,this.a2.x-=g*this.a2x1+w*this.a2x2+z*this.a2x3,this.a2.y-=g*this.a2y1+w*this.a2y2+z*this.a2y3,this.a2.z-=g*this.a2z1+w*this.a2z2+z*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,e=this.a2.z-this.a1.z;this.limitVelocity3=30;var s=t*this.ax1+i*this.ay1+e*this.az1-this.limitVelocity1,o=t*this.ax2+i*this.ay2+e*this.az2-this.limitVelocity2,n=t*this.ax3+i*this.ay3+e*this.az3-this.limitVelocity3,r=s*this.d00+o*this.d01+n*this.d02,a=s*this.d10+o*this.d11+n*this.d12,h=s*this.d20+o*this.d21+n*this.d22;this.limitImpulse1+=r,this.limitImpulse2+=a,this.limitImpulse3+=h,this.a1.x+=r*this.a1x1+a*this.a1x2+h*this.a1x3,this.a1.y+=r*this.a1y1+a*this.a1y2+h*this.a1y3,this.a1.z+=r*this.a1z1+a*this.a1z2+h*this.a1z3,this.a2.x-=r*this.a2x1+a*this.a2x2+h*this.a2x3,this.a2.y-=r*this.a2y1+a*this.a2y2+h*this.a2y3,this.a2.z-=r*this.a2z1+a*this.a2z2+h*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,e=this.a2.z-this.a1.z,s=t*this.ax1+i*this.ay1+e*this.az1,o=t*this.ax2+i*this.ay2+e*this.az2,n=t*this.ax3+i*this.ay3+e*this.az3,r=this.motorImpulse1,a=this.motorImpulse2,h=this.motorImpulse3,l=0,c=0,u=0;this.enableMotor1&&(l=(s-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-r),this.enableMotor2&&(c=(o-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-a),this.enableMotor3&&(u=(n-this.motorSpeed3)*this.dv22,this.motorImpulse3+=u,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),u=this.motorImpulse3-h),s+=l*this.kv00+c*this.k01+u*this.k02,o+=l*this.k10+c*this.kv11+u*this.k12,n+=l*this.k20+c*this.k21+u*this.kv22,s-=this.limitVelocity1+this.limitImpulse1*this.cfm1,o-=this.limitVelocity2+this.limitImpulse2*this.cfm2,n-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,d=this.limitImpulse2,m=this.limitImpulse3,y=s*this.d00+o*this.d01+n*this.d02,f=s*this.d10+o*this.d11+n*this.d12,v=s*this.d20+o*this.d21+n*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=f,this.limitImpulse3+=v;var x,b=0;switch((2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(o+=(y=-p)*this.k10,n+=y*this.k20,b|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(s+=(f=-d)*this.k01,n+=f*this.k21,b|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(s+=(v=-m)*this.k02,o+=v*this.k12,b|=4),b){case 1:x=1/(this.k11*this.k22-this.k12*this.k21),f=(this.k22*o+-this.k12*n)*x,v=(-this.k21*o+this.k11*n)*x;break;case 2:x=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*s+-this.k02*n)*x,v=(-this.k20*s+this.k00*n)*x;break;case 3:v=n/this.k22;break;case 4:x=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*s+-this.k01*o)*x,f=(-this.k10*s+this.k00*o)*x;break;case 5:f=o/this.k11;break;case 6:y=s/this.k00}this.limitImpulse1=y+p,this.limitImpulse2=f+d,this.limitImpulse3=v+m;var g=l+y,w=c+f,z=u+v;this.a1.x+=g*this.a1x1+w*this.a1x2+z*this.a1x3,this.a1.y+=g*this.a1y1+w*this.a1y2+z*this.a1y3,this.a1.z+=g*this.a1z1+w*this.a1z2+z*this.a1z3,this.a2.x-=g*this.a2x1+w*this.a2x2+z*this.a2x3,this.a2.y-=g*this.a2y1+w*this.a2y2+z*this.a2y3,this.a2.z-=g*this.a2z1+w*this.a2z2+z*this.a2z3,t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,e=this.a2.z-this.a1.z,o=t*this.ax2+i*this.ay2+e*this.az2}}),lt.prototype=Object.assign(Object.create(rt.prototype),{constructor:lt,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.an1.copy(this.localAngle1).applyMatrix3(this.body1.rotation,!0),this.an2.copy(this.localAngle2).applyMatrix3(this.body2.rotation,!0),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).normalize(),this.tan.tangent(this.nor).normalize(),this.bin.crossVectors(this.nor,this.tan);var e=_.acosClamp(_.dotVectors(this.an1,this.an2));this.tmp.crossVectors(this.an1,this.an2),_.dotVectors(this.nor,this.tmp)<0?this.limitMotor.angle=-e:this.limitMotor.angle=e,this.tmp.crossVectors(this.ax1,this.ax2),this.r3.limitMotor2.angle=_.dotVectors(this.tan,this.tmp),this.r3.limitMotor3.angle=_.dotVectors(this.bin,this.tmp),this.r3.preSolve(t,i),this.lc.preSolve(t,i)},solve:function(){this.r3.solve(),this.lc.solve()},postSolve:function(){}}),ct.prototype=Object.assign(Object.create(rt.prototype),{constructor:ct,preSolve:function(t,i){this.updateAnchorPoints(),this.lc.preSolve(t,i)},solve:function(){this.lc.solve()},postSolve:function(){}}),Object.assign(ut.prototype,{TranslationalConstraint:!0,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var e=this.i1.elements,s=this.i2.elements;this.i1e00=e[0],this.i1e01=e[1],this.i1e02=e[2],this.i1e10=e[3],this.i1e11=e[4],this.i1e12=e[5],this.i1e20=e[6],this.i1e21=e[7],this.i1e22=e[8],this.i2e00=s[0],this.i2e01=s[1],this.i2e02=s[2],this.i2e10=s[3],this.i2e11=s[4],this.i2e12=s[5],this.i2e20=s[6],this.i2e21=s[7],this.i2e22=s[8];var o=this.p2.x-this.p1.x,n=this.p2.y-this.p1.y,r=this.p2.z-this.p1.z,a=o*this.ax+n*this.ay+r*this.az,h=this.limitMotor.frequency,l=h>0;(l&&a>20||a<-20)&&(l=!1),this.lowerLimit<=this.upperLimit?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a,l||(a=this.lowerLimit)):a<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a,l||(a=this.lowerLimit)):a>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-a,l||(a=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var c=a*this.ax,u=a*this.ay,p=a*this.az,d=this.m1/(this.m1+this.m2),m=1-d;if(this.r1x=this.r1.x+c*d,this.r1y=this.r1.y+u*d,this.r1z=this.r1.z+p*d,this.r2x=this.r2.x-c*m,this.r2y=this.r2.y-u*m,this.r2z=this.r2.z-p*m,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var y=6.2831853*h,f=y*y*t,v=i/(f+2*this.limitMotor.dampingRatio*y);this.cfm=this.motorDenom*v,this.limitVelocity*=f*v}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm);var x=this.limitImpulse+this.motorImpulse;this.l1.x+=x*this.l1x,this.l1.y+=x*this.l1y,this.l1.z+=x*this.l1z,this.a1.x+=x*this.a1x,this.a1.y+=x*this.a1y,this.a1.z+=x*this.a1z,this.l2.x-=x*this.l2x,this.l2.y-=x*this.l2y,this.l2.z-=x*this.l2z,this.a2.x-=x*this.a2x,this.a2.y-=x*this.a2y,this.a2.z-=x*this.a2z},solve:function(){var t,i,e=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(e-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),e-=(t=this.motorImpulse-s)*this.motorDenom}else t=0;if(2!=this.limitState){i=(e-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var o=this.limitImpulse;this.limitImpulse+=i,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),i=this.limitImpulse-o}else i=0;var n=i+t;this.l1.x+=n*this.l1x,this.l1.y+=n*this.l1y,this.l1.z+=n*this.l1z,this.a1.x+=n*this.a1x,this.a1.y+=n*this.a1y,this.a1.z+=n*this.a1z,this.l2.x-=n*this.l2x,this.l2.y-=n*this.l2y,this.l2.z-=n*this.l2z,this.a2.x-=n*this.a2x,this.a2.y-=n*this.a2y,this.a2.z-=n*this.a2z}}),pt.prototype=Object.assign(Object.create(rt.prototype),{constructor:pt,preSolve:function(t,i){this.updateAnchorPoints(),this.nor.sub(this.anchorPoint2,this.anchorPoint1).normalize(),this.t.preSolve(t,i)},solve:function(){this.t.solve()},postSolve:function(){}}),Object.assign(dt.prototype,{AngularConstraint:!0,preSolve:function(t,i){var e,s,o;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),e=1/((o=(new X).add(this.ii1,this.ii2).elements)[0]*(o[4]*o[8]-o[7]*o[5])+o[3]*(o[7]*o[2]-o[1]*o[8])+o[6]*(o[1]*o[5]-o[4]*o[2])),this.dd=(new X).set(o[4]*o[8]-o[5]*o[7],o[2]*o[7]-o[1]*o[8],o[1]*o[5]-o[2]*o[4],o[5]*o[6]-o[3]*o[8],o[0]*o[8]-o[2]*o[6],o[2]*o[3]-o[0]*o[5],o[3]*o[7]-o[4]*o[6],o[1]*o[6]-o[0]*o[7],o[0]*o[4]-o[1]*o[3]).multiplyScalar(e),this.relativeOrientation.invert(this.b1.orientation).multiply(this.targetOrientation).multiply(this.b2.orientation),e=2*this.relativeOrientation.w,this.vel.copy(this.relativeOrientation).multiplyScalar(e),(s=this.vel.length())>.02?(s=(.02-s)/s*i*.05,this.vel.multiplyScalar(s)):this.vel.set(0,0,0),this.rn1.copy(this.imp).applyMatrix3(this.ii1,!0),this.rn2.copy(this.imp).applyMatrix3(this.ii2,!0),this.a1.add(this.rn1),this.a2.sub(this.rn2)},solve:function(){var t=this.a2.clone().sub(this.a1).sub(this.vel);this.rn0.copy(t).applyMatrix3(this.dd,!0),this.rn1.copy(this.rn0).applyMatrix3(this.ii1,!0),this.rn2.copy(this.rn0).applyMatrix3(this.ii2,!0),this.imp.add(this.rn0),this.a1.add(this.rn1),this.a2.sub(this.rn2)}}),Object.assign(mt.prototype,{Translational3Constraint:!0,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var e=this.i1.elements,s=this.i2.elements;this.i1e00=e[0],this.i1e01=e[1],this.i1e02=e[2],this.i1e10=e[3],this.i1e11=e[4],this.i1e12=e[5],this.i1e20=e[6],this.i1e21=e[7],this.i1e22=e[8],this.i2e00=s[0],this.i2e01=s[1],this.i2e02=s[2],this.i2e10=s[3],this.i2e11=s[4],this.i2e12=s[5],this.i2e20=s[6],this.i2e21=s[7],this.i2e22=s[8];var o=this.p2.x-this.p1.x,n=this.p2.y-this.p1.y,r=this.p2.z-this.p1.z,a=o*this.ax1+n*this.ay1+r*this.az1,h=o*this.ax2+n*this.ay2+r*this.az2,l=o*this.ax3+n*this.ay3+r*this.az3,c=this.limitMotor1.frequency,u=this.limitMotor2.frequency,p=this.limitMotor3.frequency,d=c>0,m=u>0,y=p>0,f=this.lowerLimit1<=this.upperLimit1,v=this.lowerLimit2<=this.upperLimit2,x=this.lowerLimit3<=this.upperLimit3;(d&&a>20||a<-20)&&(d=!1),(m&&h>20||h<-20)&&(m=!1),(y&&l>20||l<-20)&&(y=!1),f?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-a,d||(a=this.lowerLimit1)):a<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-a,d||(a=this.lowerLimit1)):a>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-a,d||(a=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),d||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),v?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-h,m||(h=this.lowerLimit2)):h<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-h,m||(h=this.lowerLimit2)):h>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-h,m||(h=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),m||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),x?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,y||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),y||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||d)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||m)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||y)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var b=a*this.ax1+h*this.ax2+l*this.ax2,g=a*this.ay1+h*this.ay2+l*this.ay2,w=a*this.az1+h*this.az2+l*this.az2,z=this.m2/(this.m1+this.m2);this.weight>=0&&(z=this.weight);var N=1-z;this.r1x=this.r1.x+b*z,this.r1y=this.r1.y+g*z,this.r1z=this.r1.z+w*z,this.r2x=this.r2.x-b*N,this.r2y=this.r2.y-g*N,this.r2z=this.r2.z-w*N,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var S=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*S,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*S,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*S,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*S,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*S,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*S,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*S,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*S,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*S,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,d&&2!=this.limitState1){var M=6.2831853*c,P=M*M*t,k=i/(P+2*this.limitMotor1.dampingRatio*M);this.cfm1=this.kv00*k,this.limitVelocity1*=P*k}else this.cfm1=0,this.limitVelocity1*=.05*i;m&&2!=this.limitState2?(k=i/((P=(M=6.2831853*u)*M*t)+2*this.limitMotor2.dampingRatio*M),this.cfm2=this.kv11*k,this.limitVelocity2*=P*k):(this.cfm2=0,this.limitVelocity2*=.05*i),y&&2!=this.limitState3?(k=i/((P=(M=6.2831853*p)*M*t)+2*this.limitMotor3.dampingRatio*M),this.cfm3=this.kv22*k,this.limitVelocity3*=P*k):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var A=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*A,this.d01=(this.k02*this.k21-this.k01*this.k22)*A,this.d02=(this.k01*this.k12-this.k02*this.k11)*A,this.d10=(this.k12*this.k20-this.k10*this.k22)*A,this.d11=(this.k00*this.k22-this.k02*this.k20)*A,this.d12=(this.k02*this.k10-this.k00*this.k12)*A,this.d20=(this.k10*this.k21-this.k11*this.k20)*A,this.d21=(this.k01*this.k20-this.k00*this.k21)*A,this.d22=(this.k00*this.k11-this.k01*this.k10)*A;var V=this.limitImpulse1+this.motorImpulse1,T=this.limitImpulse2+this.motorImpulse2,I=this.limitImpulse3+this.motorImpulse3;this.l1.x+=V*this.l1x1+T*this.l1x2+I*this.l1x3,this.l1.y+=V*this.l1y1+T*this.l1y2+I*this.l1y3,this.l1.z+=V*this.l1z1+T*this.l1z2+I*this.l1z3,this.a1.x+=V*this.a1x1+T*this.a1x2+I*this.a1x3,this.a1.y+=V*this.a1y1+T*this.a1y2+I*this.a1y3,this.a1.z+=V*this.a1z1+T*this.a1z2+I*this.a1z3,this.l2.x-=V*this.l2x1+T*this.l2x2+I*this.l2x3,this.l2.y-=V*this.l2y1+T*this.l2y2+I*this.l2y3,this.l2.z-=V*this.l2z1+T*this.l2z2+I*this.l2z3,this.a2.x-=V*this.a2x1+T*this.a2x2+I*this.a2x3,this.a2.y-=V*this.a2y1+T*this.a2y2+I*this.a2y3,this.a2.z-=V*this.a2z1+T*this.a2z2+I*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,e=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,s=t*this.ax1+i*this.ay1+e*this.az1,o=t*this.ax2+i*this.ay2+e*this.az2,n=t*this.ax3+i*this.ay3+e*this.az3,r=this.motorImpulse1,a=this.motorImpulse2,h=this.motorImpulse3,l=0,c=0,u=0;this.enableMotor1&&(l=(s-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-r),this.enableMotor2&&(c=(o-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-a),this.enableMotor3&&(u=(n-this.motorSpeed3)*this.dv22,this.motorImpulse3+=u,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),u=this.motorImpulse3-h),s+=l*this.kv00+c*this.k01+u*this.k02,o+=l*this.k10+c*this.kv11+u*this.k12,n+=l*this.k20+c*this.k21+u*this.kv22,s-=this.limitVelocity1+this.limitImpulse1*this.cfm1,o-=this.limitVelocity2+this.limitImpulse2*this.cfm2,n-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,d=this.limitImpulse2,m=this.limitImpulse3,y=s*this.d00+o*this.d01+n*this.d02,f=s*this.d10+o*this.d11+n*this.d12,v=s*this.d20+o*this.d21+n*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=f,this.limitImpulse3+=v;var x,b=0;switch((2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(o+=(y=-p)*this.k10,n+=y*this.k20,b|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(s+=(f=-d)*this.k01,n+=f*this.k21,b|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(s+=(v=-m)*this.k02,o+=v*this.k12,b|=4),b){case 1:x=1/(this.k11*this.k22-this.k12*this.k21),f=(this.k22*o+-this.k12*n)*x,v=(-this.k21*o+this.k11*n)*x;break;case 2:x=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*s+-this.k02*n)*x,v=(-this.k20*s+this.k00*n)*x;break;case 3:v=n/this.k22;break;case 4:x=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*s+-this.k01*o)*x,f=(-this.k10*s+this.k00*o)*x;break;case 5:f=o/this.k11;break;case 6:y=s/this.k00}this.limitImpulse1=p+y,this.limitImpulse2=d+f,this.limitImpulse3=m+v;var g=l+y,w=c+f,z=u+v;this.l1.x+=g*this.l1x1+w*this.l1x2+z*this.l1x3,this.l1.y+=g*this.l1y1+w*this.l1y2+z*this.l1y3,this.l1.z+=g*this.l1z1+w*this.l1z2+z*this.l1z3,this.a1.x+=g*this.a1x1+w*this.a1x2+z*this.a1x3,this.a1.y+=g*this.a1y1+w*this.a1y2+z*this.a1y3,this.a1.z+=g*this.a1z1+w*this.a1z2+z*this.a1z3,this.l2.x-=g*this.l2x1+w*this.l2x2+z*this.l2x3,this.l2.y-=g*this.l2y1+w*this.l2y2+z*this.l2y3,this.l2.z-=g*this.l2z1+w*this.l2z2+z*this.l2z3,this.a2.x-=g*this.a2x1+w*this.a2x2+z*this.a2x3,this.a2.y-=g*this.a2y1+w*this.a2y2+z*this.a2y3,this.a2.z-=g*this.a2z1+w*this.a2z2+z*this.a2z3}}),yt.prototype=Object.assign(Object.create(rt.prototype),{constructor:yt,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).normalize(),this.tan.tangent(this.nor).normalize(),this.bin.crossVectors(this.nor,this.tan),this.ac.preSolve(t,i),this.t3.preSolve(t,i)},solve:function(){this.ac.solve(),this.t3.solve()},postSolve:function(){}}),ft.prototype=Object.assign(Object.create(rt.prototype),{constructor:ft,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.an1.copy(this.localAngle1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.an2.copy(this.localAngle2).applyMatrix3(this.body2.rotation,!0),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).normalize(),this.tan.tangent(this.nor).normalize(),this.bin.crossVectors(this.nor,this.tan),this.tmp.crossVectors(this.an1,this.an2);var e=_.acosClamp(_.dotVectors(this.an1,this.an2));_.dotVectors(this.nor,this.tmp)<0?this.rotationalLimitMotor.angle=-e:this.rotationalLimitMotor.angle=e,this.tmp.crossVectors(this.ax1,this.ax2),this.r3.limitMotor2.angle=_.dotVectors(this.tan,this.tmp),this.r3.limitMotor3.angle=_.dotVectors(this.bin,this.tmp),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},solve:function(){this.r3.solve(),this.t3.solve()},postSolve:function(){}}),vt.prototype=Object.assign(Object.create(rt.prototype),{constructor:vt,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.an1.copy(this.localAngle1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.an2.copy(this.localAngle2).applyMatrix3(this.body2.rotation,!0),this.r3.limitMotor1.angle=_.dotVectors(this.ax1,this.ax2);var e=_.dotVectors(this.an1,this.ax2);_.dotVectors(this.ax1,this.tmp.crossVectors(this.an1,this.ax2))<0?this.rotationalLimitMotor1.angle=-e:this.rotationalLimitMotor1.angle=e,e=_.dotVectors(this.an2,this.ax1),_.dotVectors(this.ax2,this.tmp.crossVectors(this.an2,this.ax1))<0?this.rotationalLimitMotor2.angle=-e:this.rotationalLimitMotor2.angle=e,this.nor.crossVectors(this.ax1,this.ax2).normalize(),this.tan.crossVectors(this.nor,this.ax2).normalize(),this.bin.crossVectors(this.nor,this.ax1).normalize(),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},solve:function(){this.r3.solve(),this.t3.solve()},postSolve:function(){}}),Nt.prototype={constructor:Nt,reset:function(t,i){this.body1=t.parent,this.body2=i.parent,this.numPoints=0},addPointVec:function(t,i,e,s){var o=this.points[this.numPoints++];o.position.copy(t),o.localPoint1.sub(t,this.body1.position).applyMatrix3(this.body1.rotation),o.localPoint2.sub(t,this.body2.position).applyMatrix3(this.body2.rotation),o.normal.copy(i),s&&o.normal.negate(),o.normalImpulse=0,o.penetration=e,o.warmStarted=!1},addPoint:function(t,i,e,s,o,n,r,a){var h=this.points[this.numPoints++];h.position.set(t,i,e),h.localPoint1.sub(h.position,this.body1.position).applyMatrix3(this.body1.rotation),h.localPoint2.sub(h.position,this.body2.position).applyMatrix3(this.body2.rotation),h.normalImpulse=0,h.normal.set(s,o,n),a&&h.normal.negate(),h.penetration=r,h.warmStarted=!1}},Mt.prototype=Object.assign(Object.create(ot.prototype),{constructor:Mt,attach:function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},detach:function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},preSolve:function(t,i){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass;var e=this.m1+this.m2;this.num=this.manifold.numPoints;for(var s,o,n,r,a,h,l,c=this.cs,u=0;u<this.num;u++)s=this.ps[u],this.tmpP1.sub(s.position,this.p1),this.tmpP2.sub(s.position,this.p2),this.tmpC1.crossVectors(this.av1,this.tmpP1),this.tmpC2.crossVectors(this.av2,this.tmpP2),c.norImp=s.normalImpulse,c.tanImp=s.tangentImpulse,c.binImp=s.binormalImpulse,c.nor.copy(s.normal),this.tmp.set(this.lv2.x+this.tmpC2.x-(this.lv1.x+this.tmpC1.x),this.lv2.y+this.tmpC2.y-(this.lv1.y+this.tmpC1.y),this.lv2.z+this.tmpC2.z-(this.lv1.z+this.tmpC1.z)),o=_.dotVectors(c.nor,this.tmp),c.tan.set(this.tmp.x-o*c.nor.x,this.tmp.y-o*c.nor.y,this.tmp.z-o*c.nor.z),_.dotVectors(c.tan,c.tan)<=.04&&c.tan.tangent(c.nor),c.tan.normalize(),c.bin.crossVectors(c.nor,c.tan),c.norU1.scale(c.nor,this.m1),c.norU2.scale(c.nor,this.m2),c.tanU1.scale(c.tan,this.m1),c.tanU2.scale(c.tan,this.m2),c.binU1.scale(c.bin,this.m1),c.binU2.scale(c.bin,this.m2),c.norT1.crossVectors(this.tmpP1,c.nor),c.tanT1.crossVectors(this.tmpP1,c.tan),c.binT1.crossVectors(this.tmpP1,c.bin),c.norT2.crossVectors(this.tmpP2,c.nor),c.tanT2.crossVectors(this.tmpP2,c.tan),c.binT2.crossVectors(this.tmpP2,c.bin),h=this.i1,l=this.i2,c.norTU1.copy(c.norT1).applyMatrix3(h,!0),c.tanTU1.copy(c.tanT1).applyMatrix3(h,!0),c.binTU1.copy(c.binT1).applyMatrix3(h,!0),c.norTU2.copy(c.norT2).applyMatrix3(l,!0),c.tanTU2.copy(c.tanT2).applyMatrix3(l,!0),c.binTU2.copy(c.binT2).applyMatrix3(l,!0),this.tmpC1.crossVectors(c.norTU1,this.tmpP1),this.tmpC2.crossVectors(c.norTU2,this.tmpP2),this.tmp.add(this.tmpC1,this.tmpC2),c.norDen=1/(e+_.dotVectors(c.nor,this.tmp)),this.tmpC1.crossVectors(c.tanTU1,this.tmpP1),this.tmpC2.crossVectors(c.tanTU2,this.tmpP2),this.tmp.add(this.tmpC1,this.tmpC2),c.tanDen=1/(e+_.dotVectors(c.tan,this.tmp)),this.tmpC1.crossVectors(c.binTU1,this.tmpP1),this.tmpC2.crossVectors(c.binTU2,this.tmpP2),this.tmp.add(this.tmpC1,this.tmpC2),c.binDen=1/(e+_.dotVectors(c.bin,this.tmp)),s.warmStarted?(n=s.normalImpulse,this.lv1.addScaledVector(c.norU1,n),this.av1.addScaledVector(c.norTU1,n),this.lv2.subScaledVector(c.norU2,n),this.av2.subScaledVector(c.norTU2,n),c.norImp=n,c.tanImp=0,c.binImp=0,o=0):(c.norImp=0,c.tanImp=0,c.binImp=0),o>-1&&(o=0),(r=this.restitution*-o)<(a=-(s.penetration+.005)*i*.05)&&(r=a),c.norTar=r,c.last=u==this.num-1,c=c.next},solve:function(){var t,i,e,s,o,n,r,a,h;this.tmplv1.copy(this.lv1),this.tmplv2.copy(this.lv2),this.tmpav1.copy(this.av1),this.tmpav2.copy(this.av2);for(var l=this.cs;o=l.norImp,n=l.tanImp,r=l.binImp,a=-o*this.friction,this.tmp.sub(this.tmplv2,this.tmplv1),t=n,e=r,(h=(n+=i=(_.dotVectors(this.tmp,l.tan)+_.dotVectors(this.tmpav2,l.tanT2)-_.dotVectors(this.tmpav1,l.tanT1))*l.tanDen)*n+(r+=s=(_.dotVectors(this.tmp,l.bin)+_.dotVectors(this.tmpav2,l.binT2)-_.dotVectors(this.tmpav1,l.binT1))*l.binDen)*r)>a*a&&(n*=h=a/_.sqrt(h),r*=h),i=n-t,s=r-e,this.tmp.set(l.tanU1.x*i+l.binU1.x*s,l.tanU1.y*i+l.binU1.y*s,l.tanU1.z*i+l.binU1.z*s),this.tmplv1.addEqual(this.tmp),this.tmp.set(l.tanTU1.x*i+l.binTU1.x*s,l.tanTU1.y*i+l.binTU1.y*s,l.tanTU1.z*i+l.binTU1.z*s),this.tmpav1.addEqual(this.tmp),this.tmp.set(l.tanU2.x*i+l.binU2.x*s,l.tanU2.y*i+l.binU2.y*s,l.tanU2.z*i+l.binU2.z*s),this.tmplv2.subEqual(this.tmp),this.tmp.set(l.tanTU2.x*i+l.binTU2.x*s,l.tanTU2.y*i+l.binTU2.y*s,l.tanTU2.z*i+l.binTU2.z*s),this.tmpav2.subEqual(this.tmp),this.tmp.sub(this.tmplv2,this.tmplv1),t=o,(o+=i=(_.dotVectors(this.tmp,l.nor)+_.dotVectors(this.tmpav2,l.norT2)-_.dotVectors(this.tmpav1,l.norT1)-l.norTar)*l.norDen)>0&&(o=0),i=o-t,this.tmplv1.addScaledVector(l.norU1,i),this.tmpav1.addScaledVector(l.norTU1,i),this.tmplv2.subScaledVector(l.norU2,i),this.tmpav2.subScaledVector(l.norTU2,i),l.norImp=o,l.tanImp=n,l.binImp=r,!l.last;)l=l.next;this.lv1.copy(this.tmplv1),this.lv2.copy(this.tmplv2),this.av1.copy(this.tmpav1),this.av2.copy(this.tmpav2)},postSolve:function(){for(var t,i=this.cs,e=this.num;e--;)(t=this.ps[e]).normal.copy(i.nor),t.tangent.copy(i.tan),t.binormal.copy(i.bin),t.normalImpulse=i.norImp,t.tangentImpulse=i.tanImp,t.binormalImpulse=i.binImp,t.normalDenominator=i.norDen,t.tangentDenominator=i.tanDen,t.binormalDenominator=i.binDen,i=i.next}}),Object.assign(Pt.prototype,{Contact:!0,mixRestitution:function(t,i){return _.sqrt(t*i)},mixFriction:function(t,i){return _.sqrt(t*i)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,i=t;i--;){var e=this.buffer[i],s=this.points[i];e.lp1X=s.localPoint1.x,e.lp1Y=s.localPoint1.y,e.lp1Z=s.localPoint1.z,e.lp2X=s.localPoint2.x,e.lp2Y=s.localPoint2.y,e.lp2Z=s.localPoint2.z,e.impulse=s.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var o=this.manifold.numPoints;if(0==o)return this.touching=!1,this.close=!1,void(this.dist=_.INF);for((this.touching||this.dist<.001)&&(this.close=!0),this.touching=!0,i=o;i--;){for(var n=(s=this.points[i]).localPoint1.x,r=s.localPoint1.y,a=s.localPoint1.z,h=s.localPoint2.x,l=s.localPoint2.y,c=s.localPoint2.z,u=-1,p=4e-4,d=t;d--;){var m=(e=this.buffer[d]).lp1X-n,y=e.lp1Y-r,f=e.lp1Z-a,v=m*m+y*y+f*f,x=(m=e.lp2X-h)*m+(y=e.lp2Y-l)*y+(f=e.lp2Z-c)*f;v<x?v<p&&(p=v,u=d):x<p&&(p=x,u=d),p<this.dist&&(this.dist=p)}if(-1!=u){var b=this.buffer[u];this.buffer[u]=this.buffer[--t],this.buffer[t]=b,s.normalImpulse=b.impulse,s.warmStarted=!0}else s.normalImpulse=0,s.warmStarted=!1}},attach:function(t,i){this.shape1=t,this.shape2=i,this.body1=t.parent,this.body2=i.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=i,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=i.contactLink?(this.s2Link.next=i.contactLink).prev=this.s2Link:this.s2Link.next=null,i.contactLink=this.s2Link,i.numContacts++,this.b1Link.shape=i,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,i=this.s1Link.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=i),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,i=this.s2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=i),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,i=this.b1Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,i=this.b2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}}),Object.assign(kt.prototype,{setParent:function(t){this.parent=t,this.scale=this.parent.scale,this.invScale=this.parent.invScale,this.id=this.parent.numRigidBodies,this.name||(this.name=this.id),this.updateMesh()},addShape:function(t){t.parent&&W("RigidBody","It is not possible that you add a shape which already has an associated body."),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var i=t;if(i.parent==this){var e=i.prev,s=i.next;null!=e&&(e.next=s),null!=s&&(s.prev=e),this.shapes==i&&(this.shapes=s),i.prev=null,i.next=null,i.parent=null,this.parent&&this.parent.removeShape(i),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,i){var e=void 0===i||i;this.type=t||2,this.isDynamic=1===this.type,this.isStatic=2===this.type,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var s=new X,o=new H,n=this.shapes;null!==n;n=n.next){n.calculateMassInfo(this.massInfo);var r=this.massInfo.mass;o.addScaledVector(n.relativePosition,r),this.mass+=r,this.rotateInertia(n.relativeRotation,this.massInfo.inertia,s),this.localInertia.add(s),this.localInertia.addOffset(r,n.relativePosition)}if(this.inverseMass=1/this.mass,o.scaleEqual(this.inverseMass),e){for(this.position.add(o),n=this.shapes;null!==n;n=n.next)n.relativePosition.subEqual(o);this.localInertia.subOffset(this.mass,o)}this.inverseLocalInertia.invert(this.localInertia),2===this.type&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var i=this.jointLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var e=this.shapes;null!=e;e=e.next)e.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},testWakeUp:function(){(this.linearVelocity.testZero()||this.angularVelocity.testZero()||this.position.testDiff(this.sleepPosition)||this.orientation.testDiff(this.sleepOrientation))&&this.awake()},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case 2:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case 1:this.isKinematic&&(this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0)),this.controlPos&&(this.linearVelocity.subVectors(this.newPosition,this.position).multiplyScalar(1/t),this.controlPos=!1),this.controlRot&&(this.angularVelocity.copy(this.getAxis()),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addScaledVector(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t),this.updateMesh();break;default:W("RigidBody","Invalid type.")}this.syncShapes(),this.updateMesh()},getAxis:function(){return new H(0,1,0).applyMatrix3(this.inverseLocalInertia,!0).normalize()},rotateInertia:function(t,i,e){this.tmpInertia.multiplyMatrices(t,i),e.multiplyMatrices(this.tmpInertia,t,!0)},syncShapes:function(){this.rotation.setQuat(this.orientation),this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var t=this.shapes;null!=t;t=t.next)t.position.copy(t.relativePosition).applyMatrix3(this.rotation,!0).add(this.position),t.rotation.multiplyMatrices(this.rotation,t.relativeRotation),t.updateProxy()},applyImpulse:function(t,i){this.linearVelocity.addScaledVector(i,this.inverseMass);var e=(new H).copy(t).sub(this.position).cross(i).applyMatrix3(this.inverseInertia,!0);this.angularVelocity.add(e)},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(this.invScale),this.controlPos=!0,this.isKinematic||(this.isKinematic=!0)},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0,this.isKinematic||(this.isKinematic=!0)},setRotation:function(t){this.newOrientation=(new G).setFromEuler(t.x*_.degtorad,t.y*_.degtorad,t.y*_.degtorad),this.controlRot=!0},resetPosition:function(t,i,e){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,i,e).multiplyScalar(this.invScale),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new G(t.x,t.y,t.z,t.w),this.awake()},resetRotation:function(t,i,e){this.angularVelocity.set(0,0,0),this.orientation=(new G).setFromEuler(t*_.degtorad,i*_.degtorad,e*_.degtorad),this.awake()},getPosition:function(){return this.pos},getQuaternion:function(){return this.quaternion},connectMesh:function(t){this.mesh=t,this.updateMesh()},updateMesh:function(){this.pos.scale(this.position,this.scale),this.quaternion.copy(this.orientation),null!==this.mesh&&(this.mesh.position.copy(this.getPosition()),this.mesh.quaternion.copy(this.getQuaternion()))}}),Object.assign(Vt.prototype,{BroadPhase:!0,createProxy:function(t){W("BroadPhase","Inheritance error.")},addProxy:function(t){W("BroadPhase","Inheritance error.")},removeProxy:function(t){W("BroadPhase","Inheritance error.")},isAvailablePair:function(t,i){var e,s=t.parent,o=i.parent;if(s==o||!s.isDynamic&&!o.isDynamic||0==(t.belongsTo&i.collidesWith)||0==(i.belongsTo&t.collidesWith))return!1;for(e=s.numJoints<o.numJoints?s.jointLink:o.jointLink;null!==e;){var n=e.joint;if(!n.allowCollision&&(n.body1==s&&n.body2==o||n.body1==o&&n.body2==s))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){Error("BroadPhase","Inheritance error.")},addPair:function(t,i){var e=new At(t,i);this.pairs.push(e),this.numPairs++}});var Tt=0;function It(t){this.shape=t,this.aabb=t.aabb}function Lt(t){It.call(this,t),this.id=Tt++}function Ct(){Vt.call(this),this.types=M,this.proxies=[]}function Bt(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new Float32Array(64)}function Et(t,i){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=i,this.value=0}function Rt(t,i){It.call(this,i),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new Et(this,!1),this.max[0]=new Et(this,!0),this.min[1]=new Et(this,!1),this.max[1]=new Et(this,!0),this.min[2]=new Et(this,!1),this.max[2]=new Et(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]}function Ft(){Vt.call(this),this.types=P,this.numElementsD=0,this.numElementsS=0,this.axesD=[new Bt,new Bt,new Bt],this.axesS=[new Bt,new Bt,new Bt],this.index1=0,this.index2=1}function qt(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new Y}function jt(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new Y}function Ot(t){It.call(this,t),this.leaf=new qt,this.leaf.proxy=this}function Dt(){Vt.call(this),this.types=k,this.tree=new jt,this.stack=[],this.leaves=[],this.numLeaves=0}function _t(){this.flip=!1}function Wt(){_t.call(this),this.clipVertices1=new Float32Array(24),this.clipVertices2=new Float32Array(24),this.used=new Float32Array(8),this.INF=1/0}function Ut(t){_t.call(this),this.flip=t}function Ht(){_t.call(this)}function Gt(t){_t.call(this),this.flip=t}function Xt(t){_t.call(this),this.flip=t}function Yt(){_t.call(this)}function Qt(t){_t.call(this),this.flip=t,this.n=new H,this.p=new H}function Zt(t){_t.call(this),this.flip=t,this.n=new H,this.p=new H,this.dix=new H,this.diy=new H,this.diz=new H,this.cc=new H,this.cc2=new H}function Kt(t){switch(t instanceof Object||(t={}),this.scale=t.worldscale||1,this.invScale=1/this.scale,this.timeStep=t.timestep||.01666,this.timerate=1e3*this.timeStep,this.timer=null,this.preLoop=null,this.postLoop=null,this.numIterations=t.iterations||8,t.broadphase||2){case 1:this.broadPhase=new Ct;break;case 2:default:this.broadPhase=new Ft;break;case 3:this.broadPhase=new Dt}this.Btypes=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhaseType=this.Btypes[t.broadphase||2],this.performance=null,this.isStat=void 0!==t.info&&t.info,this.isStat&&(this.performance=new U(this)),this.enableRandomizer=void 0===t.random||t.random,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new H(0,-9.8,0),void 0!==t.gravity&&this.gravity.fromArray(t.gravity);this.detectors=[],this.detectors.length=5;for(var i=5;i--;)this.detectors[i]=[],this.detectors[i].length=5;this.detectors[T][T]=new Yt,this.detectors[T][I]=new Gt(!1),this.detectors[I][T]=new Gt(!0),this.detectors[I][I]=new Wt,this.detectors[L][L]=new Ht,this.detectors[L][I]=new Ut(!0),this.detectors[I][L]=new Ut(!1),this.detectors[L][T]=new Xt(!0),this.detectors[T][L]=new Xt(!1),this.detectors[C][T]=new Qt(!0),this.detectors[T][C]=new Qt(!1),this.detectors[C][I]=new Zt(!0),this.detectors[I][C]=new Zt(!1),this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]}Object.assign(It.prototype,{Proxy:!0,update:function(){W("Proxy","Inheritance error.")}}),Lt.prototype=Object.assign(Object.create(It.prototype),{constructor:Lt,update:function(){}}),Ct.prototype=Object.assign(Object.create(Vt.prototype),{constructor:Ct,createProxy:function(t){return new Lt(t)},addProxy:function(t){this.proxies.push(t)},removeProxy:function(t){var i=this.proxies.indexOf(t);i>-1&&this.proxies.splice(i,1)},collectPairs:function(){var t,i,e,s=0,o=this.proxies,n=o.length;for(this.numPairChecks=n*(n-1)>>1;s<n;)for(i=o[s++],t=s+1;t<n;)e=o[t++],!i.aabb.intersectTest(e.aabb)&&this.isAvailablePair(i.shape,e.shape)&&this.addPair(i.shape,e.shape)}}),Object.assign(Bt.prototype,{SAPAxis:!0,addElements:function(t,i){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var e=[],s=this.numElements;s--;)e[s]=this.elements[s]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=i},removeElements:function(t,i){for(var e=-1,s=-1,o=0,n=this.numElements;o<n;o++){var r=this.elements[o];if(r==t||r==i){if(-1!=e){s=o;break}e=o}}for(o=e+1,n=s;o<n;o++)this.elements[o-1]=this.elements[o];for(o=s+1,n=this.numElements;o<n;o++)this.elements[o-2]=this.elements[o];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,i=1;this.numElements>>i!=0;)i++;i=i*this.numElements>>2,t=0;for(var e=!1,s=this.elements,o=1,n=this.numElements;o<n;o++){var r=s[o],a=r.value,h=s[o-1];if(h.value>a){var l=o;do{if(s[l]=h,0==--l)break;h=s[l-1]}while(h.value>a);if(s[l]=r,(t+=o-l)>i){e=!0;break}}}if(e){t=2;var c=this.stack;for(c[0]=0,c[1]=this.numElements-1;t>0;){var u=c[--t],p=c[--t],d=u-p;if(d>16){var m=p+_.floor(.5*d);for(r=s[m],s[m]=s[u],s[u]=r,a=r.value,o=p-1,l=u;;){var y,f;do{y=s[++o]}while(y.value<a);do{f=s[--l]}while(a<f.value&&l!=p);if(o>=l)break;s[o]=f,s[l]=y}s[u]=s[o],s[o]=r,o-p>u-o?(c[t++]=p,c[t++]=o-1,c[t++]=o+1,c[t++]=u):(c[t++]=o+1,c[t++]=u,c[t++]=p,c[t++]=o-1)}else for(o=p+1;o<=u;o++)if(a=(r=s[o]).value,(h=s[o-1]).value>a){l=o;do{if(s[l]=h,0==--l)break;h=s[l-1]}while(h.value>a);s[l]=r}}}},calculateTestCount:function(){for(var t=1,i=0,e=1,s=this.numElements;e<s;e++)this.elements[e].max?t--:(i+=t,t++);return i}}),Rt.prototype=Object.assign(Object.create(It.prototype),{constructor:Rt,isDynamic:function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},update:function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))}}),Ft.prototype=Object.assign(Object.create(Vt.prototype),{constructor:Ft,createProxy:function(t){return new Rt(this,t)},addProxy:function(t){var i=t;i.isDynamic()?(this.axesD[0].addElements(i.min[0],i.max[0]),this.axesD[1].addElements(i.min[1],i.max[1]),this.axesD[2].addElements(i.min[2],i.max[2]),i.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(i.min[0],i.max[0]),this.axesS[1].addElements(i.min[1],i.max[1]),this.axesS[2].addElements(i.min[2],i.max[2]),i.belongsTo=2,this.numElementsS+=2)},removeProxy:function(t){var i=t;if(0!=i.belongsTo){switch(i.belongsTo){case 1:this.axesD[0].removeElements(i.min[0],i.max[0]),this.axesD[1].removeElements(i.min[1],i.max[1]),this.axesD[2].removeElements(i.min[2],i.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(i.min[0],i.max[0]),this.axesS[1].removeElements(i.min[1],i.max[1]),this.axesS[2].removeElements(i.min[2],i.max[2]),this.numElementsS-=2}i.belongsTo=0}},collectPairs:function(){if(0!=this.numElementsD){var t,i,e,s,o=this.axesD[this.index1],n=this.axesD[this.index2];o.sort(),n.sort(),o.calculateTestCount()<=n.calculateTestCount()?((n=this.axesS[this.index1]).sort(),t=o.elements,i=n.elements):((o=this.axesS[this.index2]).sort(),t=n.elements,i=o.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var r=0,a=0;r<this.numElementsD;){var h,l;if(a==this.numElementsS)h=t[r],l=!0,r++;else{var c=t[r],u=i[a];c.value<u.value?(h=c,l=!0,r++):(h=u,l=!1,a++)}if(h.max){var p=h.pair;if(l){if(p==e){e=e.pair;continue}h=e}else{if(p==s){s=s.pair;continue}h=s}do{if((x=h.pair)==p){h.pair=x.pair;break}h=x}while(null!=h)}else{for(var d=h.proxy.shape,m=h.min1.value,y=h.max1.value,f=h.min2.value,v=h.max2.value,x=e;null!=x;x=x.pair){var b=x.proxy.shape;this.numPairChecks++,m>x.max1.value||y<x.min1.value||f>x.max2.value||v<x.min2.value||!this.isAvailablePair(d,b)||this.addPair(d,b)}if(l){for(x=s;null!=x;x=x.pair)b=x.proxy.shape,this.numPairChecks++,m>x.max1.value||y<x.min1.value||f>x.max2.value||v<x.min2.value||!this.isAvailablePair(d,b)||this.addPair(d,b);h.pair=e,e=h}else h.pair=s,s=h}}this.index2=3^(this.index1|this.index2)}}}),Object.assign(jt.prototype,{DBVT:!0,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null!=this.root){for(var i,e,s=t.aabb,o=this.root;null==o.proxy;){var n=o.child1,r=o.child2,a=o.aabb,h=n.aabb,l=r.aabb;i=a.surfaceArea(),this.aabb.combine(s,a);var c=2*(e=this.aabb.surfaceArea()),u=2*(e-i),p=u;this.aabb.combine(s,h),null!=n.proxy?p+=this.aabb.surfaceArea():p+=this.aabb.surfaceArea()-h.surfaceArea();var d=u;if(this.aabb.combine(s,l),null!=r.proxy?d+=this.aabb.surfaceArea():d+=this.aabb.surfaceArea()-l.surfaceArea(),p<d){if(c<p)break;o=n}else{if(c<d)break;o=r}}var m,y=o.parent;(m=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new qt).parent=y,m.child1=t,m.child2=o,m.aabb.combine(t.aabb,o.aabb),m.height=o.height+1,o.parent=m,t.parent=m,o==this.root?this.root=m:y.child1==o?y.child1=m:y.child2=m;do{m=this.balance(m),this.fix(m),m=m.parent}while(null!=m)}else this.root=t},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t!=this.root){var i,e=t.parent;if(i=e.child1==t?e.child2:e.child1,e==this.root)return this.root=i,void(i.parent=null);var s=e.parent;i.parent=s,s.child1==e?s.child1=i:s.child2=i,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=e);do{s=this.balance(s),this.fix(s),s=s.parent}while(null!=s)}else this.root=null},balance:function(t){var i=t.height;if(i<2)return t;var e,s=t.parent,o=t.child1,n=t.child2,r=o.height,a=n.height,h=r-a;if(h>1){var l=o.child1,c=o.child2,u=l.height,p=c.height;return u>p?(o.child2=t,t.parent=o,t.child1=c,c.parent=t,t.aabb.combine(c.aabb,n.aabb),e=p-a,t.height=p-(e&e>>31)+1,o.aabb.combine(l.aabb,t.aabb),e=u-i,o.height=u-(e&e>>31)+1):(o.child1=t,t.parent=o,t.child1=l,l.parent=t,t.aabb.combine(l.aabb,n.aabb),e=u-a,t.height=u-(e&e>>31)+1,o.aabb.combine(t.aabb,c.aabb),e=i-p,o.height=i-(e&e>>31)+1),null!=s?s.child1==t?s.child1=o:s.child2=o:this.root=o,o.parent=s,o}if(h<-1){var d=n.child1,m=n.child2,y=d.height,f=m.height;return y>f?(n.child2=t,t.parent=n,t.child2=m,m.parent=t,t.aabb.combine(o.aabb,m.aabb),e=r-f,t.height=r-(e&e>>31)+1,n.aabb.combine(d.aabb,t.aabb),e=y-i,n.height=y-(e&e>>31)+1):(n.child1=t,t.parent=n,t.child2=d,d.parent=t,t.aabb.combine(o.aabb,d.aabb),e=r-y,t.height=r-(e&e>>31)+1,n.aabb.combine(t.aabb,m.aabb),e=i-f,n.height=i-(e&e>>31)+1),null!=s?s.child1==t?s.child1=n:s.child2=n:this.root=n,n.parent=s,n}return t},fix:function(t){var i=t.child1,e=t.child2;t.aabb.combine(i.aabb,e.aabb),t.height=i.height<e.height?e.height+1:i.height+1}}),Ot.prototype=Object.assign(Object.create(It.prototype),{constructor:Ot,update:function(){}}),Dt.prototype=Object.assign(Object.create(Vt.prototype),{constructor:Dt,createProxy:function(t){return new Ot(t)},addProxy:function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},removeProxy:function(t){this.tree.deleteLeaf(t.leaf);var i=this.leaves.indexOf(t.leaf);i>-1&&(this.leaves.splice(i,1),this.numLeaves--)},collectPairs:function(){if(!(this.numLeaves<2))for(var t,i=this.numLeaves;i--;)(t=this.leaves[i]).proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,.1),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},collide:function(t,i){var e,s,o,n,r,a,h=2;for(this.stack[0]=t,this.stack[1]=i;h>0;)if(o=this.stack[--h],n=this.stack[--h],r=null!=o.proxy,a=null!=n.proxy,this.numPairChecks++,r&&a){if((e=o.proxy.shape)==(s=n.proxy.shape)||e.aabb.intersectTest(s.aabb)||!this.isAvailablePair(e,s))continue;this.addPair(e,s)}else{if(o.aabb.intersectTest(n.aabb))continue;a||!r&&o.aabb.surfaceArea()>n.aabb.surfaceArea()?(this.stack[h++]=o.child1,this.stack[h++]=n,this.stack[h++]=o.child2,this.stack[h++]=n):(this.stack[h++]=o,this.stack[h++]=n.child1,this.stack[h++]=o,this.stack[h++]=n.child2)}}}),Object.assign(_t.prototype,{CollisionDetector:!0,detectCollision:function(t,i,e){W("CollisionDetector","Inheritance error.")}}),Wt.prototype=Object.assign(Object.create(_t.prototype),{constructor:Wt,detectCollision:function(t,i,e){var s,o;t.id<i.id?(s=t,o=i):(s=i,o=t);var n,r,a,h,l,c,u,p,d,m,y,f,v,x,b,g,w,z,N,S,M,P,k,A,V,T,I,L,C,B,E,R,F,q,j,O=s.elements,D=o.elements,W=s.dimentions,U=o.dimentions,H=s.position,G=o.position,X=H.x,Y=H.y,Q=H.z,Z=G.x,K=G.y,J=G.z,$=Z-X,tt=K-Y,it=J-Q,et=s.halfWidth,st=s.halfHeight,ot=s.halfDepth,nt=o.halfWidth,rt=o.halfHeight,at=o.halfDepth,ht=W[0],lt=W[1],ct=W[2],ut=W[3],pt=W[4],dt=W[5],mt=W[6],yt=W[7],ft=W[8],vt=W[9],xt=W[10],bt=W[11],gt=W[12],wt=W[13],zt=W[14],Nt=W[15],St=W[16],Mt=W[17],Pt=U[0],kt=U[1],At=U[2],Vt=U[3],Tt=U[4],It=U[5],Lt=U[6],Ct=U[7],Bt=U[8],Et=U[9],Rt=U[10],Ft=U[11],qt=U[12],jt=U[13],Ot=U[14],Dt=U[15],_t=U[16],Wt=U[17],Ut=lt*At-ct*kt,Ht=ct*Pt-ht*At,Gt=ht*kt-lt*Pt,Xt=lt*It-ct*Tt,Yt=ct*Vt-ht*It,Qt=ht*Tt-lt*Vt,Zt=lt*Bt-ct*Ct,Kt=ct*Lt-ht*Bt,Jt=ht*Ct-lt*Lt,$t=pt*At-dt*kt,ti=dt*Pt-ut*At,ii=ut*kt-pt*Pt,ei=pt*It-dt*Tt,si=dt*Vt-ut*It,oi=ut*Tt-pt*Vt,ni=pt*Bt-dt*Ct,ri=dt*Lt-ut*Bt,ai=ut*Ct-pt*Lt,hi=yt*At-ft*kt,li=ft*Pt-mt*At,ci=mt*kt-yt*Pt,ui=yt*It-ft*Tt,pi=ft*Vt-mt*It,di=mt*Tt-yt*Vt,mi=yt*Bt-ft*Ct,yi=ft*Lt-mt*Bt,fi=mt*Ct-yt*Lt,vi=!1,xi=!1,bi=!1,gi=!1,wi=!1,zi=!1,Ni=!1,Si=!1,Mi=!1;if((n=(E=ht*$+lt*tt+ct*it)>0)||(E=-E),(F=ht*Pt+lt*kt+ct*At)<0&&(F=-F),(q=ht*Vt+lt*Tt+ct*It)<0&&(q=-q),(j=ht*Lt+lt*Ct+ct*Bt)<0&&(j=-j),!((g=E-(R=et)-(F*nt+q*rt+j*at))>0||((r=(E=ut*$+pt*tt+dt*it)>0)||(E=-E),(F=ut*Pt+pt*kt+dt*At)<0&&(F=-F),(q=ut*Vt+pt*Tt+dt*It)<0&&(q=-q),(j=ut*Lt+pt*Ct+dt*Bt)<0&&(j=-j),(w=E-(R=st)-(F*nt+q*rt+j*at))>0||((a=(E=mt*$+yt*tt+ft*it)>0)||(E=-E),(F=mt*Pt+yt*kt+ft*At)<0&&(F=-F),(q=mt*Vt+yt*Tt+ft*It)<0&&(q=-q),(j=mt*Lt+yt*Ct+ft*Bt)<0&&(j=-j),(z=E-(R=ot)-(F*nt+q*rt+j*at))>0||((h=(E=Pt*$+kt*tt+At*it)>0)||(E=-E),(F=Pt*ht+kt*lt+At*ct)<0&&(F=-F),(q=Pt*ut+kt*pt+At*dt)<0&&(q=-q),(j=Pt*mt+kt*yt+At*ft)<0&&(j=-j),(N=1*(E-(R=F*et+q*st+j*ot)-nt))>0||((l=(E=Vt*$+Tt*tt+It*it)>0)||(E=-E),(F=Vt*ht+Tt*lt+It*ct)<0&&(F=-F),(q=Vt*ut+Tt*pt+It*dt)<0&&(q=-q),(j=Vt*mt+Tt*yt+It*ft)<0&&(j=-j),(S=1*(E-(R=F*et+q*st+j*ot)-rt))>0||((c=(E=Lt*$+Ct*tt+Bt*it)>0)||(E=-E),(F=Lt*ht+Ct*lt+Bt*ct)<0&&(F=-F),(q=Lt*ut+Ct*pt+Bt*dt)<0&&(q=-q),(j=Lt*mt+Ct*yt+Bt*ft)<0&&(j=-j),(M=1*(E-(R=F*et+q*st+j*ot)-at))>0))))))){if((E=Ut*Ut+Ht*Ht+Gt*Gt)>1e-5){if((u=(E=(Ut*=E=1/_.sqrt(E))*$+(Ht*=E)*tt+(Gt*=E)*it)>0)||(E=-E),(F=Ut*ut+Ht*pt+Gt*dt)<0&&(F=-F),(q=Ut*mt+Ht*yt+Gt*ft)<0&&(q=-q),R=F*st+q*ot,(F=Ut*Vt+Ht*Tt+Gt*It)<0&&(F=-F),(q=Ut*Lt+Ht*Ct+Gt*Bt)<0&&(q=-q),(P=E-R-(F*rt+q*at))>0)return}else u=!1,P=0,vi=!0;if((E=Xt*Xt+Yt*Yt+Qt*Qt)>1e-5){if((p=(E=(Xt*=E=1/_.sqrt(E))*$+(Yt*=E)*tt+(Qt*=E)*it)>0)||(E=-E),(F=Xt*ut+Yt*pt+Qt*dt)<0&&(F=-F),(q=Xt*mt+Yt*yt+Qt*ft)<0&&(q=-q),R=F*st+q*ot,(F=Xt*Pt+Yt*kt+Qt*At)<0&&(F=-F),(q=Xt*Lt+Yt*Ct+Qt*Bt)<0&&(q=-q),(k=E-R-(F*nt+q*at))>0)return}else p=!1,k=0,xi=!0;if((E=Zt*Zt+Kt*Kt+Jt*Jt)>1e-5){if((d=(E=(Zt*=E=1/_.sqrt(E))*$+(Kt*=E)*tt+(Jt*=E)*it)>0)||(E=-E),(F=Zt*ut+Kt*pt+Jt*dt)<0&&(F=-F),(q=Zt*mt+Kt*yt+Jt*ft)<0&&(q=-q),R=F*st+q*ot,(F=Zt*Pt+Kt*kt+Jt*At)<0&&(F=-F),(q=Zt*Vt+Kt*Tt+Jt*It)<0&&(q=-q),(A=E-R-(F*nt+q*rt))>0)return}else d=!1,A=0,bi=!0;if((E=$t*$t+ti*ti+ii*ii)>1e-5){if((m=(E=($t*=E=1/_.sqrt(E))*$+(ti*=E)*tt+(ii*=E)*it)>0)||(E=-E),(F=$t*ht+ti*lt+ii*ct)<0&&(F=-F),(q=$t*mt+ti*yt+ii*ft)<0&&(q=-q),R=F*et+q*ot,(F=$t*Vt+ti*Tt+ii*It)<0&&(F=-F),(q=$t*Lt+ti*Ct+ii*Bt)<0&&(q=-q),(V=E-R-(F*rt+q*at))>0)return}else m=!1,V=0,gi=!0;if((E=ei*ei+si*si+oi*oi)>1e-5){if((y=(E=(ei*=E=1/_.sqrt(E))*$+(si*=E)*tt+(oi*=E)*it)>0)||(E=-E),(F=ei*ht+si*lt+oi*ct)<0&&(F=-F),(q=ei*mt+si*yt+oi*ft)<0&&(q=-q),R=F*et+q*ot,(F=ei*Pt+si*kt+oi*At)<0&&(F=-F),(q=ei*Lt+si*Ct+oi*Bt)<0&&(q=-q),(T=E-R-(F*nt+q*at))>0)return}else y=!1,T=0,wi=!0;if((E=ni*ni+ri*ri+ai*ai)>1e-5){if((f=(E=(ni*=E=1/_.sqrt(E))*$+(ri*=E)*tt+(ai*=E)*it)>0)||(E=-E),(F=ni*ht+ri*lt+ai*ct)<0&&(F=-F),(q=ni*mt+ri*yt+ai*ft)<0&&(q=-q),R=F*et+q*ot,(F=ni*Pt+ri*kt+ai*At)<0&&(F=-F),(q=ni*Vt+ri*Tt+ai*It)<0&&(q=-q),(I=E-R-(F*nt+q*rt))>0)return}else f=!1,I=0,zi=!0;if((E=hi*hi+li*li+ci*ci)>1e-5){if((v=(E=(hi*=E=1/_.sqrt(E))*$+(li*=E)*tt+(ci*=E)*it)>0)||(E=-E),(F=hi*ht+li*lt+ci*ct)<0&&(F=-F),(q=hi*ut+li*pt+ci*dt)<0&&(q=-q),R=F*et+q*st,(F=hi*Vt+li*Tt+ci*It)<0&&(F=-F),(q=hi*Lt+li*Ct+ci*Bt)<0&&(q=-q),(L=E-R-(F*rt+q*at))>0)return}else v=!1,L=0,Ni=!0;if((E=ui*ui+pi*pi+di*di)>1e-5){if((x=(E=(ui*=E=1/_.sqrt(E))*$+(pi*=E)*tt+(di*=E)*it)>0)||(E=-E),(F=ui*ht+pi*lt+di*ct)<0&&(F=-F),(q=ui*ut+pi*pt+di*dt)<0&&(q=-q),R=F*et+q*st,(F=ui*Pt+pi*kt+di*At)<0&&(F=-F),(q=ui*Lt+pi*Ct+di*Bt)<0&&(q=-q),(C=E-R-(F*nt+q*at))>0)return}else x=!1,C=0,Si=!0;if((E=mi*mi+yi*yi+fi*fi)>1e-5){if((b=(E=(mi*=E=1/_.sqrt(E))*$+(yi*=E)*tt+(fi*=E)*it)>0)||(E=-E),(F=mi*ht+yi*lt+fi*ct)<0&&(F=-F),(q=mi*ut+yi*pt+fi*dt)<0&&(q=-q),R=F*et+q*st,(F=mi*Pt+yi*kt+fi*At)<0&&(F=-F),(q=mi*Vt+yi*Tt+fi*It)<0&&(q=-q),(B=E-R-(F*nt+q*rt))>0)return}else b=!1,B=0,Mi=!0;var Pi=g,ki=g,Ai=0,Vi=n;w>ki&&(Pi=w,ki=w,Ai=1,Vi=r),z>ki&&(Pi=z,ki=z,Ai=2,Vi=a),N>ki&&(Pi=N,ki=N,Ai=3,Vi=h),S>ki&&(Pi=S,ki=S,Ai=4,Vi=l),M>ki&&(Pi=M,ki=M,Ai=5,Vi=c),P-.01>ki&&!vi&&(Pi=P,ki=P-.01,Ai=6,Vi=u),k-.01>ki&&!xi&&(Pi=k,ki=k-.01,Ai=7,Vi=p),A-.01>ki&&!bi&&(Pi=A,ki=A-.01,Ai=8,Vi=d),V-.01>ki&&!gi&&(Pi=V,ki=V-.01,Ai=9,Vi=m),T-.01>ki&&!wi&&(Pi=T,ki=T-.01,Ai=10,Vi=y),I-.01>ki&&!zi&&(Pi=I,ki=I-.01,Ai=11,Vi=f),L-.01>ki&&!Ni&&(Pi=L,ki=L-.01,Ai=12,Vi=v),C-.01>ki&&!Si&&(Pi=C,ki=C-.01,Ai=13,Vi=x),B-.01>ki&&!Mi&&(Pi=B,Ai=14,Vi=b);var Ti=0,Ii=0,Li=0,Ci=0,Bi=0,Ei=0,Ri=0,Fi=0,qi=0,ji=0,Oi=0,Di=0,_i=0,Wi=0,Ui=0,Hi=0,Gi=0,Xi=0,Yi=!1;if(0==Ai?(Vi?(ji=X+vt,Oi=Y+xt,Di=Q+bt,Ti=ht,Ii=lt,Li=ct):(ji=X-vt,Oi=Y-xt,Di=Q-bt,Ti=-ht,Ii=-lt,Li=-ct),_i=gt,Wi=wt,Ui=zt,Ci=-ut,Bi=-pt,Ei=-dt,Hi=Nt,Gi=St,Xi=Mt,Ri=-mt,Fi=-yt,qi=-ft):1==Ai?(Vi?(ji=X+gt,Oi=Y+wt,Di=Q+zt,Ti=ut,Ii=pt,Li=dt):(ji=X-gt,Oi=Y-wt,Di=Q-zt,Ti=-ut,Ii=-pt,Li=-dt),_i=vt,Wi=xt,Ui=bt,Ci=-ht,Bi=-lt,Ei=-ct,Hi=Nt,Gi=St,Xi=Mt,Ri=-mt,Fi=-yt,qi=-ft):2==Ai?(Vi?(ji=X+Nt,Oi=Y+St,Di=Q+Mt,Ti=mt,Ii=yt,Li=ft):(ji=X-Nt,Oi=Y-St,Di=Q-Mt,Ti=-mt,Ii=-yt,Li=-ft),_i=vt,Wi=xt,Ui=bt,Ci=-ht,Bi=-lt,Ei=-ct,Hi=gt,Gi=wt,Xi=zt,Ri=-ut,Fi=-pt,qi=-dt):3==Ai?(Yi=!0,Vi?(ji=Z-Et,Oi=K-Rt,Di=J-Ft,Ti=-Pt,Ii=-kt,Li=-At):(ji=Z+Et,Oi=K+Rt,Di=J+Ft,Ti=Pt,Ii=kt,Li=At),_i=qt,Wi=jt,Ui=Ot,Ci=-Vt,Bi=-Tt,Ei=-It,Hi=Dt,Gi=_t,Xi=Wt,Ri=-Lt,Fi=-Ct,qi=-Bt):4==Ai?(Yi=!0,Vi?(ji=Z-qt,Oi=K-jt,Di=J-Ot,Ti=-Vt,Ii=-Tt,Li=-It):(ji=Z+qt,Oi=K+jt,Di=J+Ot,Ti=Vt,Ii=Tt,Li=It),_i=Et,Wi=Rt,Ui=Ft,Ci=-Pt,Bi=-kt,Ei=-At,Hi=Dt,Gi=_t,Xi=Wt,Ri=-Lt,Fi=-Ct,qi=-Bt):5==Ai?(Yi=!0,Vi?(ji=Z-Dt,Oi=K-_t,Di=J-Wt,Ti=-Lt,Ii=-Ct,Li=-Bt):(ji=Z+Dt,Oi=K+_t,Di=J+Wt,Ti=Lt,Ii=Ct,Li=Bt),_i=Et,Wi=Rt,Ui=Ft,Ci=-Pt,Bi=-kt,Ei=-At,Hi=qt,Gi=jt,Xi=Ot,Ri=-Vt,Fi=-Tt,qi=-It):6==Ai?(Ti=Ut,Ii=Ht,Li=Gt,Ci=ht,Bi=lt,Ei=ct,Ri=Pt,Fi=kt,qi=At):7==Ai?(Ti=Xt,Ii=Yt,Li=Qt,Ci=ht,Bi=lt,Ei=ct,Ri=Vt,Fi=Tt,qi=It):8==Ai?(Ti=Zt,Ii=Kt,Li=Jt,Ci=ht,Bi=lt,Ei=ct,Ri=Lt,Fi=Ct,qi=Bt):9==Ai?(Ti=$t,Ii=ti,Li=ii,Ci=ut,Bi=pt,Ei=dt,Ri=Pt,Fi=kt,qi=At):10==Ai?(Ti=ei,Ii=si,Li=oi,Ci=ut,Bi=pt,Ei=dt,Ri=Vt,Fi=Tt,qi=It):11==Ai?(Ti=ni,Ii=ri,Li=ai,Ci=ut,Bi=pt,Ei=dt,Ri=Lt,Fi=Ct,qi=Bt):12==Ai?(Ti=hi,Ii=li,Li=ci,Ci=mt,Bi=yt,Ei=ft,Ri=Pt,Fi=kt,qi=At):13==Ai?(Ti=ui,Ii=pi,Li=di,Ci=mt,Bi=yt,Ei=ft,Ri=Vt,Fi=Tt,qi=It):14==Ai&&(Ti=mi,Ii=yi,Li=fi,Ci=mt,Bi=yt,Ei=ft,Ri=Lt,Fi=Ct,qi=Bt),Ai>5){var Qi,Zi,Ki,Ji,$i,te,ie,ee,se,oe,ne;Vi||(Ti=-Ti,Ii=-Ii,Li=-Li),Zi=Ti*(te=O[0])+Ii*(ie=O[1])+Li*(ee=O[2]),(Qi=Ti*(Ki=O[3])+Ii*(Ji=O[4])+Li*($i=O[5]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),(Qi=Ti*(Ki=O[6])+Ii*(Ji=O[7])+Li*($i=O[8]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),(Qi=Ti*(Ki=O[9])+Ii*(Ji=O[10])+Li*($i=O[11]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),(Qi=Ti*(Ki=O[12])+Ii*(Ji=O[13])+Li*($i=O[14]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),(Qi=Ti*(Ki=O[15])+Ii*(Ji=O[16])+Li*($i=O[17]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),(Qi=Ti*(Ki=O[18])+Ii*(Ji=O[19])+Li*($i=O[20]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),(Qi=Ti*(Ki=O[21])+Ii*(Ji=O[22])+Li*($i=O[23]))>Zi&&(Zi=Qi,te=Ki,ie=Ji,ee=$i),Zi=Ti*(se=D[0])+Ii*(oe=D[1])+Li*(ne=D[2]),(Qi=Ti*(Ki=D[3])+Ii*(Ji=D[4])+Li*($i=D[5]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i),(Qi=Ti*(Ki=D[6])+Ii*(Ji=D[7])+Li*($i=D[8]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i),(Qi=Ti*(Ki=D[9])+Ii*(Ji=D[10])+Li*($i=D[11]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i),(Qi=Ti*(Ki=D[12])+Ii*(Ji=D[13])+Li*($i=D[14]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i),(Qi=Ti*(Ki=D[15])+Ii*(Ji=D[16])+Li*($i=D[17]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i),(Qi=Ti*(Ki=D[18])+Ii*(Ji=D[19])+Li*($i=D[20]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i),(Qi=Ti*(Ki=D[21])+Ii*(Ji=D[22])+Li*($i=D[23]))<Zi&&(Zi=Qi,se=Ki,oe=Ji,ne=$i);var re=((Ki=se-te)*(Ci-Ri*(F=Ci*Ri+Bi*Fi+Ei*qi))+(Ji=oe-ie)*(Bi-Fi*F)+($i=ne-ee)*(Ei-qi*F))/(1-F*F);e.addPoint(te+Ci*re+Ti*Pi*.5,ie+Bi*re+Ii*Pi*.5,ee+Ei*re+Li*Pi*.5,Ti,Ii,Li,Pi,!1)}else{var ae,he,le,ce,ue,pe,de,me,ye,fe,ve,xe,be,ge,we,ze,Ne,Se,Me,Pe,ke,Ae=1,Ve=0,Te=0;Yi?((Ve=ht*Ti+lt*Ii+ct*Li)<Ae&&(Ae=Ve,Te=0),-Ve<Ae&&(Ae=-Ve,Te=1),(Ve=ut*Ti+pt*Ii+dt*Li)<Ae&&(Ae=Ve,Te=2),-Ve<Ae&&(Ae=-Ve,Te=3),(Ve=mt*Ti+yt*Ii+ft*Li)<Ae&&(Ae=Ve,Te=4),-Ve<Ae&&(Ae=-Ve,Te=5),0==Te?(ae=O[0],he=O[1],le=O[2],ce=O[6],ue=O[7],pe=O[8],de=O[9],me=O[10],ye=O[11],fe=O[3],ve=O[4],xe=O[5]):1==Te?(ae=O[15],he=O[16],le=O[17],ce=O[21],ue=O[22],pe=O[23],de=O[18],me=O[19],ye=O[20],fe=O[12],ve=O[13],xe=O[14]):2==Te?(ae=O[12],he=O[13],le=O[14],ce=O[0],ue=O[1],pe=O[2],de=O[3],me=O[4],ye=O[5],fe=O[15],ve=O[16],xe=O[17]):3==Te?(ae=O[21],he=O[22],le=O[23],ce=O[9],ue=O[10],pe=O[11],de=O[6],me=O[7],ye=O[8],fe=O[18],ve=O[19],xe=O[20]):4==Te?(ae=O[12],he=O[13],le=O[14],ce=O[18],ue=O[19],pe=O[20],de=O[6],me=O[7],ye=O[8],fe=O[0],ve=O[1],xe=O[2]):5==Te&&(ae=O[3],he=O[4],le=O[5],ce=D[9],ue=D[10],pe=D[11],de=O[21],me=O[22],ye=O[23],fe=O[15],ve=O[16],xe=O[17])):((Ve=Pt*Ti+kt*Ii+At*Li)<Ae&&(Ae=Ve,Te=0),-Ve<Ae&&(Ae=-Ve,Te=1),(Ve=Vt*Ti+Tt*Ii+It*Li)<Ae&&(Ae=Ve,Te=2),-Ve<Ae&&(Ae=-Ve,Te=3),(Ve=Lt*Ti+Ct*Ii+Bt*Li)<Ae&&(Ae=Ve,Te=4),-Ve<Ae&&(Ae=-Ve,Te=5),0==Te?(ae=D[0],he=D[1],le=D[2],ce=D[6],ue=D[7],pe=D[8],de=D[9],me=D[10],ye=D[11],fe=D[3],ve=D[4],xe=D[5]):1==Te?(ae=D[15],he=D[16],le=D[17],ce=D[21],ue=D[22],pe=D[23],de=D[18],me=D[19],ye=D[20],fe=D[12],ve=D[13],xe=D[14]):2==Te?(ae=D[12],he=D[13],le=D[14],ce=D[0],ue=D[1],pe=D[2],de=D[3],me=D[4],ye=D[5],fe=D[15],ve=D[16],xe=D[17]):3==Te?(ae=D[21],he=D[22],le=D[23],ce=D[9],ue=D[10],pe=D[11],de=D[6],me=D[7],ye=D[8],fe=D[18],ve=D[19],xe=D[20]):4==Te?(ae=D[12],he=D[13],le=D[14],ce=D[18],ue=D[19],pe=D[20],de=D[6],me=D[7],ye=D[8],fe=D[0],ve=D[1],xe=D[2]):5==Te&&(ae=D[3],he=D[4],le=D[5],ce=D[9],ue=D[10],pe=D[11],de=D[21],me=D[22],ye=D[23],fe=D[15],ve=D[16],xe=D[17])),this.clipVertices1[0]=ae,this.clipVertices1[1]=he,this.clipVertices1[2]=le,this.clipVertices1[3]=ce,this.clipVertices1[4]=ue,this.clipVertices1[5]=pe,this.clipVertices1[6]=de,this.clipVertices1[7]=me,this.clipVertices1[8]=ye,this.clipVertices1[9]=fe,this.clipVertices1[10]=ve,this.clipVertices1[11]=xe,ge=0,F=((ze=this.clipVertices1[9])-ji-_i)*Ci+((Ne=this.clipVertices1[10])-Oi-Wi)*Bi+((Se=this.clipVertices1[11])-Di-Ui)*Ei;for(var Ie=0;Ie<4;Ie++)we=3*Ie,q=((Me=this.clipVertices1[we])-ji-_i)*Ci+((Pe=this.clipVertices1[we+1])-Oi-Wi)*Bi+((ke=this.clipVertices1[we+2])-Di-Ui)*Ei,F>0?q>0?(we=3*ge,ge++,this.clipVertices2[we]=Me,this.clipVertices2[we+1]=Pe,this.clipVertices2[we+2]=ke):(we=3*ge,ge++,re=F/(F-q),this.clipVertices2[we]=ze+(Me-ze)*re,this.clipVertices2[we+1]=Ne+(Pe-Ne)*re,this.clipVertices2[we+2]=Se+(ke-Se)*re):q>0&&(we=3*ge,ge++,re=F/(F-q),this.clipVertices2[we]=ze+(Me-ze)*re,this.clipVertices2[we+1]=Ne+(Pe-Ne)*re,this.clipVertices2[we+2]=Se+(ke-Se)*re,we=3*ge,ge++,this.clipVertices2[we]=Me,this.clipVertices2[we+1]=Pe,this.clipVertices2[we+2]=ke),ze=Me,Ne=Pe,Se=ke,F=q;if(0!=(be=ge)){for(ge=0,we=3*(be-1),F=((ze=this.clipVertices2[we])-ji-Hi)*Ri+((Ne=this.clipVertices2[we+1])-Oi-Gi)*Fi+((Se=this.clipVertices2[we+2])-Di-Xi)*qi,Ie=0;Ie<be;Ie++)we=3*Ie,q=((Me=this.clipVertices2[we])-ji-Hi)*Ri+((Pe=this.clipVertices2[we+1])-Oi-Gi)*Fi+((ke=this.clipVertices2[we+2])-Di-Xi)*qi,F>0?q>0?(we=3*ge,ge++,this.clipVertices1[we]=Me,this.clipVertices1[we+1]=Pe,this.clipVertices1[we+2]=ke):(we=3*ge,ge++,re=F/(F-q),this.clipVertices1[we]=ze+(Me-ze)*re,this.clipVertices1[we+1]=Ne+(Pe-Ne)*re,this.clipVertices1[we+2]=Se+(ke-Se)*re):q>0&&(we=3*ge,ge++,re=F/(F-q),this.clipVertices1[we]=ze+(Me-ze)*re,this.clipVertices1[we+1]=Ne+(Pe-Ne)*re,this.clipVertices1[we+2]=Se+(ke-Se)*re,we=3*ge,ge++,this.clipVertices1[we]=Me,this.clipVertices1[we+1]=Pe,this.clipVertices1[we+2]=ke),ze=Me,Ne=Pe,Se=ke,F=q;if(0!=(be=ge)){for(ge=0,we=3*(be-1),F=((ze=this.clipVertices1[we])-ji+_i)*-Ci+((Ne=this.clipVertices1[we+1])-Oi+Wi)*-Bi+((Se=this.clipVertices1[we+2])-Di+Ui)*-Ei,Ie=0;Ie<be;Ie++)we=3*Ie,q=((Me=this.clipVertices1[we])-ji+_i)*-Ci+((Pe=this.clipVertices1[we+1])-Oi+Wi)*-Bi+((ke=this.clipVertices1[we+2])-Di+Ui)*-Ei,F>0?q>0?(we=3*ge,ge++,this.clipVertices2[we]=Me,this.clipVertices2[we+1]=Pe,this.clipVertices2[we+2]=ke):(we=3*ge,ge++,re=F/(F-q),this.clipVertices2[we]=ze+(Me-ze)*re,this.clipVertices2[we+1]=Ne+(Pe-Ne)*re,this.clipVertices2[we+2]=Se+(ke-Se)*re):q>0&&(we=3*ge,ge++,re=F/(F-q),this.clipVertices2[we]=ze+(Me-ze)*re,this.clipVertices2[we+1]=Ne+(Pe-Ne)*re,this.clipVertices2[we+2]=Se+(ke-Se)*re,we=3*ge,ge++,this.clipVertices2[we]=Me,this.clipVertices2[we+1]=Pe,this.clipVertices2[we+2]=ke),ze=Me,Ne=Pe,Se=ke,F=q;if(0!=(be=ge)){for(ge=0,we=3*(be-1),F=((ze=this.clipVertices2[we])-ji+Hi)*-Ri+((Ne=this.clipVertices2[we+1])-Oi+Gi)*-Fi+((Se=this.clipVertices2[we+2])-Di+Xi)*-qi,Ie=0;Ie<be;Ie++)we=3*Ie,q=((Me=this.clipVertices2[we])-ji+Hi)*-Ri+((Pe=this.clipVertices2[we+1])-Oi+Gi)*-Fi+((ke=this.clipVertices2[we+2])-Di+Xi)*-qi,F>0?q>0?(we=3*ge,ge++,this.clipVertices1[we]=Me,this.clipVertices1[we+1]=Pe,this.clipVertices1[we+2]=ke):(we=3*ge,ge++,re=F/(F-q),this.clipVertices1[we]=ze+(Me-ze)*re,this.clipVertices1[we+1]=Ne+(Pe-Ne)*re,this.clipVertices1[we+2]=Se+(ke-Se)*re):q>0&&(we=3*ge,ge++,re=F/(F-q),this.clipVertices1[we]=ze+(Me-ze)*re,this.clipVertices1[we+1]=Ne+(Pe-Ne)*re,this.clipVertices1[we+2]=Se+(ke-Se)*re,we=3*ge,ge++,this.clipVertices1[we]=Me,this.clipVertices1[we+1]=Pe,this.clipVertices1[we+2]=ke),ze=Me,Ne=Pe,Se=ke,F=q;if(Yi){var Le=s;s=o,o=Le}if(0!=(be=ge)){var Ce=s!=t;if(be>4){Ci=ae-(ze=.25*(ae+ce+de+fe)),Bi=he-(Ne=.25*(he+ue+me+ve)),Ei=le-(Se=.25*(le+pe+ye+xe)),Ri=ce-ze,Fi=ue-Ne,qi=pe-Se;var Be=0,Ee=0,Re=0,Fe=0,qe=-this.INF;for(Ae=this.INF,Ie=0;Ie<be;Ie++)this.used[Ie]=!1,we=3*Ie,(Ve=(ze=this.clipVertices1[we])*Ci+(Ne=this.clipVertices1[we+1])*Bi+(Se=this.clipVertices1[we+2])*Ei)<Ae&&(Ae=Ve,Be=Ie),Ve>qe&&(qe=Ve,Re=Ie);for(this.used[Be]=!0,this.used[Re]=!0,qe=-this.INF,Ae=this.INF,Ie=0;Ie<be;Ie++)this.used[Ie]||(we=3*Ie,(Ve=(ze=this.clipVertices1[we])*Ri+(Ne=this.clipVertices1[we+1])*Fi+(Se=this.clipVertices1[we+2])*qi)<Ae&&(Ae=Ve,Ee=Ie),Ve>qe&&(qe=Ve,Fe=Ie));we=3*Be,(Ve=((ze=this.clipVertices1[we])-ji)*Ti+((Ne=this.clipVertices1[we+1])-Oi)*Ii+((Se=this.clipVertices1[we+2])-Di)*Li)<0&&e.addPoint(ze,Ne,Se,Ti,Ii,Li,Ve,Ce),we=3*Ee,(Ve=((ze=this.clipVertices1[we])-ji)*Ti+((Ne=this.clipVertices1[we+1])-Oi)*Ii+((Se=this.clipVertices1[we+2])-Di)*Li)<0&&e.addPoint(ze,Ne,Se,Ti,Ii,Li,Ve,Ce),we=3*Re,(Ve=((ze=this.clipVertices1[we])-ji)*Ti+((Ne=this.clipVertices1[we+1])-Oi)*Ii+((Se=this.clipVertices1[we+2])-Di)*Li)<0&&e.addPoint(ze,Ne,Se,Ti,Ii,Li,Ve,Ce),we=3*Fe,(Ve=((ze=this.clipVertices1[we])-ji)*Ti+((Ne=this.clipVertices1[we+1])-Oi)*Ii+((Se=this.clipVertices1[we+2])-Di)*Li)<0&&e.addPoint(ze,Ne,Se,Ti,Ii,Li,Ve,Ce)}else for(Ie=0;Ie<be;Ie++)we=3*Ie,(Ve=((ze=this.clipVertices1[we])-ji)*Ti+((Ne=this.clipVertices1[we+1])-Oi)*Ii+((Se=this.clipVertices1[we+2])-Di)*Li)<0&&e.addPoint(ze,Ne,Se,Ti,Ii,Li,Ve,Ce)}}}}}}}}),Ut.prototype=Object.assign(Object.create(_t.prototype),{constructor:Ut,getSep:function(t,i,e,s,o){var n,r,a,h,l,c,u,p,d,m,y,f,v,x=new H,b=t.position.x,g=t.position.y,w=t.position.z,z=i.position.x,N=i.position.y,S=i.position.z,M=z-b,P=N-g,k=S-w;M*M+P*P+k*k==0&&(P=.001);var A=-M,V=-P,T=-k;this.supportPointB(t,-A,-V,-T,x);var I=x.x,L=x.y,C=x.z;this.supportPointC(i,A,V,T,x);var B=x.x,E=x.y,R=x.z,F=B-I,q=E-L,j=R-C;if(F*A+q*V+j*T<=0)return!1;if((A=q*k-j*P)*A+(V=j*M-F*k)*V+(T=F*P-q*M)*T==0)return e.set(F-M,q-P,j-k).normalize(),s.set(.5*(I+B),.5*(L+E),.5*(C+R)),!0;this.supportPointB(t,-A,-V,-T,x);var O=x.x,D=x.y,W=x.z;this.supportPointC(i,A,V,T,x);var U=x.x,G=x.y,X=x.z,Y=U-O,Q=G-D,Z=X-W;if(Y*A+Q*V+Z*T<=0)return!1;(A=(r=q-P)*(c=Z-k)-(a=j-k)*(l=Q-P))*M+(V=a*(h=Y-M)-(n=F-M)*c)*P+(T=n*l-r*h)*k>0&&(n=F,r=q,a=j,F=Y,q=Q,j=Z,Y=n,Q=r,Z=a,n=I,r=L,a=C,I=O,L=D,C=W,O=n,D=r,W=a,n=B,r=E,a=R,B=U,E=G,R=X,U=n,G=r,X=a,A=-A,V=-V,T=-T);for(var K=0;;){if(++K>100)return!1;this.supportPointB(t,-A,-V,-T,x);var J=x.x,$=x.y,tt=x.z;this.supportPointC(i,A,V,T,x);var it=x.x,et=x.y,st=x.z,ot=it-J,nt=et-$,rt=st-tt;if(ot*A+nt*V+rt*T<=0)return!1;if((q*rt-j*nt)*M+(j*ot-F*rt)*P+(F*nt-q*ot)*k<0)Y=ot,Q=nt,Z=rt,O=J,D=$,W=tt,U=it,G=et,X=st,A=(r=q-P)*(c=rt-k)-(a=j-k)*(l=nt-P),V=a*(h=ot-M)-(n=F-M)*c,T=n*l-r*h;else if((nt*Z-rt*Q)*M+(rt*Y-ot*Z)*P+(ot*Q-nt*Y)*k<0)F=ot,q=nt,j=rt,I=J,L=$,C=tt,B=it,E=et,R=st,A=(r=nt-P)*(c=Z-k)-(a=rt-k)*(l=Q-P),V=a*(h=Y-M)-(n=ot-M)*c,T=n*l-r*h;else for(var at=!1;;){if(A=(r=Q-q)*(c=rt-j)-(a=Z-j)*(l=nt-q),V=a*(h=ot-F)-(n=Y-F)*c,T=n*l-r*h,(A*=u=1/_.sqrt(A*A+V*V+T*T))*F+(V*=u)*q+(T*=u)*j>=0&&!at){var ht=(q*Z-j*Q)*ot+(j*Y-F*Z)*nt+(F*Q-q*Y)*rt,lt=(nt*Z-rt*Q)*M+(rt*Y-ot*Z)*P+(ot*Q-nt*Y)*k,ct=(P*j-k*q)*ot+(k*F-M*j)*nt+(M*q-P*F)*rt,ut=(Q*j-Z*q)*M+(Z*F-Y*j)*P+(Y*q-Q*F)*k,pt=ht+lt+ct+ut;pt<=0&&(ht=0,pt=(lt=(Q*rt-Z*nt)*A+(Z*ot-Y*rt)*V+(Y*nt-Q*ot)*T)+(ct=(nt*Z-rt*Q)*A+(rt*Y-ot*Z)*V+(ot*Q-nt*Y)*T)+(ut=(q*Z-j*Q)*A+(j*Y-F*Z)*V+(F*Q-q*Y)*T));var dt=1/pt;p=(b*ht+I*lt+O*ct+J*ut)*dt,d=(g*ht+L*lt+D*ct+$*ut)*dt,m=(w*ht+C*lt+W*ct+tt*ut)*dt,y=(z*ht+B*lt+U*ct+it*ut)*dt,f=(N*ht+E*lt+G*ct+et*ut)*dt,v=(S*ht+R*lt+X*ct+st*ut)*dt,at=!0}this.supportPointB(t,-A,-V,-T,x);var mt=x.x,yt=x.y,ft=x.z;this.supportPointC(i,A,V,T,x);var vt=x.x,xt=x.y,bt=x.z,gt=vt-mt,wt=xt-yt,zt=bt-ft,Nt=-(gt*A+wt*V+zt*T);if((gt-ot)*A+(wt-nt)*V+(zt-rt)*T<=.01||Nt>=0)return!!at&&(e.set(-A,-V,-T),s.set(.5*(p+y),.5*(d+f),.5*(m+v)),o.x=Nt,!0);(wt*j-zt*q)*M+(zt*F-gt*j)*P+(gt*q-wt*F)*k<0?(wt*Z-zt*Q)*M+(zt*Y-gt*Z)*P+(gt*Q-wt*Y)*k<0?(F=gt,q=wt,j=zt,I=mt,L=yt,C=ft,B=vt,E=xt,R=bt):(ot=gt,nt=wt,rt=zt,J=mt,$=yt,tt=ft,it=vt,et=xt,st=bt):(wt*rt-zt*nt)*M+(zt*ot-gt*rt)*P+(gt*nt-wt*ot)*k<0?(Y=gt,Q=wt,Z=zt,O=mt,D=yt,W=ft,U=vt,G=xt,X=bt):(F=gt,q=wt,j=zt,I=mt,L=yt,C=ft,B=vt,E=xt,R=bt)}}},supportPointB:function(t,i,e,s,o){var n,r,a,h=t.rotation.elements,l=h[0]*i+h[3]*e+h[6]*s,c=h[1]*i+h[4]*e+h[7]*s,u=h[2]*i+h[5]*e+h[8]*s,p=t.halfWidth,d=t.halfHeight,m=t.halfDepth;n=l<0?-p:p,r=c<0?-d:d,a=u<0?-m:m,l=h[0]*n+h[1]*r+h[2]*a+t.position.x,c=h[3]*n+h[4]*r+h[5]*a+t.position.y,u=h[6]*n+h[7]*r+h[8]*a+t.position.z,o.set(l,c,u)},supportPointC:function(t,i,e,s,o){var n,r,a,h=t.rotation.elements,l=h[0]*i+h[3]*e+h[6]*s,c=h[1]*i+h[4]*e+h[7]*s,u=h[2]*i+h[5]*e+h[8]*s,p=l,d=u,m=p*p+d*d,y=t.radius,f=t.halfHeight;0==m?c<0?(n=y,r=-f,a=0):(n=y,r=f,a=0):(m=t.radius/_.sqrt(m),c<0?(n=p*m,r=-f,a=d*m):(n=p*m,r=f,a=d*m)),l=h[0]*n+h[1]*r+h[2]*a+t.position.x,c=h[3]*n+h[4]*r+h[5]*a+t.position.y,u=h[6]*n+h[7]*r+h[8]*a+t.position.z,o.set(l,c,u)},detectCollision:function(t,i,e){var s,o;this.flip?(s=i,o=t):(s=t,o=i);var n=new H,r=new H,a=new H;if(this.getSep(s,o,n,r,a)){var h=s.position.x,l=s.position.y,c=s.position.z,u=o.position.x,p=o.position.y,d=o.position.z,m=s.halfWidth,y=s.halfHeight,f=s.halfDepth,v=o.halfHeight,x=o.radius,b=s.dimentions,g=b[0],w=b[1],z=b[2],N=b[3],S=b[4],M=b[5],P=b[6],k=b[7],A=b[8],V=b[9],T=b[10],I=b[11],L=b[12],C=b[13],B=b[14],E=b[15],R=b[16],F=b[17],q=o.normalDirection.x,j=o.normalDirection.y,O=o.normalDirection.z,D=o.halfDirection.x,W=o.halfDirection.y,U=o.halfDirection.z,G=n.x,X=n.y,Y=n.z,Q=G*g+X*w+Y*z,Z=G*N+X*S+Y*M,K=G*P+X*k+Y*A,J=G*q+X*j+Y*O,$=Q>0,tt=Z>0,it=K>0,et=J>0;$||(Q=-Q),tt||(Z=-Z),it||(K=-K),et||(J=-J);var st,ot,nt,rt,at,ht,lt,ct,ut,pt,dt,mt,yt,ft,vt,xt,bt,gt,wt,zt,Nt,St,Mt,Pt,kt,At,Vt,Tt,It,Lt,Ct,Bt,Et,Rt,Ft,qt,jt,Ot,Dt,_t,Wt,Ut,Ht,Gt,Xt,Yt,Qt,Zt,Kt,Jt,$t,ti,ii,ei=0;if(J>.999?ei=Q>.999?Q>J?1:4:Z>.999?Z>J?2:4:K>.999&&K>J?3:4:Q>.999?ei=1:Z>.999?ei=2:K>.999&&(ei=3),0==ei)e.addPoint(r.x,r.y,r.z,G,X,Y,a.x,this.flip);else if(4==ei){var si,oi,ni,ri,ai,hi,li,ci,ui,pi,di,mi;et?(rt=u-D,at=p-W,ht=d-U,G=-q,X=-j,Y=-O):(rt=u+D,at=p+W,ht=d+U,G=q,X=j,Y=O),ei=0,(Ht=g*G+w*X+z*Y)<(zt=1)&&(zt=Ht,ei=0),-Ht<zt&&(zt=-Ht,ei=1),(Ht=N*G+S*X+M*Y)<zt&&(zt=Ht,ei=2),-Ht<zt&&(zt=-Ht,ei=3),(Ht=P*G+k*X+A*Y)<zt&&(zt=Ht,ei=4),-Ht<zt&&(zt=-Ht,ei=5);var yi=s.elements;switch(ei){case 0:si=yi[0],oi=yi[1],ni=yi[2],ri=yi[6],ai=yi[7],hi=yi[8],li=yi[9],ci=yi[10],ui=yi[11],pi=yi[3],di=yi[4],mi=yi[5];break;case 1:si=yi[15],oi=yi[16],ni=yi[17],ri=yi[21],ai=yi[22],hi=yi[23],li=yi[18],ci=yi[19],ui=yi[20],pi=yi[12],di=yi[13],mi=yi[14];break;case 2:si=yi[12],oi=yi[13],ni=yi[14],ri=yi[0],ai=yi[1],hi=yi[2],li=yi[3],ci=yi[4],ui=yi[5],pi=yi[15],di=yi[16],mi=yi[17];break;case 3:si=yi[21],oi=yi[22],ni=yi[23],ri=yi[9],ai=yi[10],hi=yi[11],li=yi[6],ci=yi[7],ui=yi[8],pi=yi[18],di=yi[19],mi=yi[20];break;case 4:si=yi[12],oi=yi[13],ni=yi[14],ri=yi[18],ai=yi[19],hi=yi[20],li=yi[6],ci=yi[7],ui=yi[8],pi=yi[0],di=yi[1],mi=yi[2];break;case 5:si=yi[3],oi=yi[4],ni=yi[5],ri=yi[9],ai=yi[10],hi=yi[11],li=yi[21],ci=yi[22],ui=yi[23],pi=yi[15],di=yi[16],mi=yi[17]}(wt=G*(si-rt)+X*(oi-at)+Y*(ni-ht))<=0&&e.addPoint(si,oi,ni,-G,-X,-Y,wt,this.flip),(wt=G*(ri-rt)+X*(ai-at)+Y*(hi-ht))<=0&&e.addPoint(ri,ai,hi,-G,-X,-Y,wt,this.flip),(wt=G*(li-rt)+X*(ci-at)+Y*(ui-ht))<=0&&e.addPoint(li,ci,ui,-G,-X,-Y,wt,this.flip),(wt=G*(pi-rt)+X*(di-at)+Y*(mi-ht))<=0&&e.addPoint(pi,di,mi,-G,-X,-Y,wt,this.flip)}else{switch(ei){case 1:$?(st=h+V,ot=l+T,nt=c+I,G=g,X=w,Y=z):(st=h-V,ot=l-T,nt=c-I,G=-g,X=-w,Y=-z),Yt=N,Qt=S,Zt=M,ti=y,Kt=P,Jt=k,$t=A,ii=f;break;case 2:tt?(st=h+L,ot=l+C,nt=c+B,G=N,X=S,Y=M):(st=h-L,ot=l-C,nt=c-B,G=-N,X=-S,Y=-M),Yt=g,Qt=w,Zt=z,ti=m,Kt=P,Jt=k,$t=A,ii=f;break;case 3:it?(st=h+E,ot=l+R,nt=c+F,G=P,X=k,Y=A):(st=h-E,ot=l-R,nt=c-F,G=-P,X=-k,Y=-A),Yt=g,Qt=w,Zt=z,ti=m,Kt=N,Jt=S,$t=M,ii=y}if(rt=u+(Nt=(zt=G*q+X*j+Y*O)<0?v:-v)*q,at=p+Nt*j,ht=d+Nt*O,J>=.999999?(St=-X,Mt=Y,Pt=G):(St=G,Mt=X,Pt=Y),At=(Nt=St*q+Mt*j+Pt*O)*q-St,Vt=Nt*j-Mt,Tt=Nt*O-Pt,0==(Nt=_.sqrt(At*At+Vt*Vt+Tt*Tt)))return;if(St=rt+(At*=Nt=x/Nt),Mt=at+(Vt*=Nt),Pt=ht+(Tt*=Nt),zt<-.96||zt>.96)lt=q*q*1.5-.5,ct=q*j*1.5-.866025403*O,ut=q*O*1.5+.866025403*j,pt=j*q*1.5+.866025403*O,dt=j*j*1.5-.5,mt=j*O*1.5-.866025403*q,yt=O*q*1.5-.866025403*j,ft=O*j*1.5+.866025403*q,vt=O*O*1.5-.5,(Ot=Yt*(St=(xt=St)-(wt=G*(xt-st)+X*((bt=Mt)-ot)+Y*((gt=Pt)-nt))*G-st)+Qt*(Mt=bt-wt*X-ot)+Zt*(Pt=gt-wt*Y-nt))<-ti?Ot=-ti:Ot>ti&&(Ot=ti),(Ut=Kt*St+Jt*Mt+$t*Pt)<-ii?Ut=-ii:Ut>ii&&(Ut=ii),xt=st+(St=Ot*Yt+Ut*Kt),bt=ot+(Mt=Ot*Qt+Ut*Jt),gt=nt+(Pt=Ot*Zt+Ut*$t),e.addPoint(xt,bt,gt,G,X,Y,wt,this.flip),bt=At*pt+Vt*dt+Tt*mt,gt=At*yt+Vt*ft+Tt*vt,(wt=G*((xt=(At=xt=At*lt+Vt*ct+Tt*ut)+rt)-st)+X*((bt=(Vt=bt)+at)-ot)+Y*((gt=(Tt=gt)+ht)-nt))<=0&&((Ot=Yt*(St=xt-wt*G-st)+Qt*(Mt=bt-wt*X-ot)+Zt*(Pt=gt-wt*Y-nt))<-ti?Ot=-ti:Ot>ti&&(Ot=ti),(Ut=Kt*St+Jt*Mt+$t*Pt)<-ii?Ut=-ii:Ut>ii&&(Ut=ii),xt=st+(St=Ot*Yt+Ut*Kt),bt=ot+(Mt=Ot*Qt+Ut*Jt),gt=nt+(Pt=Ot*Zt+Ut*$t),e.addPoint(xt,bt,gt,G,X,Y,wt,this.flip)),bt=At*pt+Vt*dt+Tt*mt,gt=At*yt+Vt*ft+Tt*vt,(wt=G*((xt=(At=xt=At*lt+Vt*ct+Tt*ut)+rt)-st)+X*((bt=(Vt=bt)+at)-ot)+Y*((gt=(Tt=gt)+ht)-nt))<=0&&((Ot=Yt*(St=xt-wt*G-st)+Qt*(Mt=bt-wt*X-ot)+Zt*(Pt=gt-wt*Y-nt))<-ti?Ot=-ti:Ot>ti&&(Ot=ti),(Ut=Kt*St+Jt*Mt+$t*Pt)<-ii?Ut=-ii:Ut>ii&&(Ut=ii),xt=st+(St=Ot*Yt+Ut*Kt),bt=ot+(Mt=Ot*Qt+Ut*Jt),gt=nt+(Pt=Ot*Zt+Ut*$t),e.addPoint(xt,bt,gt,G,X,Y,wt,this.flip));else{if(Ft=St,zt>0?(Dt=St+2*D,_t=Mt+2*W,Wt=Pt+2*U):(Dt=St-2*D,_t=Mt-2*W,Wt=Pt-2*U),St=(Dt-=(Ut=G*(Dt-st)+X*(_t-ot)+Y*(Wt-nt))*G)-(Ft-=(Ot=G*(Ft-st)+X*((qt=Mt)-ot)+Y*((jt=Pt)-nt))*G),Mt=(_t-=Ut*X)-(qt-=Ot*X),Pt=(Wt-=Ut*Y)-(jt-=Ot*Y),kt=Ut-Ot,Gt=(Z=(Bt=Dt-st)*Yt+(Et=_t-ot)*Qt+(Rt=Wt-nt)*Zt)-ti,(Ht=(Q=(It=Ft-st)*Yt+(Lt=qt-ot)*Qt+(Ct=jt-nt)*Zt)-ti)>0){if(Gt>0)return;Q=(It=(Ft+=St*(Xt=Ht/(Ht-Gt)))-st)*Yt+(Lt=(qt+=Mt*Xt)-ot)*Qt+(Ct=(jt+=Pt*Xt)-nt)*Zt,St=Dt-Ft,Mt=_t-qt,Pt=Wt-jt,kt=Ut-(Ot+=kt*Xt)}else Gt>0&&(Z=(Bt=(Dt=Ft+St*(Xt=Ht/(Ht-Gt)))-st)*Yt+(Et=(_t=qt+Mt*Xt)-ot)*Qt+(Rt=(Wt=jt+Pt*Xt)-nt)*Zt,St=Dt-Ft,Mt=_t-qt,Pt=Wt-jt,kt=(Ut=Ot+kt*Xt)-Ot);if(Gt=Z+ti,(Ht=Q+ti)<0){if(Gt<0)return;It=(Ft+=St*(Xt=Ht/(Ht-Gt)))-st,Lt=(qt+=Mt*Xt)-ot,Ct=(jt+=Pt*Xt)-nt,St=Dt-Ft,Mt=_t-qt,Pt=Wt-jt,kt=Ut-(Ot+=kt*Xt)}else Gt<0&&(Bt=(Dt=Ft+St*(Xt=Ht/(Ht-Gt)))-st,Et=(_t=qt+Mt*Xt)-ot,Rt=(Wt=jt+Pt*Xt)-nt,St=Dt-Ft,Mt=_t-qt,Pt=Wt-jt,kt=(Ut=Ot+kt*Xt)-Ot);if(Gt=(Z=Bt*Kt+Et*Jt+Rt*$t)-ii,(Ht=(Q=It*Kt+Lt*Jt+Ct*$t)-ii)>0){if(Gt>0)return;Q=(It=(Ft+=St*(Xt=Ht/(Ht-Gt)))-st)*Kt+(Lt=(qt+=Mt*Xt)-ot)*Jt+(Ct=(jt+=Pt*Xt)-nt)*$t,St=Dt-Ft,Mt=_t-qt,Pt=Wt-jt,kt=Ut-(Ot+=kt*Xt)}else Gt>0&&(Z=(Bt=(Dt=Ft+St*(Xt=Ht/(Ht-Gt)))-st)*Kt+(Et=(_t=qt+Mt*Xt)-ot)*Jt+(Rt=(Wt=jt+Pt*Xt)-nt)*$t,St=Dt-Ft,Mt=_t-qt,Pt=Wt-jt,kt=(Ut=Ot+kt*Xt)-Ot);if(Gt=Z+ii,(Ht=Q+ii)<0){if(Gt<0)return;Ft+=St*(Xt=Ht/(Ht-Gt)),qt+=Mt*Xt,jt+=Pt*Xt,Ot+=kt*Xt}else Gt<0&&(Dt=Ft+St*(Xt=Ht/(Ht-Gt)),_t=qt+Mt*Xt,Wt=jt+Pt*Xt,Ut=Ot+kt*Xt);Ot<0&&e.addPoint(Ft,qt,jt,G,X,Y,Ot,this.flip),Ut<0&&e.addPoint(Dt,_t,Wt,G,X,Y,Ut,this.flip)}}}}}),Ht.prototype=Object.assign(Object.create(_t.prototype),{constructor:Ht,getSep:function(t,i,e,s,o){var n,r,a,h,l,c,u,p,d,m,y,f,v,x=new H,b=t.position.x,g=t.position.y,w=t.position.z,z=i.position.x,N=i.position.y,S=i.position.z,M=z-b,P=N-g,k=S-w;M*M+P*P+k*k==0&&(P=.001);var A=-M,V=-P,T=-k;this.supportPoint(t,-A,-V,-T,x);var I=x.x,L=x.y,C=x.z;this.supportPoint(i,A,V,T,x);var B=x.x,E=x.y,R=x.z,F=B-I,q=E-L,j=R-C;if(F*A+q*V+j*T<=0)return!1;if((A=q*k-j*P)*A+(V=j*M-F*k)*V+(T=F*P-q*M)*T==0)return e.set(F-M,q-P,j-k).normalize(),s.set(.5*(I+B),.5*(L+E),.5*(C+R)),!0;this.supportPoint(t,-A,-V,-T,x);var O=x.x,D=x.y,W=x.z;this.supportPoint(i,A,V,T,x);var U=x.x,G=x.y,X=x.z,Y=U-O,Q=G-D,Z=X-W;if(Y*A+Q*V+Z*T<=0)return!1;(A=(r=q-P)*(c=Z-k)-(a=j-k)*(l=Q-P))*M+(V=a*(h=Y-M)-(n=F-M)*c)*P+(T=n*l-r*h)*k>0&&(n=F,r=q,a=j,F=Y,q=Q,j=Z,Y=n,Q=r,Z=a,n=I,r=L,a=C,I=O,L=D,C=W,O=n,D=r,W=a,n=B,r=E,a=R,B=U,E=G,R=X,U=n,G=r,X=a,A=-A,V=-V,T=-T);for(var K=0;;){if(++K>100)return!1;this.supportPoint(t,-A,-V,-T,x);var J=x.x,$=x.y,tt=x.z;this.supportPoint(i,A,V,T,x);var it=x.x,et=x.y,st=x.z,ot=it-J,nt=et-$,rt=st-tt;if(ot*A+nt*V+rt*T<=0)return!1;if((q*rt-j*nt)*M+(j*ot-F*rt)*P+(F*nt-q*ot)*k<0)Y=ot,Q=nt,Z=rt,O=J,D=$,W=tt,U=it,G=et,X=st,A=(r=q-P)*(c=rt-k)-(a=j-k)*(l=nt-P),V=a*(h=ot-M)-(n=F-M)*c,T=n*l-r*h;else if((nt*Z-rt*Q)*M+(rt*Y-ot*Z)*P+(ot*Q-nt*Y)*k<0)F=ot,q=nt,j=rt,I=J,L=$,C=tt,B=it,E=et,R=st,A=(r=nt-P)*(c=Z-k)-(a=rt-k)*(l=Q-P),V=a*(h=Y-M)-(n=ot-M)*c,T=n*l-r*h;else for(var at=!1;;){if(A=(r=Q-q)*(c=rt-j)-(a=Z-j)*(l=nt-q),V=a*(h=ot-F)-(n=Y-F)*c,T=n*l-r*h,(A*=u=1/_.sqrt(A*A+V*V+T*T))*F+(V*=u)*q+(T*=u)*j>=0&&!at){var ht=(q*Z-j*Q)*ot+(j*Y-F*Z)*nt+(F*Q-q*Y)*rt,lt=(nt*Z-rt*Q)*M+(rt*Y-ot*Z)*P+(ot*Q-nt*Y)*k,ct=(P*j-k*q)*ot+(k*F-M*j)*nt+(M*q-P*F)*rt,ut=(Q*j-Z*q)*M+(Z*F-Y*j)*P+(Y*q-Q*F)*k,pt=ht+lt+ct+ut;pt<=0&&(ht=0,pt=(lt=(Q*rt-Z*nt)*A+(Z*ot-Y*rt)*V+(Y*nt-Q*ot)*T)+(ct=(nt*Z-rt*Q)*A+(rt*Y-ot*Z)*V+(ot*Q-nt*Y)*T)+(ut=(q*Z-j*Q)*A+(j*Y-F*Z)*V+(F*Q-q*Y)*T));var dt=1/pt;p=(b*ht+I*lt+O*ct+J*ut)*dt,d=(g*ht+L*lt+D*ct+$*ut)*dt,m=(w*ht+C*lt+W*ct+tt*ut)*dt,y=(z*ht+B*lt+U*ct+it*ut)*dt,f=(N*ht+E*lt+G*ct+et*ut)*dt,v=(S*ht+R*lt+X*ct+st*ut)*dt,at=!0}this.supportPoint(t,-A,-V,-T,x);var mt=x.x,yt=x.y,ft=x.z;this.supportPoint(i,A,V,T,x);var vt=x.x,xt=x.y,bt=x.z,gt=vt-mt,wt=xt-yt,zt=bt-ft,Nt=-(gt*A+wt*V+zt*T);if((gt-ot)*A+(wt-nt)*V+(zt-rt)*T<=.01||Nt>=0)return!!at&&(e.set(-A,-V,-T),s.set(.5*(p+y),.5*(d+f),.5*(m+v)),o.x=Nt,!0);(wt*j-zt*q)*M+(zt*F-gt*j)*P+(gt*q-wt*F)*k<0?(wt*Z-zt*Q)*M+(zt*Y-gt*Z)*P+(gt*Q-wt*Y)*k<0?(F=gt,q=wt,j=zt,I=mt,L=yt,C=ft,B=vt,E=xt,R=bt):(ot=gt,nt=wt,rt=zt,J=mt,$=yt,tt=ft,it=vt,et=xt,st=bt):(wt*rt-zt*nt)*M+(zt*ot-gt*rt)*P+(gt*nt-wt*ot)*k<0?(Y=gt,Q=wt,Z=zt,O=mt,D=yt,W=ft,U=vt,G=xt,X=bt):(F=gt,q=wt,j=zt,I=mt,L=yt,C=ft,B=vt,E=xt,R=bt)}}},supportPoint:function(t,i,e,s,o){var n,r,a,h=t.rotation.elements,l=h[0]*i+h[3]*e+h[6]*s,c=h[1]*i+h[4]*e+h[7]*s,u=h[2]*i+h[5]*e+h[8]*s,p=l,d=u,m=p*p+d*d,y=t.radius,f=t.halfHeight;0==m?c<0?(n=y,r=-f,a=0):(n=y,r=f,a=0):(m=t.radius/_.sqrt(m),c<0?(n=p*m,r=-f,a=d*m):(n=p*m,r=f,a=d*m)),l=h[0]*n+h[1]*r+h[2]*a+t.position.x,c=h[3]*n+h[4]*r+h[5]*a+t.position.y,u=h[6]*n+h[7]*r+h[8]*a+t.position.z,o.set(l,c,u)},detectCollision:function(t,i,e){var s,o;t.id<i.id?(s=t,o=i):(s=i,o=t);var n,r,a,h,l,c,u,p,d,m,y,f,v,x,b,g,w,z,N,S,M,P=s.position,k=o.position,A=P.x,V=P.y,T=P.z,I=k.x,L=k.y,C=k.z,B=s.halfHeight,E=o.halfHeight,R=s.normalDirection,F=o.normalDirection,q=s.halfDirection,j=o.halfDirection,O=s.radius,D=o.radius,W=R.x,U=R.y,G=R.z,X=F.x,Y=F.y,Q=F.z,Z=q.x,K=q.y,J=q.z,$=j.x,tt=j.y,it=j.z,et=A-I,st=V-L,ot=T-C,nt=new H,rt=new H,at=new H;if(this.getSep(s,o,nt,rt,at)){var ht=nt.x*W+nt.y*U+nt.z*G,lt=nt.x*X+nt.y*Y+nt.z*Q,ct=ht>0,ut=lt>0;ct||(ht=-ht),ut||(lt=-lt);var pt,dt,mt,yt=0;(ht>.999||lt>.999)&&(yt=ht>lt?1:2);var ft,vt,xt,bt,gt,wt,zt,Nt,St,Mt,Pt,kt,At,Vt,Tt,It,Lt=at.x;switch(pt=nt.x,dt=nt.y,mt=nt.z,yt){case 0:e.addPoint(rt.x,rt.y,rt.z,pt,dt,mt,Lt,!1);break;case 1:if(ct?(r=A+Z,a=V+K,h=T+J,pt=W,dt=U,mt=G):(r=A-Z,a=V-K,h=T-J,pt=-W,dt=-U,mt=-G),l=I+(n=(N=pt*X+dt*Y+mt*Q)<0?E:-E)*X,c=L+n*Y,u=C+n*Q,lt>=.999999?(p=-dt,d=mt,m=pt):(p=pt,d=dt,m=mt),et=(n=p*X+d*Y+m*Q)*X-p,st=n*Y-d,ot=n*Q-m,0==(n=_.sqrt(et*et+st*st+ot*ot)))break;if(p=l+(et*=n=D/n),d=c+(st*=n),m=u+(ot*=n),N<-.96||N>.96)ft=X*X*1.5-.5,vt=X*Y*1.5-.866025403*Q,xt=X*Q*1.5+.866025403*Y,bt=Y*X*1.5+.866025403*Q,gt=Y*Y*1.5-.5,wt=Y*Q*1.5-.866025403*X,zt=Q*X*1.5-.866025403*Y,Nt=Q*Y*1.5+.866025403*X,St=Q*Q*1.5-.5,(n=(p=(Mt=p)-(At=pt*(Mt-r)+dt*((Pt=d)-a)+mt*((kt=m)-h))*pt-r)*p+(d=Pt-At*dt-a)*d+(m=kt-At*mt-h)*m)>O*O&&(p*=n=O/_.sqrt(n),d*=n,m*=n),Mt=r+p,Pt=a+d,kt=h+m,e.addPoint(Mt,Pt,kt,pt,dt,mt,At,!1),Pt=et*bt+st*gt+ot*wt,kt=et*zt+st*Nt+ot*St,(At=pt*((Mt=(et=Mt=et*ft+st*vt+ot*xt)+l)-r)+dt*((Pt=(st=Pt)+c)-a)+mt*((kt=(ot=kt)+u)-h))<=0&&((n=(p=Mt-At*pt-r)*p+(d=Pt-At*dt-a)*d+(m=kt-At*mt-h)*m)>O*O&&(p*=n=O/_.sqrt(n),d*=n,m*=n),Mt=r+p,Pt=a+d,kt=h+m,e.addPoint(Mt,Pt,kt,pt,dt,mt,At,!1)),Pt=et*bt+st*gt+ot*wt,kt=et*zt+st*Nt+ot*St,(At=pt*((Mt=(et=Mt=et*ft+st*vt+ot*xt)+l)-r)+dt*((Pt=(st=Pt)+c)-a)+mt*((kt=(ot=kt)+u)-h))<=0&&((n=(p=Mt-At*pt-r)*p+(d=Pt-At*dt-a)*d+(m=kt-At*mt-h)*m)>O*O&&(p*=n=O/_.sqrt(n),d*=n,m*=n),Mt=r+p,Pt=a+d,kt=h+m,e.addPoint(Mt,Pt,kt,pt,dt,mt,At,!1));else{if(y=p,N>0?(x=p+X*E*2,b=d+Y*E*2,g=m+Q*E*2):(x=p-X*E*2,b=d-Y*E*2,g=m-Q*E*2),(It=(Vt=(et=r-(y-=(w=pt*(y-r)+dt*((f=d)-a)+mt*((v=m)-h))*pt))*(p=(x-=(z=pt*(x-r)+dt*(b-a)+mt*(g-h))*pt)-y)+(st=a-(f-=w*dt))*(d=(b-=z*dt)-f)+(ot=h-(v-=w*mt))*(m=(g-=z*mt)-v))*Vt-(Tt=p*p+d*d+m*m)*(et*et+st*st+ot*ot-O*O))<0)break;(M=(Vt-(It=_.sqrt(It)))/Tt)<(S=(Vt+It)/Tt)&&(n=S,S=M,M=n),M>1&&(M=1),S<0&&(S=0),p=y+(x-y)*S,d=f+(b-f)*S,m=v+(g-v)*S,x=y+(x-y)*M,b=f+(b-f)*M,g=v+(g-v)*M,y=p,f=d,v=m,n=w+(z-w)*S,z=w+(z-w)*M,(w=n)<0&&e.addPoint(y,f,v,pt,dt,mt,At,!1),z<0&&e.addPoint(x,b,g,pt,dt,mt,At,!1)}break;case 2:if(ut?(l=I-$,c=L-tt,u=C-it,pt=-X,dt=-Y,mt=-Q):(l=I+$,c=L+tt,u=C+it,pt=X,dt=Y,mt=Q),r=A+(n=(N=pt*W+dt*U+mt*G)<0?B:-B)*W,a=V+n*U,h=T+n*G,ht>=.999999?(p=-dt,d=mt,m=pt):(p=pt,d=dt,m=mt),et=(n=p*W+d*U+m*G)*W-p,st=n*U-d,ot=n*G-m,0==(n=_.sqrt(et*et+st*st+ot*ot)))break;if(p=r+(et*=n=O/n),d=a+(st*=n),m=h+(ot*=n),N<-.96||N>.96)ft=W*W*1.5-.5,vt=W*U*1.5-.866025403*G,xt=W*G*1.5+.866025403*U,bt=U*W*1.5+.866025403*G,gt=U*U*1.5-.5,wt=U*G*1.5-.866025403*W,zt=G*W*1.5-.866025403*U,Nt=G*U*1.5+.866025403*W,St=G*G*1.5-.5,(n=(p=(Mt=p)-(At=pt*(Mt-l)+dt*((Pt=d)-c)+mt*((kt=m)-u))*pt-l)*p+(d=Pt-At*dt-c)*d+(m=kt-At*mt-u)*m)>D*D&&(p*=n=D/_.sqrt(n),d*=n,m*=n),Mt=l+p,Pt=c+d,kt=u+m,e.addPoint(Mt,Pt,kt,-pt,-dt,-mt,At,!1),Pt=et*bt+st*gt+ot*wt,kt=et*zt+st*Nt+ot*St,(At=pt*((Mt=(et=Mt=et*ft+st*vt+ot*xt)+r)-l)+dt*((Pt=(st=Pt)+a)-c)+mt*((kt=(ot=kt)+h)-u))<=0&&((n=(p=Mt-At*pt-l)*p+(d=Pt-At*dt-c)*d+(m=kt-At*mt-u)*m)>D*D&&(p*=n=D/_.sqrt(n),d*=n,m*=n),Mt=l+p,Pt=c+d,kt=u+m,e.addPoint(Mt,Pt,kt,-pt,-dt,-mt,At,!1)),Pt=et*bt+st*gt+ot*wt,kt=et*zt+st*Nt+ot*St,(At=pt*((Mt=(et=Mt=et*ft+st*vt+ot*xt)+r)-l)+dt*((Pt=(st=Pt)+a)-c)+mt*((kt=(ot=kt)+h)-u))<=0&&((n=(p=Mt-At*pt-l)*p+(d=Pt-At*dt-c)*d+(m=kt-At*mt-u)*m)>D*D&&(p*=n=D/_.sqrt(n),d*=n,m*=n),Mt=l+p,Pt=c+d,kt=u+m,e.addPoint(Mt,Pt,kt,-pt,-dt,-mt,At,!1));else{if(y=p,N>0?(x=p+W*B*2,b=d+U*B*2,g=m+G*B*2):(x=p-W*B*2,b=d-U*B*2,g=m-G*B*2),(It=(Vt=(et=l-(y-=(w=pt*(y-l)+dt*((f=d)-c)+mt*((v=m)-u))*pt))*(p=(x-=(z=pt*(x-l)+dt*(b-c)+mt*(g-u))*pt)-y)+(st=c-(f-=w*dt))*(d=(b-=z*dt)-f)+(ot=u-(v-=w*mt))*(m=(g-=z*mt)-v))*Vt-(Tt=p*p+d*d+m*m)*(et*et+st*st+ot*ot-D*D))<0)break;(M=(Vt-(It=_.sqrt(It)))/Tt)<(S=(Vt+It)/Tt)&&(n=S,S=M,M=n),M>1&&(M=1),S<0&&(S=0),p=y+(x-y)*S,d=f+(b-f)*S,m=v+(g-v)*S,x=y+(x-y)*M,b=f+(b-f)*M,g=v+(g-v)*M,y=p,f=d,v=m,n=w+(z-w)*S,z=w+(z-w)*M,(w=n)<0&&e.addPoint(y,f,v,-pt,-dt,-mt,w,!1),z<0&&e.addPoint(x,b,g,-pt,-dt,-mt,z,!1)}}}}}),Gt.prototype=Object.assign(Object.create(_t.prototype),{constructor:Gt,detectCollision:function(t,i,e){var s,o;this.flip?(s=i,o=t):(s=t,o=i);var n,r,a,h,l,c=o.dimentions,u=s.position,p=u.x,d=u.y,m=u.z,y=o.position,f=y.x,v=y.y,x=y.z,b=s.radius,g=o.halfWidth,w=o.halfHeight,z=o.halfDepth,N=p-f,S=d-v,M=m-x,P=c[0]*N+c[1]*S+c[2]*M,k=c[3]*N+c[4]*S+c[5]*M,A=c[6]*N+c[7]*S+c[8]*M,V=0;P>g?P=g:P<-g?P=-g:V=1,k>w?k=w:k<-w?k=-w:V|=2,A>z?A=z:A<-z?A=-z:V|=4,7==V?(M=A<0?z+A:z-A,(N=P<0?g+P:g-P)<(S=k<0?w+k:w-k)?N<M?(h=N-g,P<0?(P=-g,N=c[0],S=c[1],M=c[2]):(P=g,N=-c[0],S=-c[1],M=-c[2])):(h=M-z,A<0?(A=-z,N=c[6],S=c[7],M=c[8]):(A=z,N=-c[6],S=-c[7],M=-c[8])):S<M?(h=S-w,k<0?(k=-w,N=c[3],S=c[4],M=c[5]):(k=w,N=-c[3],S=-c[4],M=-c[5])):(h=M-z,A<0?(A=-z,N=c[6],S=c[7],M=c[8]):(A=z,N=-c[6],S=-c[7],M=-c[8])),n=f+P*c[0]+k*c[3]+A*c[6],r=v+P*c[1]+k*c[4]+A*c[7],a=x+P*c[2]+k*c[5]+A*c[8],e.addPoint(p+b*N,d+b*S,m+b*M,N,S,M,h-b,this.flip)):(n=f+P*c[0]+k*c[3]+A*c[6],r=v+P*c[1]+k*c[4]+A*c[7],a=x+P*c[2]+k*c[5]+A*c[8],(h=(N=n-u.x)*N+(S=r-u.y)*S+(M=a-u.z)*M)>0&&h<b*b&&(N*=l=1/(h=_.sqrt(h)),S*=l,M*=l,e.addPoint(p+b*N,d+b*S,m+b*M,N,S,M,h-b,this.flip)))}}),Xt.prototype=Object.assign(Object.create(_t.prototype),{constructor:Xt,detectCollision:function(t,i,e){var s,o;this.flip?(s=i,o=t):(s=t,o=i);var n=s.position,r=n.x,a=n.y,h=n.z,l=o.position,c=l.x,u=l.y,p=l.z,d=o.normalDirection.x,m=o.normalDirection.y,y=o.normalDirection.z,f=s.radius,v=o.radius,x=f+v,b=o.halfHeight,g=r-c,w=a-u,z=h-p,N=g*d+w*m+z*y;if(!(N<-b-f||N>b+f)){var S,M=c+N*d,P=u+N*m,k=p+N*y,A=r-M,V=a-P,T=h-k,I=A*A+V*V+T*T;if(!(I>x*x))I>v*v&&(A*=I=v/_.sqrt(I),V*=I,T*=I),N<-b?N=-b:N>b&&(N=b),(I=(g=(M=c+N*d+A)-r)*g+(w=(P=u+N*m+V)-a)*w+(z=(k=p+N*y+T)-h)*z)>0&&I<f*f&&(g*=S=1/(I=_.sqrt(I)),w*=S,z*=S,e.addPoint(r+g*f,a+w*f,h+z*f,g,w,z,I-f,this.flip))}}}),Yt.prototype=Object.assign(Object.create(_t.prototype),{constructor:Yt,detectCollision:function(t,i,e){var s=t,o=i,n=s.position,r=o.position,a=r.x-n.x,h=r.y-n.y,l=r.z-n.z,c=a*a+h*h+l*l,u=s.radius,p=u+o.radius;if(c>0&&c<p*p){var d=1/(c=_.sqrt(c));a*=d,h*=d,l*=d,e.addPoint(n.x+a*u,n.y+h*u,n.z+l*u,a,h,l,c-p,!1)}}}),Qt.prototype=Object.assign(Object.create(_t.prototype),{constructor:Qt,detectCollision:function(t,i,e){var s,o=this.n,n=this.p,r=this.flip?i:t,a=this.flip?t:i,h=r.radius;o.sub(r.position,a.position),o.x*=a.normal.x,o.y*=a.normal.y,o.z*=a.normal.z,(s=o.lengthSq())>0&&s<h*h&&(s=_.sqrt(s),o.copy(a.normal).negate(),n.copy(r.position).addScaledVector(o,h),e.addPointVec(n,o,s-h,this.flip))}}),Zt.prototype=Object.assign(Object.create(_t.prototype),{constructor:Zt,detectCollision:function(t,i,e){var s,o=this.n,n=this.p,r=this.cc,a=this.flip?i:t,h=this.flip?t:i,l=a.dimentions,c=a.halfWidth,u=a.halfHeight,p=a.halfDepth,d=0;this.dix.set(l[0],l[1],l[2]),this.diy.set(l[3],l[4],l[5]),this.diz.set(l[6],l[7],l[8]),o.sub(a.position,h.position),o.x*=h.normal.x,o.y*=h.normal.y,o.z*=h.normal.z,r.set(_.dotVectors(this.dix,o),_.dotVectors(this.diy,o),_.dotVectors(this.diz,o)),r.x>c?r.x=c:r.x<-c?r.x=-c:d=1,r.y>u?r.y=u:r.y<-u?r.y=-u:d|=2,r.z>p?r.z=p:r.z<-p?r.z=-p:d|=4,7===d&&(o.set(r.x<0?c+r.x:c-r.x,r.y<0?u+r.y:u-r.y,r.z<0?p+r.z:p-r.z),o.x<o.y?o.x<o.z?(s=o.x-c,r.x<0?(r.x=-c,o.copy(this.dix)):(r.x=c,o.subEqual(this.dix))):(s=o.z-p,r.z<0?(r.z=-p,o.copy(this.diz)):(r.z=p,o.subEqual(this.diz))):o.y<o.z?(s=o.y-u,r.y<0?(r.y=-u,o.copy(this.diy)):(r.y=u,o.subEqual(this.diy))):(s=o.z-p,r.z<0?(r.z=-p,o.copy(this.diz)):(r.z=p,o.subEqual(this.diz))),n.copy(h.position).addScaledVector(o,1),e.addPointVec(n,o,s,this.flip))}}),Object.assign(Kt.prototype,{World:!0,play:function(){if(null===this.timer){var t=this;this.timer=setInterval((function(){t.step()}),this.timerate)}},stop:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)},setGravity:function(t){this.gravity.fromArray(t)},getInfo:function(){return this.isStat?this.performance.show():""},clear:function(){for(this.stop(),this.preLoop=null,this.postLoop=null,this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies)},addRigidBody:function(t){t.parent&&W("World","It is not possible to be added to more than one world one of the rigid body"),t.setParent(this);for(var i=t.shapes;null!==i;i=i.next)this.addShape(i);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var i=t;if(i.parent===this){i.awake();for(var e=i.jointLink;null!=e;){var s=e.joint;e=e.next,this.removeJoint(s)}for(var o=t.shapes;null!==o;o=o.next)this.removeShape(o);var n=i.prev,r=i.next;null!==n&&(n.next=r),null!==r&&(r.prev=n),this.rigidBodies==i&&(this.rigidBodies=r),i.prev=null,i.next=null,i.parent=null,this.numRigidBodies--}},getByName:function(t){for(var i=this.rigidBodies;null!==i;){if(i.name===t)return i;i=i.next}for(var e=this.joints;null!==e;){if(e.name===t)return e;e=e.next}return null},addShape:function(t){t.parent&&t.parent.parent||W("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&W("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.setParent(this),this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){var i=t,e=i.prev,s=i.next;null!==e&&(e.next=s),null!==s&&(s.prev=e),this.joints==i&&(this.joints=s),i.prev=null,i.next=null,this.numJoints--,i.awake(),i.detach(),i.parent=null},addContact:function(t,i){var e;null!==this.unusedContacts?(e=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):e=new Pt,e.attach(t,i),e.detector=this.detectors[t.type][i.type],this.contacts&&((this.contacts.prev=e).next=this.contacts),this.contacts=e,this.numContacts++},removeContact:function(t){var i=t.prev,e=t.next;e&&(e.prev=i),i&&(i.next=e),this.contacts==t&&(this.contacts=e),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},getContact:function(t,i){var e,s;t=t.constructor===kt?t.name:t,i=i.constructor===kt?i.name:i;for(var o=this.contacts;null!==o;){if(e=o.body1.name,s=o.body2.name,e===t&&s===i||s===t&&e===i)return o.touching?o:null;o=o.next}return null},checkContact:function(t,i){for(var e,s,o=this.contacts;null!==o;){if(e=o.body1.name||" ",s=o.body2.name||" ",e==t&&s==i||s==t&&e==i)return!!o.touching;o=o.next}},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t=this.isStat;t&&this.performance.setTime(0);for(var i=this.rigidBodies;null!==i;)i.addedToIsland=!1,i.sleeping&&i.testWakeUp(),i=i.next;t&&this.performance.setTime(1),this.broadPhase.detectPairs();for(var e=this.broadPhase.pairs,s=this.broadPhase.numPairs;s--;){var o,n,r,a=e[s];a.shape1.id<a.shape2.id?(o=a.shape1,n=a.shape2):(o=a.shape2,n=a.shape1),r=o.numContacts<n.numContacts?o.contactLink:n.contactLink;for(var h=!1;r;){if((g=r.contact).shape1==o&&g.shape2==n){g.persisting=!0,h=!0;break}r=r.next}h||this.addContact(o,n)}for(t&&this.performance.calcBroadPhase(),this.numContactPoints=0,g=this.contacts;null!==g;)if(g.persisting||!g.shape1.aabb.intersectTest(g.shape2.aabb)){var l=g.body1,c=g.body2;(l.isDynamic&&!l.sleeping||c.isDynamic&&!c.sleeping)&&g.updateManifold(),this.numContactPoints+=g.manifold.numPoints,g.persisting=!1,g.constraint.addedToIsland=!1,g=g.next}else{var u=g.next;this.removeContact(g),g=u}t&&this.performance.calcNarrowPhase();var p,d,m=1/this.timeStep;for(p=this.joints;null!==p;p=p.next)p.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],t&&this.performance.setTime(1),this.numIslands=0;for(var y=this.rigidBodies;null!==y;y=y.next)if(!(y.addedToIsland||y.isStatic||y.sleeping))if(y.isLonely())y.isDynamic&&y.linearVelocity.addScaledVector(this.gravity,this.timeStep),this.callSleep(y)?(y.sleepTime+=this.timeStep,y.sleepTime>.5?y.sleep():y.updatePosition(this.timeStep)):(y.sleepTime=0,y.updatePosition(this.timeStep)),this.numIslands++;else{var f=0,v=0,x=1;this.islandStack[0]=y,y.addedToIsland=!0;do{if(i=this.islandStack[--x],this.islandStack[x]=null,i.sleeping=!1,this.islandRigidBodies[f++]=i,!i.isStatic){for(var b=i.contactLink;null!==b;b=b.next){var g;if(!(d=(g=b.contact).constraint).addedToIsland&&g.touching)this.islandConstraints[v++]=d,d.addedToIsland=!0,(u=b.body).addedToIsland||(this.islandStack[x++]=u,u.addedToIsland=!0)}for(var w=i.jointLink;null!==w;w=w.next)(d=w.joint).addedToIsland||(this.islandConstraints[v++]=d,d.addedToIsland=!0,!(u=w.body).addedToIsland&&u.isDynamic&&(this.islandStack[x++]=u,u.addedToIsland=!0))}}while(0!=x);for(var z=(new H).addScaledVector(this.gravity,this.timeStep),N=f;N--;)(i=this.islandRigidBodies[N]).isDynamic&&i.linearVelocity.addEqual(z);if(this.enableRandomizer)for(N=v;N--;)if(0!==N){var S=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*N|0;d=this.islandConstraints[N],this.islandConstraints[N]=this.islandConstraints[S],this.islandConstraints[S]=d}for(N=v;N--;)this.islandConstraints[N].preSolve(this.timeStep,m);for(var M=this.numIterations;M--;)for(N=v;N--;)this.islandConstraints[N].solve();for(N=v;N--;)this.islandConstraints[N].postSolve(),this.islandConstraints[N]=null;var P=10;for(N=f;N--;)i=this.islandRigidBodies[N],this.callSleep(i)?(i.sleepTime+=this.timeStep,i.sleepTime<P&&(P=i.sleepTime)):(i.sleepTime=0,P=0);if(P>.5)for(N=f;N--;)this.islandRigidBodies[N].sleep(),this.islandRigidBodies[N]=null;else for(N=f;N--;)this.islandRigidBodies[N].updatePosition(this.timeStep),this.islandRigidBodies[N]=null;this.numIslands++}t&&this.performance.calcEnd(),null!==this.postLoop&&this.postLoop()},remove:function(t){},add:function(t){var i=(t=t||{}).type||"box";return i.constructor===String&&(i=[i]),"joint"===i[0].substring(0,5)?this.initJoint(i[0],t):this.initBody(i,t)},initBody:function(t,i){var e=this.invScale,s=i.move||!1,o=i.kinematic||!1,n=i.pos||[0,0,0];n=n.map((function(t){return t*e}));var r=i.posShape||[0,0,0];r=r.map((function(t){return t*e}));var a=i.rot||[0,0,0];a=a.map((function(t){return t*_.degtorad}));var h=i.rotShape;h=a.map((function(t){return t*_.degtorad}));var l=void 0===i.size?[1,1,1]:i.size;1===l.length&&(l[1]=l[0]),2===l.length&&(l[2]=l[0]),l=l.map((function(t){return t*e}));var c=new et;void 0!==i.density&&(c.density=i.density),void 0!==i.friction&&(c.friction=i.friction),void 0!==i.restitution&&(c.restitution=i.restitution),void 0!==i.belongsTo&&(c.belongsTo=i.belongsTo),void 0!==i.collidesWith&&(c.collidesWith=i.collidesWith),void 0!==i.config&&(void 0!==i.config[0]&&(c.density=i.config[0]),void 0!==i.config[1]&&(c.friction=i.config[1]),void 0!==i.config[2]&&(c.restitution=i.config[2]),void 0!==i.config[3]&&(c.belongsTo=i.config[3]),void 0!==i.config[4]&&(c.collidesWith=i.config[4]));for(var u,p,d=new kt(new H(n[0],n[1],n[2]),(new G).setFromEuler(a[0],a[1],a[2])),m=0;m<t.length;m++){switch(void 0!==r[p=3*m]&&c.relativePosition.set(r[p],r[p+1],r[p+2]),void 0!==h[p]&&c.relativeRotation.setQuat((new G).setFromEuler(h[p],h[p+1],h[p+2])),t[m]){case"sphere":u=new J(c,l[p]);break;case"cylinder":u=new $(c,l[p],l[p+1]);break;case"box":u=new K(c,l[p],l[p+1],l[p+2]);break;case"plane":u=new tt(c)}d.addShape(u)}return i.neverSleep||o?d.allowSleep=!1:d.allowSleep=!0,d.isKinematic=o,s?i.massPos||i.massRot?d.setupMass(1,!1):d.setupMass(1,!0):d.setupMass(2),void 0!==i.name&&(d.name=i.name),this.addRigidBody(d),s&&(i.sleep?d.sleep():d.awake()),d},initJoint:function(t,i){var e,s,o=this.invScale,n=i.axe1||[1,0,0],r=i.axe2||[1,0,0],a=i.pos1||[0,0,0],h=i.pos2||[0,0,0];a=a.map((function(t){return t*o})),h=h.map((function(t){return t*o})),"jointDistance"===t?(e=i.min||0,s=i.max||10,e*=o,s*=o):(e=i.min||57.29578,s=i.max||0,e*=_.degtorad,s*=_.degtorad);var l=i.limit||null,c=i.spring||null,u=i.motor||null,p=new xt;p.scale=this.scale,p.invScale=this.invScale,p.allowCollision=i.collision||!1,p.localAxis1.set(n[0],n[1],n[2]),p.localAxis2.set(r[0],r[1],r[2]),p.localAnchorPoint1.set(a[0],a[1],a[2]),p.localAnchorPoint2.set(h[0],h[1],h[2]);var d,m=null,y=null;if(void 0===i.body1||void 0===i.body2)return W("World","Can't add joint if attach rigidbodys not define !");if(i.body1.constructor===String?m=this.getByName(i.body1):i.body1.constructor===Number?m=this.getByName(i.body1):i.body1.constructor===kt&&(m=i.body1),i.body2.constructor===String?y=this.getByName(i.body2):i.body2.constructor===Number?y=this.getByName(i.body2):i.body2.constructor===kt&&(y=i.body2),null===m||null===y)return W("World","Can't add joint attach rigidbodys not find !");switch(p.body1=m,p.body2=y,t){case"jointDistance":d=new pt(p,e,s),null!==c&&d.limitMotor.setSpring(c[0],c[1]),null!==u&&d.limitMotor.setMotor(u[0],u[1]);break;case"jointHinge":case"joint":d=new lt(p,e,s),null!==c&&d.limitMotor.setSpring(c[0],c[1]),null!==u&&d.limitMotor.setMotor(u[0],u[1]);break;case"jointPrisme":d=new yt(p,e,s);break;case"jointSlide":d=new ft(p,e,s);break;case"jointBall":d=new ct(p);break;case"jointWheel":d=new vt(p),null!==l&&d.rotationalLimitMotor1.setLimit(l[0],l[1]),null!==c&&d.rotationalLimitMotor1.setSpring(c[0],c[1]),null!==u&&d.rotationalLimitMotor1.setMotor(u[0],u[1])}return d.name=i.name||"",this.addJoint(d),d}});var Jt,$t=function(){function t(t,i){this.objs=[],this.scene=t,this.oimoGroup=new n.Group,this.oimoGroup.name="oimo",this.scene.add(this.oimoGroup),i=i||{};var e=new n.Vector3;i.gravity?e.copy(i.gravity):e.set(0,-9.8,0),this.world=new Kt({timestep:i.timestep||1/60,iterations:i.iterations||8,broadphase:i.broadphase||2,worldscale:i.worldscale||1,random:null==i.random||i.random,info:null!=i.info&&i.info,gravity:[e.x,e.y,e.z]})}return t.prototype.add=function(t,i){i=i||{},this.oimoGroup.add(t),this.createParam(i,t);var e=this.world.add({type:i.type,size:i.size||[1,1,1],pos:i.pos||[0,0,0],rot:i.rot||[0,0,0],move:null==i.move||i.move,density:null!=i.density?i.move:1,friction:null!=i.friction?i.friction:.2,restitution:null!=i.restitution?i.restitution:.2,belongsTo:null!=i.belongsTo?i.belongsTo:1,collidesWith:null!=i.collidesWith?i.collidesWith:4294967295});return this.objs.push({threeObj:t,body:e}),e},t.prototype.createParam=function(t,i){var e=i.scale,s=i.geometry;if(s&&null==t.type){var o=s.type;if(-1!==o.indexOf("Box"))(a=s.parameters).width=void 0===a.width?1:a.width,a.height=void 0===a.height?1:a.height,a.depth=void 0===a.depth?1:a.depth,t.type="box",t.size=[a.width*e.x,a.height*e.y,a.depth*e.z];else if(-1!==o.indexOf("Sphere")){(a=s.parameters).radius=void 0===a.radius?1:a.radius,t.type="sphere";var r=Math.max(e.x,Math.max(e.y,e.z));t.size=[a.radius*r]}else if(-1!==o.indexOf("Plane")){(a=s.parameters).width=void 0===a.width?1:a.width,a.height=void 0===a.height?1:a.height,t.type="plane"}else if(-1!==o.indexOf("Cylinder")){var a;(a=s.parameters).radiusTop=void 0===a.radiusTop?1:a.radiusTop,a.radiusBottom=void 0===a.radiusBottom?1:a.radiusBottom,a.height=void 0===a.height?1:a.height,t.type="cylinder";var h=Math.max(a.radiusTop,a.radiusBottom);r=Math.max(e.x,e.z);t.size=[h*r,a.height*e.y]}t.pos=[i.position.x,i.position.y,i.position.z],t.rot=[i.rotation.x*n.Math.RAD2DEG,i.rotation.y*n.Math.RAD2DEG,i.rotation.z*n.Math.RAD2DEG]}},t.prototype.update=function(t){this.world.step();for(var i=0;i<this.objs.length;i++){var e=this.objs[i];e.threeObj.position.copy(e.body.position),e.threeObj.quaternion.copy(e.body.quaternion)}},t}(),ti=function(){function t(){this._isAnimating=!1,this.animatingCount=0,this.dispatchEvents=[],this.variables={}}return Object.defineProperty(t.prototype,"isAnimating",{get:function(){return this._isAnimating},enumerable:!0,configurable:!0}),t.prototype.addVariable=function(t,i,e){var s;s=e?{func:e.func,variables:e.variables||[]}:{func:o.sigmoid,variables:[4]},this.variables[t]={x:1,duration:1,value:i||0,base:0,distance:0,easing:s}},t.prototype.setEasing=function(t,i){var e=this.variables[t];e?e.easing=i:console.warn("variable doesn't exist : "+t)},t.prototype.animate=function(t,i,e,s){var o=this.variables[t];o?(o.x>=1&&(this._isAnimating=!0,this.animatingCount++),o.x=0,o.duration=null!=e?e:1,o.base=o.value,o.distance=i-o.base,o.onMoved=s):console.warn("variable doesn't exist : "+t)},t.prototype.getValue=function(t){return this.variables[t]?this.variables[t].value:(console.warn("variable doesn't exist:"+t),null)},t.prototype.update=function(t){for(var i=Object.keys(this.variables);0!=this.dispatchEvents.length;)this.dispatchEvents.pop()();for(var e=0;e<i.length;e++){var s=this.variables[i[e]];if(s.x<1){0!=s.duration?s.x+=(t||.016)/s.duration:s.x=1;var o=s.easing.func(s.x,s.easing.variables);s.value=s.base+s.distance*o,s.x>=1&&(s.x=1,s.value=s.base+s.distance,this.animatingCount--,0==this.animatingCount&&(this._isAnimating=!1),s.onMoved&&this.dispatchEvents.push(s.onMoved))}}},t}(),ii=s(4),ei=s.n(ii),si=(Jt=function(t,i){return(Jt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(t,i)},function(t,i){function e(){this.constructor=t}Jt(t,i),t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}),oi=function(t){function i(i,e){var s=this,o=new n.BufferGeometry,r=[],a=[],h=[];r.push(-1,1,0),r.push(1,1,0),r.push(1,-1,0),r.push(-1,-1,0),h.push(0,1),h.push(1,1),h.push(1,0),h.push(0,0),a.push(0,2,1,0,3,2);var l=new Float32Array(r),c=new Uint32Array(a),u=new Float32Array(h);o.addAttribute("position",new n.BufferAttribute(l,3)),o.addAttribute("uv",new n.BufferAttribute(u,2)),o.setIndex(new n.BufferAttribute(c,1));var p=new n.ShaderMaterial({uniforms:e,fragmentShader:i,vertexShader:ei.a,transparent:!0,depthFunc:n.NeverDepth});return(s=t.call(this,o,p)||this).frustumCulled=!1,s}return si(i,t),i}(n.Mesh),ni=s(5),ri=s.n(ni),ai=s(2),hi=s.n(ai),li=s(6),ci=s.n(li),ui=function(){function t(t,i,e){var s=this;this.renderer=t,this.resolutionRatio=e||1,this.resolution=new n.Vector2,this.renderer.getSize(this.resolution),this.resolution.multiplyScalar(this.renderer.getPixelRatio()*(this.resolutionRatio?this.resolutionRatio:1)),this.scene=new n.Scene,this.camera=new n.OrthographicCamera(-1,1,1,-1,0,1),this.screenMesh=new n.Mesh(new n.PlaneBufferGeometry(2,2),null),this.scene.add(this.screenMesh),this.initRenderTargets(),i.forEach((function(t){t.uniforms||(t.uniforms={}),t.uniforms.backbuffer||(t.uniforms.backbuffer={value:null}),t.uniforms.resolution||(t.uniforms.resolution={value:s.resolution});var i={material:new n.ShaderMaterial({defines:t.defines||null,linewidth:t.linewidth||null,wireframe:t.wireframe||null,wireframeLinewidth:t.wireframeLinewidth||null,lights:t.lights||null,clipping:t.clipping||null,skinning:t.skinning||null,morphTargets:t.morphTargets||null,morphNormals:t.morphNormals||null,uniforms:t.uniforms||null,vertexShader:"varying vec2 vUv; void main() { vUv = uv; gl_Position = vec4( position, 1.0 ); } ",fragmentShader:t.fragmentShader||null,depthTest:!1,depthFunc:n.NeverDepth,transparent:t.transparent||!1,blending:t.blending||n.NormalBlending}),uniforms:t.uniforms};s.effectMaterials?s.effectMaterials.push(i):s.effectMaterials=[i]}))}return t.prototype.initRenderTargets=function(){this.readBuffer=this.createRenderTarget(),this.writeBuffer=this.createRenderTarget()},t.prototype.createRenderTarget=function(){return new n.WebGLRenderTarget(this.resolution.x,this.resolution.y)},t.prototype.swapBuffers=function(){var t=this.writeBuffer;this.writeBuffer=this.readBuffer,this.readBuffer=t},t.prototype.render=function(t,i,e){var s=this;void 0===t&&(t=!1),void 0===i&&(i=!1),void 0===e&&(e=!1);var o=!1,n=!1;"Scene"==t.type?(this.renderer.setRenderTarget(this.readBuffer),this.renderer.clear(),this.renderer.render(t,i),o=e):"boolean"==typeof t?o=t:(this.effectMaterials[0].uniforms.backbuffer.value=t,n=!0,o=i),this.effectMaterials.forEach((function(t,i){s.screenMesh.material=t.material,(!n||i>0)&&(t.uniforms.backbuffer.value=s.readBuffer.texture),i<s.effectMaterials.length-1||o?s.renderer.setRenderTarget(s.writeBuffer):s.renderer.setRenderTarget(null),s.renderer.render(s.scene,s.camera),s.swapBuffers()})),this.resultBuffer=o?this.readBuffer:null},t.prototype.getResultTexture=function(){return this.resultBuffer?this.resultBuffer.texture:null},t.prototype.resize=function(t){var i=t.clone().multiplyScalar(this.resolutionRatio);this.resolution.set(i.x,i.y),this.readBuffer.setSize(i.x,i.y),this.writeBuffer.setSize(i.x,i.y)},t}(),pi=function(){function t(t,i){this.renderCount=5,this.threshold=.9,this.brightness=.9,this.blurRange=10,this.renderer=t,this.blurTextureResolutionRatio=i||.1,this.resolution=new n.Vector2,this.renderer.getSize(this.resolution),this.resolution.multiplyScalar(this.renderer.getPixelRatio()),this.init()}return t.prototype.init=function(){this.sceneTex={value:null},this.blurResolution=(new n.Vector2).copy(this.resolution.clone().divideScalar(this.blurRange)),this._brightUni={threshold:{value:this.threshold}},this._blurUni1={direction:{value:!0},resolution:{value:this.blurResolution}},this._blurUni2={direction:{value:!1},resolution:{value:this.blurResolution}},this._bloomUni={sceneTex:this.sceneTex,brightness:{value:this.brightness}};var t=[{fragmentShader:ri.a,uniforms:this._brightUni}],i=[{fragmentShader:hi.a,uniforms:this._blurUni1},{fragmentShader:hi.a,uniforms:this._blurUni2}],e=[{fragmentShader:ci.a,uniforms:this._bloomUni}];this._brightPP=new ui(this.renderer,t,this.blurTextureResolutionRatio),this._blurPP=new ui(this.renderer,i,this.blurTextureResolutionRatio),this._bloomPP=new ui(this.renderer,e),this.sceneRenderTarget=this._bloomPP.createRenderTarget()},t.prototype.render=function(t,i){this._brightUni.threshold.value=this.threshold,this._bloomUni.brightness.value=this.brightness,this.blurResolution.copy(this.resolution.clone().divideScalar(this.blurRange)),this.renderer.setRenderTarget(this.sceneRenderTarget),this.renderer.render(t,i),this.sceneTex.value=this.sceneRenderTarget.texture,this._brightPP.render(this.sceneRenderTarget.texture,!0);for(var e=this._brightPP.getResultTexture(),s=0;s<this.renderCount;s++)this._blurPP.render(e,!0),e=this._blurPP.getResultTexture();this._bloomPP.render(e,!1)},t.prototype.resize=function(t){this.resolution.copy(t),this.blurResolution.copy(this.resolution.clone().divideScalar(this.blurRange)),this.sceneRenderTarget.setSize(t.x,t.y),this._brightPP.resize(t),this._blurPP.resize(t),this._bloomPP.resize(t)},t}(),di=s(7),mi=s.n(di),yi=function(){var t=function(i,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(i,e)};return function(i,e){function s(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}}(),fi=function(t){function i(i,e){var s=this,o=new n.PlaneBufferGeometry(2,2,1,1);e.vertexShader=mi.a;var r=new n.ShaderMaterial(e);(s=t.call(this,o,r)||this).frustumCulled=!1,s.dom=i,s.uni=e.uniforms;var a=s.dom.getBoundingClientRect();return s.domPos=new n.Vector2(a.left,a.right),s.domSize=new n.Vector2(a.width,a.height),s.windowSize=new n.Vector2(window.innerWidth,window.innerHeight),s.uni.domPos={value:s.domPos},s.uni.domSize={value:s.domSize},s.uni.windowSize={value:s.windowSize},s}return yi(i,t),Object.defineProperty(i.prototype,"uniforms",{get:function(){return this.uni},enumerable:!0,configurable:!0}),i.prototype.updateDom=function(){this.windowSize.set(window.innerWidth,window.innerHeight);var t=this.dom.getBoundingClientRect();this.domSize.set(t.width,t.height),this.domPos.set(t.left,t.top)},i}(n.Mesh),vi=s(8),xi=s.n(vi),bi=s(3),gi=s.n(bi),wi=s(9),zi=s.n(wi),Ni=s(10),Si=s.n(Ni),Mi=s(11),Pi=s.n(Mi),ki=function(){function t(t,i){this.renderer=t,this.resolution=i,this.tempDataLinear=this.createData({minFilter:n.LinearFilter,magFilter:n.LinearFilter}),this.tempDataNear=this.createData({minFilter:n.NearestFilter,magFilter:n.NearestFilter}),this.scene=new n.Scene,this.camera=new n.Camera,this.camera.position.z=1,this.materials=[],this.mesh=new n.Mesh(new n.PlaneBufferGeometry(2,2)),this.scene.add(this.mesh)}return Object.defineProperty(t.prototype,"isSupported",{get:function(){return this.renderer.extensions.get("OES_texture_float")},enumerable:!0,configurable:!0}),t.prototype.createInitializeTexture=function(){var t=new Float32Array(this.resolution.x*this.resolution.y*4),i=new n.DataTexture(t,this.resolution.x,this.resolution.y,n.RGBAFormat,n.FloatType);return i.needsUpdate=!0,i},t.prototype.createData=function(t,i){var e,s,o={wrapS:n.ClampToEdgeWrapping,wrapT:n.ClampToEdgeWrapping,minFilter:n.LinearFilter,magFilter:n.LinearFilter,format:n.RGBAFormat,type:/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?n.HalfFloatType:n.FloatType,stencilBuffer:!1,depthBuffer:!1};t&&(t.isDataTexture?(e=t,i&&(s=i)):s=t),s&&(o.wrapS=s.wrapS||o.wrapS,o.wrapT=s.wrapT||o.wrapT,o.minFilter=s.minFilter||o.minFilter,o.magFilter=s.magFilter||o.magFilter,o.format=s.format||o.format,o.type=s.type||o.type,o.stencilBuffer=s.stencilBuffer||o.stencilBuffer,o.depthBuffer=s.depthBuffer||o.depthBuffer);var r={buffer:new n.WebGLRenderTarget(this.resolution.x,this.resolution.y,o)};if(e){var a=this.createKernel(Pi.a);a.uniforms.texture={value:e},this.compute(a,r)}return r},t.prototype.createKernel=function(t){var i={resolution:{value:this.resolution}},e=new n.ShaderMaterial({vertexShader:Si.a,fragmentShader:t,uniforms:i});return this.materials.push(e),{material:e,uniforms:i}},t.prototype.compute=function(t,i){var e;e=i.buffer.texture.magFilter==n.LinearFilter?this.tempDataLinear:this.tempDataNear,this.mesh.material=t.material,this.renderer.setRenderTarget(e.buffer),this.renderer.render(this.scene,this.camera),this.swapBuffers(i,e),this.renderer.setRenderTarget(null)},t.prototype.swapBuffers=function(t,i){var e=t.buffer;t.buffer=i.buffer,i.buffer=e},t.prototype.dispose=function(){this.mesh.geometry.dispose();for(var t=0;t<this.materials.length;t++)this.materials[t].dispose();this.scene.remove(this.mesh),this.tempDataLinear.buffer.dispose()},t}(),Ai=function(){var t=function(i,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(i,e)};return function(i,e){function s(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}}(),Vi=function(t){function i(i,e,s,o){void 0===o&&(o=null);var r=t.call(this)||this;r.renderer=i,r.num=e,r.length=s,r.fragment=null!=o?o:gi.a,r.gcController=new ki(r.renderer,new n.Vector2(r.length,r.num)),r.kernels={position:r.gcController.createKernel(xi.a),velocity:r.gcController.createKernel(gi.a)};var a=r.gcController.createInitializeTexture();return r.initPosition(a),r.positionData=r.gcController.createData(a),r.velocityData=r.gcController.createData(),a.dispose(),r.kernels.position.uniforms.texturePosition={value:null},r.kernels.position.uniforms.textureVelocity={value:null},r.kernels.velocity.uniforms.texturePosition={value:null},r.kernels.velocity.uniforms.textureVelocity={value:null},r.kernels.velocity.uniforms.time={value:0},r.kernels.velocity.uniforms.seed={value:100*Math.random()},r.createTrails(),r}return Ai(i,t),i.prototype.initPosition=function(t){for(var i=t.image.data,e=new n.Vector3(10,10,10),s=0;s<i.length;s+=4*this.length)for(var o=Math.random()*e.x-e.x/2,r=Math.random()*e.y-e.y/2,a=Math.random()*e.z-e.z/2,h=0;h<4*this.length;h+=4)i[s+h+0]=o,i[s+h+1]=r,i[s+h+2]=a,i[s+h+3]=1},i.prototype.createTrails=function(){for(var t=new n.InstancedBufferGeometry,i=[],e=[],s=[],o=[],r=[],a=0;a<this.length;a++)for(var h=a,l=0;l<10;l++){var c=2*Math.PI/10*l,u=.1*Math.cos(c),p=.1*Math.sin(c);0,i.push(u),i.push(p),i.push(0);var d=new n.Vector3(u,p,0);d.normalize(),s.push(d.x,d.y,d.z),o.push(a/this.length);var m=10*h+l;a>0&&(e.push(m),e.push(10*(h-1)+(l+1)%10),e.push(10*h+(l+1)%10),e.push(m),e.push(m-10),e.push(10*(h-1)+(l+1)%10))}var y=new Float32Array(i),f=new Float32Array(s),v=new Uint32Array(e),x=new Float32Array(o);t.addAttribute("position",new n.BufferAttribute(y,3)),t.addAttribute("uvx",new n.BufferAttribute(x,1)),t.addAttribute("normal",new n.BufferAttribute(f,3)),t.setIndex(new n.BufferAttribute(v,1));for(var b=0;b<this.num;b++)r.push(b/this.num);var g=new Float32Array(r);t.addAttribute("uvy",new n.InstancedBufferAttribute(g,1,!1,1));var w=n.ShaderLib.standard;this.uni=n.UniformsUtils.merge([w.uniforms,{texturePosition:{value:null},textureVelocity:{value:null}}]);var z=new n.ShaderMaterial({uniforms:this.uni,vertexShader:zi.a,fragmentShader:w.fragmentShader,lights:!0,flatShading:!0}),N=new n.Mesh(t,z);N.matrixAutoUpdate=!1,N.updateMatrix(),this.add(N)},i.prototype.update=function(t){this.kernels.velocity.uniforms.time.value=t,this.kernels.velocity.uniforms.textureVelocity.value=this.velocityData.buffer.texture,this.kernels.velocity.uniforms.texturePosition.value=this.positionData.buffer.texture,this.gcController.compute(this.kernels.velocity,this.velocityData),this.kernels.position.uniforms.textureVelocity.value=this.velocityData.buffer.texture,this.kernels.position.uniforms.texturePosition.value=this.positionData.buffer.texture,this.gcController.compute(this.kernels.position,this.positionData),this.uni.texturePosition.value=this.positionData.buffer.texture,this.uni.textureVelocity.value=this.velocityData.buffer.texture},i.prototype.dispose=function(){this.positionData.buffer.dispose(),this.velocityData.buffer.dispose(),this.gcController.dispose()},i}(n.Object3D),Ti=s(12),Ii=s.n(Ti),Li=s(13),Ci=s.n(Li),Bi=s(14),Ei=s.n(Bi),Ri=s(15),Fi=s.n(Ri),qi=s(16),ji=s.n(qi),Oi=s(17),Di=s.n(Oi),_i=function(){function t(t,i){this.parameter={solverIteration:20,screenAspect:1,pointerSize:1,curl:.1,velocityAttenuation:.95,pressureAttenuation:.8},this.time=0,this.renderer=t,this.resolution=i,this.gcConroller=new ki(this.renderer,this.resolution),this.kernels={curl:this.gcConroller.createKernel(Di.a),divergence:this.gcConroller.createKernel(Fi.a),velocity:this.gcConroller.createKernel(Ei.a),gradientSubtract:this.gcConroller.createKernel(Ci.a),pressure:this.gcConroller.createKernel(Ii.a),advect:this.gcConroller.createKernel(ji.a)},this.kernels.curl.uniforms.dataTex={value:null},this.kernels.curl.uniforms.curl={value:this.parameter.curl},this.kernels.velocity.uniforms.dataTex={value:null},this.kernels.velocity.uniforms.curlTex={value:null},this.kernels.velocity.uniforms.screenAspect={value:this.parameter.screenAspect},this.kernels.velocity.uniforms.pointerPos={value:0},this.kernels.velocity.uniforms.pointerVec={value:0},this.kernels.velocity.uniforms.pointerSize={value:this.parameter.pointerSize},this.kernels.pressure.uniforms.dataTex={value:null},this.kernels.gradientSubtract.uniforms.dataTex={value:null},this.kernels.divergence.uniforms.dataTex={value:null},this.kernels.advect.uniforms.dataTex={value:null},this.kernels.advect.uniforms.velocityAttenuation={value:this.parameter.velocityAttenuation},this.kernels.advect.uniforms.pressureAttenuation={value:this.parameter.pressureAttenuation},this.fluidData=this.gcConroller.createData({magFilter:n.LinearFilter,minFilter:n.LinearFilter}),this.curlData=this.gcConroller.createData({magFilter:n.LinearFilter,minFilter:n.LinearFilter})}return t.prototype.update=function(t){this.time+=t,this.kernels.curl.uniforms.curl.value=this.parameter.curl,this.kernels.velocity.uniforms.screenAspect.value=this.parameter.screenAspect,this.kernels.velocity.uniforms.pointerSize.value=this.parameter.pointerSize,this.kernels.advect.uniforms.velocityAttenuation.value=this.parameter.velocityAttenuation,this.kernels.advect.uniforms.pressureAttenuation.value=this.parameter.pressureAttenuation,this.kernels.curl.uniforms.dataTex.value=this.fluidData.buffer.texture,this.gcConroller.compute(this.kernels.curl,this.curlData),this.kernels.velocity.uniforms.dataTex.value=this.fluidData.buffer.texture,this.kernels.velocity.uniforms.curlTex.value=this.curlData.buffer.texture,this.gcConroller.compute(this.kernels.velocity,this.fluidData),this.kernels.divergence.uniforms.dataTex.value=this.fluidData.buffer.texture,this.gcConroller.compute(this.kernels.divergence,this.fluidData);for(var i=0;i<20;i++)this.kernels.pressure.uniforms.dataTex.value=this.fluidData.buffer.texture,this.gcConroller.compute(this.kernels.pressure,this.fluidData);this.kernels.gradientSubtract.uniforms.dataTex.value=this.fluidData.buffer.texture,this.gcConroller.compute(this.kernels.gradientSubtract,this.fluidData),this.kernels.advect.uniforms.dataTex.value=this.fluidData.buffer.texture,this.gcConroller.compute(this.kernels.advect,this.fluidData)},t.prototype.setPointer=function(t,i){this.kernels.velocity.uniforms.pointerPos.value=t,this.kernels.velocity.uniforms.pointerVec.value=i},t.prototype.getTexture=function(){return this.fluidData.buffer.texture},t.prototype.resize=function(t,i){},t}();s.d(e,"Controller",(function(){return h})),s.d(e,"Cursor",(function(){return r})),s.d(e,"PageScroller",(function(){return l})),s.d(e,"PageScrollerSection",(function(){return c})),s.d(e,"BaseScene",(function(){return u})),s.d(e,"MouseRotator",(function(){return p})),s.d(e,"MouseVertexRotator",(function(){return d})),s.d(e,"TransformAnimator",(function(){return m})),s.d(e,"AudioPlayer",(function(){return y})),s.d(e,"MicData",(function(){return f})),s.d(e,"CannonAdapter",(function(){return x})),s.d(e,"OimoAdapter",(function(){return $t})),s.d(e,"Animator",(function(){return ti})),s.d(e,"Background",(function(){return oi})),s.d(e,"BloomFilter",(function(){return pi})),s.d(e,"DomGLSL",(function(){return fi})),s.d(e,"Easings",(function(){return o})),s.d(e,"Fish",(function(){return Vi})),s.d(e,"GPUComputationController",(function(){return ki})),s.d(e,"PostProcessing",(function(){return ui})),s.d(e,"StableFluids",(function(){return _i}))}]);