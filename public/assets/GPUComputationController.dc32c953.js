var z=Object.defineProperty;var C=(s,t,e)=>t in s?z(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var n=(s,t,e)=>(C(s,typeof t!="symbol"?t+"":t,e),e);import{L as h,N as f,c as F,ap as L,M as x,P as g,aq as P,R as y,ar as w,W as I,U as v,S as u,x as S,as as A,B as b,d as E,a2 as B,Y as D,a9 as _,C as G}from"./Uniforms.1c993ea0.js";const V=`#define GLSLIFY 1
varying vec2 vUv;void main(){gl_Position=vec4(position,1.0);vUv=uv;}`,Y=`#define GLSLIFY 1
uniform sampler2D tex;varying vec2 vUv;void main(){gl_FragColor=texture2D(tex,vUv);}`;class M{constructor(t,e){this.renderTargets=[],this.renderer=t,this.dataSize=e.clone(),this.uniforms={dataSize:{value:this.dataSize}},this.tempDataLinear=this.createData({minFilter:h,magFilter:h}),this.tempDataNear=this.createData({minFilter:f,magFilter:f}),this.scene=new F,this.camera=new L,this.materials=[],this.mesh=new x(new g(2,2)),this.scene.add(this.mesh)}get isSupported(){return this.renderer.extensions.get("OES_texture_float")}createInitializeTexture(){let t=new Float32Array(this.uniforms.dataSize.value.x*this.uniforms.dataSize.value.y*4),e=new P(t,this.uniforms.dataSize.value.x,this.uniforms.dataSize.value.y,y,w);return e.needsUpdate=!0,e}createData(t,e){let r=navigator.userAgent,o=r.indexOf("iPhone")>=0||r.indexOf("iPad")>=0||navigator.platform=="iPad"||navigator.platform=="MacIntel"&&navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1&&navigator.standalone!==void 0,i={wrapS:S,wrapT:S,minFilter:f,magFilter:f,format:y,type:o?A:w,stencilBuffer:!1,depthBuffer:!1},l=null,a=null;t&&(t.isDataTexture?(l=t,e&&(a=e)):a=t),a&&(i.wrapS=a.wrapS||i.wrapS,i.wrapT=a.wrapT||i.wrapT,i.minFilter=a.minFilter||i.minFilter,i.magFilter=a.magFilter||i.magFilter,i.format=a.format||i.format,i.type=a.type||i.type,i.stencilBuffer=a.stencilBuffer||i.stencilBuffer,i.depthBuffer=a.depthBuffer||i.depthBuffer);let p=new I(this.uniforms.dataSize.value.x,this.uniforms.dataSize.value.y,i),c={buffer:p};if(this.renderTargets.push(p),l){let m=this.createKernel({fragmentShader:Y,uniforms:{tex:{value:l}}});this.compute(m,c)}return c}createKernel(t){let e=v.mergeUniforms(t.uniforms,this.uniforms);t.uniforms=e,t.vertexShader=t.vertexShader||V;let r=new u(t);return this.materials.push(r),{material:r,uniforms:t.uniforms}}compute(t,e,r){let o;e.buffer.texture.magFilter==h?o=this.tempDataLinear:o=this.tempDataNear,this.mesh.material=t.material;let i=this.renderer.getRenderTarget();this.renderer.setRenderTarget(o.buffer),this.renderer.render(this.scene,r||this.camera),this.swapBuffers(e,o),this.renderer.setRenderTarget(i)}swapBuffers(t,e){let r=t.buffer;t.buffer=e.buffer,e.buffer=r}dispose(){this.mesh.geometry.dispose();for(let e=0;e<this.materials.length;e++)this.materials[e].dispose();this.scene.remove(this.mesh),this.tempDataLinear.buffer.dispose(),this.tempDataNear.buffer.dispose()}resizeData(t){this.dataSize.copy(t);for(let e=0;e<this.renderTargets.length;e++)this.renderTargets[e].setSize(t.x,t.y)}}const j=`#define GLSLIFY 1
uniform vec2 dataSize;uniform sampler2D dataPos;uniform sampler2D dataVel;varying vec2 vUv;void main(void){vec4 posData=texture2D(dataPos,vUv);vec3 pos=posData.xyz;float pTime=posData.w;vec4 velData=texture2D(dataVel,vUv);vec3 vel=velData.xyz;float lifeTime=velData.w;if(pTime<0.0){pTime=0.0;}else if(pTime<=lifeTime){pTime+=0.016;}else if(pTime>lifeTime){pos=vec3(0.0);pTime=-1.0;}pos.xyz+=vel.xyz;gl_FragColor=vec4(pos,pTime);}`,k=`#define GLSLIFY 1
uniform vec2 dataSize;uniform sampler2D dataPos;uniform sampler2D dataVel;uniform float time;uniform float seed;varying vec2 vUv;
#define NOISE_SCALE 1.5
#define TIME_SCALE 2.5
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float snoise4D(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}float random(vec2 p){return fract(sin(dot(p.xy,vec2(12.9898,78.233)))*43758.5453);}vec3 snoise3D(vec3 p){return vec3(snoise4D(vec4(NOISE_SCALE*p,7.225*seed+TIME_SCALE*time)),snoise4D(vec4(NOISE_SCALE*p,3.553*seed+TIME_SCALE*time)),snoise4D(vec4(NOISE_SCALE*p,1.259*seed+TIME_SCALE*time)))*0.6;}void main(void){vec4 posData=texture2D(dataPos,vUv);vec3 pos=posData.xyz;float pTime=posData.w;vec4 velData=texture2D(dataVel,vUv);vec3 vel=velData.xyz;float lifeTime=velData.w;if(pTime<0.0){lifeTime=snoise4D(vec4(vUv.xy*1.0,time,time))*1.0+1.0;vel=vec3(random(vUv+vec2(0.0,0.0))-0.5,random(vUv+vec2(10.0,-100.0))-0.5,random(vUv+vec2(34.0,354.0))-0.5)*0.01;}else if(pTime<lifeTime){vel*=0.9;vel+=snoise3D(pos*7.0)*0.005;}gl_FragColor=vec4(vel,lifeTime);}`,O=`#define GLSLIFY 1
uniform sampler2D posTex;uniform sampler2D velTex;varying vec2 vUv;varying vec4 vColor;
#define PI 3.14159265359
#define TPI 6.28318530718
#define HPI 1.57079632679
void main(void){vec3 pos=position;vec4 posData=texture2D(posTex,uv);vec4 velData=texture2D(velTex,uv);pos+=posData.xyz*10.0;vec4 mvPosition=modelViewMatrix*vec4(pos,1.0);gl_Position=projectionMatrix*mvPosition;vUv=uv;vColor=vec4(1.0*smoothstep(0.5,0.7,(1.0-gl_Position.z*0.04)));gl_PointSize=10.0*sin((posData.w/velData.w)*PI);}`,N=`#define GLSLIFY 1
varying vec2 vUv;varying vec4 vColor;uniform sampler2D velTex;uniform sampler2D posTex;void main(void){gl_FragColor=vColor;}`,T=`#define GLSLIFY 1
varying vec2 vUv;varying vec4 vColor;varying float depth;void main(void){vec3 pos=position;vec4 mvPosition=modelViewMatrix*vec4(pos,1.0);gl_Position=projectionMatrix*mvPosition;vUv=uv;vColor=vec4(1.0);}`,U=`#define GLSLIFY 1
varying vec2 vUv;varying vec4 vColor;uniform sampler2D posTex;uniform sampler2D velTex;uniform float selector;void main(void){vec4 tex=selector>0.5 ? texture2D(posTex,vUv): texture2D(velTex,vUv)*50.0;gl_FragColor=vec4(tex);}`;class K extends b{constructor(){super();n(this,"pointUni");n(this,"gCon");n(this,"kernels");n(this,"datas");n(this,"points");this.commonUniforms=v.mergeUniforms(this.commonUniforms,{time:{value:0},seed:{value:Math.random()*1e3}})}onBind(e){super.onBind(e),this.camera.position.set(0,0,10),this.camera.lookAt(0,0,0);let r=new E(256,256);this.initGPUComputationController(r),this.createPoints(r)}initGPUComputationController(e){if(this.renderer==null)return;this.gCon=new M(this.renderer,e);let r=v.mergeUniforms(this.commonUniforms,{dataPos:{value:null},dataVel:{value:null}}),o=this.gCon.createKernel({fragmentShader:j,uniforms:r}),i=v.mergeUniforms(this.commonUniforms,{dataPos:{value:null},dataVel:{value:null}}),l=this.gCon.createKernel({fragmentShader:k,uniforms:i});this.kernels={position:o,velocity:l},this.datas={position:this.gCon.createData(),velocity:this.gCon.createData()}}createPoints(e){let r=new B,o=[],i=[];for(let m=0;m<e.y;m++)for(let d=0;d<e.x;d++)i.push(0,0,0),o.push(d/(e.x-1),m/(e.y-1));r.setAttribute("position",new D(new Float32Array(i),3)),r.setAttribute("uv",new D(new Float32Array(o),2)),this.pointUni=v.mergeUniforms(this.commonUniforms,{posTex:{value:null},velTex:{value:null}});let l=new u({vertexShader:O,fragmentShader:N,uniforms:this.pointUni});this.points=new _(r,l),this.scene.add(this.points);let a=2,p=new x(new g(a,a),new u({fragmentShader:U,vertexShader:T,uniforms:v.mergeUniforms(this.pointUni,{selector:{value:0}})}));p.position.x=1.5;let c=new x(new g(a,a),new u({fragmentShader:U,vertexShader:T,uniforms:v.mergeUniforms(this.pointUni,{selector:{value:1}})}));c.position.x=-1.5}animate(e){this.commonUniforms.time.value=this.time,this.kernels&&this.datas&&this.pointUni&&this.gCon&&(this.kernels.velocity.uniforms.dataPos.value=this.datas.position.buffer.texture,this.kernels.velocity.uniforms.dataVel.value=this.datas.velocity.buffer.texture,this.gCon.compute(this.kernels.velocity,this.datas.velocity),this.kernels.position.uniforms.dataPos.value=this.datas.position.buffer.texture,this.kernels.position.uniforms.dataVel.value=this.datas.velocity.buffer.texture,this.gCon.compute(this.kernels.position,this.datas.position),this.pointUni.posTex.value=this.datas.position.buffer.texture,this.pointUni.velTex.value=this.datas.velocity.buffer.texture),this.renderer&&this.renderer.render(this.scene,this.camera)}}class R{constructor(){n(this,"controller");n(this,"scene");this.controller=new G,this.scene=new K,this.controller.addLayer(this.scene,{name:"Main",canvas:document.querySelector("#canvas")})}}window.addEventListener("load",()=>{new R});
